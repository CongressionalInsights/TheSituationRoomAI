var de=typeof window<"u"?window.SR_CONFIG||{}:{},Hr=typeof window<"u"&&window.location.hostname.endsWith(".github.io");function Vn(e){return e?e.endsWith("/")?e.slice(0,-1):e:""}function qr(){let e=Vn(de.apiBase);return e?/^https?:\/\//i.test(e)?e:e.startsWith("/")?`${window.location.origin}${e}`:e:window.location.origin}function Gr(){let e=Vn(de.basePath);if(e)return e;let t=window.location.pathname||"";if(!t||t==="/")return"";let n=t.endsWith("/")?t.slice(0,-1):t;return(n.split("/").pop()||"").includes(".")?n.replace(/\/[^/]*$/,""):n}var jr=qr(),Qn=Gr(),tn=typeof de.staticMode=="boolean"?de.staticMode:Hr&&!de.apiBase,he=`${Qn}/data`;function $(){return tn}function Ne(){return de.openAiProxy||""}function Yn(){return de.mcpProxy||""}function nn(){return de.openSkyProxy||""}function an(){return de.acledProxy||""}function Xn(e){if(e.startsWith("/api/feeds"))return`${he}/feeds.json`;if(e.startsWith("/api/energy-map"))return`${he}/energy-map.json`;if(e.startsWith("/api/feed")){let n=new URL(e,"http://local").searchParams.get("id");return n?`${he}/feeds/${n}.json`:`${he}/feeds.json`}return e.startsWith("/api/geocode")||e.startsWith("/api/chat")||e.startsWith("/api/snapshot")?`${he}/unavailable.json`:e.startsWith("/api/money-flows")?`${he}/unavailable.json`:e.startsWith("/api/congress-detail")?`${he}/unavailable.json`:`${he}/unavailable.json`}function zr(e){return/^https?:\/\//i.test(e)?e:tn?Xn(e):new URL(e,jr).toString()}function be(e){if(/^https?:\/\//i.test(e))return e;let t=e.startsWith("/")?e:`/${e}`;return`${Qn}${t}`}async function ve(e,t={},n=12e3){let a=new AbortController,s=setTimeout(()=>a.abort(),n);try{let i=zr(e);if(tn&&(!t.method||t.method.toUpperCase()==="GET")){let c=i.includes("?")?"&":"?";i=`${i}${c}_ts=${Date.now()}`}return await fetch(i,{...t,signal:a.signal})}finally{clearTimeout(s)}}async function me(e,t={},n=12e3){let a=async()=>{if(!e.startsWith("/api/feed"))return null;let c=Kr(e,t);if(!c||!["energy-eia","energy-eia-brent","energy-eia-ng"].includes(c))return null;let p=Xn(`/api/feed?id=${encodeURIComponent(c)}`);try{let m=await fetch(`${p}?_ts=${Date.now()}`),y=await m.json();return{response:m,data:y,error:null}}catch{return null}},s;try{s=await ve(e,t,n)}catch(c){let p=await a();return p||{response:null,data:null,error:c}}let i=null,l=null;try{i=await s.json()}catch(c){l=c}if(!s.ok){let c=await a();if(c)return c}return{response:s,data:i,error:l}}function Kr(e,t){if(e.startsWith("/api/feed")){let a=new URL(e,"http://local").searchParams.get("id");if(a)return a}if(t?.body)try{return(typeof t.body=="string"?JSON.parse(t.body):t.body)?.id||null}catch{return null}return null}function ea({elements:e,state:t,focusPanelExclude:n=new Set,focusGeoTarget:a="geo"}={}){let s={active:!1,target:null,panels:[]},i=h=>{let b=document.createElement("div");b.className="panel-placeholder";let k=h.getBoundingClientRect();b.style.height=`${Math.round(k.height)}px`;let C=window.getComputedStyle(h),S=h.style.gridColumnEnd||C.gridColumnEnd;return S&&S!=="auto"&&(b.style.gridColumnEnd=S),b},l=h=>{let b=i(h);return h.parentNode.insertBefore(b,h),e.focusBody.appendChild(h),{panel:h,placeholder:b}},c=()=>{s.panels.forEach(({panel:h,placeholder:b})=>{b.parentNode&&(b.parentNode.insertBefore(h,b),b.remove())}),s.panels=[],s.target=null},p=h=>{e.focusOverlay&&(e.focusOverlay.classList.toggle("open",h),e.focusOverlay.setAttribute("aria-hidden",h?"false":"true"),e.focusOverlay.inert=!h,!h&&e.focusBody&&(e.focusBody.innerHTML="",e.focusBody.classList.remove("focus-geo"),e.focusBody.classList.remove("focus-single")))},m=h=>{if(h===a){let k=document.querySelector('.panel[data-panel="map"]'),C=document.querySelector('.panel[data-panel="imagery"]');return[k,C].filter(Boolean)}let b=document.querySelector(`.panel[data-panel="${h}"]`);return b?[b]:[]},y=h=>{if(!e.focusBody)return;let b=String(h||"").trim().toLowerCase(),k=[".list-item",".summary-card",".finance-card",".map-detail-item",".legend-item",".legend-subitem",".detail-card",".trends-item",".denario-item"],C=e.focusBody.querySelectorAll(k.join(","));C.length&&C.forEach(S=>{if(!b){S.style.display="";return}let A=S.textContent?S.textContent.toLowerCase():"";S.style.display=A.includes(b)?"":"none"})},d=h=>{if(!e.focusBody)return;s.active&&g();let b=m(h);b.length&&(s.active=!0,s.target=h,e.focusTitle&&(e.focusTitle.textContent=h===a?"Geo + Imagery":b[0].querySelector(".panel-title")?.textContent||"Panel"),e.focusMeta&&(e.focusMeta.textContent=h===a?"Live incidents & events + basemaps/overlays":b[0].querySelector(".panel-sub")?.textContent||"Expanded view"),e.focusBody.innerHTML="",h===a&&e.focusBody.classList.add("focus-geo"),e.focusBody.classList.toggle("focus-single",b.length===1&&h!==a),s.panels=b.map(k=>l(k)),p(!0),e.focusSearch&&(e.focusSearch.value="",e.focusSearch.oninput=()=>y(e.focusSearch.value)),y(""),h===a&&t.map&&setTimeout(()=>t.map.invalidateSize(),120))},g=()=>{if(!s.active)return;let h=s.target===a;c(),p(!1),s.active=!1,e.focusSearch&&(e.focusSearch.value=""),h&&t.map&&setTimeout(()=>t.map.invalidateSize(),120)};return{initFocusModal:()=>{[...document.querySelectorAll(".panel[data-panel]")].forEach(b=>{let k=b.dataset.panel;if(n.has(k))return;let C=b.querySelector(".panel-header");if(!C)return;let S=C.querySelector(".panel-actions");if(S||(S=document.createElement("div"),S.className="panel-actions",C.appendChild(S)),S.querySelector(".panel-focus-btn"))return;let A=document.createElement("button");A.className="btn ghost panel-focus-btn",A.type="button",A.dataset.panelFocus=k==="map"||k==="imagery"?a:k,A.title="Focus panel",A.innerHTML='<svg class="icon" aria-hidden="true"><use href="#icon-expand"></use></svg><span class="sr-only">Focus</span>',A.addEventListener("click",()=>d(A.dataset.panelFocus)),S.appendChild(A)}),e.focusClose&&e.focusClose.addEventListener("click",()=>g()),e.focusOverlay&&e.focusOverlay.addEventListener("click",b=>{b.target===e.focusOverlay&&g()})},openFocusModal:d,closeFocusModal:g,applyFocusFilter:y,isActive:()=>s.active}}var Wr="https://situation-room-mcp-382918878290.us-central1.run.app/mcp";function Jr(e){if(!e)return null;let n=e.split(`
`).map(s=>s.trim()).filter(s=>s.startsWith("data:"));if(!n.length)return null;let a=n[n.length-1].replace(/^data:\s*/,"");try{return JSON.parse(a)}catch{return null}}function ta(e){let t=e||Wr;async function n(a,s={}){if(!t)return{error:"missing_endpoint",message:"MCP endpoint not configured."};let i={jsonrpc:"2.0",id:Date.now(),method:"tools/call",params:{name:a,arguments:s}},c=await(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json, text/event-stream"},body:JSON.stringify(i)})).text(),p=Jr(c);if(!p)return{error:"invalid_response",message:"Unable to parse MCP response."};if(p.error)return{error:p.error.message||"mcp_error",message:p.error.message||"MCP error."};let m=p.result||{};return{data:m.structuredContent??null,raw:m}}return{callTool:n}}var Zr=["state of emergency","emergency declared","mandatory evacuation","evacuation order","mass casualty","shooting","explosion","bomb","terror","attack","hostage","wildfire","tornado","hurricane","earthquake","flood warning","flash flood","tsunami","landslide","hazmat","radiation","nuclear"];function rn(e){if(!e)return!1;if(e.alertType||e.severity||e.hazardType||Number.isFinite(e.magnitude)&&e.magnitude>=6||Number.isFinite(e.fatalities)&&e.fatalities>=10||Number.isFinite(e.impactScore)&&e.impactScore>=80)return!0;let t=[e.title,e.summary,e.summaryHtml,e.detailSummary,e.detailTitle].filter(Boolean).join(" ").toLowerCase();return Zr.some(n=>t.includes(n))}var Ma=4,xa="situationRoomCustomFeeds",Vr=12e3,tt=180,Qr=120,Yr={hillshade:!1,sar:!1,aerosol:!1,lidar:!1,lidarPoints:!1,thermal:!1,fire:!1},Xr={hillshade:.45,sar:.55,aerosol:.45,lidar:.25,lidarPoints:.65,thermal:.45,fire:.45},es={useCustom:!1,pointCap:15e4,radiusKm:5,maxTilesDesktop:16,maxTilesMobile:8},ts={battle:!0,explosion:!0,violence:!0,protest:!0,riot:!0,other:!0},ns={weather:!0,disaster:!0,space:!0,news:!0,spill:!0,health:!0,travel:!0,transport:!0,security:!0,securityLagged:!0,military:!0,gpsjam:!0,infrastructure:!0,outage:!0,local:!0},Ee={refreshMinutes:60,theme:"system",maxAgeDays:30,languageMode:"en",radiusKm:150,scope:"global",country:"US",countryAuto:!0,aiTranslate:!0,superMonitor:!1,showStatus:!0,showTravelTicker:!0,showKeys:!0,showMcp:!0,liveSearch:!0,tickerWatchlist:[],useClientOpenAI:!1,mapBasemap:"osm",mapRasterOverlays:Yr,mapImageryDate:"",mapSarDate:"",lastImageryDate:"",lastSarDate:"",mapOverlayOpacity:Xr,lidarPointLimits:es,lidarEnabled:!1,mapConflictTypes:ts,mapLayers:ns,mapFlightDensity:"medium"};function Na(){return{...Ee,tickerWatchlist:[...Ee.tickerWatchlist],mapRasterOverlays:{...Ee.mapRasterOverlays},mapOverlayOpacity:{...Ee.mapOverlayOpacity},lidarPointLimits:{...Ee.lidarPointLimits},mapConflictTypes:{...Ee.mapConflictTypes},mapLayers:{...Ee.mapLayers}}}function na(e={}){let t=Na(),n={...t,...e};n.mapLayers={...t.mapLayers,...e.mapLayers||{}},n.mapRasterOverlays={...t.mapRasterOverlays,...e.mapRasterOverlays||{}},n.mapOverlayOpacity={...t.mapOverlayOpacity,...e.mapOverlayOpacity||{}},n.lidarPointLimits=Ot({...t.lidarPointLimits,...e.lidarPointLimits||{}}),n.mapBasemap||(n.mapBasemap=t.mapBasemap),n.mapBasemap==="gibs"&&(n.mapBasemap="gibs-viirs"),n.mapImageryDate||(n.mapImageryDate=""),n.mapSarDate||(n.mapSarDate=""),n.lastImageryDate||(n.lastImageryDate=""),n.lastSarDate||(n.lastSarDate=""),n.mapFlightDensity||(n.mapFlightDensity=t.mapFlightDensity),(!n.mapConflictTypes||typeof n.mapConflictTypes!="object")&&(n.mapConflictTypes={...t.mapConflictTypes}),typeof n.lidarEnabled!="boolean"&&(n.lidarEnabled=t.lidarEnabled),n.aiTranslate=typeof n.aiTranslate=="boolean"?n.aiTranslate:t.aiTranslate,n.showStatus=typeof n.showStatus=="boolean"?n.showStatus:t.showStatus,n.showTravelTicker=typeof n.showTravelTicker=="boolean"?n.showTravelTicker:t.showTravelTicker,n.showKeys=typeof n.showKeys=="boolean"?n.showKeys:t.showKeys,n.showMcp=typeof n.showMcp=="boolean"?n.showMcp:t.showMcp,n.liveSearch=typeof n.liveSearch=="boolean"?n.liveSearch:t.liveSearch;let a=Object.prototype.hasOwnProperty.call(e,"superMonitor")&&typeof e.superMonitor=="boolean";return n.superMonitor=a?e.superMonitor:$(),Array.isArray(n.tickerWatchlist)||(n.tickerWatchlist=[]),n.country||(n.country=t.country),typeof n.countryAuto!="boolean"&&(n.countryAuto=t.countryAuto),n}var r={feeds:[],baseFeeds:[],customFeeds:[],items:[],scopedItems:[],clusters:[],panels:{defaultOrder:[],order:[],visibility:{},sizes:{}},keys:{},keyStatus:{},keyFilter:null,feedStatus:{},keyGroups:{},searchCategories:[],lastSearchQuery:"",lastSearchScope:"all",lastSearchCategories:[],translationCache:{},translationInFlight:new Set,congressAmendmentCache:new Map,congressBillAmendments:new Map,congressAmendmentsLoading:!1,congressHearingCache:new Map,staticAnalysis:null,customTickers:[],energyMarket:{},listLimits:{},countries:[],countryIndex:{},settings:Na(),location:{lat:35.5951,lon:-82.5515,source:"fallback"},geoCache:{},chatHistory:[],mapPoints:[],map:null,mapBaseLayers:{},mapOverlayLayers:{},activeBaseLayer:null,lidarMap:null,lidarControl:null,lidarModules:null,imageryDate:null,sarDate:null,imageryDateManual:!1,sarDateManual:!1,imageryResolveInFlight:!1,sarResolveInFlight:!1,sarCapabilitiesChecked:!1,sarCapabilitiesDate:null,sarCoverageTimer:null,sarCoverageCache:{},overlayStatus:{imagery:{state:"idle",message:""},sar:{state:"idle",message:""},lidar:{state:"idle",message:""},lidarPoints:{state:"idle",message:""}},energyMap:null,energyMapLayer:null,energyGeo:null,energyMapData:null,energyMapError:null,energyMapFetchedAt:0,moneyFlowsData:null,moneyFlowsItems:[],moneyFlowsFetchedAt:0,moneyFlowsLoading:!1,moneyFlowsError:null,moneyFlowsQuery:"",moneyFlowsRangeDays:tt,lastBuildAt:null,refreshTimer:null,lastFetch:null,refreshing:!1,retryingFeeds:!1,staleRetrying:!1,lastStaleRetry:0,health:"Initializing",previousSignals:null,analysisSignature:null,analysisRunning:!1,searching:!1,mcpTrends:{loading:!1,query:"",summary:null,signals:[],sources:[],error:null,updatedAt:null},denario:{loading:!1,available:!1,summary:null,items:[],error:null},predictionFallback:{items:[],loading:!1,loaded:!1},flightFocus:null,flightTrack:null,flightTrackLayer:null,flightTrackLoading:!1,flightTrackFetchedAt:0,lidarCoverageLayer:null,lidarCoverageLoading:!1,lidarPointLayer:null,lidarPointData:null,lidarPointLoading:!1,lidarPointAnchor:null,lidarPointProject:null,lidarPointEptUrl:null,lidarPointTelemetry:[],lidarPointEptAvailable:!1,lidarPointEptMeta:null,lidarPointSource:null,lidarSelectedLayer:null,lidarSelectedBounds:null},o={app:document.querySelector(".app"),sidebar:document.getElementById("sidebar"),sidebarScrim:document.getElementById("sidebarScrim"),navToggle:document.getElementById("navToggle"),sidebarSettings:document.getElementById("sidebarSettings"),sidebarAbout:document.getElementById("sidebarAbout"),communityConnect:document.getElementById("communityConnect"),communityFrame:document.querySelector(".chat-frame"),lidarMap:document.getElementById("lidarMap"),lidarLoad:document.getElementById("lidarLoad"),lidarLoadInline:document.getElementById("lidarLoadInline"),lidarReload:document.getElementById("lidarReload"),lidarOpen:document.getElementById("lidarOpen"),lidarClose:document.getElementById("lidarClose"),lidarOverlayOpen:document.getElementById("lidarOverlayOpen"),lidarScrim:document.getElementById("lidarScrim"),lidarEmpty:document.getElementById("lidarEmpty"),lidarEmptyTitle:document.getElementById("lidarEmptyTitle"),lidarEmptySub:document.getElementById("lidarEmptySub"),panelGrid:document.getElementById("panelGrid"),exportSnapshot:document.getElementById("exportSnapshot"),refreshNow:document.getElementById("refreshNow"),statusText:document.getElementById("statusText"),dataFresh:document.getElementById("dataFresh"),proxyHealth:document.getElementById("proxyHealth"),refreshValue:document.getElementById("refreshValue"),refreshRange:document.getElementById("refreshRange"),refreshRangeValue:document.getElementById("refreshRangeValue"),maxAgeRange:document.getElementById("maxAgeRange"),maxAgeValue:document.getElementById("maxAgeValue"),languageToggle:document.getElementById("languageToggle"),radiusRange:document.getElementById("radiusRange"),radiusRangeValue:document.getElementById("radiusRangeValue"),themeToggle:document.getElementById("themeToggle"),ageToggle:document.getElementById("ageToggle"),settingsPanel:document.getElementById("settingsPanel"),settingsToggle:document.getElementById("settingsToggle"),settingsScrim:document.getElementById("settingsScrim"),panelToggles:document.getElementById("panelToggles"),resetLayout:document.getElementById("resetLayout"),aiTranslateToggle:document.getElementById("aiTranslateToggle"),superMonitorToggle:document.getElementById("superMonitorToggle"),keyManager:document.getElementById("keyManager"),feedHealth:document.getElementById("feedHealth"),aboutOverlay:document.getElementById("aboutOverlay"),aboutOpen:document.getElementById("aboutOpen"),aboutOpenSettings:document.getElementById("aboutOpenSettings"),aboutClose:document.getElementById("aboutClose"),listOverlay:document.getElementById("listOverlay"),listModalTitle:document.getElementById("listModalTitle"),listModalMeta:document.getElementById("listModalMeta"),listModalList:document.getElementById("listModalList"),listModalClose:document.getElementById("listModalClose"),detailOverlay:document.getElementById("detailOverlay"),detailTitle:document.getElementById("detailTitle"),detailMeta:document.getElementById("detailMeta"),detailBody:document.getElementById("detailBody"),detailClose:document.getElementById("detailClose"),focusOverlay:document.getElementById("focusOverlay"),focusTitle:document.getElementById("focusTitle"),focusMeta:document.getElementById("focusMeta"),focusBody:document.getElementById("focusBody"),focusSearch:document.getElementById("focusSearch"),focusClose:document.getElementById("focusClose"),feedScope:document.getElementById("feedScope"),searchInput:document.getElementById("searchInput"),searchBtn:document.getElementById("searchBtn"),searchHint:document.getElementById("searchHint"),liveSearchToggle:document.getElementById("liveSearchToggle"),scopeToggle:document.getElementById("scopeToggle"),countrySelect:document.getElementById("countrySelect"),countrySelectLabel:document.getElementById("countrySelectLabel"),geoLocateBtn:document.getElementById("geoLocateBtn"),geoValue:document.getElementById("geoValue"),healthValue:document.getElementById("healthValue"),statusCompact:document.getElementById("statusCompact"),statusToggle:document.getElementById("statusToggle"),keySection:document.getElementById("keySection"),keyCompactBody:document.getElementById("keyCompactBody"),keyToggle:document.getElementById("keyToggle"),mcpSection:document.getElementById("mcpSection"),mcpToggle:document.getElementById("mcpToggle"),newsList:document.getElementById("newsList"),securityList:document.getElementById("securityList"),cryptoList:document.getElementById("cryptoList"),disasterList:document.getElementById("disasterList"),localList:document.getElementById("localList"),predictionList:document.getElementById("predictionList"),policyList:document.getElementById("policyList"),congressList:document.getElementById("congressList"),cyberList:document.getElementById("cyberList"),agricultureList:document.getElementById("agricultureList"),researchList:document.getElementById("researchList"),spaceList:document.getElementById("spaceList"),energyList:document.getElementById("energyList"),energyMap:document.getElementById("energyMap"),energyMapLegend:document.getElementById("energyMapLegend"),energyMapEmpty:document.getElementById("energyMapEmpty"),healthList:document.getElementById("healthList"),transportList:document.getElementById("transportList"),analysisOutput:document.getElementById("analysisOutput"),analysisMeta:document.getElementById("analysisMeta"),analysisStory:document.getElementById("analysisStory"),analysisBody:document.querySelector("#analysisOutput .analysis-body"),analysisRun:document.getElementById("analysisRun"),mcpTrendsPanel:document.getElementById("mcpTrendsPanel"),mcpTrendsQuery:document.getElementById("mcpTrendsQuery"),mcpTrendsRun:document.getElementById("mcpTrendsRun"),mcpTrendsSummary:document.getElementById("mcpTrendsSummary"),mcpTrendsList:document.getElementById("mcpTrendsList"),mcpTrendsMeta:document.getElementById("mcpTrendsMeta"),denarioPanel:document.getElementById("denarioPanel"),denarioMeta:document.getElementById("denarioMeta"),denarioList:document.getElementById("denarioList"),summaryGlobalActivity:document.getElementById("summaryGlobalActivity"),summaryGlobalActivityMeta:document.getElementById("summaryGlobalActivityMeta"),summaryNewsSaturation:document.getElementById("summaryNewsSaturation"),summaryNewsSaturationMeta:document.getElementById("summaryNewsSaturationMeta"),summaryLocalEvents:document.getElementById("summaryLocalEvents"),summaryLocalEventsMeta:document.getElementById("summaryLocalEventsMeta"),summaryMarketPulse:document.getElementById("summaryMarketPulse"),summaryMarketPulseMeta:document.getElementById("summaryMarketPulseMeta"),globalActivity:document.getElementById("globalActivity"),globalActivityMeta:document.getElementById("globalActivityMeta"),newsSaturation:document.getElementById("newsSaturation"),newsSaturationMeta:document.getElementById("newsSaturationMeta"),localEvents:document.getElementById("localEvents"),localEventsMeta:document.getElementById("localEventsMeta"),marketPulse:document.getElementById("marketPulse"),marketPulseMeta:document.getElementById("marketPulseMeta"),signalHealthChip:document.getElementById("signalHealthChip"),signalHealthDetail:document.getElementById("signalHealthDetail"),mapCanvas:document.getElementById("mapCanvas"),mapBase:document.getElementById("mapBase"),mapEmpty:document.getElementById("mapEmpty"),mapTooltip:document.getElementById("mapTooltip"),mapLegendBtn:document.getElementById("mapLegendBtn"),mapLegend:document.getElementById("mapLegend"),legendOutages:document.getElementById("legendOutages"),imageryDateInput:document.getElementById("imageryDateInput"),sarDateInput:document.getElementById("sarDateInput"),imageryDatePanel:document.getElementById("imageryDatePanel"),sarDatePanel:document.getElementById("sarDatePanel"),imageryAutoBtn:document.getElementById("imageryAutoBtn"),sarAutoBtn:document.getElementById("sarAutoBtn"),imageryPanelAutoBtn:document.getElementById("imageryPanelAutoBtn"),sarPanelAutoBtn:document.getElementById("sarPanelAutoBtn"),imageryResetBtn:document.getElementById("imageryResetBtn"),imageryResetPanelBtn:document.getElementById("imageryResetPanelBtn"),imageryStatus:document.getElementById("imageryStatus"),lidarPointMeta:document.getElementById("lidarPointMeta"),lidarPointProject:document.getElementById("lidarPointProject"),lidarPointEpt:document.getElementById("lidarPointEpt"),lidarPointTelemetry:document.getElementById("lidarPointTelemetry"),lidarPointPerfNote:document.getElementById("lidarPointPerfNote"),lidarPointCustomize:document.getElementById("lidarPointCustomize"),lidarPointCap:document.getElementById("lidarPointCap"),lidarPointRadius:document.getElementById("lidarPointRadius"),lidarPointTilesDesktop:document.getElementById("lidarPointTilesDesktop"),lidarPointTilesMobile:document.getElementById("lidarPointTilesMobile"),lidarPointLimitGrid:document.getElementById("lidarPointLimitGrid"),lidarPointCenter:document.getElementById("lidarPointCenter"),lidarPointRefresh:document.getElementById("lidarPointRefresh"),lidarPointLoad:document.getElementById("lidarPointLoad"),mapDetail:document.getElementById("mapDetail"),mapDetailList:document.getElementById("mapDetailList"),mapDetailMeta:document.getElementById("mapDetailMeta"),mapDetailClose:document.getElementById("mapDetailClose"),flightFocus:document.getElementById("flightFocus"),flightFocusMeta:document.getElementById("flightFocusMeta"),flightFocusBody:document.getElementById("flightFocusBody"),flightFocusTrack:document.getElementById("flightFocusTrack"),flightFocusOpen:document.getElementById("flightFocusOpen"),flightFocusClear:document.getElementById("flightFocusClear"),mapWrap:document.querySelector(".map-wrap"),travelTicker:document.getElementById("travelTicker"),travelTickerTrack:document.getElementById("travelTickerTrack"),travelTickerBtn:document.getElementById("travelTickerBtn"),tickerBar:document.getElementById("tickerBar"),tickerTrack:document.getElementById("tickerTrack"),financeSpotlight:document.getElementById("financeSpotlight"),searchResults:document.getElementById("searchResults"),searchResultsList:document.getElementById("searchResultsList"),searchResultsMeta:document.getElementById("searchResultsMeta"),searchResultsClose:document.getElementById("searchResultsClose"),aboutSources:document.getElementById("aboutSources"),attributionOverlay:document.getElementById("attributionOverlay"),attributionTitle:document.getElementById("attributionTitle"),attributionMeta:document.getElementById("attributionMeta"),attributionBody:document.getElementById("attributionBody"),attributionClose:document.getElementById("attributionClose"),categoryFilters:document.getElementById("categoryFilters"),savedSearches:document.getElementById("savedSearches"),chatLog:document.getElementById("chatLog"),chatInput:document.getElementById("chatInput"),chatSend:document.getElementById("chatSend"),financeMarketsList:document.getElementById("financeMarketsList"),financePolicyList:document.getElementById("financePolicyList"),financeTabs:document.getElementById("financeTabs"),moneyFlowsQuery:document.getElementById("moneyFlowsQuery"),moneyFlowsRange:document.getElementById("moneyFlowsRange"),moneyFlowsRun:document.getElementById("moneyFlowsRun"),moneyFlowsSummary:document.getElementById("moneyFlowsSummary"),moneyFlowsList:document.getElementById("moneyFlowsList"),moneyFlowsMeta:document.getElementById("moneyFlowsMeta"),moneyFlowsRateNotice:document.getElementById("moneyFlowsRateNotice"),moneyInMeta:document.getElementById("moneyInMeta"),moneyInBody:document.getElementById("moneyInBody"),moneyOutMeta:document.getElementById("moneyOutMeta"),moneyOutBody:document.getElementById("moneyOutBody"),moneyLobbyMeta:document.getElementById("moneyLobbyMeta"),moneyLobbyBody:document.getElementById("moneyLobbyBody"),moneyRegistryMeta:document.getElementById("moneyRegistryMeta"),moneyRegistryBody:document.getElementById("moneyRegistryBody"),customFeedToggle:document.getElementById("customFeedToggle"),customFeedExport:document.getElementById("customFeedExport"),customFeedImportToggle:document.getElementById("customFeedImportToggle"),customFeedDownload:document.getElementById("customFeedDownload"),customFeedOpen:document.getElementById("customFeedOpen"),customFeedJsonPanel:document.getElementById("customFeedJsonPanel"),customFeedJson:document.getElementById("customFeedJson"),customFeedJsonCopy:document.getElementById("customFeedJsonCopy"),customFeedJsonApply:document.getElementById("customFeedJsonApply"),customFeedJsonStatus:document.getElementById("customFeedJsonStatus"),customFeedList:document.getElementById("customFeedList"),customFeedForm:document.getElementById("customFeedForm"),customFeedName:document.getElementById("customFeedName"),customFeedUrl:document.getElementById("customFeedUrl"),customFeedCategory:document.getElementById("customFeedCategory"),customFeedFormat:document.getElementById("customFeedFormat"),customFeedProxy:document.getElementById("customFeedProxy"),customFeedTags:document.getElementById("customFeedTags"),customFeedSupportsQuery:document.getElementById("customFeedSupportsQuery"),customFeedDefaultQuery:document.getElementById("customFeedDefaultQuery"),customFeedRequiresKey:document.getElementById("customFeedRequiresKey"),customFeedKeyParam:document.getElementById("customFeedKeyParam"),customFeedKeyHeader:document.getElementById("customFeedKeyHeader"),customFeedTtl:document.getElementById("customFeedTtl"),customFeedSave:document.getElementById("customFeedSave"),customFeedCancel:document.getElementById("customFeedCancel"),customFeedStatus:document.getElementById("customFeedStatus")},as=[{id:"map",cols:12},{id:"ticker",cols:12},{id:"finance-spotlight",cols:12},{id:"imagery",cols:12},{id:"command",cols:12},{id:"signals",cols:6},{id:"news",cols:6},{id:"finance",cols:4},{id:"money-flows",cols:12},{id:"crypto",cols:4},{id:"prediction",cols:4},{id:"mcp-trends",cols:12},{id:"hazards",cols:4},{id:"security",cols:4},{id:"local",cols:6},{id:"community",cols:6},{id:"policy",cols:4},{id:"congress",cols:4},{id:"cyber",cols:4},{id:"agriculture",cols:4},{id:"research",cols:4},{id:"space",cols:4},{id:"energy-map",cols:6},{id:"energy",cols:6},{id:"health",cols:4},{id:"transport",cols:6}],rs=Object.fromEntries(as.map(e=>[e.id,{cols:e.cols}])),nt=null,ss=["the","a","an","and","or","to","in","of","for","on","with","at","from","by","as","is","are","was","were","be","has","have"],os=new Set(ss),is=["b","strong","i","em","u","br","p","span","a","font"],ls=new Set(is),cs=[{id:"openai",url:"https://platform.openai.com/api-keys"}],aa=Object.fromEntries(cs.map(e=>[e.id,e.url])),us=[{id:"api.data.gov",label:"Data.gov (FOIA + GovInfo)"},{id:"eia",label:"EIA (Energy)"}],ra=Object.fromEntries(us.map(e=>[e.id,e.label])),ds=[{id:"hazards",filters:["weather","disaster","space"]},{id:"finance",filters:["finance","gov","cyber","agriculture"]},{id:"map",filters:["weather","disaster","space","news","travel","transport","local"]},{id:"geo",filters:["weather","disaster","space","news","travel","transport","local"]},{id:"local",filters:["news","gov","disaster","weather"]},{id:"assistant",filters:["assistant"]}],ms=Object.fromEntries(ds.map(e=>[e.id,e.filters])),Fa=[{id:"news",label:"News"},{id:"finance",label:"Finance"},{id:"gov",label:"Government"},{id:"crypto",label:"Crypto / Web3"},{id:"prediction",label:"Prediction Markets"},{id:"spill",label:"Oil Spills"},{id:"disaster",label:"Disasters"},{id:"weather",label:"Weather"},{id:"space",label:"Space"},{id:"cyber",label:"Cyber"},{id:"agriculture",label:"Agriculture"},{id:"research",label:"Research"},{id:"energy",label:"Energy"},{id:"health",label:"Health"},{id:"travel",label:"Travel"},{id:"transport",label:"Transport"},{id:"security",label:"Conflict & Security"},{id:"infrastructure",label:"Infrastructure"},{id:"local",label:"Local"}],Ce=Object.fromEntries(Fa.map(e=>[e.id,e.label])),bn=Fa.map(e=>e.id),ps=new Set(["crypto","research","space","travel","health","security"]),gs=8,Pa=[{id:"newsList",title:"News Layer",withCoverage:!0,defaultLimit:30,getItems:()=>Wt(r.clusters)},{id:"securityList",title:"Conflict & Security",defaultLimit:20,getItems:()=>O("security").items},{id:"financeMarketsList",title:"Finance: Markets",defaultLimit:20,getItems:()=>le(["finance","energy"])},{id:"financePolicyList",title:"Finance: Regulatory",defaultLimit:20,getItems:()=>le(["gov","cyber","agriculture"])},{id:"moneyFlowsList",title:"Money Flows",defaultLimit:20,getItems:()=>r.moneyFlowsItems||[]},{id:"cryptoList",title:"Crypto / Web3",defaultLimit:20,getItems:()=>O("crypto").items},{id:"predictionList",title:"Prediction Markets",defaultLimit:20,getItems:()=>Qt()},{id:"disasterList",title:"Hazards & Weather",defaultLimit:20,getItems:()=>le(["disaster","weather","space"])},{id:"localList",title:"Local Lens",defaultLimit:20,getItems:()=>Jt()},{id:"policyList",title:"Policy & Government",defaultLimit:20,getItems:()=>O("gov").items},{id:"congressList",title:"Congressional Insights",defaultLimit:30,getItems:()=>Ve()},{id:"cyberList",title:"Cyber Pulse",defaultLimit:20,getItems:()=>O("cyber").items},{id:"agricultureList",title:"Agriculture",defaultLimit:20,getItems:()=>O("agriculture").items},{id:"researchList",title:"Research Watch",defaultLimit:20,getItems:()=>O("research").items},{id:"spaceList",title:"Space Weather",defaultLimit:20,getItems:()=>O("space").items},{id:"energyList",title:"Energy",defaultLimit:20,getItems:()=>Zt()},{id:"healthList",title:"Health",defaultLimit:20,getItems:()=>O("health").items},{id:"transportList",title:"Transport & Logistics",defaultLimit:20,getItems:()=>O("transport").items}],ys=Object.fromEntries(Pa.filter(e=>typeof e.defaultLimit=="number").map(e=>[e.id,e.defaultLimit])),fs=Pa.map(({defaultLimit:e,...t})=>t),Bl=Object.fromEntries(fs.map(e=>[e.id,e])),hs=new Set(["ticker","signals","crypto","energy-map"]),bs="geo",vs=ea({elements:o,state:r,focusPanelExclude:hs,focusGeoTarget:bs}),sa=ta(Yn()),Ba=[{id:"openstreetmap",name:"OpenStreetMap",short:"Basemap + geocoding",url:"https://www.openstreetmap.org/copyright",attribution:"\xA9 OpenStreetMap contributors. Open Data Commons Open Database License (ODbL).",termsUrl:"https://osmfoundation.org/wiki/Licence/Attribution_Guidelines",notes:"OpenStreetMap data used for basemaps and geocoding."},{id:"esri",name:"Esri Basemaps",short:"Imagery tiles",url:"https://www.esri.com/en-us/arcgis/products/arcgis-online",attribution:"Sources: Esri, DigitalGlobe, GeoEye, i-cubed, USDA FSA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community.",termsUrl:"https://support.esri.com/en-us/knowledge-base/what-is-the-correct-way-to-cite-an-arcgis-online-basema-000012040",notes:"Satellite basemaps and ArcGIS Online services."},{id:"arcgis-online",name:"ArcGIS Online (Esri)",short:"ArcGIS datasets",url:"https://www.arcgis.com",attribution:"\xA9 Esri. Data provided via ArcGIS Online services.",termsUrl:"https://www.esri.com/en-us/legal/terms/full-master-agreement",notes:"ArcGIS-hosted feature layers referenced by the map overlays."},{id:"s2-underground",name:"S2 Underground",short:"Kinetic events",url:"https://nexus-s2underground.hub.arcgis.com/",attribution:"Source: S2 Underground (Common Intelligence Picture). Please credit S2 Underground.",termsUrl:"https://nexus-s2underground.hub.arcgis.com/",notes:"Kinetic Activity Tracker layers sourced from the S2 Underground public ArcGIS Hub."},{id:"nasa-gibs",name:"NASA EOSDIS GIBS",short:"Global imagery",url:"https://earthdata.nasa.gov/eosdis/science-system-description/eosdis-components/gibs",attribution:"We acknowledge the use of imagery provided by services from NASA's Global Imagery Browse Services (GIBS), part of NASA's Earth Science Data and Information System (ESDIS).",termsUrl:"https://earthdata.nasa.gov/eosdis/science-system-description/eosdis-components/gibs",notes:"Global imagery layers (VIIRS/MODIS/Day-Night)."},{id:"nasa-firms",name:"NASA FIRMS",short:"Fire data",url:"https://firms.modaps.eosdis.nasa.gov",attribution:"We acknowledge the use of data and/or imagery from NASA's Land, Atmosphere Near real-time Capability for Earth observations (LANCE) (https://earthdata.nasa.gov/lance), part of NASA's Earth Science Data and Information System (ESDIS).",termsUrl:"https://www.earthdata.nasa.gov/data/projects/lance#ed-firms-citation",notes:"Global fire detections."},{id:"nasa-eonet",name:"NASA EONET",short:"Natural events",url:"https://eonet.gsfc.nasa.gov",attribution:"NASA EONET (Earth Observatory Natural Event Tracker). Source: NASA/GSFC.",termsUrl:"https://eonet.gsfc.nasa.gov/docs/v3",notes:"Natural events and hazards."},{id:"noaa-nws",name:"NOAA/NWS",short:"Alerts + warnings",url:"https://www.weather.gov/documentation/services-web-api",attribution:"Source: National Weather Service (NOAA). Data are public domain; credit NOAA/NWS.",termsUrl:"https://www.weather.gov/documentation/services-web-api",notes:"US weather alerts and short-term warnings."},{id:"noaa-nhc",name:"NOAA NHC",short:"Hurricane outlooks",url:"https://www.nhc.noaa.gov",attribution:"Source: NOAA National Hurricane Center. Data are public domain; credit NOAA/NHC.",termsUrl:"https://www.nhc.noaa.gov",notes:"Atlantic basin outlooks and advisories."},{id:"noaa-swpc",name:"NOAA SWPC",short:"Space weather",url:"https://www.swpc.noaa.gov",attribution:"Source: NOAA Space Weather Prediction Center. Data are public domain; credit NOAA/SWPC.",termsUrl:"https://www.swpc.noaa.gov",notes:"Kp index and solar wind conditions."},{id:"noaa-hms",name:"NOAA HMS",short:"Fire detections",url:"https://hms.smfc.nasa.gov",attribution:"Source: NOAA/NESDIS Hazard Mapping System (HMS).",termsUrl:"https://hms.smfc.nasa.gov",notes:"Satellite fire detection overlays."},{id:"noaa-incidentnews",name:"NOAA IncidentNews",short:"Spill reports",url:"https://incidentnews.noaa.gov",attribution:"Source: NOAA Office of Response and Restoration IncidentNews.",termsUrl:"https://incidentnews.noaa.gov",notes:"Oil spill and incident reports."},{id:"usgs-earthquakes",name:"USGS Earthquakes",short:"Seismic events",url:"https://earthquake.usgs.gov",attribution:"USGS Earthquake Hazards Program. Data courtesy of the U.S. Geological Survey.",termsUrl:"https://www.usgs.gov/information-policies-and-instructions/acknowledging-or-crediting-usgs",notes:"Recent seismic activity feeds."},{id:"cdc-travel",name:"CDC Travel Notices",short:"Travel alerts",url:"https://www.cdc.gov/travel",attribution:"Source: Centers for Disease Control and Prevention (CDC). Data are public domain; credit CDC.",termsUrl:"https://www.cdc.gov/other/policies.html",notes:"Travel health notices."},{id:"state-travel",name:"U.S. State Department Travel Advisories",short:"Travel advisories",url:"https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html",attribution:"Source: U.S. Department of State Travel Advisories.",termsUrl:"https://travel.state.gov/content/travel/en/legal.html",notes:"Travel advisory RSS feed."},{id:"eia",name:"U.S. EIA",short:"Energy data",url:"https://www.eia.gov",attribution:"Source: U.S. Energy Information Administration (EIA). Data are public domain; credit EIA.",termsUrl:"https://www.eia.gov/about/copyrights_reuse.php",notes:"Energy market data and Today in Energy."},{id:"bls",name:"U.S. BLS",short:"Economic data",url:"https://www.bls.gov",attribution:"Source: U.S. Bureau of Labor Statistics (BLS). Data are public domain; credit BLS.",termsUrl:"https://www.bls.gov/bls/linksite.htm",notes:"CPI and macroeconomic releases."},{id:"treasury",name:"U.S. Treasury Fiscal Data",short:"Debt & fiscal",url:"https://fiscaldata.treasury.gov",attribution:"Source: U.S. Department of the Treasury, Fiscal Service. Data are public domain; credit Treasury Fiscal Service.",termsUrl:"https://fiscaldata.treasury.gov/developer/api-documentation/",notes:"Debt to the Penny and fiscal releases."},{id:"usaspending",name:"USAspending.gov",short:"Federal spending",url:"https://www.usaspending.gov",attribution:"Source: USAspending.gov (U.S. Department of the Treasury).",termsUrl:"https://www.usaspending.gov/about",notes:"Award and transaction data from USAspending.gov."},{id:"lda",name:"U.S. Senate LDA",short:"Lobbying disclosure",url:"https://lda.senate.gov",attribution:"Source: U.S. Senate Office of Public Records (Lobbying Disclosure Act).",termsUrl:"https://lda.senate.gov/about/",notes:"LDA filings and contribution reports."},{id:"fec",name:"FEC (OpenFEC)",short:"Campaign contributions",url:"https://api.open.fec.gov",attribution:"Source: Federal Election Commission (OpenFEC API).",termsUrl:"https://api.open.fec.gov/developers/#/about/terms",notes:"Campaign finance data from the FEC."},{id:"sam",name:"SAM.gov",short:"Entity registrations",url:"https://sam.gov",attribution:"Source: SAM.gov (U.S. General Services Administration).",termsUrl:"https://sam.gov/content/home",notes:"Entity registration data from SAM.gov."},{id:"cisa-kev",name:"CISA KEV",short:"Cyber advisories",url:"https://www.cisa.gov/known-exploited-vulnerabilities-catalog",attribution:"Source: Cybersecurity and Infrastructure Security Agency (CISA). Data are public domain; credit CISA.",termsUrl:"https://www.cisa.gov/known-exploited-vulnerabilities-catalog",notes:"Known Exploited Vulnerabilities catalog."},{id:"openaq",name:"OpenAQ",short:"Air quality",url:"https://openaq.org",attribution:"Source: OpenAQ air quality data. Please credit OpenAQ.",termsUrl:"https://openaq.org/terms/",notes:"Air quality alerts and station readings."},{id:"opensky",name:"OpenSky Network",short:"Flight data",url:"https://opensky-network.org",attribution:"The OpenSky Network (https://opensky-network.org). Cite: \u201CBringing up OpenSky: A large-scale ADS-B sensor network for research\u201D (Sch\xE4fer et al., ACM/IEEE IPSN 2014).",termsUrl:"https://opensky-network.org/about/terms-of-use",notes:"Live aviation data and aircraft tracking."},{id:"coinpaprika",name:"CoinPaprika",short:"Crypto markets",url:"https://coinpaprika.com",attribution:"Source: CoinPaprika API data. Please credit CoinPaprika.",termsUrl:"https://coinpaprika.com/terms-of-use/",notes:"Crypto prices and market caps."},{id:"polymarket",name:"Polymarket (Gamma)",short:"Prediction markets",url:"https://polymarket.com",attribution:"Source: Polymarket market data via Gamma API. Please credit Polymarket/Gamma.",termsUrl:"https://docs.polymarket.com",notes:"Prediction market prices and volumes."},{id:"gdelt",name:"GDELT Project",short:"Global news",url:"https://www.gdeltproject.org",attribution:"The GDELT Project (https://www.gdeltproject.org). Any use or redistribution must cite the GDELT Project and link to the website.",termsUrl:"https://www.gdeltproject.org/about.html#termsofuse",notes:"Global news and conflict signals."},{id:"acled",name:"ACLED",short:"Conflict events",url:"https://acleddata.com",attribution:"ACLED (Armed Conflict Location & Event Data). Cite ACLED as the source and include a link to https://acleddata.com.",termsUrl:"https://acleddata.com/attributionpolicy",notes:"Conflict and security event data."},{id:"ucdp",name:"UCDP",short:"Conflict data",url:"https://ucdp.uu.se",attribution:"Uppsala Conflict Data Program (UCDP) Candidate Events Dataset. Please cite the UCDP Georeferenced Event Dataset (GED); datasets are licensed CC BY 4.0.",termsUrl:"https://ucdp.uu.se/downloads/",notes:"Candidate conflict events."},{id:"gpsjam",name:"GPSJAM",short:"GPS jamming",url:"https://gpsjam.org",attribution:"Source: GPSJAM.org. Please credit GPSJAM.org.",termsUrl:"https://gpsjam.org",notes:"GPS jamming risk overlays."},{id:"warspotting",name:"Warspotting",short:"Loss tracking",url:"https://warspotting.net",attribution:"Source: Warspotting.net. Please credit Warspotting.",termsUrl:"https://warspotting.net",notes:"Conflict equipment loss tracking."},{id:"gdacs",name:"GDACS",short:"Disaster alerts",url:"https://www.gdacs.org",attribution:"GDACS (Global Disaster Alert and Coordination System), a cooperation framework between the United Nations and the European Commission.",termsUrl:"https://www.gdacs.org/About",notes:"Global disaster alerts and coordination."},{id:"govinfo",name:"GovInfo",short:"Gov publications",url:"https://www.govinfo.gov",attribution:"Source: U.S. Government Publishing Office (govinfo.gov). Data are public domain; credit GPO.",termsUrl:"https://www.govinfo.gov/help",notes:"Federal publications and documents."},{id:"foia",name:"FOIA.gov",short:"FOIA logs",url:"https://www.foia.gov",attribution:"Source: FOIA.gov (U.S. Department of Justice). Data are public domain; credit DOJ/FOIA.gov.",termsUrl:"https://www.foia.gov/about.html",notes:"FOIA request data."},{id:"federal-register",name:"Federal Register",short:"Regulatory updates",url:"https://www.federalregister.gov",attribution:"Source: Federal Register (Office of the Federal Register, NARA). Public domain; credit Federal Register/NARA.",termsUrl:"https://www.federalregister.gov/reader-aids/using-federalregister-gov",notes:"Regulations, rules, and notices."},{id:"congress-gov",name:"Congress.gov",short:"Legislative data",url:"https://www.congress.gov",attribution:"Source: Congress.gov (Library of Congress). Data are public domain; credit Congress.gov.",termsUrl:"https://www.congress.gov/help/legislative-resources",notes:"Bills, nominations, hearings, treaties, and record."},{id:"fda",name:"FDA MedWatch",short:"Health alerts",url:"https://www.fda.gov/safety/medwatch-fda-safety-information-and-adverse-event-reporting-program",attribution:"Source: U.S. Food and Drug Administration (FDA). Data are public domain; credit FDA.",termsUrl:"https://www.fda.gov/about-fda/website-policies",notes:"MedWatch safety alerts and recalls."},{id:"usda-nass",name:"USDA NASS",short:"Ag reports",url:"https://www.nass.usda.gov",attribution:"USDA-NASS data are in the public domain; USDA-NASS requests appropriate acknowledgment.",termsUrl:"https://www.nass.usda.gov/Data_and_Statistics/Citation_Request/index.php",notes:"Agricultural reports and price summaries."},{id:"stooq",name:"Stooq",short:"Market data",url:"https://stooq.com",attribution:"Stooq market data.",termsUrl:"https://stooq.com/terms.html",notes:"Equities and index snapshots."},{id:"google-news",name:"Google News",short:"News headlines",url:"https://news.google.com",attribution:"Google News. \xA9 Google.",termsUrl:"https://policies.google.com/terms",notes:"News aggregation results."},{id:"bbc",name:"BBC News",short:"RSS source",url:"https://www.bbc.com/news",attribution:"\xA9 BBC News.",termsUrl:"https://www.bbc.co.uk/usingthebbc/terms/",notes:"Headlines via RSS."},{id:"guardian",name:"The Guardian",short:"RSS source",url:"https://www.theguardian.com/world",attribution:"\xA9 The Guardian.",termsUrl:"https://www.theguardian.com/help/terms-of-service",notes:"Headlines via RSS."},{id:"pbs",name:"PBS NewsHour",short:"RSS source",url:"https://www.pbs.org/newshour",attribution:"\xA9 PBS NewsHour.",termsUrl:"https://www.pbs.org/about/policies/",notes:"Headlines via RSS."},{id:"dw",name:"Deutsche Welle (DW)",short:"RSS source",url:"https://www.dw.com",attribution:"\xA9 Deutsche Welle (DW).",termsUrl:"https://www.dw.com/en/legal-information/a-18265275",notes:"Headlines via RSS."},{id:"arxiv",name:"arXiv",short:"Research preprints",url:"https://arxiv.org",attribution:"arXiv.org e-print archive.",termsUrl:"https://arxiv.org/help/license",notes:"Research preprints and metadata."},{id:"blockstream",name:"mempool.space",short:"Bitcoin mempool",url:"https://mempool.space",attribution:"Source: mempool.space (Blockstream). Please credit mempool.space.",termsUrl:"https://mempool.space/docs/api",notes:"Bitcoin mempool and fee data."}],R={"gibs-viirs":{id:"VIIRS_SNPP_CorrectedReflectance_TrueColor",label:"NASA VIIRS True Color",format:"jpg",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9"},"gibs-modis-terra":{id:"MODIS_Terra_CorrectedReflectance_TrueColor",label:"MODIS Terra True Color",format:"jpg",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9"},"gibs-modis-aqua":{id:"MODIS_Aqua_CorrectedReflectance_TrueColor",label:"MODIS Aqua True Color",format:"jpg",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9"},"gibs-nightlights":{id:"VIIRS_Black_Marble",label:"VIIRS Black Marble",format:"png",maxZoom:8,matrixSet:"GoogleMapsCompatible_Level8",defaultDate:"2016-01-01"},"gibs-daynight":{id:"VIIRS_SNPP_DayNightBand_At_Sensor_Radiance",label:"VIIRS Day/Night Band",format:"png",maxZoom:8,matrixSet:"GoogleMapsCompatible_Level8"}},U={aerosol:{id:"OMPS_Aerosol_Index",label:"Aerosol Index",format:"png",maxZoom:6,matrixSet:"GoogleMapsCompatible_Level6",opacity:.45},thermal:{id:"VIIRS_NOAA20_Brightness_Temp_BandI5_Night",label:"Thermal Brightness (VIIRS)",format:"png",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9",opacity:.45},"fire-east":{id:"GOES-East_ABI_FireTemp",label:"GOES East Fire Temp",format:"png",maxZoom:7,matrixSet:"GoogleMapsCompatible_Level7",opacity:.45},"fire-west":{id:"GOES-West_ABI_FireTemp",label:"GOES West Fire Temp",format:"png",maxZoom:7,matrixSet:"GoogleMapsCompatible_Level7",opacity:.45}},Ss="https://raw.githubusercontent.com/hobuinc/usgs-lidar/master/boundaries/boundaries.topojson",oa="lidarCoverageCache",ws="https://raw.githubusercontent.com/visgl/loaders.gl/master/modules/las/test/data/indoor.laz",Cs=45e3,Da="lidarPointTelemetry",Ls=[{min:8,label:"Great"},{min:7,label:"Major"},{min:6,label:"Strong"},{min:5,label:"Moderate"},{min:4,label:"Light"},{min:3,label:"Minor"},{min:0,label:"Micro"}],vn=["google-news-us","bbc-world","guardian-world","pbs-headlines","usgs-quakes-hour","nws-alerts","eonet-events","cdc-travel-notices","coinpaprika-global","coinpaprika-tickers","treasury-debt","bls-cpi","energy-eia","energy-eia-brent","energy-eia-ng","eia-today"],ks=new Set(["llc","inc","corp","news","update","report","alert","press","group"]);function xn(e){return e.filter(t=>!t?.feed?.id||!vn.includes(t.feed.id)||t.error==="requires_key"||t.error==="requires_config"||t.error==="missing_server_key"?!1:t.error||t.stale||t.httpStatus&&t.httpStatus>=400).length}function Et(e,t){if(!t?.fetchedAt)return!1;let n=Number(e?.ttlMinutes)||r.settings.refreshMinutes,a=Math.max(5,Math.min(15,Math.round(n*.2))),s=(n+a)*60*1e3;return Date.now()-t.fetchedAt>s}var Es=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),ia="situationRoomCountryIndex",As="https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";function $a(e,t){if(e){if(typeof e[0]=="number"&&typeof e[1]=="number"){t(e);return}e.forEach(n=>$a(n,t))}}function Ts(e){let t={minLat:90,maxLat:-90,minLon:180,maxLon:-180};return $a(e?.coordinates||[],n=>{let[a,s]=n;Number.isNaN(s)||Number.isNaN(a)||(t.minLat=Math.min(t.minLat,s),t.maxLat=Math.max(t.maxLat,s),t.minLon=Math.min(t.minLon,a),t.maxLon=Math.max(t.maxLon,a))}),t.minLat===90||t.maxLat===-90?null:t}function sn(e){let t={};return e.forEach(n=>{n.code&&(t[n.code.toUpperCase()]=n)}),t}async function Is(){if(r.countries.length)return r.countries;try{let e=localStorage.getItem(ia);if(e){let t=JSON.parse(e);if(Array.isArray(t?.list)&&t.list.length)return r.countries=t.list,r.countryIndex=sn(t.list),r.countries}}catch{}try{let e=await fetch(As,{cache:"force-cache"});if(!e.ok)throw new Error("Country source fetch failed");let n=((await e.json()).features||[]).map(a=>{let s=a.properties||{},i=s["ISO3166-1-Alpha-2"],l=s.name;if(!i||!l)return null;let c=Ts(a.geometry);return c?{code:i.toUpperCase(),name:l,bbox:c}:null}).filter(Boolean);n.sort((a,s)=>a.name.localeCompare(s.name)),r.countries=n,r.countryIndex=sn(n);try{localStorage.setItem(ia,JSON.stringify({list:n}))}catch{}return n}catch{let t=[{code:"US",name:"United States",bbox:{minLat:24,maxLat:49,minLon:-125,maxLon:-66}}];return r.countries=t,r.countryIndex=sn(t),t}}function je(){let e=(r.settings.country||"US").toUpperCase(),t={code:"US",name:"United States",bbox:{minLat:24,maxLat:49,minLon:-125,maxLon:-66}};return r.countryIndex?.[e]||(e==="US"?t:null)}function Fe(e){return(e||"").toString().toLowerCase()}function Ms(e,t){if(!Array.isArray(e))return[];if(!Number.isFinite(t)||t<=0)return[];if(e.length<=t)return e;let n=Math.max(1,Math.floor(e.length/t)),a=[];for(let s=0;s<e.length&&(a.push(e[s]),!(a.length>=t));s+=n);return a}function Oa(e,t){if(!t)return!1;let n=t.code.toUpperCase();if(n==="US")return e.tags?.includes("us")?!0:e.geo?At(e.geo.lat,e.geo.lon,t):!1;let a=Fe(e.regionTag),s=Fe(e.location||e.geoLabel||""),i=Fe(e.title||""),l=Fe(e.summary||""),c=Fe(t.name),p=n.toLowerCase();return!!(e.tags?.some(m=>Fe(m)===p)||a&&(a===p||a.includes(c))||s&&s.includes(c)||i.includes(c)||l.includes(c)||e.geo&&At(e.geo.lat,e.geo.lon,t))}function At(e,t,n){if(!n?.bbox)return!1;let{minLat:a,maxLat:s,minLon:i,maxLon:l}=n.bbox;return e>=a&&e<=s&&t>=i&&t<=l}function xs(e,t){return!Number.isFinite(e)||!Number.isFinite(t)?null:(r.countries||[]).find(a=>At(e,t,a))||null}function Ns(){if(!r.settings.countryAuto)return;let e=xs(r.location.lat,r.location.lon);e&&(e.code!==r.settings.country&&(r.settings.country=e.code,D()),at())}async function Fs(){if(!o.countrySelect)return;let e=await Is();o.countrySelect.innerHTML="",e.forEach(t=>{let n=document.createElement("option");n.value=t.code,n.textContent=t.name,o.countrySelect.appendChild(n)}),at(),o.countrySelect.addEventListener("change",()=>{let t=o.countrySelect.value||"US";r.settings.scope="us",r.settings.country=t.toUpperCase(),r.settings.countryAuto=!1,D(),Pn(),at(),r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(n=>n.category==="news")),ye(),ie(),it(),ut(),H()})}function at(){let e=(r.settings.country||"US").toUpperCase(),t=je();o.countrySelect&&o.countrySelect.value!==e&&(o.countrySelect.value=e),o.countrySelect&&(o.countrySelect.disabled=!1);let n=o.scopeToggle?.querySelector('[data-scope="us"]');n&&(n.textContent=e,n.title=t?.name||"Country"),o.countrySelectLabel&&(o.countrySelectLabel.textContent=t?.name||"Country")}function Ps(){let e=nn(),t=r.feeds.find(n=>n.id==="transport-opensky");if(t){if(e){let n=e.endsWith("/")?e.slice(0,-1):e;t.url=`${n}/states?extended=1`,t.proxy=null,t.requiresKey=!1,t.keySource=null,t.keyGroup=null,t.keyParam=null,t.keyHeader=null}else if(t.url&&!t.url.includes("extended=1")){let n=new URL(t.url);n.searchParams.set("extended","1"),t.url=n.toString()}}}function Bs(){let e=an(),t=r.feeds.filter(n=>n.id==="acled-events"||n.acledMode);t.length&&t.forEach(n=>{if(!e)return;let a=e.endsWith("/")?e.slice(0,-1):e,s=n.acledMode==="aggregated"?"aggregated":"events";n.url=`${a}/${s}`,n.proxy=null,n.requiresKey=!1,n.keySource=null,n.keyParam=null,n.keyHeader=null,n.requiresConfig=!1})}function Ds(){let e=localStorage.getItem("situationRoomSettings");if(e)try{let t=JSON.parse(e);r.settings=na(t);try{let n=localStorage.getItem(Da);n&&(r.lidarPointTelemetry=JSON.parse(n))}catch(n){console.warn("LiDAR telemetry read failed",n)}}catch{r.settings=na()}}function D(){localStorage.setItem("situationRoomSettings",JSON.stringify(r.settings))}function $s(){let e=localStorage.getItem("situationRoomKeys");if(e)try{r.keys=JSON.parse(e),r.keys?.openai?.key&&(r.keys.openai.key=r.keys.openai.key.trim())}catch{r.keys={}}}function on(){localStorage.setItem("situationRoomKeys",JSON.stringify(r.keys))}function Os(){let e=localStorage.getItem("situationRoomKeyGroups");if(e)try{r.keyGroups=JSON.parse(e)}catch{r.keyGroups={}}}function Rs(){localStorage.setItem("situationRoomKeyGroups",JSON.stringify(r.keyGroups))}function _s(){let e=localStorage.getItem("situationRoomKeyStatus");if(e)try{r.keyStatus=JSON.parse(e)}catch{r.keyStatus={}}}function Sn(){localStorage.setItem("situationRoomKeyStatus",JSON.stringify(r.keyStatus))}function Us(){let e=localStorage.getItem("situationRoomGeoCache");if(e)try{r.geoCache=JSON.parse(e)}catch{r.geoCache={}}}function ln(){localStorage.setItem("situationRoomGeoCache",JSON.stringify(r.geoCache))}function Hs(){let e=localStorage.getItem(xa);if(!e)return[];try{let t=JSON.parse(e);return Array.isArray(t)?t.map(n=>({...n,tags:Array.isArray(n.tags)?n.tags:[],supportsQuery:!!n.supportsQuery,requiresKey:!!n.requiresKey,format:n.format||"rss",category:n.category||"news",ttlMinutes:Number(n.ttlMinutes||60),isCustom:!0,keySource:"client"})):[]}catch{return[]}}function Ht(){localStorage.setItem(xa,JSON.stringify(r.customFeeds))}function Nn(e){let t=0,n=String(e||"");for(let a=0;a<n.length;a+=1)t=(t<<5)-t+n.charCodeAt(a),t|=0;return Math.abs(t).toString(36)}function qt(e,t){let n=[...e],a=new Set(e.map(i=>i.id)),s=!1;return t.forEach(i=>{let l=i.id;if(l||(l=`custom-${Nn(i.url||i.name)}`,i.id=l,s=!0),a.has(l)){let c=`${l}-${Math.random().toString(36).slice(2,6)}`;i.id=c,l=c,s=!0}i.isCustom=!0,i.keySource="client",a.add(l),n.push(i)}),s&&Ht(),n}async function Ra(){if(!$())return null;try{let e=be(`/data/analysis.json?ts=${Date.now()}`),t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error("analysis_fetch_failed");let n=await t.json();return!n||!n.text?(r.staticAnalysis=null,null):(r.staticAnalysis=n,n)}catch{return r.staticAnalysis=null,null}}async function qs(){if(!$())return null;try{let e=be(`/data/build.json?ts=${Date.now()}`),t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error("build_fetch_failed");let n=await t.json();return n?.generatedAt&&(r.lastBuildAt=Date.parse(n.generatedAt)),n}catch{return null}}function Gs(){if(!o.dataFresh)return;let e=r.lastFetch;if($()&&(e=r.settings.superMonitor?r.lastFetch:r.lastBuildAt||r.lastFetch),!e){o.dataFresh.textContent="Data fresh",o.dataFresh.removeAttribute("title");return}let t=V(e);o.dataFresh.textContent=$()?r.settings.superMonitor?`Live ${t}`:`Cache ${t}`:`Data ${t}`;let n=new Date(e).toLocaleString();o.dataFresh.title=$()?r.settings.superMonitor?`Live fetch ${n}`:`Cache built ${n}`:`Last fetch ${n}`}function js(){let e=localStorage.getItem("situationRoomPanels");if(e){let t=JSON.parse(e);t.version===Ma?(r.panels.order=Array.isArray(t.order)?t.order:[],r.panels.visibility=t.visibility&&typeof t.visibility=="object"?t.visibility:{},r.panels.sizes=t.sizes&&typeof t.sizes=="object"?t.sizes:{}):(r.panels.order=[],r.panels.visibility={},r.panels.sizes={})}}function dt(){localStorage.setItem("situationRoomPanels",JSON.stringify({order:r.panels.order,visibility:r.panels.visibility,sizes:r.panels.sizes,version:Ma}))}function xe(){return[...document.querySelectorAll(".panel[data-panel]")].map(e=>({id:e.dataset.panel,title:e.querySelector(".panel-title")?.textContent||e.dataset.panel,element:e}))}function Fn(){xe().forEach(e=>{let t=r.panels.visibility[e.id]!==!1;e.element.classList.toggle("panel-hidden",!t)})}function _a(){if(!r.panels.order.length)return;let e=xe(),t=new Map(e.map(n=>[n.id,n.element]));r.panels.order.forEach(n=>{let a=t.get(n);a&&o.panelGrid.appendChild(a)}),e.forEach(n=>{r.panels.order.includes(n.id)||o.panelGrid.appendChild(n.element)})}function Ua(){xe().forEach(e=>{let t=r.panels.sizes[e.id]||rs[e.id];if(!t){e.element.style.gridColumnEnd="",e.element.style.height="";return}t.cols?e.element.style.gridColumnEnd=`span ${t.cols}`:e.element.style.gridColumnEnd="",t.height?e.element.style.height=`${t.height}px`:r.panels.sizes[e.id]?.height||(e.element.style.height="")})}function Ha(){let e=xe();o.panelToggles.innerHTML="",e.forEach(t=>{let n=document.createElement("div");n.className="panel-toggle";let a=document.createElement("label"),s=`panel-toggle-${String(t.id).replace(/[^a-zA-Z0-9_-]/g,"-")}`;a.className="panel-toggle-label",a.setAttribute("for",s),a.textContent=t.title;let i=document.createElement("input");i.type="checkbox",i.id=s,i.name=s,i.checked=r.panels.visibility[t.id]!==!1,i.addEventListener("change",()=>{r.panels.visibility[t.id]=i.checked,dt(),Fn()}),n.appendChild(a),n.appendChild(i),o.panelToggles.appendChild(n)})}function zs(){r.panels.order=[...document.querySelectorAll(".panel[data-panel]")].map(e=>e.dataset.panel),dt()}function Ks(){let e=null;xe().forEach(t=>{t.element.setAttribute("draggable","true"),t.element.addEventListener("dragstart",n=>{e=t.id,t.element.classList.add("dragging"),n.dataTransfer.effectAllowed="move"}),t.element.addEventListener("dragend",()=>{t.element.classList.remove("dragging"),document.querySelectorAll(".panel.drag-over").forEach(n=>n.classList.remove("drag-over"))}),t.element.addEventListener("dragover",n=>{n.preventDefault(),t.element.classList.add("drag-over")}),t.element.addEventListener("dragleave",()=>{t.element.classList.remove("drag-over")}),t.element.addEventListener("drop",n=>{n.preventDefault(),t.element.classList.remove("drag-over");let a=document.querySelector(`.panel[data-panel="${e}"]`);if(!a||a===t.element)return;let s=t.element.getBoundingClientRect(),i=n.clientY<s.top+s.height/2;o.panelGrid.insertBefore(a,i?t.element:t.element.nextSibling),zs()})})}function Ws(){let e=o.panelGrid;if(!e)return;let t=window.getComputedStyle(e),n=parseFloat(t.columnGap||t.gap||"0"),a=(l,c,p)=>Math.min(Math.max(l,c),p),s=()=>(e.getBoundingClientRect().width-n*11)/12,i=(l,c,p)=>{p.preventDefault(),p.stopPropagation();let m=l.element.getBoundingClientRect(),y=m.width,d=m.height,g=p.clientX,f=p.clientY,k=(window.getComputedStyle(l.element).gridColumnEnd||"span 12").match(/span\s+(\d+)/),C=k?Number(k[1]):Math.round(y/(s()+n)),S=l.element.getAttribute("draggable");l.element.setAttribute("draggable","false");let A=w=>{let I=w.clientX-g,u=w.clientY-f;if(c!=="y"){let v=s(),E=y+I,T=a(Math.round((E+n)/(v+n)),2,12);l.element.style.gridColumnEnd=`span ${T}`,r.panels.sizes[l.id]={...r.panels.sizes[l.id],cols:T,height:r.panels.sizes[l.id]?.height||Math.round(d)}}if(c!=="x"){let v=Math.max(180,d+u);l.element.style.height=`${v}px`,r.panels.sizes[l.id]={...r.panels.sizes[l.id],cols:r.panels.sizes[l.id]?.cols||C,height:Math.round(v)}}dt()},M=()=>{S!==null?l.element.setAttribute("draggable",S):l.element.removeAttribute("draggable"),window.removeEventListener("mousemove",A),window.removeEventListener("mouseup",M),r.map&&setTimeout(()=>r.map.invalidateSize(),120),r.energyMap&&setTimeout(()=>r.energyMap.invalidateSize(),120)};window.addEventListener("mousemove",A),window.addEventListener("mouseup",M)};xe().forEach(l=>{if(l.element.querySelector(".panel-resize-handle"))return;let c=document.createElement("div");c.className="panel-resize-handle",l.element.appendChild(c),c.addEventListener("mousedown",y=>i(l,"both",y));let p=document.createElement("div");p.className="panel-resize-handle-x",l.element.appendChild(p),p.addEventListener("mousedown",y=>i(l,"x",y));let m=document.createElement("div");m.className="panel-resize-handle-y",l.element.appendChild(m),m.addEventListener("mousedown",y=>i(l,"y",y))})}function Js(){r.panels.order=[...r.panels.defaultOrder],r.panels.visibility={},r.panels.sizes={},dt(),_a(),Fn(),Ua(),Ha()}function wn(e){r.settings.theme=e;let t=e==="system"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;o.app.dataset.theme=t,document.documentElement.dataset.theme=t,document.body.dataset.theme=t,document.querySelectorAll(".modal-overlay").forEach(n=>{n.dataset.theme=t}),Bt()}function Zs(){[...o.themeToggle.querySelectorAll(".seg")].forEach(e=>{e.classList.toggle("active",e.dataset.theme===r.settings.theme)})}function Vs(){o.ageToggle&&[...o.ageToggle.querySelectorAll(".seg")].forEach(e=>{let t=Number(e.dataset.age);e.classList.toggle("active",t===r.settings.maxAgeDays)})}function Qs(){o.languageToggle&&[...o.languageToggle.querySelectorAll(".seg")].forEach(e=>{e.classList.toggle("active",e.dataset.language===r.settings.languageMode)})}function Pn(){[...o.scopeToggle.querySelectorAll(".seg")].forEach(e=>{e.classList.toggle("active",e.dataset.scope===r.settings.scope)}),at()}function j(){o.refreshValue.textContent=`${r.settings.refreshMinutes} min`,o.refreshRange.value=r.settings.refreshMinutes,o.refreshRangeValue.textContent=r.settings.refreshMinutes,o.maxAgeRange&&(o.maxAgeRange.value=r.settings.maxAgeDays,o.maxAgeValue.textContent=`${r.settings.maxAgeDays} days`),o.radiusRange.value=r.settings.radiusKm,o.radiusRangeValue.textContent=r.settings.radiusKm,o.geoValue.textContent=r.location.source==="geo"?"Geolocated":"Fallback (Asheville)",o.aiTranslateToggle&&(o.aiTranslateToggle.checked=r.settings.aiTranslate),o.superMonitorToggle&&(o.superMonitorToggle.checked=r.settings.superMonitor),o.statusCompact&&o.statusCompact.classList.toggle("collapsed",!r.settings.showStatus),o.statusToggle&&(o.statusToggle.textContent=r.settings.showStatus?"Hide":"Show"),o.keySection&&o.keySection.classList.toggle("collapsed",!r.settings.showKeys),o.keyToggle&&(o.keyToggle.textContent=r.settings.showKeys?"Hide":"Show"),o.mcpSection&&o.mcpSection.classList.toggle("collapsed",!r.settings.showMcp),o.mcpToggle&&(o.mcpToggle.textContent=r.settings.showMcp?"Hide":"Show"),o.travelTickerBtn&&(o.travelTickerBtn.classList.toggle("active",r.settings.showTravelTicker),o.travelTickerBtn.textContent=r.settings.showTravelTicker?"Travel Ticker":"Travel Ticker Off"),o.travelTicker&&o.travelTicker.classList.toggle("hidden",!r.settings.showTravelTicker),Zs(),Pn(),Vs(),Qs(),Ue(),ze(),at(),o.liveSearchToggle&&(o.liveSearchToggle.classList.toggle("active",r.settings.liveSearch),o.liveSearchToggle.textContent=r.settings.liveSearch?"Live Search On":"Live Search Off"),Tt()}function Ys(){return r.settings.aiTranslate?ue()?"AI query translation is on. Search adapts to each source.":"AI translation is on, but AI is offline. Using default feed queries.":"AI query translation is off. Searches use the exact text you enter."}function Tt(){o.searchHint&&(r.searching||o.searchResults?.classList.contains("open")||(o.searchHint.textContent=Ys()))}function ft(e){o.settingsPanel.classList.toggle("open",e),o.settingsScrim&&o.settingsScrim.classList.toggle("open",e),o.settingsPanel.setAttribute("aria-hidden",e?"false":"true"),o.settingsPanel.inert=!e}function Ie(e){o.aboutOverlay&&(o.aboutOverlay.classList.toggle("open",e),o.aboutOverlay.setAttribute("aria-hidden",e?"false":"true"),o.aboutOverlay.inert=!e)}function St(e){o.attributionOverlay&&(o.attributionOverlay.classList.toggle("open",e),o.attributionOverlay.setAttribute("aria-hidden",e?"false":"true"),o.attributionOverlay.inert=!e)}function Xs(){o.aboutSources&&(o.aboutSources.innerHTML="",Ba.forEach(e=>{let t=document.createElement("button");t.type="button",t.className="about-source",t.dataset.attributionId=e.id,t.setAttribute("role","listitem"),t.title=`${e.name}${e.short?` \u2014 ${e.short}`:""}`;let n=document.createElement("div");n.textContent=e.name;let a=document.createElement("span");a.className="about-source-meta",a.textContent=e.short||"Details",t.appendChild(n),t.appendChild(a),t.addEventListener("click",()=>eo(e.id)),o.aboutSources.appendChild(t)}))}function eo(e){let t=Ba.find(a=>a.id===e);if(!t||!o.attributionBody)return;if(o.attributionTitle&&(o.attributionTitle.textContent=t.name),o.attributionMeta&&(o.attributionMeta.textContent=t.short||"Attribution requirements"),o.attributionBody.innerHTML="",t.notes){let a=document.createElement("div");a.className="detail-summary";let s=document.createElement("p");s.textContent=t.notes,a.appendChild(s),o.attributionBody.appendChild(a)}let n=[{label:"Attribution",value:t.attribution},{label:"Source",value:t.url}];t.termsUrl&&n.push({label:"Terms",value:t.termsUrl}),n.forEach(a=>{if(!a.value)return;let s=document.createElement("div");s.className="detail-row";let i=document.createElement("div");i.className="detail-label",i.textContent=a.label;let l=document.createElement("div");if(l.className="detail-value",typeof a.value=="string"&&a.value.startsWith("http")){let c=document.createElement("a");c.href=a.value,c.target="_blank",c.rel="noopener noreferrer",c.textContent=a.value,l.appendChild(c)}else l.textContent=a.value;s.appendChild(i),s.appendChild(l),o.attributionBody.appendChild(s)}),St(!0)}function qa(e){o.listOverlay&&(o.listOverlay.classList.toggle("open",e),o.listOverlay.setAttribute("aria-hidden",e?"false":"true"),o.listOverlay.inert=!e,!e&&o.listModalList&&(o.listModalList.innerHTML="",o.listModalList.dataset.listContext=""))}function Ga(e){o.detailOverlay&&(o.detailOverlay.classList.toggle("open",e),o.detailOverlay.setAttribute("aria-hidden",e?"false":"true"),o.detailOverlay.inert=!e,!e&&o.detailBody&&(o.detailBody.innerHTML=""))}function to(e){if(!(!o.detailOverlay||!e)){if(o.detailTitle&&(o.detailTitle.textContent=e.detailTitle||e.title||"Details"),o.detailMeta){let t=[e.source||e.feedName||"",V(e.publishedAt||Date.now())].filter(Boolean);o.detailMeta.textContent=t.join(" \u2022 ")}if(o.detailBody){o.detailBody.innerHTML="";let t=e.summaryHtml?Ln(e.summaryHtml):e.translatedSummary||e.summary||"";if(t){let a=document.createElement("div");if(a.className="detail-summary",e.summaryHtml)a.innerHTML=Ln(e.summaryHtml);else{let s=document.createElement("p");s.textContent=t,a.appendChild(s)}o.detailBody.appendChild(a)}if(Array.isArray(e.detailFields)&&e.detailFields.filter(a=>a&&a.label&&a.value).forEach(a=>{let s=document.createElement("div");s.className="detail-row";let i=document.createElement("div");i.className="detail-label",i.textContent=a.label;let l=document.createElement("div");l.className="detail-value",l.textContent=a.value,s.appendChild(i),s.appendChild(l),o.detailBody.appendChild(s)}),Array.isArray(e.amendments)&&e.amendments.length){let a=document.createElement("div");a.className="detail-section";let s=document.createElement("div");s.className="detail-section-title",s.textContent="Amendments",a.appendChild(s);let i=document.createElement("div");i.className="detail-list",[...e.amendments].sort((c,p)=>(c.publishedAt||0)-(p.publishedAt||0)).forEach(c=>{let p=document.createElement("div");p.className="detail-item";let m=document.createElement("div");if(m.className="detail-item-title",c.externalUrl){let g=document.createElement("a");g.href=c.externalUrl,g.target="_blank",g.rel="noopener noreferrer",g.textContent=c.title||"Amendment",m.appendChild(g)}else m.textContent=c.title||"Amendment";p.appendChild(m);let y=document.createElement("div");y.className="detail-item-meta";let d=[c.type&&c.number?`${c.type} ${c.number}`:"",c.chamber,c.publishedAt?re(c.publishedAt):""].filter(Boolean);if(y.textContent=d.join(" \u2022 "),p.appendChild(y),c.summary){let g=document.createElement("div");g.className="detail-item-summary",g.textContent=c.summary,p.appendChild(g)}if(c.purpose){let g=document.createElement("div");g.className="detail-item-summary",g.textContent=c.purpose,p.appendChild(g)}i.appendChild(p)}),a.appendChild(i),o.detailBody.appendChild(a)}if(Array.isArray(e.nominationActions)&&e.nominationActions.length){let a=document.createElement("div");a.className="detail-section";let s=document.createElement("div");s.className="detail-section-title",s.textContent="Nomination Actions",a.appendChild(s);let i=document.createElement("div");i.className="detail-list",[...e.nominationActions].sort((c,p)=>(p.publishedAt||0)-(c.publishedAt||0)).forEach(c=>{let p=document.createElement("div");p.className="detail-item";let m=document.createElement("div");if(m.className="detail-item-title",c.externalUrl){let d=document.createElement("a");d.href=c.externalUrl,d.target="_blank",d.rel="noopener noreferrer",d.textContent=c.title||"Action",m.appendChild(d)}else m.textContent=c.title||"Action";p.appendChild(m);let y=document.createElement("div");y.className="detail-item-meta",y.textContent=c.publishedAt?re(c.publishedAt):"",p.appendChild(y),i.appendChild(p)}),a.appendChild(i),o.detailBody.appendChild(a)}let n=e.externalUrl||e.fallbackUrl;if(n){let a=document.createElement("div");a.className="detail-actions";let s=document.createElement("a");s.className="btn primary",s.href=n,s.target="_blank",s.rel="noopener noreferrer",s.textContent=e.detailLinkLabel||(e.source?`Open on ${e.source}`:"Open record"),a.appendChild(s),o.detailBody.appendChild(a)}}Ga(!0)}}function la(){Ga(!1)}function De(e){o.app&&(o.app.classList.toggle("nav-open",e),o.navToggle&&o.navToggle.setAttribute("aria-expanded",e?"true":"false"))}function rt(e){r.health=e,o.healthValue.textContent=e,o.statusText&&(o.statusText.textContent=e==="Healthy"?"Live":e)}function ca(e){o.refreshNow&&(r.refreshing=e,o.refreshNow.disabled=e,o.refreshNow.textContent=e?"Refreshing...":"Refresh Now",o.mapEmpty&&(o.mapEmpty.textContent=e?"Fetching geo signals\u2026":"No geo signals yet."))}function Gt(){o.feedScope.innerHTML="";let e=document.createElement("option");e.value="all",e.textContent="All Sources",o.feedScope.appendChild(e);let t=Array.from(new Set(r.feeds.map(s=>s.category).filter(Boolean))),n=[...bn.filter(s=>t.includes(s)),...t.filter(s=>!bn.includes(s))];o.categoryFilters&&(o.categoryFilters.innerHTML="",n.forEach(s=>{let i=document.createElement("button");i.className="chip chip-toggle",i.type="button",i.dataset.category=s,i.textContent=Ce[s]||s,i.addEventListener("click",()=>{r.searchCategories.includes(s)?r.searchCategories=r.searchCategories.filter(c=>c!==s):r.searchCategories=[...r.searchCategories,s],It()}),o.categoryFilters.appendChild(i)}));let a=document.createElement("optgroup");a.label="Categories",n.forEach(s=>{let i=document.createElement("option");i.value=`cat:${s}`,i.textContent=`All ${Ce[s]||s}`,a.appendChild(i)}),o.feedScope.appendChild(a),n.forEach(s=>{let i=document.createElement("optgroup");i.label=`${Ce[s]||s} Feeds`,r.feeds.filter(l=>l.category===s).forEach(l=>{let c=document.createElement("option");c.value=l.id,c.textContent=l.name,i.appendChild(c)}),o.feedScope.appendChild(i)}),It()}function It(){if(!o.categoryFilters)return;let e=new Set(r.searchCategories);[...o.categoryFilters.querySelectorAll(".chip-toggle")].forEach(t=>{t.classList.toggle("active",e.has(t.dataset.category))}),e.size&&(o.feedScope.value="all")}function no(){o.customFeedCategory&&(o.customFeedCategory.innerHTML="",bn.forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=Ce[e]||e,o.customFeedCategory.appendChild(t)}))}function wt(e){o.customFeedForm&&(o.customFeedForm.classList.toggle("hidden",!e),o.customFeedForm.setAttribute("aria-hidden",e?"false":"true"),e||(nt=null))}function ja(e){o.customFeedJsonPanel&&(o.customFeedJsonPanel.classList.toggle("hidden",!e),o.customFeedJsonPanel.setAttribute("aria-hidden",e?"false":"true"))}function ao(e){if(!e||typeof e!="object")return null;let t=String(e.name||"").trim(),n=String(e.url||"").trim();if(!t||!n||!/^https?:\/\//i.test(n))return null;let a=e.category||"news",s=e.format||"rss",i=e.proxy||"",l=Array.isArray(e.tags)?e.tags.filter(Boolean):[],c=!!e.supportsQuery,p=c?String(e.defaultQuery||""):"",m=!!e.requiresKey,y=m?String(e.keyParam||"api_key"):void 0,d=m?String(e.keyHeader||""):void 0,g=Number.isFinite(Number(e.ttlMinutes))?Number(e.ttlMinutes):60;return{id:e.id||Nn(`${t}:${n}`),name:t,url:n,category:a,format:s,proxy:i||void 0,tags:l,supportsQuery:c,defaultQuery:p,requiresKey:m,keyParam:y,keyHeader:d,ttlMinutes:g,isCustom:!0,keySource:"client"}}function ro(){if(!o.customFeedJson)return;let e=r.customFeeds.map(t=>({id:t.id,name:t.name,url:t.url,category:t.category,format:t.format,proxy:t.proxy,tags:t.tags,supportsQuery:t.supportsQuery,defaultQuery:t.defaultQuery,requiresKey:t.requiresKey,keyParam:t.keyParam,keyHeader:t.keyHeader,ttlMinutes:t.ttlMinutes}));o.customFeedJson.value=JSON.stringify(e,null,2),ja(!0),o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent=e.length?"Exported feeds to JSON.":"No custom feeds to export.")}function so(){let e=r.customFeeds.map(t=>({id:t.id,name:t.name,url:t.url,category:t.category,format:t.format,proxy:t.proxy,tags:t.tags,supportsQuery:t.supportsQuery,defaultQuery:t.defaultQuery,requiresKey:t.requiresKey,keyParam:t.keyParam,keyHeader:t.keyHeader,ttlMinutes:t.ttlMinutes}));return JSON.stringify(e,null,2)}function oo(){if(!o.customFeedJson)return;let e=o.customFeedJson.value.trim();if(!e){o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent="Paste JSON to import feeds.");return}let t;try{t=JSON.parse(e)}catch{o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent="Invalid JSON. Please check the format.");return}let n=Array.isArray(t)?t:Array.isArray(t.feeds)?t.feeds:[];if(!n.length){o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent="No feeds found in the JSON payload.");return}let a=n.map(ao).filter(Boolean);if(!a.length){o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent="No valid feeds found. Check name and URL fields.");return}let s=new Map(r.customFeeds.map(i=>[i.id,i]));a.forEach(i=>{s.set(i.id,i)}),r.customFeeds=Array.from(s.values()),Ht(),r.feeds=qt(r.baseFeeds,r.customFeeds),jt(),Gt(),pt(),Ge(!0),o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent=`Imported ${a.length} feed${a.length===1?"":"s"}.`)}function za(e){if(!o.customFeedForm)return;let t=e||{};if(o.customFeedName.value=t.name||"",o.customFeedUrl.value=t.url||"",o.customFeedCategory.value=t.category||"news",o.customFeedFormat.value=t.format||"rss",o.customFeedProxy.value=t.proxy||"",o.customFeedTags.value=Array.isArray(t.tags)?t.tags.join(", "):"",o.customFeedSupportsQuery.checked=!!t.supportsQuery,o.customFeedDefaultQuery.value=t.defaultQuery||"",o.customFeedRequiresKey.checked=!!t.requiresKey,o.customFeedKeyParam.value=t.keyParam||"api_key",o.customFeedKeyHeader.value=t.keyHeader||"",o.customFeedTtl.value=t.ttlMinutes?String(t.ttlMinutes):"",o.customFeedRequiresKey){let n=o.customFeedRequiresKey.checked;o.customFeedKeyParam.disabled=!n,o.customFeedKeyHeader.disabled=!n}o.customFeedSupportsQuery&&(o.customFeedDefaultQuery.disabled=!o.customFeedSupportsQuery.checked),o.customFeedStatus&&(o.customFeedStatus.textContent=e?"Editing custom feed.":"Custom feeds are stored in this browser only.")}function jt(){if(o.customFeedList){if(o.customFeedList.innerHTML="",!r.customFeeds.length){o.customFeedList.innerHTML='<div class="settings-note">No custom feeds yet.</div>';return}r.customFeeds.forEach(e=>{let t=document.createElement("div");t.className="custom-feed-row";let n=document.createElement("div");n.className="custom-feed-info";let a=document.createElement("div");a.className="custom-feed-name",a.textContent=e.name||e.url;let s=document.createElement("div");s.className="custom-feed-meta";let i=Array.isArray(e.tags)&&e.tags.length?`\u2022 ${e.tags.join(", ")}`:"";s.textContent=`${e.category||"news"} \u2022 ${e.format||"rss"} ${i}`.trim(),n.appendChild(a),n.appendChild(s);let l=document.createElement("div");l.className="custom-feed-actions";let c=document.createElement("button");c.className="chip",c.type="button",c.textContent="Edit",c.addEventListener("click",()=>{nt=e.id,za(e),wt(!0)});let p=document.createElement("button");p.className="chip",p.type="button",p.textContent="Remove",p.addEventListener("click",()=>{r.customFeeds=r.customFeeds.filter(m=>m.id!==e.id),Ht(),r.feeds=qt(r.baseFeeds,r.customFeeds),jt(),Gt(),pt(),Ge(!0)}),l.appendChild(c),l.appendChild(p),t.appendChild(n),t.appendChild(l),o.customFeedList.appendChild(t)})}}function io(){let e=o.customFeedName.value.trim(),t=o.customFeedUrl.value.trim(),n=o.customFeedCategory.value,a=o.customFeedFormat.value,s=o.customFeedProxy.value||"",i=o.customFeedTags.value.split(",").map(f=>f.trim()).filter(Boolean),l=o.customFeedSupportsQuery.checked,c=o.customFeedDefaultQuery.value.trim(),p=o.customFeedRequiresKey.checked,m=o.customFeedKeyParam.value.trim()||"api_key",y=o.customFeedKeyHeader.value.trim(),d=Number(o.customFeedTtl.value||60);return!e||!t?{error:"Name and URL are required."}:/^https?:\/\//i.test(t)?{feed:{id:nt,name:e,url:t,category:n,format:a,proxy:s||void 0,tags:i,supportsQuery:l,defaultQuery:l?c:"",requiresKey:p,keyParam:p?m:void 0,keyHeader:p?y:void 0,ttlMinutes:Number.isFinite(d)?d:60,isCustom:!0,keySource:"client"}}:{error:"URL must start with http:// or https://."}}function Ue(){o.mapLegend&&(o.mapLegend.querySelectorAll("input[data-layer]").forEach(e=>{let t=e.dataset.layer;e.checked=!!r.settings.mapLayers[t]}),o.mapLegend.querySelectorAll("input[data-conflict-type]").forEach(e=>{let t=e.dataset.conflictType,n=r.settings.mapConflictTypes?.[t];e.checked=n!==!1}),o.legendOutages&&(o.legendOutages.checked=!!r.settings.mapLayers.outage),o.mapLegend.querySelectorAll("input[data-basemap]").forEach(e=>{let t=e.dataset.basemap;e.checked=t===r.settings.mapBasemap}),o.mapLegend.querySelectorAll("input[data-overlay]").forEach(e=>{let t=e.dataset.overlay;e.checked=!!r.settings.mapRasterOverlays?.[t]}),o.mapLegend.querySelectorAll("input[data-flight-density]").forEach(e=>{e.checked=e.dataset.flightDensity===(r.settings.mapFlightDensity||"medium")}))}function ze(){let e=r.settings.mapImageryDate||r.imageryDate,t=r.settings.mapSarDate||r.sarDate,n=Yt(0),a="2014-10-01";o.imageryDateInput&&e&&(o.imageryDateInput.min=a,o.imageryDateInput.max=n,o.imageryDateInput.value=e),o.sarDateInput&&t&&(o.sarDateInput.min=a,o.sarDateInput.max=n,o.sarDateInput.value=t),o.imageryDatePanel&&e&&(o.imageryDatePanel.min=a,o.imageryDatePanel.max=n,o.imageryDatePanel.value=e),o.sarDatePanel&&t&&(o.sarDatePanel.min=a,o.sarDatePanel.max=n,o.sarDatePanel.value=t),Le()}function N(e,t,n=""){r.overlayStatus||(r.overlayStatus={}),r.overlayStatus[e]={state:t,message:n},Ka()}function lo(e,t){let n=e==="imagery"?"Imagery":e.toUpperCase();if(!t)return`${n}: --`;let a=`${n}: ${t.state||"--"}`;return t.message?`${a} \u2014 ${t.message}`:a}function Ka(){let e=o.imageryStatus;e&&e.querySelectorAll("[data-imagery-status]").forEach(t=>{let n=t.dataset.imageryStatus,a=r.overlayStatus?.[n];t.textContent=lo(n,a),t.dataset.state=a?.state||""})}function st(){if(!o.lidarPointMeta)return;let e=r.lidarPointProject||"\u2014",t=r.lidarPointEptUrl,n=r.lidarPointEptAvailable?"available":t?"unavailable":"\u2014",a=r.lidarPointTelemetry?.[r.lidarPointTelemetry.length-1],s=r.overlayStatus?.lidarPoints?.message||"",i=a?.status?`${a.status}${a.loadMs?` \u2022 ${a.loadMs}ms`:""}`:s||"\u2014",l=Ot(r.settings.lidarPointLimits),c=l.useCustom?`Custom caps: ${l.pointCap.toLocaleString()} pts \u2022 ${l.radiusKm}km radius \u2022 ${l.maxTilesMobile}/${l.maxTilesDesktop} tiles`:"Defaults: 150k pts \u2022 5km radius \u2022 8/16 tiles";o.lidarPointProject&&(o.lidarPointProject.textContent=e),o.lidarPointEpt&&(o.lidarPointEpt.textContent=n,t?(o.lidarPointEpt.href=t,o.lidarPointEpt.setAttribute("aria-disabled","false")):(o.lidarPointEpt.removeAttribute("href"),o.lidarPointEpt.setAttribute("aria-disabled","true"))),o.lidarPointTelemetry&&(o.lidarPointTelemetry.textContent=i),o.lidarPointPerfNote&&(o.lidarPointPerfNote.textContent=c),o.lidarPointCustomize&&(o.lidarPointCustomize.checked=l.useCustom),o.lidarPointCap&&(o.lidarPointCap.value=String(l.pointCap)),o.lidarPointRadius&&(o.lidarPointRadius.value=String(l.radiusKm)),o.lidarPointTilesDesktop&&(o.lidarPointTilesDesktop.value=String(l.maxTilesDesktop)),o.lidarPointTilesMobile&&(o.lidarPointTilesMobile.value=String(l.maxTilesMobile)),o.lidarPointLimitGrid&&o.lidarPointLimitGrid.classList.toggle("is-hidden",!l.useCustom),o.lidarPointCenter&&(o.lidarPointCenter.disabled=!r.lidarSelectedBounds),o.lidarPointRefresh&&(o.lidarPointRefresh.disabled=!t),o.lidarPointLoad&&(o.lidarPointLoad.disabled=!r.lidarPointEptAvailable)}function ne(e,t=.5){let n=r.settings.mapOverlayOpacity?.[e];return Number.isFinite(n)?n:t}function Le(){document.querySelectorAll("[data-imagery-basemap]").forEach(e=>{let t=e.dataset.imageryBasemap;e.classList.toggle("active",t===r.settings.mapBasemap)}),document.querySelectorAll("[data-imagery-overlay]").forEach(e=>{let t=e.dataset.imageryOverlay;e.classList.toggle("active",!!r.settings.mapRasterOverlays?.[t])}),document.querySelectorAll("[data-overlay-opacity]").forEach(e=>{let t=e.dataset.overlayOpacity,n=Math.round(ne(t,.5)*100);e.value=n;let a=document.querySelector(`[data-overlay-opacity-value="${t}"]`);a&&(a.textContent=`${n}%`)}),Ka(),st()}function Bn(e){return e?.keySource==="server"}function co(){let e=r.feeds.filter(t=>!Bn(t)).filter(t=>t.requiresKey||t.keyParam||t.keyHeader||(t.tags||[]).includes("key")).map(t=>({...t,docsUrl:t.docsUrl||aa[t.id]}));return e.find(t=>t.id==="openai")||e.unshift({id:"openai",name:"OpenAI Assistant",category:"assistant",requiresKey:!0,docsUrl:aa.openai}),e}function mt(e){if(Bn(e))return{key:"",keyParam:"",keyHeader:"",groupId:e.keyGroup||null,fromGroup:!1,serverManaged:!0};let t=r.keys[e.id]||{},n=e.keyGroup,a=n?r.keyGroups[n]||{}:{},s=a.key||t.key,i=e.lockKeyParam?e.keyParam:t.keyParam||e.keyParam,l=e.lockKeyHeader?e.keyHeader:t.keyHeader||e.keyHeader;return{key:s,keyParam:i,keyHeader:l,groupId:n,fromGroup:!!a.key}}function pt(e){r.keyFilter=e||r.keyFilter;let t=co(),n=r.keyFilter,a=n?ms[n]||[n]:null,s=a?t.filter(d=>a.includes(d.category)):t;n&&!s.length&&(s=t);let i=d=>String(d||"").replace(/[^a-zA-Z0-9_-]/g,"-");o.keyManager.innerHTML="";let l=document.createElement("div");l.className="key-manager-header";let c=document.createElement("div");c.textContent=n?`API Keys - ${n.toUpperCase()}`:"API Keys";let p=document.createElement("div");if(p.className="key-manager-actions",n){let d=document.createElement("button");d.className="chip",d.textContent="Show All",d.addEventListener("click",()=>{r.keyFilter=null,pt()}),p.appendChild(d)}if(l.appendChild(c),l.appendChild(p),o.keyManager.appendChild(l),$()){let d=document.createElement("div");d.className="settings-note",d.textContent=r.settings.superMonitor?"Super Monitor Mode is active. Live fetches run for keyless feeds, plus custom feeds with browser keys. OpenAI uses the proxy by default (optional BYO key).":"Static mode is active. Feeds load from the published cache. Optional: enable Super Monitor Mode to pull live keyless feeds (proxy required for OpenAI).",o.keyManager.appendChild(d),r.settings.superMonitor||(s=s.filter(g=>g.id==="openai"))}if(r.feeds.filter(d=>Bn(d)).length){let d=document.createElement("div");d.className="settings-note",d.textContent="Server-managed keys: DATA_GOV, EIA, NASA_FIRMS, OPEN_AQ. Configure in the proxy.",o.keyManager.appendChild(d)}let y=[...new Set(s.map(d=>d.keyGroup).filter(Boolean))];if(y.length){let d=document.createElement("div");d.className="key-group-section";let g=document.createElement("div");g.className="key-group-title",g.textContent="Shared Keys",d.appendChild(g),y.forEach(f=>{let h=document.createElement("div");h.className="key-row key-group-row";let b=document.createElement("div");b.className="key-row-head";let k=document.createElement("div");k.className="list-title",k.textContent=ra[f]||f;let C=document.createElement("div");C.className="key-group-meta";let S=s.filter(T=>T.keyGroup===f),A=S.map(T=>T.name),M=S.map(T=>T.id);C.textContent=`Applies to: ${A.join(", ")}`,b.appendChild(k),b.appendChild(C);let w=document.createElement("label");w.textContent="API Key";let I=document.createElement("input");I.type="password",I.id=`key-group-${i(f)}`,I.name=I.id,I.autocomplete="new-password",w.setAttribute("for",I.id),I.placeholder="Paste shared key",I.value=r.keyGroups[f]?.key||"",I.addEventListener("input",()=>{let T=I.value.trim();r.keyGroups[f]={...r.keyGroups[f]||{},key:T},M.forEach(x=>{r.keyStatus[x]="untested"}),Rs(),Sn(),r.energyMapData=null,r.energyMapFetchedAt=0,Tn(),Bt(),document.querySelectorAll(".key-row[data-feed]").forEach(x=>{let F=x.dataset.feed;if(s.find(B=>B.id===F)?.keyGroup===f){let B=x.querySelector('input[type="password"], input[type="text"]');B&&(B.value=I.value);let J=x.querySelector(".key-status");J&&(J.className="key-status untested",J.textContent="untested")}})});let u=document.createElement("button");u.className="chip",u.textContent="Show",u.addEventListener("click",()=>{I.type=I.type==="password"?"text":"password",u.textContent=I.type==="password"?"Show":"Hide"});let v=document.createElement("div");v.className="key-row-input";let E=document.createElement("input");E.type="text",E.className="sr-only",E.autocomplete="username",E.name=`user-${I.id}`,E.id=`user-${I.id}`,E.tabIndex=-1,E.setAttribute("aria-hidden","true"),v.appendChild(E),v.appendChild(I),v.appendChild(u),h.appendChild(b),h.appendChild(w),h.appendChild(v),d.appendChild(h)}),o.keyManager.appendChild(d)}if(!s.length){o.keyManager.innerHTML+='<div class="settings-note">No feeds require keys yet.</div>';return}s.forEach(d=>{let g=document.createElement("div");g.className="key-row",g.dataset.feed=d.id;let f=document.createElement("div");f.className="key-row-head";let h=document.createElement("div");h.textContent=d.name,h.className="list-title";let b=document.createElement("span"),k=r.keyStatus[d.id]||"untested";b.className=`key-status ${k}`,b.textContent=k;let C=document.createElement("div");C.className="key-row-actions";let S=document.createElement("button");if(S.className="chip",S.textContent="Test",S.addEventListener("click",()=>po(d,b)),C.appendChild(S),d.docsUrl){let T=document.createElement("a");T.className="chip",T.href=d.docsUrl,T.target="_blank",T.rel="noopener noreferrer",T.textContent="Docs",C.appendChild(T)}f.appendChild(h),f.appendChild(b),f.appendChild(C);let A=document.createElement("label");A.textContent="API Key";let M=document.createElement("input");M.type="password",M.id=`key-${i(d.id)}`,M.name=M.id,M.autocomplete="new-password",A.setAttribute("for",M.id);let w=mt(d),I=d.keyGroup?ra[d.keyGroup]||d.keyGroup:null;M.placeholder=d.keyGroup?"Set in Shared Keys":"Paste key",M.value=w.key||"",M.disabled=!!d.keyGroup,d.keyGroup||M.addEventListener("input",()=>{let T=M.value.trim();r.keys[d.id]={...r.keys[d.id]||{},key:T},r.keyStatus[d.id]="untested",on(),Sn(),b.className="key-status untested",b.textContent="untested",d.id==="openai"&&Ut(),r.energyMapData=null,r.energyMapFetchedAt=0,Tn(),Bt()});let u=document.createElement("button");u.className="chip",u.textContent="Show",u.addEventListener("click",()=>{M.type=M.type==="password"?"text":"password",u.textContent=M.type==="password"?"Show":"Hide"});let v=document.createElement("div");v.className="key-row-input";let E=document.createElement("input");if(E.type="text",E.className="sr-only",E.autocomplete="username",E.name=`user-${M.id}`,E.id=`user-${M.id}`,E.tabIndex=-1,E.setAttribute("aria-hidden","true"),v.appendChild(E),v.appendChild(M),v.appendChild(u),g.appendChild(f),g.appendChild(A),g.appendChild(v),d.id==="openai"){let T=document.createElement("details");T.className="advanced-toggle",T.open=!1;let x=document.createElement("summary");x.textContent="Advanced",T.appendChild(x);let F=document.createElement("label");F.className="toggle-row";let P=document.createElement("span");P.textContent="Use my OpenAI key for AI requests";let B=document.createElement("input");B.type="checkbox",B.id="useOpenAiKey",B.name="useOpenAiKey",B.checked=!!r.settings.useClientOpenAI,B.setAttribute("aria-label","Use browser OpenAI key for AI requests"),B.addEventListener("change",()=>{r.settings.useClientOpenAI=B.checked,D(),Ut(),we(),B.checked&&(T.open=!0)}),F.appendChild(P),F.appendChild(B),T.appendChild(F);let J=document.createElement("div");J.className="settings-note",J.textContent="When off, AI uses the server key. When on, your key is passed to the proxy.",T.appendChild(J),g.appendChild(T)}if(d.id!=="openai"){let T=document.createElement("label");T.textContent="Key Param (query string)";let x=document.createElement("input");x.id=`key-param-${i(d.id)}`,x.name=x.id,T.setAttribute("for",x.id),x.placeholder=d.keyParam||"api_key",x.value=d.lockKeyParam?d.keyParam||"":r.keys[d.id]?.keyParam||d.keyParam||"",d.lockKeyParam?x.disabled=!0:x.addEventListener("input",()=>{r.keys[d.id]={...r.keys[d.id]||{},keyParam:x.value},on()});let F=document.createElement("label");F.textContent="Key Header (optional)";let P=document.createElement("input");if(P.id=`key-header-${i(d.id)}`,P.name=P.id,F.setAttribute("for",P.id),P.placeholder=d.keyHeader||"X-API-Key",P.value=d.lockKeyHeader?d.keyHeader||"":r.keys[d.id]?.keyHeader||d.keyHeader||"",d.lockKeyHeader?P.disabled=!0:P.addEventListener("input",()=>{r.keys[d.id]={...r.keys[d.id]||{},keyHeader:P.value},on()}),g.appendChild(T),g.appendChild(x),g.appendChild(F),g.appendChild(P),d.keyGroup){let B=document.createElement("div");B.className="settings-note",B.textContent=`Uses shared key: ${I}`,g.appendChild(B)}if(d.lockKeyParam||d.lockKeyHeader){let B=document.createElement("div");B.className="settings-note",B.textContent="Key parameters are fixed for this API.",g.appendChild(B)}}else{let T=document.createElement("div");T.className="settings-note",T.textContent="Used for chat, AI briefings, and query translation.",g.appendChild(T)}o.keyManager.appendChild(g)})}function ee(e,t,n,a){r.keyStatus[e]=t,Sn(),n&&(n.className=`key-status ${t}`,n.textContent=t,a?n.title=a:n.removeAttribute("title"))}function uo(e){return e?e.error==="requires_key"?"missing":e.httpStatus>=200&&e.httpStatus<300?"ok":e.httpStatus===401||e.httpStatus===403?"invalid":e.httpStatus===429?"rate_limited":"error":"error"}function mo(){let e=(r.keys.openai?.key||"").trim();return e&&r.settings.useClientOpenAI?e:""}function ue(){return Ne()?!0:!$()}function Dn(e){let t=(e?.message||"").toString(),n=t.toLowerCase();return n.includes("assistant_unavailable")?{status:"error",message:"AI requires a proxy on GitHub Pages."}:n.includes("missing_api_key")||n.includes("provide an openai api key")?{status:"missing",message:"Add an OpenAI API key in Settings."}:n.includes("failed to fetch")||n.includes("network")||n.includes("cors")?{status:"error",message:"Browser blocked the request (CORS). Key saved; use a proxy for live chat."}:(n.includes("invalid")||n.includes("unauthorized")||n.includes("401"))&&!$()?{status:"invalid",message:t||"Invalid API key"}:n.includes("invalid")||n.includes("unauthorized")||n.includes("401")?{status:"error",message:"OpenAI request blocked on static hosting. Use a proxy for live chat."}:n.includes("rate")||n.includes("429")?{status:"rate_limited",message:t||"Rate limited"}:{status:"error",message:t||"OpenAI error"}}async function po(e,t){let n=mt(e);e.id==="openai"&&n.key&&(n.key=n.key.trim());let a=Ne();if(!n.key){if(e.id==="openai"&&a){ee(e.id,"ok",t,"Using server key");return}ee(e.id,"missing",t,"Missing API key");return}if(ee(e.id,"testing",t,"Testing key..."),e.id==="openai"){if(a&&!r.settings.useClientOpenAI){ee(e.id,"ok",t,"Using server key");return}if($()&&!Ne()){if(!r.settings.superMonitor){ee(e.id,"missing",t,"Enable Super Monitor Mode to test.");return}ee(e.id,"ok",t,"Key saved. Static hosting cannot validate without a proxy.");return}try{await Ze({messages:[{role:"user",content:"ping"}],context:{mode:"key-test"},temperature:0})?ee(e.id,"ok",t,"Key valid"):ee(e.id,"error",t,"No response")}catch(s){let{status:i,message:l}=Dn(s);ee(e.id,i,t,l)}return}try{let s,i;if($()){let p=new URLSearchParams;p.set("id",e.id),p.set("force","1"),e.supportsQuery&&e.defaultQuery&&p.set("query",e.defaultQuery);let m=await me(`/api/feed?${p.toString()}`);s=m.data,i=m.error}else{let p=await me("/api/feed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,force:!0,query:e.supportsQuery?e.defaultQuery:void 0,key:n.key||void 0,keyParam:n.keyParam||void 0,keyHeader:n.keyHeader||void 0})});s=p.data,i=p.error}if(i||!s){ee(e.id,"error",t,"Feed API unreachable");return}let l=uo(s),c=s.message||s.error||(s.httpStatus?`HTTP ${s.httpStatus}`:"");ee(e.id,l,t,c)}catch(s){ee(e.id,"error",t,s.message)}}function X(e=""){return e.toLowerCase().replace(/https?:\/\/\S+/g,"").replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(t=>t&&!os.has(t)).join(" ").trim()}function Ke(e){if(!e)return"";try{let t=new URL(e);return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(n=>t.searchParams.delete(n)),t.toString()}catch{return e}}function go(){try{let e=new URL(window.location.href),t=["key","api_key","apikey","openai_key","openai","x-api-key","token","access_token"],n=!1;if(t.forEach(a=>{e.searchParams.has(a)&&(e.searchParams.delete(a),n=!0)}),n){let a=e.searchParams.toString(),s=`${e.pathname}${a?`?${a}`:""}${e.hash}`;window.history.replaceState({},document.title,s)}}catch{}}async function yo(){if(o.proxyHealth){o.proxyHealth.textContent="Feed API: Checking",o.proxyHealth.classList.remove("ok","error");try{let{response:e,data:t}=await me("/health",{},8e3);if(e?.ok&&t?.ok){o.proxyHealth.textContent="Feed API: Healthy",o.proxyHealth.classList.add("ok");return}o.proxyHealth.textContent="Feed API: Degraded",o.proxyHealth.classList.add("error")}catch{o.proxyHealth.textContent="Feed API: Offline",o.proxyHealth.classList.add("error")}}}function We(e){let t=new Set,n=[];return e.forEach(a=>{let s=a._dedupeKey||Ke(a.url||"")||X(a.title||"");if(!s){n.push(a);return}t.has(s)||(t.add(s),n.push(a))}),n}function fo(e,t){if(!e.size||!t.size)return 0;let n=0;for(let s of e)t.has(s)&&(n+=1);let a=e.size+t.size-n;return a?n/a:0}function ge(e){let t=[];return e.forEach(n=>{let a=Ke(n.url),s=new Set(X(n.title).split(" ").filter(Boolean)),i=null;for(let l of t){if(a&&l.urls.has(a)){i=l;break}if(fo(s,l.tokens)>.72){i=l;break}}if(i)i.items.push(n),i.sources.add(n.source),a&&i.urls.add(a),n.publishedAt&&n.publishedAt>i.updatedAt&&(i.updatedAt=n.publishedAt,i.primary=n);else{let l={id:`cluster-${t.length}-${Date.now()}`,primary:n,items:[n],sources:new Set([n.source]),urls:a?new Set([a]):new Set,tokens:s,updatedAt:n.publishedAt||Date.now()};t.push(l)}}),t.sort((n,a)=>a.updatedAt-n.updatedAt)}function Cn(e,t){let a=new DOMParser().parseFromString(e,"text/xml"),s=[...a.getElementsByTagName("item")];if(!s.length){let i=[...a.getElementsByTagName("entry")];return(i.length?i:a.getElementsByTagNameNS?[...a.getElementsByTagNameNS("*","entry")]:[]).map(c=>{let p=c.getElementsByTagName("title")?.[0]?.textContent||"Untitled",m=c.getElementsByTagName("link")?.[0],y=m?.getAttribute("href")||m?.textContent||"",d=c.getElementsByTagName("updated")?.[0]?.textContent||c.getElementsByTagName("published")?.[0]?.textContent,g=c.getElementsByTagName("summary")?.[0],f=g?.textContent||"",h=g?.innerHTML||"",b=ma(f,h);return{title:p,url:y,summary:b.summary,summaryHtml:b.summaryHtml,publishedAt:d?Date.parse(d):Date.now(),source:t.name,category:t.category}})}return s.map(i=>{let l=i.getElementsByTagName("title")?.[0]?.textContent||"Untitled",c=i.getElementsByTagName("link")?.[0]?.textContent||i.getElementsByTagName("guid")?.[0]?.textContent||"",p=i.getElementsByTagName("dc:date")?.[0]?.textContent,m=i.getElementsByTagName("pubDate")?.[0]?.textContent||p,y=i.getElementsByTagName("source")?.[0]?.textContent||t.name,d=null,g=i.getElementsByTagName("georss:point")?.[0]?.textContent;if(g){let[C,S]=g.trim().split(/\\s+/).map(Number);!Number.isNaN(C)&&!Number.isNaN(S)&&(d={lat:C,lon:S})}else{let C=i.getElementsByTagName("geo:lat")?.[0]?.textContent,S=i.getElementsByTagName("geo:long")?.[0]?.textContent;if(C&&S){let A=Number(C),M=Number(S);!Number.isNaN(A)&&!Number.isNaN(M)&&(d={lat:A,lon:M})}}let f=i.querySelector("description"),h=f?.textContent||"",b=f?.innerHTML||"",k=ma(h,b);return{title:l,url:c,summary:k.summary,summaryHtml:k.summaryHtml,publishedAt:m?Date.parse(m):Date.now(),source:y,category:t.category,geo:d}})}function Mt(e,t){try{if(t.format==="csv")return ht[t.id]?ht[t.id](e,t):Lo(e,t);let n=JSON.parse(e);return t.format==="arcgis"?bo(n,t):ht[t.id]?ht[t.id](n,t):t.isCustom?ho(n,t):[]}catch{return[]}}function ho(e,t){return(Array.isArray(e?.items)?e.items:Array.isArray(e?.entries)?e.entries:Array.isArray(e?.articles)?e.articles:Array.isArray(e?.data)?e.data:[]).slice(0,20).map(a=>{if(typeof a=="string")return{title:a,url:"",summary:"",publishedAt:Date.now(),source:t.name,category:t.category};let s=a.title||a.name||a.headline||"Untitled",i=a.url||a.link||a.permalink||"",l=a.summary||a.description||a.body||"",c=a.publishedAt||a.pubDate||a.date||a.updatedAt,p=a.geo||(a.latitude&&a.longitude?{lat:Number(a.latitude),lon:Number(a.longitude)}:null);return{title:s,url:i,summary:l,publishedAt:c?Date.parse(c):Date.now(),source:a.source||t.name,category:t.category,geo:p}})}function bo(e,t){let n=Array.isArray(e?.features)?e.features:[],a=(h,b=[])=>{for(let k of b)if(h[k]!==void 0&&h[k]!==null&&String(h[k]).trim()!=="")return h[k];return null},s=h=>{if(h==null||h==="")return null;if(typeof h=="number"){if(h>1e12)return h;if(h>1e9)return h*1e3}let b=Date.parse(h);return Number.isNaN(b)?null:b},i=h=>{let k=a(h,["reported_date","report_date","reportdate","incident_date","event_date","date","datetime","timestamp","time","created_date","created","updated_date","updated","last_updated","last_update","edit_date","start_date","end_date"]);if(k)return s(k);for(let C of Object.keys(h||{})){let S=C.toLowerCase();if(S.includes("date")||S.includes("time")||S.includes("updated")){let A=s(h[C]);if(A)return A}}return null},l=h=>a(h,["title","name","incident","event","type","category","hazard","AttackType","attacktype","attack_type","summary","description"])||t.name,c=h=>a(h,["summary","description","details","Notes","notes","comments","status","headline"])||"",p=h=>a(h,["alert_type","event","type","category","hazard","incident_type","AttackType","attacktype","attack_type"]),m=h=>a(h,["severity","sig","significance","priority","status"]),y=h=>a(h,["location","loc_desc","area_desc","place","city","county","state","country","region"]),d=Number(t?.maxItems),g=Number.isFinite(d)?d:250;return(g>0?n.slice(0,g):n).map(h=>{let b=h?.properties||h?.attributes||{},k=l(b),C=c(b),S=i(b)||Date.now(),A=p(b),M=m(b),w=y(b),I=!!(t.mapOnly||t.tags?.includes("mapOnly")),u=$n(h.geometry);if(!u){let v=a(b,["latitude","lat","y"]),E=a(b,["longitude","lon","x"]);if(v!==null&&E!==null){let T=Number(v),x=Number(E);!Number.isNaN(T)&&!Number.isNaN(x)&&(u={lat:T,lon:x})}}return{title:k,url:b.url||b.link||"",summary:C,publishedAt:S,source:t.name,category:t.category,geo:u,alertType:A,severity:M,location:w,mapOnly:I}}).filter(h=>h.geo)}function vo(e,t){let n=Array.isArray(e?.data)?e.data:Array.isArray(e?.response?.data)?e.response.data:[];if(!n.length)return[];let a=n[0]||{};if(!!(a.event_id_cnty||a.event_date||a.latitude||a.longitude))return n.map(m=>{let y=Number(m.latitude),d=Number(m.longitude),g=Number(m.fatalities),f=m.event_date||"",h=f?Date.parse(f):Date.now(),b=m.event_type||"Conflict Event",k=m.sub_event_type||"",C=m.location||m.admin2||m.admin1||m.country||"",S=`${b}${C?` \u2014 ${C}`:""}`,A=[];k&&A.push(k),Number.isNaN(g)||A.push(`Fatalities: ${g}`);let M=[m.actor1,m.actor2].filter(Boolean).join(" vs ");M&&A.push(`Actors: ${M}`);let w=A.join(" \u2022 "),I=(()=>{if(!Number.isFinite(y)||!Number.isFinite(d))return"";let u=Math.round(y*5)/5,v=Math.round(d*5)/5,E=X(b||"").slice(0,24);return`${f||""}:${u}:${v}:${E}`})();return{title:S,url:"",summary:w,summaryHtml:w,publishedAt:Number.isNaN(h)?Date.now():h,source:m.source||t.name,category:t.category,geo:Number.isFinite(y)&&Number.isFinite(d)?{lat:y,lon:d}:null,alertType:b,eventType:b,subEventType:k,hazardType:m.disorder_type||"",severity:Number.isNaN(g)?"":`Fatalities ${g}`,location:C,geoLabel:C,conflictKey:I,tags:["conflict","security"]}});let i=(m,y)=>{for(let d of y){let g=m?.[d];if(g!=null&&String(g).trim()!=="")return g}return null},l=(m,y)=>{let d=i(m,y),g=d===null?NaN:Number(d);return Number.isFinite(g)?g:NaN},c=i(a,["week","week_start","week_end","event_date","date"]),p=1e3*60*60*24*30;return n.map(m=>{let y=l(m,["latitude","lat","centroid_latitude","admin1_latitude","location_latitude"]),d=l(m,["longitude","lon","centroid_longitude","admin1_longitude","location_longitude"]),g=i(m,["event_type","event","type"])||i(m,["sub_event_type","subevent_type"])||"Conflict",f=i(m,["disorder_type","disorder"])||"",h=i(m,["sub_event_type","subevent_type"])||"",b=i(m,["week","week_start","week_end","event_date","date"])||"",k=b?Date.parse(b):Date.now(),C=Number.isFinite(k)?Date.now()-k>p:!1,S=i(m,["admin1","admin_1","region","location","country"])||"",A=i(m,["country"])||"",M=i(m,["admin1","admin_1"])||"",w=l(m,["event_count","events","event_cnt","event_number"]),I=l(m,["fatalities","fatality","fatalities_count"]),u=l(m,["population_exposure","pop_exposure","exposure","population"]),v=f||g||"Conflict",E=`${v}${M||A?` \u2014 ${M||A}`:""}`,T=[];h&&h!==g&&T.push(h),Number.isNaN(w)||T.push(`Events: ${q(w)}`),Number.isNaN(I)||T.push(`Fatalities: ${q(I)}`),Number.isNaN(u)||T.push(`Exposure: ${q(u)}`),b&&T.push(`Week: ${b}`);let x=T.join(" \u2022 "),F=(()=>{if(!Number.isFinite(y)||!Number.isFinite(d))return"";let P=Math.round(y*5)/5,B=Math.round(d*5)/5,J=X(v||"").slice(0,24);return`${b||""}:${P}:${B}:${J}`})();return{title:E,url:"",summary:x,summaryHtml:x,publishedAt:Number.isNaN(k)?Date.now():k,source:t.name,category:C?"security-lagged":t.category,geo:Number.isFinite(y)&&Number.isFinite(d)?{lat:y,lon:d}:null,alertType:v,eventType:v,subEventType:h,hazardType:f,severity:Number.isNaN(I)?"":`Fatalities ${q(I)}`,location:S||M||A,geoLabel:S||M||A,conflictKey:F,tags:["conflict","security","aggregated"].concat(C?["lagged"]:[])}}).filter(m=>m.geo)}function So(e,t){let n=Array.isArray(e?.losses)?e.losses:[],a=Number(t.limit)||300;return n.slice(0,a).map(s=>{let i=typeof s.geo=="string"?s.geo:"",l=null;if(i&&i.includes(",")){let[A,M]=i.split(","),w=Number(A),I=Number(M);Number.isFinite(w)&&Number.isFinite(I)&&(l={lat:w,lon:I})}let c=s.nearest_location||"",p=s.status||"Loss",m=s.type||"Equipment",y=s.model||"",d=s.unit||"",g=s.tags||"",f=[];m&&f.push(m),y&&y!==m&&f.push(y),d&&f.push(`Unit: ${d}`),g&&f.push(`Tags: ${g}`);let h=s.date||"",b=h?Date.parse(h):Date.now(),C=`${p} \u2014 ${y||m||"Equipment Loss"}${c?` \u2022 ${c}`:""}`,S=(()=>{if(!l)return"";let A=Math.round(l.lat*5)/5,M=Math.round(l.lon*5)/5,w=X(m||"").slice(0,24);return`${h||""}:${A}:${M}:${w}`})();return{title:C,url:"https://ukr.warspotting.net/",summary:f.join(" \u2022 "),summaryHtml:f.join(" \u2022 "),publishedAt:Number.isNaN(b)?Date.now():b,source:"Warspotting",category:t.category,geo:l,alertType:p,eventType:p,hazardType:m,severity:p,location:c,geoLabel:c,conflictKey:S,tags:["conflict","security","kinetic"]}})}function wo(e,t){let n=Array.isArray(e?.features)?e.features:[],a=(i="")=>{let l=i.match(/<a[^>]+href="([^"]+)"[^>]*>(.*?)<\/a>/i);if(!l)return{url:"",text:""};let c=l[2]?.replace(/<[^>]*>/g,"").replace(/&nbsp;|&amp;|&quot;|&#39;/g," ").trim();return{url:l[1]||"",text:c||""}},s=(i="")=>{let l=i.toLowerCase();return l.includes("battle")||l.includes("armed clash")?"battle":l.includes("explosion")||l.includes("bomb")||l.includes("airstrike")?"explosion":l.includes("violence")||l.includes("attack")||l.includes("killed")||l.includes("shot")?"violence":l.includes("protest")||l.includes("demonstrat")?"protest":l.includes("riot")?"riot":"other"};return n.map(i=>{let l=i?.properties||{},c=$n(i?.geometry);if(!c)return null;let p=l.name||"",m=Number(l.count)||0,y=a(l.html||""),d=s(`${p} ${l.html||""}`),g=Math.round(c.lat*5)/5,f=Math.round(c.lon*5)/5,h=`${d}:${g}:${f}`,b=[];return m&&b.push(`Mentions ${m}`),y.text&&b.push(y.text.slice(0,120)),{title:`Conflict signal \u2014 ${p||"Unknown location"}`,url:y.url,summary:b.join(" \u2022 "),summaryHtml:b.join(" \u2022 "),publishedAt:Date.now(),source:"GDELT",category:t.category,geo:c,alertType:d,eventType:d,location:p,geoLabel:p,conflictKey:h,tags:["conflict","security","live"]}}).filter(Boolean)}function Co(e,t){return(Array.isArray(e?.Result)?e.Result:[]).map(a=>{let s=Number(a.latitude),i=Number(a.longitude);if(!Number.isFinite(s)||!Number.isFinite(i))return null;let l=Number(a.best),c=a.date_start||a.date_end||"",p=c?Date.parse(c):Date.now(),y=Number(a.type_of_violence)===1?"battle":"violence",d=a.where_description||a.adm_2||a.adm_1||a.country||"",g=a.conflict_name||"Conflict Event",f=`${g}${d?` \u2014 ${d}`:""}`,h=[];a.dyad_name&&h.push(a.dyad_name),Number.isNaN(l)||h.push(`Fatalities ${l}`),a.source_headline&&h.push(a.source_headline);let b=Math.round(s*5)/5,k=Math.round(i*5)/5,C=`${c||""}:${b}:${k}:${X(g).slice(0,24)}`;return{title:f,url:"",summary:h.join(" \u2022 "),summaryHtml:h.join(" \u2022 "),publishedAt:Number.isNaN(p)?Date.now():p,source:"UCDP",category:t.category,geo:{lat:s,lon:i},alertType:y,eventType:y,hazardType:a.conflict_name||"",severity:Number.isNaN(l)?"":`Fatalities ${l}`,location:d,geoLabel:d,conflictKey:C,tags:["conflict","security","curated"]}}).filter(Boolean)}function Lo(e,t){let n=String(e||"").trim().split(/\r?\n/);if(n.length<2)return[];let a=n[0].split(",").map(s=>s.trim().toLowerCase());return n.slice(1,21).map(s=>{let i=s.split(",").map(d=>d.trim()),l={};a.forEach((d,g)=>{l[d]=i[g]});let c=l.title||l.name||l.headline||i[0]||"Untitled",p=l.url||l.link||"",m=l.summary||l.description||"",y=l.publishedat||l.date||l.published||"";return{title:c,url:p,summary:m,publishedAt:y?Date.parse(y):Date.now(),source:t.name,category:t.category}})}function Wa(e){let t=[],n=[],a="",s=!1;for(let i=0;i<e.length;i+=1){let l=e[i];if(l==='"'){let c=e[i+1];s&&c==='"'?(a+='"',i+=1):s=!s;continue}if(l===","&&!s){n.push(a),a="";continue}if((l===`
`||l==="\r")&&!s){l==="\r"&&e[i+1]===`
`&&(i+=1),n.push(a),n.some(c=>c.trim()!=="")&&t.push(n),n=[],a="";continue}a+=l}return(a.length||n.length)&&(n.push(a),n.some(i=>i.trim()!=="")&&t.push(n)),t}var ua=(e,t)=>(e.results||[]).map(n=>({title:n.title,url:n.html_url,summary:n.abstract||n.type,publishedAt:n.publication_date?Date.parse(n.publication_date):Date.now(),source:"Federal Register",category:t.category,alertType:n.type,deadline:n.comments_close_on||n.effective_on||null})),Ae=(e,t)=>{let n=u=>!u||String(u).trim().toLowerCase()==="untitled",a=u=>{if(!u)return"";try{let v=new URL(u);return v.searchParams.delete("api_key"),v.toString()}catch{return u}},s=(u,v,E={})=>{if(!u||!v)return"";let T=String(u).toUpperCase();return`${E[T]||T} ${v}`},i=u=>{let v=u.type||u.billType||"",E=u.number||u.billNumber||u.bill?.number||"";return s(v,E,{HR:"H.R.",S:"S.",HJRES:"H.J.Res.",SJRES:"S.J.Res.",HCONRES:"H.Con.Res.",SCONRES:"S.Con.Res.",HRES:"H.Res.",SRES:"S.Res."})},l=u=>{let v=u.type||"",E=u.number||"";return s(v,E,{HAMDT:"H.Amdt.",SAMDT:"S.Amdt."})},c=u=>{let v=u.type||"",E=u.number||"",T={HRPT:"H. Rept.",SRPT:"S. Rept.",ERPT:"E. Rept."};return u.citation||s(v,E,T)},p=u=>`https://www.congress.gov/search?q=${encodeURIComponent(u)}`,m=u=>typeof u=="string"&&u.includes("congress.gov/search?"),y=u=>{let v=u.congress||u.bill?.congress||u.congressReceived,E=String(u.type||u.billType||"").toUpperCase(),T=u.number||u.billNumber||u.bill?.number;if(!v||!E||!T)return u.url||u.link||"";let F={HR:"house-bill",S:"senate-bill",HJRES:"house-joint-resolution",SJRES:"senate-joint-resolution",HCONRES:"house-concurrent-resolution",SCONRES:"senate-concurrent-resolution",HRES:"house-resolution",SRES:"senate-resolution"}[E];return F?`https://www.congress.gov/bill/${v}th-congress/${F}/${T}`:u.url||u.link||""},d=u=>{let v=u.congress,E=String(u.type||"").toUpperCase(),T=u.number;if(!v||!E||!T)return u.url||"";let x=E.startsWith("S")?"senate-amendment":"house-amendment";return`https://www.congress.gov/amendment/${v}th-congress/${x}/${T}`},g=u=>{let v=u.congress,E=String(u.type||"").toUpperCase(),T=u.number;if(!v||!E||!T)return u.url||"";let x=E.startsWith("S")?"senate-report":"house-report";return`https://www.congress.gov/congressional-report/${v}th-congress/${x}/${T}`},f=u=>{let v=u?.nomination||{},E=u.number||u.nominationNumber||v.number||v.nominationNumber||v.nominationId;if(E)return String(E).replace(/^PN/i,"").split("-")[0];let x=(u.citation||v.citation||"").match(/PN(\d+)(?:-(\d+))?/i);return x?x[1]:""},h=u=>{if(!u)return"";try{let v=new URL(u),E=`${v.origin}${v.pathname}`;return E.includes("/event/")&&E.includes("/text")?E.split("/text")[0]:E}catch{return u.split("#")[0].split("?")[0]}},b=u=>{let v=u.congress,E=u.nomination?.url||u.url||u.link||"";if(E&&E.includes("congress.gov/nomination"))return E;let x=String(u.citation||u.nomination?.citation||u.title||u.detailTitle||"").toUpperCase().match(/PN\d+(?:-\d+)?/);if(v&&x){let J=x[0].replace(/^PN/i,"").split("-")[0];return`https://www.congress.gov/nomination/${v}th-congress/${J}`}let F=u.number||u.nomination?.number||u.nominationNumber,P=u.partNumber||u.nomination?.partNumber;if(v&&F){if(P){let J=String(P).replace(/^0+/,"");return`https://www.congress.gov/nomination/${v}th-congress/${F}`}return`https://www.congress.gov/nomination/${v}th-congress/${F}`}return u.citation?p(u.citation):u.nomination?.url||u.url||u.link||""},k=u=>{let v=u.description||"";if(!v)return"";let[E,T]=v.split(", of "),x=v.split(" to be ");if(x.length>1){let F=x[0].replace(/,? of .*/i,"").trim(),P=x[1].replace(/, vice .*/i,"").trim();if(F&&P)return`${F} \u2014 ${P}`}if(E&&T){let F=T.split(", vice ")[0];if(F)return`${E.trim()} \u2014 ${F.trim()}`}return v},C=u=>{let v=u.hearingTitle||u.meetingTitle||u.title||u.topic;if(v&&!n(v))return v;let E=u.committeeName||"",T=u.date?re(u.date):"";return u.number?E?`${E} \u2014 Hearing ${u.number}`:`Hearing ${u.number}`:u.jacketNumber?E?`${E} \u2014 Jacket ${u.jacketNumber}`:`Hearing Jacket ${u.jacketNumber}`:"Hearing"},S=u=>{let v=u.congressReceived||u.congressConsidered,E=u.number;return v&&E?`https://www.congress.gov/treaty/${v}th-congress/${E}`:p(`treaty ${E||""}`.trim())},A=u=>{let v=[u.eventUrl,u.hearingUrl,u.meetingUrl,u.congressUrl,u.url,u.link].find(P=>typeof P=="string"&&P.includes("congress.gov")&&!P.includes("api.congress.gov"));if(v)return v;let E=u.congress,T=(u.chamber||"").toLowerCase(),x=u.eventId||u.meetingId||u.event;if(E&&x&&(T==="house"||T==="senate"))return`https://www.congress.gov/event/${E}th-congress/${T}-event/${x}`;let F=u.jacketNumber;return p(["hearing",F||x||"",u.committeeName||""].filter(Boolean).join(" "))},M=u=>{let v=u.Links||{},T=(v.FullRecord||v.Digest||v.Senate||v.House||v.Remarks)?.PDF?.[0]?.Url;return T||(u.PublishDate?p(`congressional record ${u.PublishDate}`):u.url||"")},w=u=>u?Array.isArray(u)?u:Array.isArray(u.items)?u.items:Array.isArray(u.item)?u.item:Array.isArray(u.bill)?u.bill:Array.isArray(u.amendment)?u.amendment:Array.isArray(u.report)?u.report:Array.isArray(u.hearing)?u.hearing:Array.isArray(u.nomination)?u.nomination:Array.isArray(u.treaty)?u.treaty:null:null;return(w(e?.bills)||w(e?.amendments)||w(e?.committeeReports)||w(e?.committeeReport)||w(e?.nominations)||w(e?.treaties)||w(e?.hearings)||w(e?.committeeMeetings)||w(e?.congressionalRecord)||w(e?.dailyCongressionalRecord)||w(e?.records)||w(e?.Results?.Issues)||w(e?.results)||[]).map(u=>{let v=u.number||u.billNumber||u.amendmentNumber||u.reportNumber||u.nominationNumber||u.treatyNumber||u.citation||u.report?.citation||"",E=u.title||u.shortTitle||u.name||u.bill?.title||u.report?.title||"",T=i(u)||l(u)||c(u),x=u.PublishDate?`Congressional Record \u2014 ${u.PublishDate}`:"",F=T||x||v,P=u.latestAction?.actionDate||u.latestAction?.actionDateTime||u.actionDate||u.date,B=u.updateDate||u.updateDateIncludingText||u.updateDateTime||u.updatedDate,J=P?Date.parse(P):u.PublishDate?Date.parse(u.PublishDate):B?Date.parse(B):Date.now(),Wn=u.latestAction?.text||u.latestAction?.action||u.latestAction?.actionDesc||"",_=t.congressType||(u.type&&u.type.includes("AMDT")?"Amendment":"")||(u.type&&u.type.includes("RPT")?"Committee Report":"")||(u.citation&&u.citation.startsWith("PN")?"Nomination":"")||(u.topic?"Treaty":"")||(u.Links?"Congressional Record":"")||(u.jacketNumber||u.chamber?"Hearing":"")||"Bill";(n(E)||String(E).toLowerCase().includes("untitled"))&&(_==="Hearing"?E=C(u):_==="Committee Report"?E=c(u)||`Committee Report ${v||""}`.trim():_==="Amendment"?E=l(u)||`Amendment ${v||""}`.trim():_==="Nomination"?E=k(u)||u.citation||`Nomination ${v||""}`.trim():_==="Treaty"?E=u.topic?`${u.topic} Treaty`:`Treaty ${v||""}`.trim():_==="Congressional Record"?E=u.PublishDate?`Congressional Record ${u.PublishDate}`:"Congressional Record":E=i(u)||`Bill ${v||""}`.trim());let Jn=(F&&E&&E!==F?`${F} \u2014 ${E}`:E||F)||"Untitled",ae=Wn||u.summary||u.description||u.action||"";if(!ae){if(_==="Bill"){let Z=u.originChamber||u.chamber||"",oe=i(u)||`${u.type||""} ${u.number||""}`.trim();ae=[Z,oe,u.latestAction?.actionDate].filter(Boolean).join(" \u2022 ")}else if(_==="Amendment")ae=u.purpose?`Purpose: ${u.purpose}`:l(u)||"Amendment";else if(_==="Committee Report"){let Z=u.citation||c(u),oe=u.part?`Part ${u.part}`:"";ae=[u.chamber,Z,oe].filter(Boolean).join(" \u2022 ")}else if(_==="Hearing"){let Z=u.hearingTitle||u.meetingTitle||u.title||"",oe=u.number?`Hearing ${u.number}`:"",en=u.jacketNumber?`Jacket ${u.jacketNumber}`:"",_r=u.committeeName||"",Ur=u.date?re(u.date):"";ae=[_r,u.chamber,Z,oe,en,Ur].filter(Boolean).join(" \u2022 ")}else if(_==="Nomination")ae=u.description||(u.organization?`Organization: ${u.organization}`:"Nomination");else if(_==="Treaty"){let Z=u.transmittedDate?`Transmitted ${re(u.transmittedDate)}`:"";ae=[u.topic||"Treaty",Z].filter(Boolean).join(" \u2022 ")}else if(_==="Congressional Record"){let Z=u.Issue?`Issue ${u.Issue}`:"",oe=u.Volume?`Volume ${u.Volume}`:"",en=u.Session?`Session ${u.Session}`:"";ae=[Z,oe,en].filter(Boolean).join(" \u2022 ")}}ae||(ae=[u.chamber,u.organization,u.topic,u.purpose].filter(Boolean).join(" \u2022 "));let Nr=a(u.url&&String(u.url).includes("api.congress.gov")?u.url:u.link&&String(u.link).includes("api.congress.gov")?u.link:""),z=u.url||u.link||u.links?.self||u.bill?.url||u.report?.url||"";u.Links?z=M(u):u.type&&(u.type.includes("AMDT")||u.amendmentNumber)?z=d(u)||z:u.type&&u.type.includes("RPT")?z=g(u)||z:u.citation&&u.citation.startsWith("PN")?z=b(u)||z:u.topic&&(u.congressReceived||u.congressConsidered)?z=S(u)||z:u.jacketNumber||u.chamber?z=A(u)||z:(u.type||u.billNumber||u.bill?.number)&&(z=y(u)||z);let Fr=z&&!m(z)?z:"",Pr=z||"",Xt=u.congress||u.bill?.congress||u.congressReceived||u.congressConsidered||"",Br=u.billType||u.bill?.type||(_==="Bill"?u.type:"")||"",Dr=u.billNumber||u.bill?.number||(_==="Bill"?u.number:"")||"",$r=_==="Amendment"&&(u.type||u.amendmentType)||"",Or=_==="Amendment"&&(u.number||u.amendmentNumber)||"",Zn=[],G=(Z,oe)=>{oe&&Zn.push({label:Z,value:String(oe)})};if(G("Type",_),G("Chamber",u.originChamber||u.chamber||u.committeeName),G("Congress",Xt?`${Xt}th Congress`:""),G("Number",v),G("Jacket",u.jacketNumber),G("Citation",u.citation||u.report?.citation),G("Committee",u.committeeName||u.committees?.[0]?.name),_==="Hearing"&&(G("Hearing Title",u.hearingTitle||u.meetingTitle||u.title||u.topic||""),G("Meeting Type",u.meetingType||u.type),G("Hearing Date",u.date?re(u.date):""),G("Event ID",u.eventId||u.meetingId||"")),G("Topic",u.topic),G("Organization",u.organization),_==="Nomination"){let Z=k(u);Z&&G("Nominee",Z)}G("Latest Action",Wn),G("Action Date",P?re(P):""),G("Updated",B?re(B):""),G("Source ID",u.systemCode||u.billId||u.reportId||u.hearingId);let Rr=_==="Nomination"?f(u):"";return{title:Jn,url:"",externalUrl:Fr,fallbackUrl:Pr,apiUrl:Nr,summary:ae,publishedAt:Number.isNaN(J)?Date.now():J,source:"Congress.gov",category:t.category,alertType:_,detailTitle:Jn,detailFields:Zn,congress:Xt,billType:Br,billNumber:Dr,amendmentType:$r,amendmentNumber:Or,nominationId:Rr,location:u.originChamber||u.committeeName||u.chamber||u.organization||u.latestAction?.actionType||""}})},cn=(e,t)=>{let n=Array.isArray(e?.series)?e.series:[];if(n.length){let s=n.flatMap(i=>{if(!Array.isArray(i.data)||!i.data.length)return[];let l=i.name||i.series_id||"EIA Series Update",c=i.units?` ${i.units}`:"",p=i.data[0],m=i.data[1],y=m?Number(p[1])-Number(m[1]):null,d=m&&Number(m[1])?y/Number(m[1])*100:null;return i.data.slice(0,4).map(([g,f],h)=>{let b=f!=null?q(f):"--";return{title:h===0?l:`${l} (${g})`,url:i.link||t.docsUrl||t.url,summary:`${g||"Latest"}: ${b}${c}`,publishedAt:Date.now()-h*3600*1e3,source:"EIA",category:t.category,value:Number(f),unit:i.units||"",delta:h===0?y:null,deltaPct:h===0?d:null}})});if(s.length)return s}let a=e?.response;if(a&&Array.isArray(a.data)&&a.data.length){let s=a.description||a.series_id||e.series_id||"EIA Series Update";return a.data.slice(0,4).map((i,l)=>{let c=i.period||i.date||i.timestamp||i.time,p=i.value??i.price??i.data;if(p===void 0&&i){let y=Object.keys(i).find(d=>!["period","date","timestamp","time","series","series_id"].includes(d));p=i[y]}let m=p!=null?q(p):"--";return{title:l===0?s:`${s} (${c})`,url:t.docsUrl||t.url,summary:`${c||"Latest"}: ${m}`,publishedAt:Date.now()-l*3600*1e3,source:"EIA",category:t.category,value:Number(p)}})}return[]},ko=(e,t)=>{let n=Array.isArray(e)?e:e?.markets||e?.data||[];if(!Array.isArray(n)||!n.length)return[];let a=l=>{let c=Number(l);return Number.isFinite(c)?c:null},s=l=>{if(!l)return[];if(Array.isArray(l))return l;try{let c=JSON.parse(l);return Array.isArray(c)?c:[]}catch{return[]}};return[...n].sort((l,c)=>{let p=a(l.volume24hr??l.volume)||0;return(a(c.volume24hr??c.volume)||0)-p}).slice(0,60).map(l=>{let c=s(l.outcomes),p=s(l.outcomePrices),m=c.findIndex(E=>String(E).toLowerCase()==="yes"),y=m>=0?m:0,d=p[y]!==void 0?Number(p[y]):null,g=a(l.bestBid),f=a(l.bestAsk),h=Number.isFinite(g)&&Number.isFinite(f)?(g+f)/2:null,b=Number.isFinite(h)?h:a(l.lastTradePrice),k=Number.isFinite(d)?d:b,C=Number.isFinite(k)?Math.round(k*100):null,S=c[y]||"Yes",A=a(l.volume24hr)||a(l.volume24hrClob)||a(l.volume)||0,M=a(l.liquidity)||a(l.liquidityClob)||0,w=a(l.oneDayPriceChange),I=[];C!==null&&I.push(`${S}: ${C}%`),A&&I.push(`24h Vol ${Q(A)}`),M&&I.push(`Liq ${Q(M)}`);let u=l.endDate||l.endDateIso;u&&I.push(`Ends ${new Date(u).toLocaleDateString("en-US")}`);let v=l.updatedAt||l.createdAt||l.startDate||l.endDate;return{title:l.question||l.title||"Polymarket Market",url:l.slug?`https://polymarket.com/market/${l.slug}`:"https://polymarket.com/",summary:I.join(" \u2022 "),publishedAt:v?Date.parse(v):Date.now(),source:"Polymarket",category:t.category,value:C!==null?C:null,alertType:"Prediction",volume24:A,liquidity:M,probability:C,outcomeLabel:S,change24h:w}})},Eo=(e,t)=>{if(!e)return[];let n=Wa(e);if(n.length<2)return[];let a=n[0].map(l=>l.trim().toLowerCase()),s=l=>a.indexOf(l),i=(l,c)=>{let p=s(c);return p>=0?l[p]:""};return n.slice(1,101).map(l=>{let c=i(l,"id"),p=i(l,"name"),m=i(l,"location"),y=i(l,"threat")||"Oil",d=i(l,"commodity"),g=i(l,"open_date"),f=Number(i(l,"lat")),h=Number(i(l,"lon"));if(!Number.isFinite(f)||!Number.isFinite(h))return null;let b=[];return y&&b.push(y),d&&b.push(d),m&&b.push(m),{title:p||"Incident",url:c?`https://incidentnews.noaa.gov/incident/${c}`:"https://incidentnews.noaa.gov/",summary:b.join(" \u2022 "),publishedAt:g?Date.parse(g):Date.now(),source:"NOAA IncidentNews",category:t.category,geo:{lat:f,lon:h},alertType:y||"Spill",location:m,severity:y}}).filter(Boolean)},Ja=(e,t)=>{if(!e)return[];let n=e.trim().split(/\r?\n/);if(n.length<2)return[];let a=n[0].split(",").map(m=>m.trim()),s=n[1].split(",").map(m=>m.trim());if(s.length<a.length)return[];let i=a.reduce((m,y,d)=>(m[y]=s[d],m),{});if(!i.Symbol||!i.Close||i.Close==="N/D")return[];let l=Number(i.Close);if(!Number.isFinite(l))return[];let c=Number(i.Open),p=Number.isFinite(c)&&c?(l-c)/c*100:null;return[{title:`${i.Symbol} Price`,url:`https://stooq.com/q/?s=${encodeURIComponent(i.Symbol.toLowerCase())}`,summary:`Close ${q(l)} | ${i.Date||"Latest"} ${i.Time||""}`.trim(),publishedAt:Date.now(),source:"Stooq",category:t.category,value:l,deltaPct:p,symbol:i.Symbol}]},ht={"gdelt-doc":(e,t)=>(e.articles||[]).map(n=>({title:n.title,url:n.url,summary:n.seen||"",publishedAt:n.seendate?Date.parse(n.seendate):Date.now(),source:n.domain||n.sourceCountry||t.name,category:t.category})),"gdelt-conflict-geo":wo,"ucdp-candidate-events":Co,"federal-register":ua,"federal-register-transport":ua,"congress-api":Ae,"congress-amendments":Ae,"congress-reports":Ae,"congress-hearings":Ae,"congress-nominations":Ae,"congress-treaties":Ae,"congress-record":Ae,"nws-alerts":(e,t)=>(e.features||[]).map(n=>({title:n.properties.event,url:n.properties.uri,summary:n.properties.headline,publishedAt:Date.parse(n.properties.sent)||Date.now(),source:"NWS",category:t.category,geo:$n(n.geometry),severity:n.properties.severity,location:n.properties.areaDesc,alertType:n.properties.event})),"usgs-quakes-hour":(e,t)=>da(e,t),"usgs-quakes-day":(e,t)=>da(e,t),"eonet-events":(e,t)=>(e.events||[]).map(n=>({title:n.title,url:n.link,summary:n.description||"",publishedAt:n.geometry?.[0]?.date?Date.parse(n.geometry[0].date):Date.now(),source:"NASA EONET",category:t.category,geo:n.geometry?.[0]?{lat:n.geometry[0].coordinates[1],lon:n.geometry[0].coordinates[0]}:null})),"swpc-json":(e,t)=>{if(!Array.isArray(e)||!e.length)return[];let n=e[e.length-1],a=n.speed??n.vsw??n.VSW,s=n.density??n.proton_density??n.DENSITY,i=n.temperature??n.TEMP,l=[];return a&&l.push(`Speed ${q(a)} km/s`),s&&l.push(`Density ${q(s)} p/cm3`),i&&l.push(`Temp ${q(i)} K`),[{title:"SWPC Solar Wind (1m)",url:"https://services.swpc.noaa.gov/json/",summary:l.length?l.join(" | "):"Solar wind updated.",publishedAt:n.time_tag?Date.parse(n.time_tag):Date.now(),source:"NOAA SWPC",category:t.category,alertType:"Solar Wind"}]},"swpc-kp":(e,t)=>{if(!Array.isArray(e)||!e.length)return[];let n=e[e.length-1],a=Number(n.kp_index??n.kp);if(!Number.isFinite(a))return[];let s="Quiet";a>=5?s="Storm":a>=4&&(s="Active");let i=`Kp ${a.toFixed(1)} (${s})`;return[{title:"Geomagnetic Kp Index",url:"https://www.swpc.noaa.gov/products/planetary-k-index",summary:i,publishedAt:n.time_tag?Date.parse(n.time_tag):Date.now(),source:"NOAA SWPC",category:t.category,severity:i,alertType:"Geomagnetic"}]},"energy-eia":cn,"energy-eia-brent":cn,"energy-eia-ng":cn,"acled-events":vo,"warspotting-losses":So,"polymarket-markets":ko,"noaa-incidentnews":Eo,"stooq-quote":Ja,"transport-opensky":(e,t)=>{let n=Array.isArray(e?.states)?e.states:[];if(!n.length)return[];let a=n.filter(p=>Number.isFinite(p?.[5])&&Number.isFinite(p?.[6])),s=r.settings.scope;if(s==="us"){let p=je();p?.bbox&&(a=a.filter(m=>At(m?.[6],m?.[5],p)))}else if(s==="local"){let{lat:p,lon:m}=r.location,y=r.settings.radiusKm||200;a=a.filter(d=>yt(p,m,d?.[6],d?.[5])<=y)}let l=Ms(a,s==="global"?240:s==="us"?160:80),c=e?.time?e.time*1e3:Date.now();return l.map(p=>{let m=p?.[0]||"",d=(p?.[1]||"").toString().trim()||m||"Flight",g=p?.[2]||"",f=Number.isFinite(p?.[9])?p[9]:null,h=Number.isFinite(f)?`${Math.round(f*3.6)} km/h`:null,b=Number.isFinite(p?.[7])?p[7]:null,k=Number.isFinite(b)?`${Math.round(b*3.28084)} ft`:null,C=Number.isFinite(p?.[10])?Math.round(p[10]):null,S=!!p?.[8],A=[h,k].filter(Boolean);return{title:`${d} \u2022 ${g||"Unknown"}`,url:m?`https://opensky-network.org/api/tracks/all?icao24=${encodeURIComponent(m)}`:"https://opensky-network.org/",summary:A.length?A.join(" | "):"Airborne signal",publishedAt:p?.[4]?p[4]*1e3:c,source:"OpenSky",category:t.category,geo:{lat:p[6],lon:p[5]},icao24:m,callsign:d,originCountry:g,velocity:f,altitude:b,heading:C,onGround:S,alertType:"Flight"}})},"coinpaprika-global":(e,t)=>[{title:`Global Market Cap: $${q(e.market_cap_usd)}`,url:"https://coinpaprika.com",summary:`24h Volume $${q(e.volume_24h_usd)} | Dominance BTC ${e.bitcoin_dominance_percentage?.toFixed(2)}%`,publishedAt:Date.now(),source:"CoinPaprika",category:t.category,value:Number(e.market_cap_usd),secondaryValue:Number(e.volume_24h_usd),dominance:Number(e.bitcoin_dominance_percentage)}],"coinpaprika-tickers":(e,t)=>e.slice(0,10).map(n=>({title:`${n.name} (${n.symbol})`,url:`https://coinpaprika.com/coin/${n.id}/`,summary:`Price $${n.quotes.USD.price.toFixed(2)} | 24h ${n.quotes.USD.percent_change_24h?.toFixed(2)}%`,publishedAt:Date.now(),source:"CoinPaprika",category:t.category,value:Number(n.quotes.USD.price),change24h:Number(n.quotes.USD.percent_change_24h),symbol:n.symbol})),"blockstream-mempool":(e,t)=>[{title:`Bitcoin Mempool: ${q(e.count)} tx`,url:"https://blockstream.info",summary:`vSize ${q(e.vsize)} | Fees ${q(e.total_fee)} sat`,publishedAt:Date.now(),source:"Blockstream",category:t.category}],"openaq-api":(e,t)=>{let n=Array.isArray(e?.results)?e.results:[];return n.length?n.slice(0,12).map(a=>{let s=a.coordinates||{},i=Number(s.latitude??s.lat),l=Number(s.longitude??s.lon),c=Number.isFinite(i)&&Number.isFinite(l),p=a.locality||a.city||a.name,m=a.country?.name||a.country?.code||a.country,y=a.provider?.name||a.provider||"OpenAQ",d=Array.isArray(a.parameters)?a.parameters.map(f=>f.name||f.parameter).filter(Boolean):[],g=[];return m&&g.push(m),d.length&&g.push(`Sensors: ${d.slice(0,4).join(", ")}`),{title:p?`${p}`:"Air Quality Station",url:a.id?`https://openaq.org/locations/${a.id}`:"https://openaq.org/",summary:g.length?g.join(" | "):"Air quality station update.",publishedAt:a.updatedAt?Date.parse(a.updatedAt):Date.now(),source:y,category:t.category,alertType:"Air Quality",regionTag:m,geo:c?{lat:i,lon:l}:null,mapOnly:!0}}):[]},"foia-api":(e,t)=>{let n=Array.isArray(e?.result?.results)?e.result.results:null;if(n)return n.slice(0,12).map(s=>({title:s.title||s.name||"FOIA Dataset",url:s.url||(s.name?`https://catalog.data.gov/dataset/${s.name}`:""),summary:s.notes||"",publishedAt:s.metadata_modified?Date.parse(s.metadata_modified):Date.now(),source:s.organization?.title||"Data.gov",category:t.category}));let a=Array.isArray(e?.data)?e.data:[];return a.length?a.slice(0,12).map(s=>({title:s.attributes?.name||s.attributes?.title||"FOIA Component",url:s.links?.self||"https://www.foia.gov/developer/",summary:s.attributes?.description||"",publishedAt:Date.parse(s.attributes?.updated_at||s.attributes?.created_at)||Date.now(),source:"FOIA.gov",category:t.category})):[]},"treasury-debt":(e,t)=>(e.data||[]).map(n=>({title:`Debt to the Penny (${n.record_date})`,url:"https://fiscaldata.treasury.gov/",summary:`Total: $${q(n.tot_pub_debt_out_amt||n.total_public_debt_outstanding_amt)} | Intragov: $${q(n.intragov_hold_amt||n.intragovernmental_holdings)}`,publishedAt:Date.parse(n.record_date)||Date.now(),source:"US Treasury",category:t.category,value:Number(n.tot_pub_debt_out_amt||n.total_public_debt_outstanding_amt),secondaryValue:Number(n.intragov_hold_amt||n.intragovernmental_holdings)})),"bls-cpi":(e,t)=>{let n=e.Results?.series?.[0]?.data?.[0];return n?[{title:`CPI (CUUR0000SA0) ${n.periodName} ${n.year}`,url:"https://www.bls.gov/",summary:`Value ${n.value}`,publishedAt:Date.now(),source:"BLS",category:t.category,value:Number(n.value)}]:[]},"cisa-kev":(e,t)=>(e.vulnerabilities||[]).slice(0,8).map(n=>({title:`${n.cveID} | ${n.vendorProject}`,url:"https://www.cisa.gov/known-exploited-vulnerabilities-catalog",summary:`${n.product} | Due ${n.dueDate}`,publishedAt:Date.parse(n.dateAdded)||Date.now(),source:"CISA KEV",category:t.category,alertType:"Known Exploited",deadline:n.dueDate,severity:n.knownRansomwareCampaignUse&&n.knownRansomwareCampaignUse!=="Unknown"?"Ransomware":"Exploited"}))};function da(e,t){return(e.features||[]).map(n=>({title:`${n.properties.mag.toFixed(1)}M - ${n.properties.place}`,url:n.properties.url,summary:`Depth ${n.geometry.coordinates[2]} km`,publishedAt:n.properties.time||Date.now(),source:"USGS",category:t.category,magnitude:n.properties.mag,severity:(()=>{let a=n.properties.mag;if(a==null)return null;let s=Ls.find(i=>a>=i.min);return s?`Magnitude ${a.toFixed(1)} (${s.label})`:`Magnitude ${a.toFixed(1)}`})(),location:n.properties.place,alertType:"Earthquake",geo:{lat:n.geometry.coordinates[1],lon:n.geometry.coordinates[0]}}))}function $n(e){if(!e||!e.coordinates)return null;if(e.type==="Point")return{lat:e.coordinates[1],lon:e.coordinates[0]};if(e.type==="MultiPoint"){let a=e.coordinates;return a?.length?{lat:a[0][1],lon:a[0][0]}:null}if(e.type==="LineString"){let a=e.coordinates;if(!a?.length)return null;let s=a[Math.floor(a.length/2)];return{lat:s[1],lon:s[0]}}if(e.type==="MultiLineString"){let a=e.coordinates?.[0];if(!a?.length)return null;let s=a[Math.floor(a.length/2)];return{lat:s[1],lon:s[0]}}let t=e.type==="Polygon"?e.coordinates[0]:e.type==="MultiPolygon"?e.coordinates[0][0]:null;if(!t||!t.length)return null;let n=t.reduce((a,s)=>(a.lat+=s[1],a.lon+=s[0],a),{lat:0,lon:0});return{lat:n.lat/t.length,lon:n.lon/t.length}}function q(e){if(e==null)return"--";let t=Number(e);return Number.isNaN(t)?e:t.toLocaleString("en-US",{maximumFractionDigits:2})}function re(e){if(!e)return"--";let t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function On(e){return e&&new DOMParser().parseFromString(e,"text/html").documentElement.textContent||""}function Je(e){if(!e)return"";let t=e;return(t.includes("&lt;")||t.includes("&gt;"))&&(t=On(t)),new DOMParser().parseFromString(`<div>${t}</div>`,"text/html").body.textContent||""}function Y(e,t){if(!e)return"";if(e.length<=t)return e;let n=e.slice(0,t),a=n.lastIndexOf(" ");return`${n.slice(0,a>80?a:t).trim()}\u2026`}function ma(e,t){let n=t&&t!==e?t:e;if(!n)return{summary:e||"",summaryHtml:""};let a=n;return(n.includes("&lt;")||n.includes("&gt;"))&&(a=On(n)),a.includes("<")&&a.includes(">")?{summary:Je(a).replace(/\s+/g," ").trim()||e||"",summaryHtml:a}:{summary:e||a,summaryHtml:""}}function Za(e){return e?(e in r.listLimits||(r.listLimits[e]=ys[e]??6),r.listLimits[e]):6}function Ln(e){if(!e)return"";let t=e;(t.includes("&lt;")||t.includes("&gt;"))&&(t=On(t));let a=new DOMParser().parseFromString(`<div>${t}</div>`,"text/html"),s=a.body.firstElementChild;if(!s)return"";let i=l=>{if(l.nodeType===Node.TEXT_NODE)return;if(l.nodeType!==Node.ELEMENT_NODE){l.remove();return}let c=l.tagName.toLowerCase();if(!ls.has(c)){let p=a.createTextNode(l.textContent||"");l.replaceWith(p);return}[...l.attributes].forEach(p=>{c==="a"&&p.name==="href"||l.removeAttribute(p.name)}),c==="a"&&(l.setAttribute("target","_blank"),l.setAttribute("rel","noopener noreferrer")),[...l.childNodes].forEach(i)};return[...s.childNodes].forEach(i),s.innerHTML}function Rn(e,t={}){return Number.isFinite(e)?new Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:2,...t}).format(e):"--"}function Q(e){return Number.isFinite(e)?`$${Rn(e)}`:"--"}function fe(e){return`${e.type}:${e.lookup}`}function Va(e){return Number.isFinite(e.value)?e.isIndex?Rn(e.value):Q(e.value):"--"}function un(e=""){if(!e)return"";let t=e.split("|");return t.length<2?"":t[1].trim()}function Ao(){let e=r.settings.tickerWatchlist||[];if(!e.length&&!r.customTickers.length)return[];let t=new Map;return r.customTickers.forEach(n=>{let a=fe({type:n.type,lookup:n.lookup||n.symbol||n.label||""});t.set(a,n)}),e.map(n=>{let a=fe(n),s=t.get(a);if(!s)return{text:`${n.label||n.symbol}: --`,url:n.url||"",change:null,pending:!0};let i=Va(s),l=Number.isFinite(s.delta)?`${s.delta>0?"+":""}${s.delta.toFixed(2)}%`:"",c=[`${s.label}: ${i}`];return l&&c.push(`24h ${l}`),{text:c.join(" | "),url:s.url,change:s.delta}})}function To(e){return e.trim().replace(/\s+/g,"").replace(/[^a-zA-Z0-9.^-]/g,"").toUpperCase()}async function Io(e,t){if(!r.settings.aiTranslate||!ue())return null;let n=`Return the best ${e==="market"?"market index":"equity"} ticker symbol for "${t}". Use ^ prefix for indices. Return only the symbol or UNKNOWN.`;try{let s=(await Ze({messages:[{role:"user",content:n}],context:{mode:"ticker_resolve",type:e},temperature:0})||"").split(/\s+/)[0].replace(/[^a-zA-Z0-9.^-]/g,"").toUpperCase();return!s||s.includes("UNKNOWN")?null:s}catch{return null}}async function Mo(e,t){let n=t.trim();if(!n)return null;if(e==="crypto"){let c=await(await fetch(`https://api.coinpaprika.com/v1/search/?q=${encodeURIComponent(n)}&c=currencies`)).json();if(!c?.currencies?.length)return null;let p=n.replace(/\s+/g,"").toLowerCase(),m=c.currencies.find(y=>y.symbol?.toLowerCase()===p)||c.currencies[0];return m?{type:"crypto",symbol:m.symbol,label:`${m.name} (${m.symbol})`,lookup:m.id,source:"CoinPaprika"}:null}let a=To(n);if(!a)return null;if((/\s/.test(n)||n.length>6)&&ue()){let l=await Io(e,n);l&&(a=l)}let s=e==="market"||a.startsWith("^"),i=a;return e==="market"&&!a.startsWith("^")&&(i=`^${a}`,a=`^${a}`),!i.includes(".")&&!i.startsWith("^")&&(i=`${i}.US`),{type:e==="market"?"market":"equity",symbol:a,label:a,lookup:i.toLowerCase(),isIndex:s,source:"Stooq"}}async function Ct(e){let t=r.feeds.find(a=>a.id==="stooq-quote");if(!t)return null;if($()){let a=`https://stooq.com/q/l/?s=${encodeURIComponent(e)}&f=sd2t2ohlcv&h&e=csv`,s=["allorigins","jina"];for(let i of s)try{let l=Un(a,i),c=await fetch(l);if(!c.ok)continue;let p=await c.text(),m=Ja(p,t);if(m?.[0])return m[0]}catch{}return null}return(await He(t,e,!0)).items?.[0]||null}async function xo(e){let n=await(await fetch(`https://api.coinpaprika.com/v1/tickers/${e}`)).json();return!n||!n.quotes?.USD?null:{value:Number(n.quotes.USD.price),delta:Number(n.quotes.USD.percent_change_24h),url:`https://coinpaprika.com/coin/${n.id}/`,name:n.name,symbol:n.symbol}}function kn(){document.querySelectorAll("[data-watchlist]").forEach(t=>{t.innerHTML="";let n=r.settings.tickerWatchlist||[];if(!n.length){let a=document.createElement("div");a.className="ticker-builder-hint",a.textContent="No custom tickers yet.",t.appendChild(a);return}n.forEach(a=>{let s=document.createElement("div");s.className=`ticker-chip ${a.type}`;let i=document.createElement("span");i.textContent=a.label||a.symbol;let l=document.createElement("button");l.className="ticker-remove",l.type="button",l.textContent="\xD7",l.dataset.key=fe(a),s.appendChild(i),s.appendChild(l),t.appendChild(s)})})}async function pa(){if($()&&!r.settings.superMonitor)try{let s=await fetch(be(`/data/energy-market.json?ts=${Date.now()}`),{cache:"no-store"});if(s.ok){let i=await s.json();if(i?.items){r.energyMarket=i.items;return}}}catch{}let[e,t,n]=await Promise.all([Ct("cl.f"),Ct("ng.f"),Ct("xauusd")]),a={};e?.value&&(a.wti={label:"WTI Crude",value:e.value,delta:Number.isFinite(e.deltaPct)?e.deltaPct:null,url:e.url,asOf:un(e.summary||""),symbol:e.symbol}),t?.value&&(a.gas={label:"Nat Gas",value:t.value,delta:Number.isFinite(t.deltaPct)?t.deltaPct:null,url:t.url,asOf:un(t.summary||""),symbol:t.symbol}),n?.value&&(a.gold={label:"Gold",value:n.value,delta:Number.isFinite(n.deltaPct)?n.deltaPct:null,url:n.url,asOf:un(n.summary||""),symbol:n.symbol}),r.energyMarket=a}async function _n(){let e=r.settings.tickerWatchlist||[];if(!e.length){r.customTickers=[],kn(),await pa();return}let t=await Promise.all(e.map(async n=>{if(n.type==="crypto"){let s=await xo(n.lookup);return!s||!Number.isFinite(s.value)?null:{label:n.label||`${s.name} (${s.symbol})`,value:s.value,delta:Number.isFinite(s.delta)?s.delta:null,url:s.url,type:n.type,isIndex:!1,lookup:n.lookup,symbol:n.symbol}}let a=await Ct(n.lookup);return!a||!Number.isFinite(a.value)?null:{label:n.label||a.symbol||n.symbol,value:a.value,delta:Number.isFinite(a.deltaPct)?a.deltaPct:null,url:a.url,type:n.type,isIndex:n.isIndex||n.symbol?.startsWith("^")||a.symbol?.startsWith("^"),lookup:n.lookup,symbol:n.symbol||a.symbol}}));r.customTickers=t.filter(Boolean),kn(),await pa()}function Pe(e,t,n){let a=e.querySelector(".ticker-builder-status");a&&(a.textContent=t||"",a.classList.remove("error","success"),n&&a.classList.add(n))}async function ga(e){let t=e.querySelector(".ticker-type"),n=e.querySelector(".ticker-query");if(!t||!n)return;let a=t.value,s=n.value.trim();if(s){Pe(e,"Searching...",null);try{let i=await Mo(a,s);if(!i){Pe(e,"No match found. Try a symbol like AAPL, ^SPX, BTC.","error");return}let l=fe(i);if((r.settings.tickerWatchlist||[]).some(m=>fe(m)===l)){Pe(e,"Already in watchlist.","error");return}r.settings.tickerWatchlist=[...r.settings.tickerWatchlist||[],i],D(),n.value="",Pe(e,"Added. Fetching quote\u2026","success"),await _n();let p=r.customTickers.some(m=>fe({type:m.type,lookup:m.lookup||m.symbol||m.label||""})===l);Pe(e,p?"Added to watchlist.":"Added, quote pending. Will refresh shortly.",p?"success":"error"),Nt(),zt()}catch{Pe(e,"Unable to add ticker right now.","error")}}}function No(e){r.settings.tickerWatchlist=(r.settings.tickerWatchlist||[]).filter(t=>fe(t)!==e),D(),_n().then(()=>{Nt(),zt()})}function Fo(){let e=K(r.items),t=w=>e.filter(I=>I.feedId===w),n=w=>t(w)[0],a=w=>t("coinpaprika-tickers").find(I=>I.symbol===w),s=[],i=n("treasury-debt");i?.value&&s.push({label:"US Debt",value:Q(i.value),meta:i.secondaryValue?`Intragov ${Q(i.secondaryValue)}`:"",source:i.source,url:i.url,category:"finance"});let l=n("bls-cpi");l?.value&&s.push({label:"CPI",value:Rn(l.value),meta:l.title.replace("CPI (CUUR0000SA0) ",""),source:l.source,url:l.url,category:"finance"});let c=r.energyMarket?.wti,p=n("energy-eia");if(c?.value||p?.value){let w=c?.value?c:p,I=c?.value?c.asOf?`Market ${c.asOf}`:"Market":p.summary.split(":")[0];s.push({label:"WTI Crude",value:Q(w.value),meta:I,delta:Number.isFinite(w.delta??w.deltaPct)?w.delta??w.deltaPct:null,source:w.source||(c?.value?"Stooq":p.source),url:w.url||p.url,category:"energy"})}let m=n("energy-eia-brent");m?.value&&s.push({label:"Brent",value:Q(m.value),meta:m.summary.split(":")[0],delta:Number.isFinite(m.deltaPct)?m.deltaPct:null,source:m.source,url:m.url,category:"energy"});let y=r.energyMarket?.gas,d=n("energy-eia-ng");if(y?.value||d?.value){let w=y?.value?y:d,I=y?.value?y.asOf?`Market ${y.asOf}`:"Market":d.summary.split(":")[0];s.push({label:"Nat Gas",value:Q(w.value),meta:I,delta:Number.isFinite(w.delta??w.deltaPct)?w.delta??w.deltaPct:null,source:w.source||(y?.value?"Stooq":d.source),url:w.url||d.url,category:"energy"})}let g=r.energyMarket?.gold;g?.value&&s.push({label:"Gold",value:Q(g.value),meta:g.asOf?`Market ${g.asOf}`:"Market",delta:Number.isFinite(g.delta)?g.delta:null,source:g.source||"Stooq",url:g.url,category:"finance"});let f=n("coinpaprika-global");f?.value&&s.push({label:"Crypto Mkt Cap",value:Q(f.value),meta:f.dominance?`BTC Dom ${f.dominance.toFixed(2)}%`:"",source:f.source,url:f.url,category:"crypto"});let h=a("BTC");h?.value&&s.push({label:"Bitcoin",value:Q(h.value),delta:Number.isFinite(h.change24h)?h.change24h:null,meta:"24h",source:h.source,url:h.url,category:"crypto"});let b=a("ETH");b?.value&&s.push({label:"Ethereum",value:Q(b.value),delta:Number.isFinite(b.change24h)?b.change24h:null,meta:"24h",source:b.source,url:b.url,category:"crypto"});let k=r.settings.tickerWatchlist||[],C=new Map;r.customTickers.forEach(w=>{let I=fe({type:w.type,lookup:w.lookup||w.symbol||w.label||""});C.set(I,w)});let S=k.map(w=>{let I=fe(w),u=C.get(I);return u?{label:u.label||u.symbol,value:Va(u),meta:u.type==="crypto"?"24h":"Session",delta:Number.isFinite(u.delta)?u.delta:null,url:u.url,category:u.type==="crypto"?"crypto":"finance"}:{label:w.label||w.symbol,value:"--",meta:"Awaiting quote",delta:null,url:w.url||"",category:w.type==="crypto"?"crypto":"finance"}}),A=new Set;return[...S,...s].filter(w=>{if(!w.label)return!1;let I=w.label.toLowerCase();return A.has(I)?!1:(A.add(I),!0)})}function Po(e,t,n="spotlight"){e&&(e.innerHTML="",t.forEach(a=>{let s=document.createElement("a");s.className=`finance-card ${n}`,Number.isFinite(a.delta)&&s.classList.add(a.delta>=0?"up":"down"),a.url&&(s.href=a.url,s.target="_blank",s.rel="noopener");let i=document.createElement("div");i.className="finance-label",i.textContent=a.label;let l=document.createElement("div");l.className="finance-value",l.textContent=a.value||"--";let c=document.createElement("div");c.className="finance-meta";let p=Number.isFinite(a.delta)?`${a.delta>0?"+":""}${a.delta.toFixed(2)}%`:"";c.textContent=[a.meta,p].filter(Boolean).join(" \u2022 "),s.appendChild(i),s.appendChild(l),s.appendChild(c),e.appendChild(s)}))}function zt(){if(!o.financeSpotlight)return;let e=Fo().slice(0,8);Po(o.financeSpotlight,e,"spotlight")}function Bo(e=tt){let t=new Date,n=new Date(t);return n.setDate(t.getDate()-Number(e||tt)),{start:n.toISOString().slice(0,10),end:t.toISOString().slice(0,10)}}function Qa(e){let t=Number(e);return Number.isFinite(t)?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(t):"--"}function ya(e){let t=Number(e);if(!Number.isFinite(t))return"--";let n=Math.abs(t);return n>=1e12?`${(t/1e12).toFixed(2)}T`:n>=1e9?`${(t/1e9).toFixed(2)}B`:n>=1e6?`${(t/1e6).toFixed(2)}M`:n>=1e3?`${(t/1e3).toFixed(1)}K`:Qa(t)}function Do(){if(!o.moneyFlowsRateNotice)return;let e=r.moneyFlowsData?.sources?.sam;if(!e||!e.error||!e.retryAt){o.moneyFlowsRateNotice.textContent="",o.moneyFlowsRateNotice.classList.remove("active");return}let t=new Date(e.retryAt),n=Number.isNaN(t.getTime())?"later":`${t.toLocaleDateString(void 0,{month:"short",day:"numeric"})} ${t.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}`;o.moneyFlowsRateNotice.textContent=`SAM rate limit reached \u2014 try again ${n}.`,o.moneyFlowsRateNotice.classList.add("active")}function Ye(){if(!o.moneyFlowsList)return;if(o.moneyFlowsMeta)if(!r.moneyFlowsQuery)o.moneyFlowsMeta.textContent="No query yet.";else if(r.moneyFlowsLoading)o.moneyFlowsMeta.textContent="Fetching money flows...";else if(r.moneyFlowsError)o.moneyFlowsMeta.textContent=`Error: ${r.moneyFlowsError}`;else{let s=r.moneyFlowsItems?.length||0,i=r.moneyFlowsData?.sources?Object.entries(r.moneyFlowsData.sources).map(([l,c])=>`${l}: ${c.count||0}${c.error?" (err)":""}`).join(" \u2022 "):"";o.moneyFlowsMeta.textContent=s?`Showing ${s} items${i?` \xB7 ${i}`:""}`:"No matching flows yet."}if(o.moneyFlowsSummary){let s=r.moneyFlowsData?.summary;if(!s)o.moneyFlowsSummary.innerHTML="";else{let i=s.buckets||{},l=[{id:"contributions",label:"Contributions In",tone:"money-tone-in"},{id:"spending",label:"Spending Out",tone:"money-tone-out"},{id:"lobbying",label:"Lobbying",tone:"money-tone-lobby"},{id:"registry",label:"SAM Registry",tone:"money-tone-registry"}],c=l.map(m=>Number(i[m.id]?.totalAmount||0)),p=Math.max(...c,1);o.moneyFlowsSummary.innerHTML=`
        <div class="summary-card money-summary-card">
          <div class="summary-label">Total items</div>
          <div class="summary-value">${s.totalItems||0}</div>
          <div class="summary-sub">Across all sources</div>
        </div>
        ${l.map(m=>{let y=i[m.id]||{},d=Number(y.totalAmount||0),g=y.count||0,f=Math.max(4,Math.round(d/p*100));return`
            <div class="summary-card money-summary-card ${m.tone}">
              <div class="summary-label">${m.label}</div>
              <div class="summary-value">${d?Qa(d):"\u2014"}</div>
              <div class="summary-sub">${g} items</div>
              <div class="money-bar"><span style="width:${d?f:6}%"></span></div>
            </div>
          `}).join("")}
      `}}Do();let e=r.moneyFlowsData?.summary,t=e?.buckets||{},n=e?.top||{},a=(s,i,{totalAmount:l,count:c,rows:p})=>{if(!s||!i)return;let m=Number(l)?ya(l):"\u2014";s.textContent=`${m} \xB7 ${c||0} items`,i.innerHTML=p.map(y=>{let d=y.value||"\u2014",g=Number.isFinite(y.amount)&&y.amount?ya(y.amount):"\u2014";return`
        <div class="money-rank">
          <div>
            <div class="money-rank-label">${y.label}</div>
            <div class="money-rank-value">${d}</div>
          </div>
          <div class="money-rank-amount">${g}</div>
        </div>
      `}).join("")};if(e?(a(o.moneyInMeta,o.moneyInBody,{totalAmount:t.contributions?.totalAmount||0,count:t.contributions?.count||0,rows:[{label:"Top donor",value:n.contributions?.donor,amount:n.contributions?.donorAmount},{label:"Top recipient",value:n.contributions?.recipient,amount:n.contributions?.recipientAmount}]}),a(o.moneyOutMeta,o.moneyOutBody,{totalAmount:t.spending?.totalAmount||0,count:t.spending?.count||0,rows:[{label:"Top recipient",value:n.spending?.recipient,amount:n.spending?.recipientAmount}]}),a(o.moneyLobbyMeta,o.moneyLobbyBody,{totalAmount:t.lobbying?.totalAmount||0,count:t.lobbying?.count||0,rows:[{label:"Top client",value:n.lobbying?.client,amount:n.lobbying?.clientAmount},{label:"Top registrant",value:n.lobbying?.registrant,amount:n.lobbying?.registrantAmount}]}),a(o.moneyRegistryMeta,o.moneyRegistryBody,{totalAmount:t.registry?.totalAmount||0,count:t.registry?.count||0,rows:[{label:"Top entity",value:n.registry?.entity,amount:n.registry?.entityAmount}]})):(o.moneyInMeta&&(o.moneyInMeta.textContent="\u2014"),o.moneyOutMeta&&(o.moneyOutMeta.textContent="\u2014"),o.moneyLobbyMeta&&(o.moneyLobbyMeta.textContent="\u2014"),o.moneyRegistryMeta&&(o.moneyRegistryMeta.textContent="\u2014"),o.moneyInBody&&(o.moneyInBody.innerHTML=""),o.moneyOutBody&&(o.moneyOutBody.innerHTML=""),o.moneyLobbyBody&&(o.moneyLobbyBody.innerHTML=""),o.moneyRegistryBody&&(o.moneyRegistryBody.innerHTML="")),r.moneyFlowsLoading){o.moneyFlowsList.innerHTML='<div class="list-item">Loading money flows...</div>';return}if(r.moneyFlowsError){o.moneyFlowsList.innerHTML='<div class="list-item">Unable to load money flows.</div>';return}ot(o.moneyFlowsList,r.moneyFlowsItems||[])}async function dn(){let e=o.moneyFlowsQuery?.value?.trim();if(!e){r.moneyFlowsError="Enter a query to search.",r.moneyFlowsLoading=!1,r.moneyFlowsItems=[],Ye();return}let t=Number(o.moneyFlowsRange?.value)||tt;r.moneyFlowsRangeDays=t,r.moneyFlowsQuery=e;let{start:n,end:a}=Bo(t),s=new URLSearchParams({q:e,start:n,end:a,limit:String(Qr)});r.moneyFlowsLoading=!0,r.moneyFlowsError=null,Ye();try{let{data:i,error:l}=await me(`/api/money-flows?${s.toString()}`,{},3e4);if(l)throw new Error(i?.message||l);r.moneyFlowsData=i,r.moneyFlowsItems=(i?.items||[]).map(c=>({...c,url:c.url||c.externalUrl||null})),r.moneyFlowsFetchedAt=i?.fetchedAt||Date.now()}catch(i){r.moneyFlowsError=i?.message||"Fetch failed.",r.moneyFlowsData=null,r.moneyFlowsItems=[]}finally{r.moneyFlowsLoading=!1,Ye(),tr(),Kt()}}function $o(e){let t=`${e.title||""} ${e.summary||""}`.replace(/https?:\/\/\S+/g,""),n=new Set,a=(e.location||e.geoLabel||"").trim();if(a){let m=a.split(";")[0].split(",").slice(0,2).join(",").trim();m&&n.add(m)}let s=(e.title||"").match(/Travel Advisory\s*[-]\s*([A-Za-z\s.'-]+)/i);s&&n.add(s[1].trim());let i=t.match(/([A-Z][A-Za-z.'-]+(?:\s+[A-Z][A-Za-z.'-]+){0,3}),\s*([A-Z]{2})/);i&&n.add(`${i[1]}, ${i[2]}`);let l=(e.title||"").match(/-\s*([A-Z][A-Za-z.'-]+(?:\s+[A-Z][A-Za-z.'-]+){0,3})$/);l&&n.add(l[1]);let c=/\b(?:in|near|at|outside|north of|south of|east of|west of)\s+([A-Z][A-Za-z.'-]+(?:\s+[A-Z][A-Za-z.'-]+){0,3})/g,p;for(;(p=c.exec(t))!==null;)n.add(p[1]);return[...n].filter(Boolean)}async function Oo(e,t=60){let n=e.filter(i=>i&&!i.geo&&i.category!=="crypto"&&i.category!=="finance"),a=new Set,s=!1;for(let i of n.slice(0,t)){let l=$o(i);for(let c of l){let p=c.toLowerCase();if(a.has(p))continue;a.add(p);let m=r.geoCache[p];if(m){if(!m.notFound&&m.lat){i.geo={lat:m.lat,lon:m.lon},i.geoLabel=m.displayName||c,s=!0;break}continue}try{let{data:y,error:d}=await me(`/api/geocode?q=${encodeURIComponent(c)}`);if(d||!y){r.geoCache[p]={query:c,notFound:!0},ln();continue}if(r.geoCache[p]=y,ln(),!y.notFound&&y.lat){i.geo={lat:y.lat,lon:y.lon},i.geoLabel=y.displayName||c,s=!0;break}}catch{r.geoCache[p]={query:c,notFound:!0},ln()}}}return s}async function He(e,t,n=!1){if(e.isCustom)return xt(e,t);if(e.id==="gpsjam")return _o(e,n);let a=new URLSearchParams,s=mt(e);try{let i,l;$()?(a.set("id",e.id),t&&a.set("query",t),n&&a.set("force","1"),l=await ve(`/api/feed?${a.toString()}`),i=await l.json()):(l=await ve("/api/feed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,query:t,force:!!n,key:s.key||void 0,keyParam:s.keyParam||void 0,keyHeader:s.keyHeader||void 0})}),i=await l.json());let c=i.httpStatus||l.status||0,p=i.error||(c>=400?`http_${c}`:null),m=i.message||(c>=400?`HTTP ${c}`:null),d=(p?[]:e.format==="rss"?Cn(i.body,e):Mt(i.body,e)).map(g=>({...g,tags:e.tags||[],feedId:e.id,feedName:e.name}));return{feed:e,items:d,error:p,errorMessage:m,httpStatus:c,fetchedAt:i.fetchedAt}}catch(i){return{feed:e,items:[],error:"fetch_failed",errorMessage:i.message,httpStatus:0,fetchedAt:Date.now()}}}function Ya(){return window.h3||window.h3js||window.h3Js||null}function Ro(e,t,n){let a=Ya();if(!a||!a.cellToLatLng&&!a.h3ToGeo)return{items:[],error:"h3_unavailable",errorMessage:"H3 library not available."};let i=Wa(String(e||"").trim()).filter(m=>m?.length>=3&&String(m[0]||"").trim().toLowerCase()!=="hex"),l=[];return i.map(m=>({hex:String(m[0]||"").trim(),good:Number(m[1]||0),bad:Number(m[2]||0)})).filter(m=>m.hex&&Number.isFinite(m.bad)&&m.bad>0).sort((m,y)=>y.bad-m.bad).slice(0,1200).forEach(m=>{let y=a.cellToLatLng?a.cellToLatLng(m.hex):a.h3ToGeo(m.hex);if(!y||y.length<2)return;let[d,g]=y;if(!Number.isFinite(d)||!Number.isFinite(g))return;let f=Number.isFinite(m.good)?m.good+m.bad:m.bad,h=f>0?Math.round(m.bad/f*100):null,b=n?Date.parse(n):Date.now(),k=[`Bad aircraft: ${m.bad}`];Number.isFinite(m.good)&&k.push(`Good aircraft: ${m.good}`),h!==null&&k.push(`Bad share: ${h}%`);let C=h!==null?h/140:Er(m.bad/400,.1,.35);l.push({title:"GPS Jamming Risk",url:n?`https://gpsjam.org/?lat=${d.toFixed(4)}&lon=${g.toFixed(4)}&z=6&date=${n}`:"https://gpsjam.org/",summary:k.join(" \u2022 "),summaryHtml:k.join(" \u2022 "),publishedAt:Number.isNaN(b)?Date.now():b,source:t.name,category:t.category,geo:{lat:d,lon:g},hex:m.hex,gpsBad:m.bad,gpsGood:m.good,gpsRatio:h,gpsIntensity:C,alertType:"GPS Jamming",severity:`${m.bad} affected aircraft`,mapOnly:!0,tags:t.tags||[],feedId:t.id,feedName:t.name})}),{items:l,error:null,errorMessage:null}}async function _o(e,t=!1){try{let n=await ve(t?"/api/gpsjam?force=1":"/api/gpsjam"),a=await n.json();if(a.error)return{feed:e,items:[],error:a.error,errorMessage:a.message||"GPSJam fetch failed.",httpStatus:a.httpStatus||n.status||0,fetchedAt:a.fetchedAt||Date.now()};let s=Ro(a.body||"",e,a.date||"");return{feed:e,items:s.items.map(i=>({...i,tags:e.tags||[]})),error:s.error,errorMessage:s.errorMessage,httpStatus:a.httpStatus||n.status||0,fetchedAt:a.fetchedAt||Date.now()}}catch(n){return{feed:e,items:[],error:"fetch_failed",errorMessage:n.message,httpStatus:0,fetchedAt:Date.now()}}}function Un(e,t){return t?Array.isArray(t)?Un(e,t[0]):t==="allorigins"?`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`:t==="jina"?`https://r.jina.ai/http://${e.replace(/^https?:\/\//,"")}`:e:e}function Uo(e){return!(!$()||!r.settings.superMonitor||e.keySource==="server"||e.requiresKey&&!mt(e).key)}function Ho(e,t){if(!t)return e;if(e.includes("{{query}}"))return e.replaceAll("{{query}}",encodeURIComponent(t));let n=new URL(e);return n.searchParams.set("q",t),n.toString()}function En(e){let t=e instanceof Date?e:new Date(e);return Number.isNaN(t.getTime())?"":t.toISOString().slice(0,10)}function Xa(){let e=new Date,t=Math.max(1,Number(r.settings.maxAgeDays)||1),n=new Date(e);return n.setDate(e.getDate()-t),{startDate:En(n),endDate:En(e)}}function qo(e){let t=an(),{startDate:n,endDate:a}=Xa(),s=new URLSearchParams,i=String(e.limit||500),l=r.settings.scope!=="global"?je()?.name:"";if(t){let c=t.endsWith("/")?t.slice(0,-1):t;return s.set("start",n),s.set("end",a),s.set("limit",i),e.acledMode==="aggregated"?(s.set("region",e.acledRegion||"global"),l&&s.set("country",l),`${c}/aggregated?${s.toString()}`):(l&&s.set("country",l),`${c}/events?${s.toString()}`)}return s.set("_format","json"),s.set("event_date",`${n}|${a}`),s.set("limit",i),l&&s.set("country",l),`${e.url}?${s.toString()}`}function Go(e,t){let a=`${Math.max(1,Number(r.settings.maxAgeDays)||1)}d`,s=t||e.defaultQuery||"",i=e.url||"";if(i=i.replaceAll("{{query}}",encodeURIComponent(s)),i=i.replaceAll("{{timespan}}",encodeURIComponent(a)),!i.includes("timespan=")){let l=new URL(i);l.searchParams.set("timespan",a),i=l.toString()}return i}function jo(e){let{startDate:t,endDate:n}=Xa(),a=e.url||"";return a=a.replaceAll("{{start}}",encodeURIComponent(t)),a=a.replaceAll("{{end}}",encodeURIComponent(n)),a}async function zo(e,t={},n=Vr){let a=new AbortController,s=setTimeout(()=>a.abort(),n);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(s)}}async function xt(e,t){let n=mt(e),a=e.acledMode?qo(e):e.id==="gdelt-conflict-geo"?Go(e,t):e.id==="ucdp-candidate-events"?jo(e):Ho(e.url,e.supportsQuery&&(t||e.defaultQuery)||"");if(n.key&&n.keyParam){let i=new URL(a);i.searchParams.set(n.keyParam,n.key),a=i.toString()}let s={};n.key&&n.keyHeader&&(s[n.keyHeader]=n.key);try{let i=Array.isArray(e.proxy)?e.proxy:e.proxy?[e.proxy]:[],l=[a,...i.map(d=>Un(a,d))],c=null;for(let d of l)try{let g=await zo(d,{headers:s});if(c=g,!g.ok)continue;let f=await g.text(),b=(e.format==="rss"?Cn(f,e):Mt(f,e)).map(k=>({...k,tags:e.tags||[],feedId:e.id,feedName:e.name}));return{feed:e,items:b,error:null,errorMessage:null,httpStatus:g.status,fetchedAt:Date.now()}}catch{}let p=c?await c.text():"",y=(c&&c.ok?e.format==="rss"?Cn(p,e):Mt(p,e):[]).map(d=>({...d,tags:e.tags||[],feedId:e.id,feedName:e.name}));return{feed:e,items:y,error:c?.ok?null:c?`http_${c.status}`:"fetch_failed",errorMessage:c?.ok?null:c?`HTTP ${c.status}`:"fetch failed",httpStatus:c?.status||0,fetchedAt:Date.now()}}catch(i){return{feed:e,items:[],error:"fetch_failed",errorMessage:i.message,httpStatus:0,fetchedAt:Date.now()}}}function $e(e,t){return!e||!t||e.id==="gdelt-doc"?t:e.id.startsWith("google-news")?t.includes("when:")?t:`${t} when:1d`:t}function Ko(){let e=new Set(["gdelt-doc","google-news-search"]);return r.feeds.filter(t=>!t||!t.supportsQuery||t.requiresKey||t.keyParam||t.keyHeader||t.requiresConfig||t.isCustom?!1:e.has(t.id)||(t.tags||[]).includes("search"))}async function fa(e,t){if(!e||!t)return t;if(!r.settings.aiTranslate||!ue())return $e(e,t);try{let n=`Translate this search query for the feed "${e.name}". Keep it short and compatible with the feed. Return only the final query string. Original: ${t}`;return(await Ze({messages:[{role:"user",content:n}],context:{feed:{id:e.id,name:e.name,url:e.url}},temperature:0})||"").split(`
`)[0].replace(/^\"|\"$/g,"").trim()||$e(e,t)}catch{return $e(e,t)}}function V(e){let t=Date.now()-e,n=Math.max(1,Math.round(t/6e4));if(n<60)return`${n}m ago`;let a=Math.round(n/60);return a<24?`${a}h ago`:`${Math.round(a/24)}d ago`}function er(){document.querySelectorAll(".panel[data-panel]").forEach(e=>{if(e.dataset.noUpdate)return;let t=e.dataset.panel;if(e.querySelector(`[data-panel-update="${t}"]`))return;let a=e.querySelector(".panel-header > div");if(!a)return;let s=document.createElement("div");s.className="panel-updated",s.dataset.panelUpdate=t,s.textContent="Updated --",a.appendChild(s)})}function bt(e){return!e||!e.length?null:e.reduce((t,n)=>Math.max(t,n.publishedAt||0),0)||null}function ha(e){let n=r.feeds.filter(a=>e.includes(a.category)).map(a=>r.feedStatus[a.id]?.fetchedAt).filter(Boolean);return n.length?Math.max(...n):null}var ba={map:["weather","disaster","space","news","travel","transport","local","security","infrastructure"],ticker:["finance","crypto","energy"],"finance-spotlight":["finance","crypto","energy"],news:["news"],finance:["finance","energy","gov","cyber","agriculture"],crypto:["crypto"],prediction:["prediction"],hazards:["disaster","weather","space"],local:["news","gov","disaster","weather"],policy:["gov"],cyber:["cyber"],agriculture:["agriculture"],research:["research"],space:["space"],energy:["energy"],"energy-map":["energy"],health:["health"],transport:["transport"]};function Wo(e){let t=n=>{let a=r.scopedItems.filter(c=>n.includes(c.category)),s=bt(a);if(s)return s;let i=W(K(r.items)).filter(c=>n.includes(c.category)),l=bt(i);return l||ha(n)||r.lastFetch||null};switch(e){case"map":return bt(Gn())||r.lastFetch||null;case"ticker":case"finance-spotlight":return t(["finance","crypto","energy"]);case"command":case"signals":return r.lastFetch||null;case"news":return r.clusters.reduce((a,s)=>Math.max(a,s.updatedAt||0),0)||ha(["news"])||r.lastFetch||null;case"finance":return t(["finance","energy","gov","cyber","agriculture"]);case"money-flows":return r.moneyFlowsFetchedAt||null;case"crypto":return t(["crypto"]);case"prediction":return t(["prediction"]);case"hazards":return t(["disaster","weather","space"]);case"local":return bt(gt())||r.lastFetch||null;case"policy":return t(["gov"]);case"cyber":return t(["cyber"]);case"agriculture":return t(["agriculture"]);case"research":return t(["research"]);case"space":return t(["space"]);case"energy":return t(["energy"]);case"energy-map":return t(["energy"]);case"health":return t(["health"]);case"transport":return t(["transport"]);default:return r.lastFetch||null}}function Jo(e){if(e==="map")return r.feeds.filter(n=>n.mapOnly||ba.map.includes(n.category)).map(n=>n.id);let t=ba[e];return t?r.feeds.filter(n=>t.includes(n.category)).map(n=>n.id):[]}function tr(){er(),document.querySelectorAll(".panel-updated[data-panel-update]").forEach(e=>{let t=e.dataset.panelUpdate,n=Wo(t);e.textContent=n?`Updated ${V(n)}`:"Updated --"})}function Zo(){document.querySelectorAll(".panel[data-panel]").forEach(e=>{if(e.dataset.noUpdate)return;let t=e.dataset.panel;if(e.querySelector(`[data-panel-error="${t}"]`))return;let a=e.querySelector(".panel-header > div");if(!a)return;let s=document.createElement("div");s.className="panel-error",s.dataset.panelError=t,s.textContent="",a.appendChild(s)})}function Kt(){Zo(),document.querySelectorAll(".panel-error[data-panel-error]").forEach(e=>{let t=e.dataset.panelError,n=!1;t==="money-flows"?n=!!r.moneyFlowsError:n=Jo(t).some(s=>r.feedStatus[s]?.error==="fetch_failed"),e.textContent=n?"Feed error":"",e.classList.toggle("active",n)})}function nr(e=""){return e?/[\u0400-\u04FF\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\u1100-\u11FF\u2E80-\u9FFF\u3040-\u30FF\uAC00-\uD7AF]/.test(e):!1}function W(e){return r.settings.languageMode==="all"?e:r.settings.languageMode==="translate"?ue()?e:e.filter(t=>!t.isNonEnglish):e.filter(t=>!t.isNonEnglish)}function K(e){let t=Date.now()-r.settings.maxAgeDays*24*60*60*1e3;return e.filter(n=>(n.publishedAt||Date.now())>=t)}function Vo(e){return e.map(t=>({...t,url:Ke(t.url),isNonEnglish:typeof t.isNonEnglish=="boolean"?t.isNonEnglish:nr(`${t.title||""} ${t.summary||""}`)}))}function Qe(e){let t=Vo(e),n=We(t);return W(K(n))}function Qo(){let e=K(r.items),t=W(e),n=f=>t.filter(h=>h.feedId===f),a=f=>n(f)[0],s=f=>f.map(h=>a(h)).find(Boolean),i=f=>n("coinpaprika-tickers").find(h=>h.title?.includes(`(${f})`)),l=f=>{if(!f?.summary)return null;let h=f.summary.match(/24h\s+(-?\d+(?:\.\d+)?)%/i);return h?Number(h[1]):null},c=[];Ao().forEach(f=>c.push(f));let p=r.energyMarket?.wti,m=r.energyMarket?.gas,y=(f,h)=>{if(!f?.value)return;let b=Q(f.value),k=f.asOf?`Market ${f.asOf}`:"Market";c.push({text:`${h}: ${b} \u2022 ${k}`,url:f.url,change:Number.isFinite(f.delta)?f.delta:null})};y(p,"WTI Crude"),y(m,"Nat Gas");let d=(f,h)=>{if(!f)return;let b=f.translatedTitle||f.title||h,k=f.summary||"";c.push({text:k?`${b} \u2022 ${k}`:b,url:f.url,change:l(f)})};d(a("treasury-debt"),"US Debt"),d(a("bls-cpi"),"US CPI"),p?.value||d(a("energy-eia"),"WTI Crude"),d(a("energy-eia-brent"),"Brent Crude"),m?.value||d(a("energy-eia-ng"),"Nat Gas"),d(a("coinpaprika-global"),"Crypto Market Cap"),["BTC","ETH"].forEach(f=>d(i(f),f)),d(a("blockstream-mempool"),"Bitcoin Mempool");let g=new Set;return c.filter(f=>{let h=(f.text||"").toLowerCase();return!h||g.has(h)?!1:(g.add(h),!0)})}function Nt(){if(!o.tickerTrack||!o.tickerBar)return;let e=Qo();if(o.tickerTrack.innerHTML="",!e.length){o.tickerBar.classList.add("empty"),o.tickerTrack.textContent="No market signals yet.";return}o.tickerBar.classList.remove("empty");let t=document.createElement("div");t.className="ticker-group",e.forEach(a=>{let s=document.createElement(a.url?"a":"span");s.className="ticker-item",typeof a.change=="number"&&s.classList.add(a.change>=0?"up":"down"),s.textContent=a.text,a.url&&(s.href=a.url,s.target="_blank",s.rel="noopener noreferrer"),t.appendChild(s)});let n=t.cloneNode(!0);o.tickerTrack.appendChild(t),o.tickerTrack.appendChild(n)}async function ar(e,t,n){if(!ue()||!e||!e.isNonEnglish)return;let a=`${e.title}|${e.summary}`;if(r.translationCache[a]){let s=r.translationCache[a];s.title&&t&&(t.textContent=s.title);return}if(!(r.translationInFlight.has(a)||r.translationInFlight.size>4)){r.translationInFlight.add(a);try{let s=`Translate the following title to English. Return only the translated title.
Title: ${e.title}`,l={title:(await Ze({messages:[{role:"user",content:s}],context:{mode:"translate"},temperature:0})||e.title||"").trim()};r.translationCache[a]=l,l.title&&t&&(t.textContent=l.title)}catch{}finally{r.translationInFlight.delete(a)}}}function Yo(e){if(!e)return"";try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}var Xo=new Set(["reuters.com","apnews.com","bloomberg.com","wsj.com","nytimes.com","ft.com","bbc.com","theguardian.com","washingtonpost.com","npr.org","economist.com","aljazeera.com","cnn.com","foxnews.com","forbes.com","wsj.com","nationalgeographic.com","nature.com","sciencemag.org"]),ei=new Set(["yahoo.com","finance.yahoo.com","cnbc.com","axios.com","politico.com","thehill.com","time.com","usatoday.com","abcnews.go.com","nbcnews.com","cbsnews.com","newsweek.com","businessinsider.com","marketwatch.com"]);function rr(e){let t=Yo(e.url||"");return t?t.endsWith(".gov")||t.endsWith(".mil")||t.endsWith(".edu")?{label:"Tier 1",className:"tier-1"}:Xo.has(t)?{label:"Tier 1",className:"tier-1"}:ei.has(t)?{label:"Tier 2",className:"tier-2"}:{label:"Tier 3",className:"tier-3"}:null}function ti(e){if(!e.coverage)return null;let t=(Date.now()-(e.publishedAt||Date.now()))/6e4;return e.coverage>=6&&t<120?"Spiking":e.coverage>=4?"Broad":t<60?"Fresh":null}function ni(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Be(e){let t=ni(e);return t=t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t=t.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'),t}function Ft(e){let n=String(e||"").replace(/```[\s\S]*?```/g,"").trim().split(/\r?\n/).map(i=>i.trim()).filter(Boolean),a="",s=null;return n.forEach(i=>{let l=/^[-*]\s*/.test(i),c=/^\d+[.)]\s+/.test(i);if(l||c){let y=c?"ol":"ul";s&&s!==y&&(a+=`</${s}>`,s=null),s||(s=y,a+=`<${y}>`);let d=i.replace(/^[-*]\s*/,"").replace(/^\d+[.)]\s+/,"");a+=`<li>${Be(d)}</li>`;return}s&&(a+=`</${s}>`,s=null);let p=/^(#{1,3})\s+(.+)/.exec(i);if(p){a+=`<div class="analysis-heading">${Be(p[2])}</div>`;return}let m=/^([A-Z][A-Za-z0-9 &/.-]{2,}):\s*(.+)$/.exec(i);if(m){a+=`<p><strong>${Be(m[1])}:</strong> ${Be(m[2])}</p>`;return}a+=`<p>${Be(i)}</p>`}),s&&(a+=`</${s}>`),a||`<p>${Be(e)}</p>`}function Oe(e){o.analysisBody&&(o.analysisBody.innerHTML=Ft(e))}function ai(){let e=r.scopedItems.length?r.scopedItems:r.items,t=0;return e.forEach(n=>{let a=new Date(n.publishedAt||n.updatedAt||0).getTime();Number.isFinite(a)&&(t=Math.max(t,a))}),[e.length,t,r.clusters.length,r.lastFetch||0,r.lastBuildAt||0,r.settings.scope,r.settings.radiusKm,r.settings.languageMode].join("|")}function we(){let e=ai();e!==r.analysisSignature&&(r.analysisSignature=e,ue()?cr({emitChat:!1,auto:!0}):Pt(!1,{metaNote:"AI offline"}))}function sr(e){if(!e.geo)return null;let{lat:t,lon:n}=r.location;return yt(t,n,e.geo.lat,e.geo.lon)}function or(e){if(!e)return"";let t=e.toUpperCase();if(t.includes("UNITED STATES")||t.includes("U.S.")||t.includes("USA"))return"US";if(t.includes("GLOBAL"))return"Global";let a=(t.match(/\b[A-Z]{2}\b/g)||[]).find(s=>Es.has(s));if(a)return a;if(e.includes(",")){let s=e.split(",").pop().trim();if(s&&s.length<=24)return s}return""}function ir(e=""){if(/global/i.test(e))return"Global";let t=e.match(/\bin\s+([A-Za-z][A-Za-z\s.-]+)/i);return t?t[1].trim():""}function ri(e=""){let t=e.match(/Level\s*(\d)/i);return t?`Level ${t[1]}`:""}function si(e){let t={...e},n=`${e.title||""} ${e.summary||""}`.toLowerCase();if(e.category==="travel"){t.alertType=t.alertType||"Travel Notice";let a=ri(e.title||"");a&&!t.severity&&(t.severity=a);let s=ir(e.title||"");s&&(t.regionTag=s),/dengue|chikungunya|zika|malaria/.test(n)?t.hazardType="Mosquito-borne":/rabies/.test(n)?t.hazardType="Zoonotic":/rmsf|rocky mountain spotted fever|tick/.test(n)?t.hazardType="Tick-borne":/cholera|diarrhea/.test(n)?t.hazardType="Waterborne":/measles|respiratory/.test(n)&&(t.hazardType="Respiratory")}if(e.category==="health"&&!t.alertType&&(/recall/.test(n)?t.alertType="Recall":/outbreak|cases/.test(n)?t.alertType="Outbreak":/advisory/.test(n)?t.alertType="Advisory":/alert/.test(n)&&(t.alertType="Alert")),e.category==="cyber"&&!t.alertType&&/cve-\\d{4}-\\d+/i.test(e.title||"")&&(t.alertType="Vulnerability"),e.category==="research"&&/arxiv/i.test(e.source||"")){let a=(e.source||"").replace(/arxiv/i,"").replace(/[()]/g,"").trim();t.topicTag=a||"arXiv";let s=(e.url||"").match(/v(\\d+)$/);s&&Number(s[1])>1?t.alertType="Updated":t.alertType="New"}if(e.category==="news"&&e.url){let a=rr(e);a&&(t.credibility=a.label)}if(!t.regionTag){let a=or(e.location||e.geoLabel||"");a?t.regionTag=a:e.tags?.includes("us")?t.regionTag="US":e.tags?.includes("global")&&(t.regionTag="Global")}return t}var va={alertType:10,severity:20,hazardType:30,deadline:40,regionTag:50,distance:60,delta:70,trend:80,credibility:90,topicTag:100},oi={news:{alertType:8,severity:12,hazardType:16,regionTag:20,trend:30,credibility:40},local:{distance:5,alertType:10,severity:14,hazardType:18,regionTag:22},travel:{severity:5,hazardType:8,regionTag:12,alertType:16},research:{topicTag:5,alertType:10},financeMarkets:{delta:5,trend:10,alertType:20,severity:24,regionTag:28},financePolicy:{alertType:5,deadline:10,regionTag:16,severity:20},policy:{alertType:5,deadline:10,regionTag:16,severity:20},cyber:{alertType:5,severity:10,deadline:14,regionTag:18},health:{alertType:5,severity:10,hazardType:14,regionTag:18},disaster:{severity:5,alertType:10,hazardType:14,regionTag:18},crypto:{delta:5,trend:10,regionTag:20},energy:{delta:5,trend:10,alertType:16},transport:{alertType:8,severity:12,regionTag:16},agriculture:{alertType:8,severity:12,regionTag:16}};function ii(e,t){let n={newsList:"news",financeMarketsList:"financeMarkets",financePolicyList:"financePolicy",policyList:"policy",congressList:"policy",cryptoList:"crypto",disasterList:"disaster",localList:"local",cyberList:"cyber",agricultureList:"agriculture",researchList:"research",spaceList:"space",energyList:"energy",healthList:"health",transportList:"transport"};return e==="searchResultsList"?(t.category==="gov"?"policy":t.category)||"default":n[e]||(t.category==="gov"?"policy":t.category)||"default"}function li(e,t){let n=oi[e]||{};return Object.prototype.hasOwnProperty.call(n,t)?n[t]:Object.prototype.hasOwnProperty.call(va,t)?va[t]:999}function ci(e,t){let n=ii(t,e),a=[],s=(i,l,c)=>{a.push({label:l,className:c,priority:li(n,i),order:a.length})};if(e.category==="news"){let i=rr(e);i&&s("credibility",i.label,`chip-badge ${i.className}`);let l=ti(e);l&&s("trend",l,"chip-badge trend")}if(rn(e)&&!e.alertType&&s("alert","Alert","chip-badge alert"),e.alertType&&s("alertType",e.alertType,"chip-badge alert"),e.severity&&s("severity",e.severity,"chip-badge severity"),Number.isFinite(e.delta)){let i=e.delta>0?`+${q(e.delta)}`:q(e.delta),l=e.unit?` ${e.unit}`:"";s("delta",`\u0394 ${i}${l}`,"chip-badge trend")}if(e.hazardType&&s("hazardType",e.hazardType,"chip-badge hazard"),e.verificationCount&&e.verificationCount>1&&s("verified",`Verified ${e.verificationCount} sources`,"chip-badge verified"),e.deadline&&s("deadline",`Due ${re(e.deadline)}`,"chip-badge deadline"),e.regionTag&&s("regionTag",e.regionTag,"chip-badge region"),n==="local"){let i=sr(e);Number.isFinite(i)&&s("distance",`${Math.round(i)} km`,"chip-badge distance")}return e.topicTag&&s("topicTag",e.topicTag,"chip-badge topic"),a.sort((i,l)=>i.priority-l.priority||i.order-l.order).slice(0,4)}function ot(e,t,{withCoverage:n=!1,append:a=!1}={}){if(!e)return;if(a||(e.innerHTML=""),!t.length){a||(e.innerHTML='<div class="list-item">No signals yet.</div>');return}let s=0,i=e?.dataset?.listContext||e?.id||"";t.forEach(l=>{if(r.settings.languageMode==="en"&&l.isNonEnglish)return;let c=document.createElement("div");c.className="list-item",rn(l)&&c.classList.add("is-alert");let m=Array.isArray(l.detailFields)&&l.detailFields.length||l.detailSummary||l.detailTitle;m&&c.classList.add("is-clickable");let y=!!(l.url&&!m),d=document.createElement(y?"a":m?"button":"div");d.className=`list-title${m?" btn-link":""}`,d.textContent=l.translatedTitle||l.title,y?(d.href=l.url,d.target="_blank",d.rel="noopener noreferrer"):m&&(d.type="button",d.addEventListener("click",()=>to(l)));let g=document.createElement("div");g.className="list-meta";let f=document.createElement("span");f.textContent=l.source||"Source";let h=document.createElement("span");if(h.textContent=V(l.publishedAt||Date.now()),g.appendChild(f),g.appendChild(h),l.externalUrl){let w=document.createElement("a");w.className="list-open-link",w.href=l.externalUrl,w.target="_blank",w.rel="noopener noreferrer",w.textContent="Open",g.appendChild(w)}let b=null;if(l.category==="prediction"&&Number.isFinite(l.probability)){let w=document.createElement("div");w.className="prediction-odds";let I=document.createElement("div");I.className="prediction-odds-label";let u=Number.isFinite(l.change24h)?l.change24h:null,v=u!==null?` (${u>0?"+":""}${Math.round(u*100)}%)`:"";I.textContent=`${l.outcomeLabel||"Yes"} ${l.probability}%${v}`;let E=document.createElement("div");E.className="prediction-odds-bar";let T=document.createElement("span");T.style.width=`${Math.max(4,Math.min(100,l.probability))}%`,E.appendChild(T),w.appendChild(I),w.appendChild(E),b=w}if(n&&l.coverage){let w=document.createElement("div");w.className="list-coverage";let I=Array.from({length:Math.min(l.coverage,6)}).map(()=>'<span class="cover-dot"></span>').join(""),u=l.coverage-Math.min(l.coverage,6);w.innerHTML=u>0?`${I} <span>+${u}</span>`:I,g.appendChild(w)}let k=ci(l,i);if(k.length){let w=document.createElement("div");w.className="list-badges",k.forEach(I=>{let u=document.createElement("span");u.className=I.className,u.textContent=I.label,w.appendChild(u)}),c.appendChild(w)}let C=document.createElement("div");C.className="list-summary";let S=i==="newsList",A=Je(l.summaryHtml||l.summary||"").trim();if(S){let w=l.translatedSummary||A;C.textContent=Y(w,240)}else l.summaryHtml?C.innerHTML=Ln(l.summaryHtml):C.textContent=l.translatedSummary||A;c.appendChild(d),c.appendChild(g),b&&c.appendChild(b),!!(l.summary||l.summaryHtml)&&!(r.settings.languageMode==="translate"&&l.isNonEnglish)&&c.appendChild(C),e.appendChild(c),s+=1,r.settings.languageMode==="translate"&&l.isNonEnglish&&ar(l,d,C)}),!s&&!a&&(e.innerHTML='<div class="list-item">No signals yet.</div>')}function ke(e,t,n={}){if(!e)return;let a=Math.min(Za(e.id),t.length);ot(e,t.slice(0,a),n);let s=n.rowEstimate||92;if(!e.clientHeight||t.length<=a)return;let i=Math.min(t.length,Math.max(a,Math.floor(e.clientHeight/s)));i>a&&(r.listLimits[e.id]=i,ot(e,t.slice(0,i),n))}function ui(e){let t=Wt(e);ke(o.newsList,t,{withCoverage:!0})}function ie(){let e=r.scopedItems.length,t=r.clusters.length,n=gt(),a=W(K(r.items)).filter(c=>c.category==="crypto"||c.category==="finance"),s=r.previousSignals,i=(c,p)=>{if(p==null)return"";let m=c-p;return m?m>0?`\u2022 +${m}`:`\u2022 ${m}`:""};o.globalActivity.textContent=e||"--",o.globalActivityMeta.textContent=e?`Signals ingested: ${e} ${i(e,s?.totalItems)}`.trim():r.refreshing?"Fetching feeds\u2026":"Awaiting signals",o.summaryGlobalActivity&&(o.summaryGlobalActivity.textContent=e||"--",o.summaryGlobalActivityMeta.textContent=e?`Signals ingested: ${e} ${i(e,s?.totalItems)}`.trim():r.refreshing?"Fetching feeds\u2026":"Awaiting signals"),o.newsSaturation.textContent=t||"--",o.newsSaturationMeta.textContent=t?`Clusters across sources ${i(t,s?.newsClusters)}`.trim():r.refreshing?"Fetching clusters\u2026":"No clusters yet",o.summaryNewsSaturation&&(o.summaryNewsSaturation.textContent=t||"--",o.summaryNewsSaturationMeta.textContent=t?`Clusters across sources ${i(t,s?.newsClusters)}`.trim():r.refreshing?"Fetching clusters\u2026":"No clusters yet"),o.localEvents.textContent=n.length?n.length:"--",o.localEventsMeta.textContent=n.length?r.location.source==="geo"?`Within local radius ${i(n.length,s?.localItems)}`:`Fallback region ${i(n.length,s?.localItems)}`:r.refreshing?"Locating\u2026":"No local signals yet",o.summaryLocalEvents&&(o.summaryLocalEvents.textContent=n.length?n.length:"--",o.summaryLocalEventsMeta.textContent=n.length?r.location.source==="geo"?`Within local radius ${i(n.length,s?.localItems)}`:`Fallback region ${i(n.length,s?.localItems)}`:r.refreshing?"Locating\u2026":"No local signals yet");let l=a.length;if(o.marketPulse.textContent=l||"--",o.marketPulseMeta.textContent=l?`Markets + macro feeds ${i(l,s?.marketCount)}`.trim():r.refreshing?"Fetching feeds\u2026":"No market signals yet",o.summaryMarketPulse&&(o.summaryMarketPulse.textContent=l||"--",o.summaryMarketPulseMeta.textContent=l?`Markets + macro feeds ${i(l,s?.marketCount)}`.trim():r.refreshing?"Fetching feeds\u2026":"No market signals yet"),o.signalHealthChip){let c=vn.map(y=>r.feedStatus[y]).filter(y=>y?y.stale?!0:!(!y.error||y.error==="requires_key"||y.error==="requires_config"||y.error==="missing_server_key"):!1),m=vn.filter(y=>{let d=r.feedStatus[y];return d?d.stale?!0:!(!d.error||d.error==="requires_key"||d.error==="requires_config"||d.error==="missing_server_key"):!1}).map(y=>r.feeds.find(d=>d.id===y)?.name||y);if(c.length){if(o.signalHealthChip.textContent=`Feed Health: Degraded (${c.length})`,o.signalHealthChip.classList.add("degraded"),o.signalHealthChip.classList.remove("healthy"),o.signalHealthDetail){let y=m.slice(0,3).join(", "),d=m.length>3?` +${m.length-3} more`:"";o.signalHealthDetail.textContent=`Degraded: ${y}${d}`,o.signalHealthDetail.title=m.join(", ")}}else o.signalHealthChip.textContent="Feed Health: Healthy",o.signalHealthChip.classList.add("healthy"),o.signalHealthChip.classList.remove("degraded"),o.signalHealthDetail&&(o.signalHealthDetail.textContent="",o.signalHealthDetail.removeAttribute("title"))}pi(),r.previousSignals={totalItems:e,newsClusters:t,localItems:n.length,marketCount:l}}function Wt(e){return e.map((t,n)=>({title:t.primary.title,source:Array.from(t.sources).slice(0,2).join(", "),summary:n<3?Y(Je(t.primary.summaryHtml||t.primary.summary||""),240):"",summaryHtml:"",publishedAt:t.updatedAt,coverage:t.sources.size,url:t.primary.url,isNonEnglish:t.primary.isNonEnglish}))}function Jt(){let e=gt().filter(n=>!n.mapOnly);return e.length||(e=W(K(r.items)).filter(n=>n.tags?.includes("us")&&!n.mapOnly)),e.filter(n=>!ur(n)).map(n=>({item:n,score:yi(n)})).sort((n,a)=>a.score-n.score).map(n=>n.item)}function Zt(){let e=r.scopedItems.filter(t=>t.feedId==="eia-today");return e.length||(e=W(K(r.items)).filter(t=>t.feedId==="eia-today")),e.length||(e=r.scopedItems.filter(t=>t.category==="energy")),e.length||(e=W(K(r.items)).filter(t=>t.category==="energy")),We(e)}function it(){if(!o.feedHealth)return;if(!Object.keys(r.feedStatus).length){o.feedHealth.innerHTML='<div class="settings-note">Fetching feeds...</div>';return}let t=r.feeds.map(n=>{let a=r.feedStatus[n.id]||{},s=a.stale,i=s?"STALE":a.httpStatus||(a.error?"ERR":"OK"),l=!a.error&&!s&&(a.httpStatus?a.httpStatus<400:!0);return{id:n.id,name:n.name,ok:l,code:i,stale:s,fetchedAt:a.fetchedAt,error:a.error,message:a.errorMessage}}).filter(n=>!n.ok&&n.error!=="requires_config");if(!t.length){o.feedHealth.innerHTML='<div class="settings-note">All feeds are healthy.</div>';return}o.feedHealth.innerHTML="",t.slice(0,6).forEach(n=>{let a=document.createElement("div");a.className="feed-health-row";let s=document.createElement("div");s.textContent=n.name;let i=document.createElement("div");i.className="feed-health-meta";let l=n.message;!l&&n.stale&&n.fetchedAt&&(l=`Stale (${V(n.fetchedAt)})`),!l&&n.error==="requires_key"&&(l="Missing API key"),!l&&n.error==="missing_server_key"&&(l="Missing server API key"),i.textContent=l||(n.error?n.error:`HTTP ${n.code}`),a.appendChild(s),a.appendChild(i),o.feedHealth.appendChild(a)})}function An(){if(!r.staticAnalysis?.generatedAt)return null;let e=Date.parse(r.staticAnalysis.generatedAt);return Number.isFinite(e)?e:null}function di(){return $()&&!r.settings.superMonitor?An()||r.lastBuildAt||r.lastFetch||null:r.lastFetch||r.lastBuildAt||An()||null}function Xe(e,t,n){if(!o.analysisMeta)return;let a={ai:"AI briefing",cached:"Cached briefing",heuristic:"Heuristic briefing",empty:"Awaiting signals"},s="";if(e==="empty")s=t||"Awaiting signals to build a briefing.";else{let i=a[e]||"Briefing",l=n??di(),c=l?`Data ${V(l)}`:"";s=[i,t,c].filter(Boolean).join(" \u2022 ")}o.analysisMeta.textContent=s,o.analysisOutput&&e&&(o.analysisOutput.dataset.mode=e)}function Hn(){return r.clusters.length?[...r.clusters].sort((e,t)=>{let n=t.sources.size-e.sources.size;return n||t.updatedAt-e.updatedAt})[0]:null}function et(e){return!e||!e.length?null:[...e].sort((t,n)=>{let a=t.publishedAt||t.updatedAt||0;return(n.publishedAt||n.updatedAt||0)-a})[0]}function qn(e=5){if(!r.clusters.length)return[];let t=[];r.clusters.slice(0,12).forEach(a=>{X(a.primary.title).split(" ").forEach(i=>{!i||i.length<3||ks.has(i)||/^\d+$/.test(i)||t.push(i)})});let n=t.reduce((a,s)=>(a[s]=(a[s]||0)+1,a),{});return Object.entries(n).sort((a,s)=>s[1]-a[1]).slice(0,e).map(([a])=>a)}function mi(){let e=[],t=Hn();if(t){let l=Y(t.primary.title||"",120),c=t.sources?.size?`${t.sources.size} sources`:"Single source",p=t.updatedAt?V(t.updatedAt):"",m=[c,p].filter(Boolean).join(" \u2022 ");e.push({label:"Focus",value:m?`${l} \u2022 ${m}`:l})}let n=et(lt());if(n){let l=Y(n.title||"",120),c=n.geoLabel||n.location||n.area||"",p=n.publishedAt?V(n.publishedAt):"",m=[c,p].filter(Boolean).join(" \u2022 ");e.push({label:"Local",value:m?`${l} \u2022 ${m}`:l})}else r.settings.scope!=="global"&&e.push({label:"Local",value:`No signals within ${r.settings.radiusKm} km.`});let a=W(K(r.items)).filter(l=>l.category==="crypto"||l.category==="finance"),s=et(a);if(s){let l=Y(s.title||"",120),c=s.summary?Y(Je(s.summary),80):"";e.push({label:"Market",value:c?`${l} \u2022 ${c}`:l})}let i=qn(3);return i.length&&e.push({label:"Themes",value:i.join(", ")}),e.slice(0,4)}function pi(){if(!o.analysisStory)return;let e=mi();if(o.analysisStory.innerHTML="",!e.length){o.analysisStory.innerHTML='<div class="analysis-story-empty">Awaiting narrative context.</div>';return}e.forEach(t=>{let n=document.createElement("div");n.className="analysis-story-item";let a=document.createElement("div");a.className="analysis-story-label",a.textContent=t.label;let s=document.createElement("div");s.className="analysis-story-value",s.textContent=t.value,n.appendChild(a),n.appendChild(s),o.analysisStory.appendChild(n)})}function lr(){let e=Hn(),t=r.feeds.map(s=>{let i=r.feedStatus[s.id];return!i||i.error==="requires_key"||i.error==="requires_config"||i.error==="missing_server_key"||!i.error&&!i.stale?null:{id:s.id,name:s.name,error:i.error||null,stale:!!i.stale,fetchedAt:i.fetchedAt||null}}).filter(Boolean).slice(0,6),n=Ve(),a=n.slice(0,6).map(s=>({title:s.title,type:s.alertType||s.category,publishedAt:s.publishedAt,url:s.externalUrl||s.url}));return{generatedAt:new Date().toISOString(),scope:r.settings.scope,location:r.location,refreshMinutes:r.settings.refreshMinutes,feedHealth:{status:r.health,issueCount:t.length,issues:t},signals:{totalItems:r.scopedItems.length,newsClusters:r.clusters.length,localEvents:lt().length,congressItems:n.length},congressSignals:a,searchContext:{query:r.lastSearchQuery||null,scope:r.lastSearchScope,categories:r.lastSearchCategories},themes:qn(5),focusCluster:e?{title:e.primary.title,sources:Array.from(e.sources),updatedAt:e.updatedAt,url:e.primary.url}:null,topClusters:r.clusters.slice(0,8).map(s=>({title:s.primary.title,sources:Array.from(s.sources),updatedAt:s.updatedAt,url:s.primary.url})),localSignals:lt().slice(0,6).map(s=>({title:s.title,source:s.source,publishedAt:s.publishedAt,url:s.url})),marketSignals:r.scopedItems.filter(s=>s.category==="finance"||s.category==="crypto").slice(0,6).map(s=>({title:s.title,source:s.source,publishedAt:s.publishedAt,url:s.url}))}}async function Ze({messages:e,context:t,temperature:n=.2,model:a}={}){let s=Ne(),i=mo();if(s){let m={messages:Array.isArray(e)?e:[],context:t,temperature:n};a&&(m.model=a);let y={"Content-Type":"application/json"};i&&(y["x-openai-key"]=i);let g=await(await fetch(s,{method:"POST",headers:y,body:JSON.stringify(m)})).json();if(g.error)throw new Error(g.message||g.error);return(g.text||"").trim()}if($())throw new Error("assistant_unavailable");let l={messages:Array.isArray(e)?e:[],context:t,temperature:n};a&&(l.model=a);let p=await(await ve("/api/chat",{method:"POST",headers:{"Content-Type":"application/json",...i?{"x-openai-key":i}:{}},body:JSON.stringify(l)})).json();if(p.error)throw new Error(p.message||p.error);return(p.text||"").trim()}function Pt(e=!1,t={}){let{metaNote:n}=t;if($()&&r.staticAnalysis?.text){let S=An(),A=S?`

Updated ${V(S)}`:"";Xe("cached",n,S),Oe(`${r.staticAnalysis.text}${A}`);return}let a=r.scopedItems.length,s=r.clusters.length,i=lt().length,l=W(K(r.items)).filter(S=>S.category==="crypto"||S.category==="finance").length,c=Ve(),p=c.length;if(!a&&!s){let S=`Awaiting signals. Check feed health or refresh. Local radius: ${r.settings.radiusKm} km.`;Xe("empty",n||"Awaiting signals to build a briefing."),Oe(S),e&&Me(`Briefing: ${S}`,"system");return}let m=Hn(),y=et(lt()),d=W(K(r.items)).filter(S=>S.category==="crypto"||S.category==="finance"),g=et(d),f=et(c),h=qn(4),b=["## Storyline"];if(m){let S=Y(m.primary.title||"",140),A=`${m.sources.size} sources`,M=m.updatedAt?V(m.updatedAt):"";b.push(`- Focus: ${S} (${[A,M].filter(Boolean).join(" \u2022 ")})`)}if(y){let S=Y(y.title||"",140),A=y.geoLabel||y.location||"",M=y.publishedAt?V(y.publishedAt):"";b.push(`- Local: ${S} (${[A,M].filter(Boolean).join(" \u2022 ")})`)}if(g){let S=Y(g.title||"",140);b.push(`- Market: ${S}`)}if(f){let S=Y(f.title||"",140);b.push(`- Congress: ${S}`)}h.length&&b.push(`- Themes: ${h.join(", ")}`);let k=["## Signals",`- Signals in view: ${a||"awaiting"} across ${s||"no"} news clusters.`,`- Local risks: ${i||"no"} events within ${r.settings.radiusKm} km.`,`- Market pulse: ${l||"no"} finance/crypto signals.`,`- Congress: ${p||"no"} legislative updates.`],C=[...b,...k].join(`
`);Xe("heuristic",n),Oe(C),e&&Me(`Briefing:
${C}`,"system")}async function cr({emitChat:e=!0}={}){if(!o.analysisRun||o.analysisRun.disabled)return;let t=o.analysisRun.textContent;if(o.analysisRun.disabled=!0,o.analysisRun.classList.add("loading"),o.analysisRun.setAttribute("aria-busy","true"),o.analysisRun.textContent="Briefing\u2026",r.analysisRunning=!0,!ue()){Pt(e,{metaNote:"AI unavailable"}),o.analysisRun.disabled=!1,o.analysisRun.classList.remove("loading"),o.analysisRun.removeAttribute("aria-busy"),o.analysisRun.textContent=t,r.analysisRunning=!1;return}Xe("ai","Generating briefing"),Oe("Generating AI briefing...");let n=e?Me("Generating briefing\u2026","system"):null;try{let s=await Ze({messages:[{role:"user",content:"Provide a concise situation briefing with 3 bullets: global pulse, local risks, and notable market/cyber signals. Mention sources when possible."}],context:lr(),temperature:.2})||"No response yet.";Xe("ai"),Oe(s),e&&(n?(n.className="chat-bubble assistant",n.innerHTML=Ft(s)):Me(s,"assistant"))}catch(a){let s=Dn(a),i=s?.message?`AI briefing unavailable. ${s.message} Showing heuristic analysis.`:"AI briefing failed. Showing heuristic analysis.";Oe(i),n&&(n.className="chat-bubble system",n.innerHTML=Ft(i)),Pt(e,{metaNote:"AI unavailable"})}finally{o.analysisRun.disabled=!1,o.analysisRun.classList.remove("loading"),o.analysisRun.removeAttribute("aria-busy"),o.analysisRun.textContent=t,r.analysisRunning=!1}}function Me(e,t){let n=document.createElement("div");return n.className=`chat-bubble ${t}`,t==="assistant"||t==="system"?n.innerHTML=Ft(e):n.textContent=e,o.chatLog.appendChild(n),o.chatLog.scrollTop=o.chatLog.scrollHeight,n}async function Sa(){let e=o.chatInput.value.trim();if(!e)return;if(Me(e,"user"),o.chatInput.value="",!ue()){Me('AI is offline. Enable the proxy or turn on "Use my OpenAI key" in Settings > API Keys.',"system");return}let t=Me("Thinking...","system");r.chatHistory.push({role:"user",content:e});let n=r.chatHistory.slice(-6);try{let a=await Ze({messages:n,context:lr(),temperature:.3});t.textContent=a||"No response.",r.chatHistory.push({role:"assistant",content:a||"No response."})}catch(a){let s=Dn(a);t.textContent=s.message||`Assistant error: ${a.message}`}}function gi(){let e={generatedAt:new Date().toISOString(),settings:r.settings,location:r.location,scope:r.settings.scope,feeds:r.feeds.map(s=>({id:s.id,name:s.name,category:s.category})),items:r.scopedItems,clusters:r.clusters.map(s=>({title:s.primary.title,sources:Array.from(s.sources),updatedAt:s.updatedAt,url:s.primary.url}))},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=document.createElement("a"),a=new Date().toISOString().replace(/[:.]/g,"-");n.href=URL.createObjectURL(t),n.download=`situation-room-snapshot-${a}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href),$()||ve("/api/snapshot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(()=>{})}function se(e){let t=K(e);if(r.settings.scope==="us"){let n=je();t=t.filter(a=>Oa(a,n))}return r.settings.scope==="local"&&(t=t.filter(n=>n.geo&&yt(r.location.lat,r.location.lon,n.geo.lat,n.geo.lon)<=r.settings.radiusKm)),W(t)}function gt(){let e=r.settings.scope==="global"?W(K(r.items)):r.scopedItems;if(!e.length)return[];let{lat:t,lon:n}=r.location,a=r.settings.radiusKm;return e.filter(s=>s.geo&&yt(t,n,s.geo.lat,s.geo.lon)<=a)}function ur(e){if(!e)return!1;let t=(e.alertType||"").toLowerCase(),n=(e.feedId||"").toLowerCase(),a=Array.isArray(e.tags)?e.tags.map(l=>String(l).toLowerCase()):[],s=(e.category||"").toLowerCase();return!!(new Set(["arcgis-military-installations","arcgis-power-plants","arcgis-submarine-cables","arcgis-submarine-landing"]).has(n)||n.includes("military")||a.includes("military")||a.includes("installations")||n==="transport-opensky"||t==="flight"||a.includes("flight")||a.includes("aviation")||a.includes("airport")||a.includes("aircraft")||e.mapOnly&&a.includes("infrastructure")&&!a.includes("outage")||e.mapOnly&&s==="infrastructure"&&!a.includes("outage")||s==="crypto"||s==="finance")}function lt(){return gt().filter(e=>!ur(e))}function yi(e){let t=0,n=(e.category||"").toLowerCase(),a=Array.isArray(e.tags)?e.tags.map(c=>String(c).toLowerCase()):[];e.alertType&&(t+=40),e.severity&&(t+=25),e.hazardType&&(t+=20),Number.isFinite(e.impactScore)&&(t+=Math.min(e.impactScore,80)),Number.isFinite(e.fatalities)&&(t+=Math.min(e.fatalities*5,60)),Number.isFinite(e.magnitude)&&(t+=Math.min((e.magnitude-3)*10,50)),new Set(["security","disaster","weather","health","infrastructure","transport","gov","travel"]).has(n)&&(t+=20),a.includes("outage")&&(t+=20),a.includes("evacuation")&&(t+=20),a.includes("emergency")&&(t+=20);let i=e.publishedAt||e.updatedAt||0;if(i){let c=Math.max(0,(Date.now()-i)/36e5);t+=Math.max(0,24-c)}let l=sr(e);return Number.isFinite(l)&&(t+=Math.max(0,25-Math.min(l,25))),t}function yt(e,t,n,a){let i=(n-e)*Math.PI/180,l=(a-t)*Math.PI/180,c=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))}function Gn(){let e=W(K(r.items));if(r.settings.scope==="us"){let n=je();return e=e.filter(a=>a.geo&&Oa(a,n)),Lt(mn(e))}if(r.settings.scope==="local"){let{lat:n,lon:a}=r.location,s=r.settings.radiusKm,i=e.filter(l=>l.geo&&yt(n,a,l.geo.lat,l.geo.lon)<=s);return Lt(mn(i))}let t=r.scopedItems.filter(n=>n.geo);return Lt(mn(t))}function mn(e){let t=[],n=[];if(e.forEach(i=>{i?.tags?.includes("wildfire")?t.push(i):n.push(i)}),!t.length)return e;t.sort((i,l)=>(l.publishedAt||0)-(i.publishedAt||0));let a=new Set,s=[];return t.forEach(i=>{if(!i.geo){s.push(i);return}let l=Math.round(i.geo.lat*10)/10,c=Math.round(i.geo.lon*10)/10,p=`${l}:${c}:${X(i.title||i.alertType||"fire")}`;a.has(p)||(a.add(p),s.push(i))}),[...n,...s]}function Lt(e){let t=[],n=[];if(e.forEach(i=>{i?.category==="security"||i?.tags?.includes("conflict")?t.push(i):n.push(i)}),!t.length)return e;let a=new Map;t.forEach(i=>{let l=i.conflictKey||(()=>{if(!i.geo)return"";let p=En(i.publishedAt||Date.now()),m=Math.round(i.geo.lat*5)/5,y=Math.round(i.geo.lon*5)/5,d=X(i.alertType||i.eventType||i.title||"").slice(0,24);return`${p}:${m}:${y}:${d}`})();if(!l){let p=`na:${X(i.title||"").slice(0,24)}`,m=a.get(p)||[];m.push(i),a.set(p,m);return}let c=a.get(l)||[];c.push(i),a.set(l,c)});let s=[];return a.forEach(i=>{let c={...[...i].sort((m,y)=>(y.publishedAt||0)-(m.publishedAt||0))[0]},p=Array.from(new Set(i.map(m=>m.source||m.feedName||"").filter(Boolean)));p.length>1&&(c.verificationCount=p.length,c.verificationSources=p,c.verified=!0),s.push(c)}),[...n,...s]}function fi(e){if(!e)return"other";let t=(e.eventType||e.alertType||e.subEventType||e.title||"").toLowerCase();return t.includes("battle")?"battle":t.includes("explosion")||t.includes("remote violence")||t.includes("ied")||t.includes("bomb")||t.includes("incendiary")||t.includes("arson")?"explosion":t.includes("violence against civilians")||t.includes("violence")||t.includes("assault")||t.includes("shoot")||t.includes("active shooter")||t.includes("killing")||t.includes("murder")||t.includes("attack")||t.includes("ambush")||t.includes("stabbing")||t.includes("ramming")||t.includes("vandalism")?"violence":t.includes("riot")?"riot":t.includes("protest")||t.includes("demonstration")?"protest":t.includes("riot")?"riot":"other"}function Vt(){let e=Jt();ke(o.localList,e)}function O(e){let t=r.scopedItems.filter(a=>a.category===e);!t.length&&ps.has(e)&&(t=W(K(r.items)).filter(a=>a.category===e));let n=t;if(t=t.filter(a=>!a.mapOnly),e==="health"&&!t.length&&n.length)return{items:[],mapOnlyNotice:!0};if(e==="health"&&t.length&&r.settings.mapLayers.health){let a=t.filter(s=>s.feedId!=="openaq-api");if(a.length)t=a;else return{items:[],mapOnlyNotice:!0}}return e==="crypto"&&(t=[...t].sort((a,s)=>Math.abs(s.change24h||0)-Math.abs(a.change24h||0))),e==="research"&&(t=We(t)),e==="security"&&(t=Lt(t)),{items:t,mapOnlyNotice:!1}}function dr(e){return e?String(e).toUpperCase().replace(/\./g,"").trim():""}function mr(e,t,n){let a=Number(e);return!a||!t||!n?"":`${a}:${dr(t)}:${n}`}function hi(e){return e?mr(e.congress,e.billType,e.billNumber):""}function wa(e){return e?.alertType==="Amendment"}function bi(e,t){let n=Number(e);return!n||!t?"":`${n}:PN:${t}`}function vi(e){let t=typeof globalThis<"u"?globalThis.formatNominationTitle:void 0;if(typeof t=="function")return t(e);let n=e?.description||"";if(!n)return"";let[a,s]=n.split(", of "),i=n.split(" to be ");if(i.length>1){let l=i[0].replace(/,? of .*/i,"").trim(),c=i[1].replace(/, vice .*/i,"").trim();if(l&&c)return`${l} \u2014 ${c}`}if(a&&s){let l=s.split(", vice ")[0];if(l)return`${a.trim()} \u2014 ${l.trim()}`}return n}function Te(e){let t=typeof globalThis<"u"?globalThis.normalizeCongressUrl:void 0;if(typeof t=="function")return t(e);if(!e)return"";try{let n=new URL(e),a=`${n.origin}${n.pathname}`;return a.includes("/event/")&&a.includes("/text")?a.split("/text")[0]:a}catch{return e.split("#")[0].split("?")[0]}}function Si(e){return e.length?e.find(n=>{let a=vi(n),s=n.detailTitle||n.title||"";return a||n.description||s.includes("\u2014")||s.length>40})||e[0]:null}function wi(e){if(!e)return{amendment:null,bill:null};let t=e.amendment||e.amendments?.[0]||e.results?.[0]||e,n=t?.amendedBill||t?.amendedBills?.[0]||t?.bill||t?.legislation||null;return{amendment:t,bill:n}}function Ci(e){return e?e.hearing||e.hearings?.[0]||e.meeting||e.meetings?.[0]||e.results?.[0]||e:null}async function pr(e){if(!e)return null;let{response:t,data:n}=await me(`/api/congress-detail?url=${encodeURIComponent(e)}`,{},12e3);return t?.ok?n:null}async function Li(e){if(!e.length)return;let t=e.filter(a=>a.apiUrl&&!r.congressHearingCache.has(a.apiUrl));if(!t.length)return;let n=t.slice(0,40);for(let a of n){let s=await pr(a.apiUrl);r.congressHearingCache.set(a.apiUrl,s||null)}}async function ki(e){if(!e.length||r.congressAmendmentsLoading)return;let t=e.filter(n=>n.apiUrl&&!r.congressAmendmentCache.has(n.apiUrl));if(t.length){r.congressAmendmentsLoading=!0;try{let n=t.slice(0,80);for(let a of n){let s=await pr(a.apiUrl);r.congressAmendmentCache.set(a.apiUrl,s||null);let{amendment:i,bill:l}=wi(s),c=mr(l?.congress||a.congress,l?.type||a.billType,l?.number||a.billNumber);if(!c)continue;let p={title:a.title,summary:a.summary,publishedAt:a.publishedAt,externalUrl:a.externalUrl,type:dr(a.amendmentType||a.type),number:a.amendmentNumber||a.number,chamber:a.location||a.chamber||"",purpose:i?.purpose||i?.description||""},y=[...r.congressBillAmendments.get(c)||[],p].filter((d,g,f)=>d.externalUrl?f.findIndex(h=>h.externalUrl===d.externalUrl)===g:f.findIndex(h=>h.title===d.title)===g);y.sort((d,g)=>(g.publishedAt||0)-(d.publishedAt||0)),r.congressBillAmendments.set(c,y.slice(0,50))}gr()}finally{r.congressAmendmentsLoading=!1}}}function Ve(){let e=g=>g.feedId==="congress-api"||g.tags?.includes("congress"),t=r.scopedItems.filter(e);t.length||(t=W(K(r.items)).filter(e)),t=t.filter(g=>!g.mapOnly);let n=We(t),a=n.filter(wa),s=n.filter(g=>g.alertType==="Hearing"),i=n.filter(g=>g.nominationId),l=n.filter(g=>!wa(g));ki(a),Li(s);let c=new Map;i.forEach(g=>{let f=bi(g.congress,g.nominationId);if(!f)return;let h=c.get(f)||[];h.push(g),c.set(f,h)});let p=[];c.forEach(g=>{let f=[...g].sort((C,S)=>(S.publishedAt||0)-(C.publishedAt||0)),h=Si(f)||f[0];if(!h)return;let b=f.map(C=>({title:C.summary||C.title,publishedAt:C.publishedAt,externalUrl:C.externalUrl})),k=f[0]?.publishedAt||h.publishedAt;p.push({...h,nominationActions:b,publishedAt:k})});let m=new Map;s.forEach(g=>{let f=Ci(r.congressHearingCache.get(g.apiUrl));if(!f)return;let h=f.meetingTitle||f.title||f.eventTitle||f.description||g.title,b=f.committee?.name||f.committees?.[0]?.name||f.committeeName,k=f.date||f.meetingDate||f.startDate,C=(f.chamber||g.chamber||"").toLowerCase(),S=f.congress||g.congress,A=f.eventId||f.hearingId||f.meetingId||f.event,M=S&&A&&(C==="house"||C==="senate")?`https://www.congress.gov/event/${S}th-congress/${C}-event/${A}`:"",w=Te(f.url)||Te(f.websiteUrl)||Te(f.eventUrl)||Te(f.congressUrl)||Te(M)||Te(g.externalUrl)||Te(g.fallbackUrl);m.set(g.apiUrl,{title:h||g.title,committee:b,when:k,link:w})});let d=[...l.filter(g=>!g.nominationId),...p].map(g=>{let f=g.publishedAt||0;if(g.alertType==="Hearing"&&g.apiUrl&&m.has(g.apiUrl)){let S=m.get(g.apiUrl),A=[S.committee,g.chamber,S.when?re(S.when):""].filter(Boolean);return{...g,title:S.title||g.title,detailTitle:S.title||g.detailTitle,summary:A.length?A.join(" \u2022 "):g.summary,externalUrl:S.link?S.link:g.externalUrl||g.fallbackUrl,detailFields:g.detailFields?.map(M=>M.label==="Committee"&&S.committee?{...M,value:S.committee}:M.label==="Hearing Date"&&S.when?{...M,value:re(S.when)}:M),congressSortTime:f}}let h=hi(g),b=h?r.congressBillAmendments.get(h)||[]:[],k=b[0]?.publishedAt||0,C=Math.max(f,k||0);return{...g,amendments:b,congressSortTime:C}});return d.sort((g,f)=>(f.congressSortTime||0)-(g.congressSortTime||0)),d.map(({congressSortTime:g,...f})=>f)}function pe(e,t){if(!t)return;let{items:n,mapOnlyNotice:a}=O(e);if(a){t.innerHTML='<div class="list-item"><div class="list-title">Air quality signals are shown on the map.</div><div class="list-summary">Toggle the Health layer in the map legend to filter air quality stations.</div></div>';return}ke(t,n)}function gr(){if(!o.congressList)return;let e=Ve();ke(o.congressList,e)}function le(e){let t=r.scopedItems.filter(n=>e.includes(n.category));return(e.includes("weather")||e.includes("disaster")||e.includes("space"))&&(t=We(t.map(n=>({...n,_dedupeKey:`${X(n.alertType||"")}|${X(n.title||"")}|${X(n.location||n.geoLabel||"")}`}))).map(n=>{let{_dedupeKey:a,...s}=n;return s})),t}function pn(e,t){if(!t)return;let n=le(e);ke(t,n)}function Tn(){if(!o.energyList)return;let e=Zt();ke(o.energyList,e)}async function Ei(){if(!(r.predictionFallback.loading||r.predictionFallback.loaded)){r.predictionFallback.loading=!0;try{let e=r.feeds.find(a=>a.id==="polymarket-markets");if(!e){r.predictionFallback.loaded=!0;return}let n=await(await fetch(`${be("/data/feeds/polymarket-markets.json")}?_ts=${Date.now()}`)).json();if(n?.body){let a=Mt(n.body,e)||[];r.predictionFallback.items=a.map(s=>({...s,tags:e.tags||[],feedId:e.id,feedName:e.name}))}r.predictionFallback.loaded=!0}catch{r.predictionFallback.loaded=!0}finally{r.predictionFallback.loading=!1}}}function Qt(){let e=O("prediction").items;if(!e.length&&r.predictionFallback.items.length&&(e=r.predictionFallback.items),!e.length)return[];let t=f=>/\\b(btc|eth|sol|xrp|crypto|bitcoin|ethereum|solana|doge)\\b/i.test(f.title||""),n=[...e].sort((f,h)=>(h.volume24||0)-(f.volume24||0)),a=n.filter(f=>!t(f)),s=n.filter(f=>t(f)),i=[...a.slice(0,2),...s.slice(0,Math.max(0,2-a.length))],l=new Set(i.map(f=>f.title)),c=[...e].sort((f,h)=>(h.publishedAt||0)-(f.publishedAt||0)).filter(f=>!l.has(f.title)),p=c.filter(f=>!t(f)),m=c.filter(f=>t(f)),y=[...p.slice(0,2),...m.slice(0,Math.max(0,2-p.length))],d=[...i,...y],g=e.filter(f=>!d.includes(f));return[...d,...g]}function yr(){if(!o.predictionList)return;let e=Qt();!e.length&&!r.predictionFallback.loaded&&!r.predictionFallback.loading&&Ei().then(()=>yr()),!e.length&&r.predictionFallback.items.length&&(e=r.predictionFallback.items),ke(o.predictionList,e)}async function Ai(){if(r.energyGeo)return r.energyGeo;let t=await(await fetch(be("/geo/us-states.geojson"))).json();return r.energyGeo=t,t}async function Ti(){if(r.energyMapData&&Date.now()-r.energyMapFetchedAt<36e5)return r.energyMapData;try{let{data:t,error:n}=await me("/api/energy-map");return n||!t?(r.energyMapError="fetch_failed",null):t?.error?(r.energyMapError=t.error,null):(r.energyMapError=null,r.energyMapData=t,r.energyMapFetchedAt=Date.now(),t)}catch{return r.energyMapError="fetch_failed",null}}function Ii(e,t,n){if(!Number.isFinite(e))return"rgba(90, 100, 120, 0.2)";let a=(e-t)/(n-t||1),s=o.app?.dataset?.theme==="light",i=200,l=s?70:75,c=s?85-a*35:55-a*25;return`hsl(${i}, ${l}%, ${c}%)`}async function Bt(){if(!o.energyMap||!window.L)return;let[e,t]=await Promise.all([Ai(),Ti()]);if(!e||!t){if(o.energyMapEmpty){let i=r.energyMapError==="missing_server_key"?"Energy map needs the server EIA key to be configured.":"Energy map unavailable right now.";o.energyMapEmpty.textContent=i,o.energyMapEmpty.style.display="flex"}return}o.energyMapEmpty&&(o.energyMapEmpty.style.display="none"),r.energyMap||(r.energyMap=window.L.map(o.energyMap,{zoomControl:!1,attributionControl:!1,dragging:!0,scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!1,keyboard:!1})),r.energyMapLayer&&r.energyMap.removeLayer(r.energyMapLayer),r.energyMapLayer=window.L.geoJSON(e,{style:i=>{let l=i?.properties?.STUSPS,c=t.values?.[l];return{color:"rgba(60, 80, 110, 0.6)",weight:1,fillColor:Ii(c?.value,t.min,t.max),fillOpacity:.8}},onEachFeature:(i,l)=>{let c=i?.properties?.STUSPS,p=i?.properties?.NAME||c||"Unknown",m=t.values?.[c],y=m?`${m.value.toFixed(2)} ${t.units}`:"No data",d=m?.period||t.period;l.bindTooltip(`${p} (${c}) \u2022 ${y} ${d?`\u2022 ${d}`:""}`,{sticky:!0,direction:"top"}),l.on("mouseover",()=>{l.setStyle({weight:2,fillOpacity:.95})}),l.on("mouseout",()=>{l.setStyle({weight:1,fillOpacity:.8})})}}).addTo(r.energyMap);let n=new Set(["AK","HI","PR","GU","VI","MP","AS"]),a=(e.features||[]).filter(i=>!n.has(i?.properties?.STUSPS)),s=a.length?window.L.geoJSON(a).getBounds():r.energyMapLayer.getBounds();s.isValid()&&r.energyMap.fitBounds(s,{padding:[10,10],maxZoom:5}),setTimeout(()=>r.energyMap.invalidateSize(),80),o.energyMapLegend&&(o.energyMapLegend.innerHTML=`
      <div class="energy-map-legend-title">Price (cents/kWh)</div>
      <div class="energy-map-legend-scale">
        <span>${t.min.toFixed(1)}</span>
        <span>${t.max.toFixed(1)}</span>
      </div>
      <div class="energy-map-legend-bar"></div>
      <div class="energy-map-legend-meta">Residential \u2022 ${t.period}</div>
    `)}function fr(){if(!o.travelTicker||!o.travelTickerTrack||(o.travelTicker.classList.toggle("hidden",!r.settings.showTravelTicker),!r.settings.showTravelTicker))return;let e=r.scopedItems.filter(a=>a.category==="travel");if(e.length||(e=W(K(r.items)).filter(a=>a.category==="travel")),e=We(e).slice(0,14),o.travelTickerTrack.innerHTML="",!e.length){o.travelTickerTrack.innerHTML='<span class="map-travel-item">No travel advisories in the current window.</span>';return}let t=()=>{let a=document.createElement("div");return a.className="map-travel-group",e.forEach(s=>{let i=document.createElement(s.url?"a":"span");i.className="map-travel-item",s.url&&(i.href=s.url,i.target="_blank",i.rel="noopener noreferrer");let l=[];s.severity&&l.push(`<span class="map-travel-chip">${s.severity}</span>`),s.regionTag&&l.push(`<span class="map-travel-chip">${s.regionTag}</span>`),l.push(`<span class="map-travel-text">${Y(s.title||"",120)}</span>`),i.innerHTML=l.join(""),a.appendChild(i)}),a},n=t();o.travelTickerTrack.appendChild(n),e.length>4&&o.travelTickerTrack.appendChild(t())}function Dt(){if(!o.mcpTrendsPanel)return;let{loading:e,error:t,summary:n,signals:a,sources:s,updatedAt:i}=r.mcpTrends;if(o.mcpTrendsSummary)if(e)o.mcpTrendsSummary.textContent="Fetching MCP signals\u2026";else if(t)o.mcpTrendsSummary.textContent=`MCP error: ${t}`;else if(n)o.mcpTrendsSummary.textContent=n;else if(a.length){let l=s.length?`${s.length} sources`:"multiple sources";o.mcpTrendsSummary.textContent=`${a.length} signals across ${l}.`}else o.mcpTrendsSummary.textContent="Awaiting MCP signals.";if(o.mcpTrendsMeta&&(o.mcpTrendsMeta.textContent=i?`Updated ${V(i)}`:"\u2014"),!!o.mcpTrendsList&&(o.mcpTrendsList.innerHTML="",!(e||t))){if(!a.length){o.mcpTrendsList.innerHTML='<div class="trends-empty">No MCP signals yet.</div>';return}a.slice(0,12).forEach(l=>{let c=document.createElement("div");c.className="trends-item";let p=document.createElement(l.url?"a":"div");p.className="trends-title",p.textContent=l.title||l.name||l.label||"Signal",l.url&&(p.href=l.url,p.target="_blank",p.rel="noopener noreferrer");let m=document.createElement("div");m.className="trends-meta";let y=[];l.source&&y.push(l.source),l.category&&y.push(l.category);let d=l.publishedAt||l.updatedAt||l.timestamp;d&&y.push(V(d)),m.textContent=y.filter(Boolean).join(" \u2022 "),c.appendChild(p),c.appendChild(m);let g=l.summary||l.detailSummary||l.description;if(g){let f=document.createElement("div");f.className="trends-summary-text",f.textContent=Y(Je(g),140),c.appendChild(f)}o.mcpTrendsList.appendChild(c)})}}async function gn(e=""){if(!sa)return;let t=String(e||"").trim();r.mcpTrends.query=t,r.mcpTrends.loading=!0,r.mcpTrends.error=null,Dt();try{let n=await sa.callTool("search.smart",{query:t||"top signals",limit:30});if(n.error)r.mcpTrends.error=n.message||"MCP request failed.",r.mcpTrends.signals=[],r.mcpTrends.sources=[],r.mcpTrends.summary=null;else{let a=n.data||{},s=Array.isArray(a.items)?a.items:Array.isArray(a.results)?a.results:Array.isArray(a.signals)?a.signals:[],i=Array.isArray(a.sources)?a.sources:Array.isArray(a.providers)?a.providers:[];r.mcpTrends.signals=s,r.mcpTrends.sources=i,r.mcpTrends.summary=a.summary||a.overview||null}}catch(n){r.mcpTrends.error=n?.message||"MCP request failed.",r.mcpTrends.signals=[],r.mcpTrends.sources=[],r.mcpTrends.summary=null}finally{r.mcpTrends.loading=!1,r.mcpTrends.updatedAt=Date.now(),Dt()}}function Mi(){o.mcpTrendsPanel&&(o.mcpTrendsRun&&o.mcpTrendsRun.addEventListener("click",()=>{gn(o.mcpTrendsQuery?.value||"")}),o.mcpTrendsQuery&&o.mcpTrendsQuery.addEventListener("keydown",e=>{e.key==="Enter"&&gn(o.mcpTrendsQuery.value||"")}),Dt(),gn(""))}function In(){if(!o.denarioPanel||(o.denarioPanel.classList.toggle("is-hidden",!r.denario.available),!r.denario.available)||(o.denarioMeta&&(o.denarioMeta.textContent=r.denario.summary||"Denario insights loaded."),!o.denarioList))return;o.denarioList.innerHTML="";let e=Array.isArray(r.denario.items)?r.denario.items:[];if(!e.length){o.denarioList.innerHTML='<div class="denario-empty">No deep analysis available yet.</div>';return}e.slice(0,6).forEach(t=>{let n=document.createElement("div");n.className="denario-item";let a=document.createElement("div");a.className="denario-item-title",a.textContent=t.title||t.label||"Insight";let s=document.createElement("div");s.className="denario-item-summary",s.textContent=Y(Je(t.summary||t.detail||""),180),n.appendChild(a),n.appendChild(s),o.denarioList.appendChild(n)})}async function xi(){if(o.denarioPanel){r.denario.loading=!0,In();try{let e=await fetch(be("data/denario.json"));if(!e.ok)throw new Error("Denario unavailable");let t=await e.json();r.denario.available=!0,r.denario.summary=t.summary||t.overview||null,r.denario.items=Array.isArray(t.items)?t.items:[]}catch(e){r.denario.available=!1,r.denario.summary=null,r.denario.items=[],r.denario.error=e?.message||"Denario unavailable"}finally{r.denario.loading=!1,In()}}}function ye(){ui(r.clusters),pn(["finance","energy"],o.financeMarketsList),pn(["gov","cyber","agriculture"],o.financePolicyList),pe("crypto",o.cryptoList),yr(),pn(["disaster","weather","space"],o.disasterList),pe("security",o.securityList),pe("gov",o.policyList),gr(),pe("cyber",o.cyberList),pe("agriculture",o.agricultureList),pe("research",o.researchList),pe("space",o.spaceList),Tn(),Bt(),pe("health",o.healthList),pe("transport",o.transportList),Vt(),fr(),zt(),Ye(),Dt(),In(),tr(),Kt()}function Ca(){qa(!1)}function Ni(){o.listModalClose&&o.listModalClose.addEventListener("click",()=>Ca()),o.listOverlay&&o.listOverlay.addEventListener("click",e=>{e.target===o.listOverlay&&Ca()})}function Fi(){o.detailClose&&o.detailClose.addEventListener("click",()=>la()),o.detailOverlay&&o.detailOverlay.addEventListener("click",e=>{e.target===o.detailOverlay&&la()})}function Pi(){if(!o.communityConnect||!o.communityFrame)return;let e=o.communityFrame,t=()=>{if(e.src)return;let n=e.dataset.src;n&&(e.src=n)};o.communityConnect.addEventListener("click",()=>{t()})}function Bi(){let e=Array.from(document.querySelectorAll(".clock-card[data-timezone]"));if(!e.length)return;let t=new Map,n=l=>(t.has(l)||t.set(l,new Intl.DateTimeFormat("en-US",{timeZone:l,hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})),t.get(l)),a=l=>{let c=NaN,p=NaN,m=NaN;return l.forEach(y=>{y.type==="hour"&&(c=Number(y.value)),y.type==="minute"&&(p=Number(y.value)),y.type==="second"&&(m=Number(y.value))}),Number.isNaN(c)||Number.isNaN(p)||Number.isNaN(m)?null:{hours:c,minutes:p,seconds:m}},s=(l,c)=>{try{let p=n(l).formatToParts(c),m=a(p);if(m)return m}catch{}try{let p=new Date(c.toLocaleString("en-US",{timeZone:l}));if(!Number.isNaN(p.getTime()))return{hours:p.getHours(),minutes:p.getMinutes(),seconds:p.getSeconds()}}catch{}return{hours:c.getHours(),minutes:c.getMinutes(),seconds:c.getSeconds()}},i=()=>{let l=new Date;e.forEach(c=>{let p=c.dataset.timezone,{hours:m,minutes:y,seconds:d}=s(p,l),f=(m%12+y/60+d/3600)*30,h=(y+d/60)*6,b=d*6,k=c.querySelector(".clock-hand.hour"),C=c.querySelector(".clock-hand.minute"),S=c.querySelector(".clock-hand.second");k&&(k.style.transform=`translateX(-50%) rotate(${f}deg)`),C&&(C.style.transform=`translateX(-50%) rotate(${h}deg)`),S&&(S.style.transform=`translateX(-50%) rotate(${b}deg)`);let A=c.querySelector('[data-role="time"]');if(A){let M=String(m).padStart(2,"0"),w=String(y).padStart(2,"0");A.textContent=`${M}:${w}`}})};i(),setInterval(i,1e3)}function Di(){let e=[...document.querySelectorAll(".nav-link[data-panel-target]")];if(!e.length)return;let t=[...document.querySelectorAll(".panel[data-panel]")].filter(i=>i.dataset.panel!=="lidar"),n=i=>{e.forEach(l=>{l.classList.toggle("active",l.dataset.panelTarget===i)})};e.forEach(i=>{i.addEventListener("click",()=>{let l=i.dataset.panelTarget,c=t.find(p=>p.dataset.panel===l);c&&c.scrollIntoView({behavior:"smooth",block:"start"}),n(l),De(!1)})});let a=!1,s=()=>{a||(a=!0,requestAnimationFrame(()=>{let l=t[0]?.dataset.panel;t.forEach(c=>{c.getBoundingClientRect().top-140<=0&&(l=c.dataset.panel)}),l&&n(l),a=!1}))};window.addEventListener("scroll",s,{passive:!0}),s()}function $i(){[...document.querySelectorAll(".command-section")].forEach(t=>{let n=t.querySelector(".command-section-toggle");if(!n)return;let a=t.dataset.defaultOpen==="true";t.classList.toggle("is-open",a),n.setAttribute("aria-expanded",a?"true":"false"),n.addEventListener("click",()=>{let s=t.classList.toggle("is-open");n.setAttribute("aria-expanded",s?"true":"false")})})}function Oi(){[{id:"newsList",withCoverage:!0,getItems:()=>Wt(r.clusters)},{id:"financeMarketsList",getItems:()=>le(["finance","energy"])},{id:"financePolicyList",getItems:()=>le(["gov","cyber","agriculture"])},{id:"cryptoList",getItems:()=>O("crypto").items},{id:"predictionList",getItems:()=>Qt()},{id:"disasterList",getItems:()=>le(["disaster","weather","space"])},{id:"localList",getItems:()=>Jt()},{id:"policyList",getItems:()=>O("gov").items},{id:"congressList",getItems:()=>Ve()},{id:"cyberList",getItems:()=>O("cyber").items},{id:"agricultureList",getItems:()=>O("agriculture").items},{id:"researchList",getItems:()=>O("research").items},{id:"spaceList",getItems:()=>O("space").items},{id:"energyList",getItems:()=>Zt()},{id:"healthList",getItems:()=>O("health").items},{id:"transportList",getItems:()=>O("transport").items}].forEach(t=>{let n=document.getElementById(t.id);n&&n.addEventListener("scroll",()=>{if(n.scrollTop+n.clientHeight<n.scrollHeight-60)return;let a=t.getItems();if(!a||!a.length)return;let s=Za(t.id);if(s>=a.length)return;let i=Math.min(a.length,s+gs);r.listLimits[t.id]=i,ot(n,a.slice(s,i),{withCoverage:t.withCoverage,append:!0})})})}function Ri(){if(typeof ResizeObserver>"u")return;let e=[{id:"newsList",withCoverage:!0,getItems:()=>Wt(r.clusters)},{id:"financeMarketsList",getItems:()=>le(["finance","energy"])},{id:"financePolicyList",getItems:()=>le(["gov","cyber","agriculture"])},{id:"cryptoList",getItems:()=>O("crypto").items},{id:"predictionList",getItems:()=>Qt()},{id:"disasterList",getItems:()=>le(["disaster","weather","space"])},{id:"localList",getItems:()=>Jt()},{id:"policyList",getItems:()=>O("gov").items},{id:"congressList",getItems:()=>Ve()},{id:"cyberList",getItems:()=>O("cyber").items},{id:"agricultureList",getItems:()=>O("agriculture").items},{id:"researchList",getItems:()=>O("research").items},{id:"spaceList",getItems:()=>O("space").items},{id:"energyList",getItems:()=>Zt()},{id:"healthList",getItems:()=>O("health").items},{id:"transportList",getItems:()=>O("transport").items}],t=new Map(e.map(a=>[a.id,a])),n=new ResizeObserver(a=>{a.forEach(s=>{let i=t.get(s.target.id);if(!i)return;let l=i.getItems();!l||!l.length||ke(s.target,l,{withCoverage:i.withCoverage})})});e.forEach(a=>{let s=document.getElementById(a.id);s&&n.observe(s)})}function Yt(e=1){let t=new Date;return t.setUTCDate(t.getUTCDate()-e),t.toISOString().slice(0,10)}function te(e,t,n="jpg",a="GoogleMapsCompatible_Level9"){return`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${e}/default/${t}/${a}/{z}/{y}/{x}.${n}`}function hr(e){return`https://services.terrascope.be/wmts/v2/wmts?service=WMTS&request=GetTile&version=1.0.0&layer=CGS_S1_GRD_SIGMA0&style=default&format=image/png&tilematrixset=EPSG:3857&tilematrix=EPSG:3857:{z}&tilerow={y}&tilecol={x}&time=${e}`}function La(e,t,n,a){return`https://services.terrascope.be/wmts/v2/wmts?service=WMTS&request=GetTile&version=1.0.0&layer=CGS_S1_GRD_SIGMA0&style=default&format=image/png&tilematrixset=EPSG:3857&tilematrix=EPSG:3857:${t}&tilerow=${n}&tilecol=${a}&time=${e}`}async function _i(){if(r.sarCapabilitiesChecked)return r.sarCapabilitiesDate;r.sarCapabilitiesChecked=!0;let e="https://services.terrascope.be/wmts/v2/wmts?service=WMTS&request=GetCapabilities";try{let t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error(`GetCapabilities ${t.status}`);let n=await t.text(),a=n.match(/<Layer[^>]*>[\s\S]*?<Identifier>CGS_S1_GRD_SIGMA0<\/Identifier>[\s\S]*?<\/Layer>/i),i=(a?a[0]:n).match(/\d{4}-\d{2}-\d{2}/g);i&&i.length&&(r.sarCapabilitiesDate=i[i.length-1])}catch(t){console.warn("SAR GetCapabilities fetch failed",t)}return r.sarCapabilitiesDate}function $t(e=.25){let t=Math.max(0,Math.min(e,.6));return{color:`rgba(58, 148, 255, ${Math.min(1,t+.35).toFixed(2)})`,weight:1,fillColor:`rgba(58, 148, 255, ${t.toFixed(2)})`,fillOpacity:t}}function Ui(e=.3){let t=Math.max(.15,Math.min(e,.7));return{color:"rgba(255, 189, 64, 0.95)",weight:2,fillColor:`rgba(255, 189, 64, ${t.toFixed(2)})`,fillOpacity:t}}function Hi(e){let t=ne("lidar",.25);r.lidarSelectedLayer&&r.lidarSelectedLayer.setStyle&&r.lidarSelectedLayer.setStyle($t(t)),r.lidarSelectedLayer=e||null,e?.setStyle&&(e.setStyle(Ui(t+.1)),e.bringToFront&&e.bringToFront())}function qi(e){if(!e)return null;let t=e.replace(/\s+/g,"_");return`https://s3-us-west-2.amazonaws.com/usgs-lidar-public/${encodeURIComponent(t)}/ept.json`}function br(e){if(!e)return null;let t=e.boundsConforming||e.bounds;if(!Array.isArray(t)||t.length<6)return null;let n=(t[0]+t[3])/2,a=(t[1]+t[4])/2,s=(t[2]+t[5])/2;return[n,a,s]}function vt(e,t,n,a){let s=Number(e);return Number.isFinite(s)?Math.min(a,Math.max(n,s)):t}function Ot(e={}){return{useCustom:!!e.useCustom,pointCap:vt(e.pointCap,15e4,1e4,5e5),radiusKm:vt(e.radiusKm,5,1,25),maxTilesDesktop:vt(e.maxTilesDesktop,16,1,32),maxTilesMobile:vt(e.maxTilesMobile,8,1,16)}}function Gi(){let e=window.matchMedia&&window.matchMedia("(max-width: 900px)").matches,t=Ot(),n=Ot(r.settings.lidarPointLimits),a=n.useCustom;return{pointCap:a?n.pointCap:t.pointCap,radiusKm:a?n.radiusKm:t.radiusKm,maxTiles:a?e?n.maxTilesMobile:n.maxTilesDesktop:e?t.maxTilesMobile:t.maxTilesDesktop}}function jn(e){let t=e?.srs;if(!t)return null;let n=t?.horizontal||t?.authority||t?.horizontalEPSG||t?.authorityCode,a=Number(n);return Number.isFinite(a)?a:null}function vr(e){let t=jn(e);return t===4326||t===3857}function ji(e,t){let a=e/6378137*(180/Math.PI),s=(2*Math.atan(Math.exp(t/6378137))-Math.PI/2)*(180/Math.PI);return[a,s]}function zi(e){return e?e.replace(/\/ept\.json$/i,"/"):null}function Ki(e,t){return`${e}ept-hierarchy/${t}.json`}function Wi(e,t,n){return`${e}data/${t}.${n}`}function Ji(e){let t=String(e).split("-").map(l=>Number(l));if(t.length!==4||t.some(l=>!Number.isFinite(l)))return null;let[n,a,s,i]=t;return{depth:n,x:a,y:s,z:i}}function Zi(e,t){let n=Ji(t);if(!n)return null;let a=e?.boundsConforming||e?.bounds;if(!Array.isArray(a)||a.length<6)return null;let[s,i,l,c,p,m]=a,y=2**n.depth,d=(c-s)/y,g=(p-i)/y,f=(m-l)/y,h=s+n.x*d,b=h+d,k=i+n.y*g,C=k+g,S=l+n.z*f,A=S+f;return[h,k,S,b,C,A]}function Vi(e,t,n,a){let i=m=>m*Math.PI/180,l=i(n-e),c=i(a-t),p=Math.sin(l/2)**2+Math.cos(i(e))*Math.cos(i(n))*Math.sin(c/2)**2;return 2*6371e3*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))}async function Qi(e){let n=Ki(e,"0-0-0-0"),a=await fetch(n,{cache:"no-store"});if(!a.ok)throw new Error(`EPT hierarchy ${a.status}`);let s=await a.json();return Object.entries(s||{}).map(([i,l])=>({key:i,count:Number(l)||0}))}function Yi(e,t,n,a,s){if(!e.length)return[];let i=jn(n),l=(s||0)*1e3,c=e.map(d=>{let g=Zi(n,d.key);if(!g||!a)return{...d,distance:Number.POSITIVE_INFINITY};let f=(g[0]+g[3])/2,h=(g[1]+g[4])/2,b=Number.POSITIVE_INFINITY;if(i===4326)b=Vi(a[1],a[0],h,f);else if(i===3857){let k=f-a[0],C=h-a[1];b=Math.sqrt(k*k+C*C)}return{...d,distance:b}}),p=l?c.filter(d=>d.distance<=l):c;return(p.length?p:c).slice().sort((d,g)=>d.distance!==g.distance?d.distance-g.distance:g.count-d.count).slice(0,t).map(d=>d.key)}async function Xi(){let e=r.lidarPointEptUrl,t=r.lidarPointEptMeta;if(!e||!t)throw new Error("EPT metadata missing");if(!vr(t))throw new Error("EPT SRS unsupported");let n=zi(e),a=t.dataType||"laz",s=Gi(),i=await Qi(n),l=br(t),c=Yi(i,s.maxTiles,t,l,s.radiusKm);if(!c.length)throw new Error("EPT hierarchy empty");let{LASLoader:p}=await import("https://unpkg.com/@loaders.gl/las@3.4.14/dist/esm/index.js"),m=[],y=jn(t),d=0;for(let g of c){let f=Wi(n,g,a),h=await fetch(f);if(!h.ok)continue;let b=await h.arrayBuffer(),C=(await p.parse(b,{}))?.attributes?.POSITION?.value;if(!C)continue;let S=C.length/3,A=Math.max(1,Math.ceil(S/Math.max(1,Math.floor(s.pointCap/c.length))));for(let M=0;M<S&&d<s.pointCap;M+=A){let w=M*3,I=C[w],u=C[w+1],v=C[w+2];if(y===3857){let E=ji(I,u);I=E[0],u=E[1]}if(m.push({position:[I,u,v],color:[80,195,255,200]}),d+=1,d>=s.pointCap)break}if(d>=s.pointCap)break}if(!m.length)throw new Error("EPT tiles empty");return r.lidarPointSource="ept",r.lidarPointData=m,m.length}function ka(e,t,n){if(!e||!t)return;let a=e?.properties?.name||null;r.lidarPointProject=a,r.lidarPointEptUrl=qi(a),r.lidarPointEptAvailable=!1,r.lidarPointEptMeta=null,r.lidarPointSource=null,r.lidarSelectedBounds=t,Hi(n),r.lidarPointEptUrl&&el(r.lidarPointEptUrl);let s=t.getCenter?.();s&&(r.lidarPointAnchor=[s.lng,s.lat,0]),r.settings.mapRasterOverlays?.lidarPoints&&Rt(),st()}async function el(e){if(e){N("lidarPoints","loading","checking ept");try{let t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error(`EPT status ${t.status}`);r.lidarPointEptAvailable=!0;try{let n=await t.clone().json();r.lidarPointEptMeta=n;let a=br(n);a&&(r.lidarPointAnchor=[a[0],a[1],0]),Re({status:"ept_meta",project:r.lidarPointProject||null})}catch(n){console.warn("LiDAR EPT meta parse failed",n)}N("lidarPoints","ready",`ept ok \u2022 ${r.lidarPointProject||"project"}`),Re({status:"ept_ok",project:r.lidarPointProject||null,eptUrl:e})}catch(t){console.warn("LiDAR EPT check failed",t),r.lidarPointEptAvailable=!1,r.lidarPointEptMeta=null,N("lidarPoints","unavailable","ept unavailable"),Re({status:"ept_unavailable",project:r.lidarPointProject||null,eptUrl:e,reason:t?.message||"ept unavailable"})}finally{st()}}}async function Mn(){if(!(!r.map||r.lidarCoverageLoading||r.lidarCoverageLayer)){if(!window.topojson){console.warn("TopoJSON not available for LiDAR coverage."),N("lidar","unavailable","topojson missing");return}r.lidarCoverageLoading=!0,N("lidar","loading","loading coverage");try{let e=await fetch(Ss);if(!e.ok)throw new Error(`LiDAR coverage fetch failed: ${e.status}`);let t=await e.json();try{localStorage.setItem(oa,JSON.stringify(t))}catch(l){console.warn("LiDAR cache write failed",l)}let n=t?.objects?Object.keys(t.objects)[0]:null;if(!n)throw new Error("LiDAR coverage data missing.");let a=window.topojson.feature(t,t.objects[n]),s=ne("lidar",.25),i=window.L.geoJSON(a,{style:()=>$t(s),onEachFeature:(l,c)=>{let p=l?.properties?.name||"LiDAR coverage",m=l?.properties?.count,y=m?`${p} \u2022 ${m} tiles`:p;c?.bindPopup&&c.bindPopup(y),c?.on&&c.getBounds&&c.on("click",()=>{ka(l,c.getBounds(),c)})}});r.lidarCoverageLayer=i,r.mapOverlayLayers={...r.mapOverlayLayers,lidar:i},ce(),N("lidar","ready","coverage loaded")}catch(e){console.warn("LiDAR coverage load failed",e);try{let t=localStorage.getItem(oa);if(t){let n=JSON.parse(t),a=n?.objects?Object.keys(n.objects)[0]:null;if(a){let s=window.topojson.feature(n,n.objects[a]),i=ne("lidar",.25),l=window.L.geoJSON(s,{style:()=>$t(i),onEachFeature:(c,p)=>{p?.on&&p.getBounds&&p.on("click",()=>{ka(c,p.getBounds(),p)})}});r.lidarCoverageLayer=l,r.mapOverlayLayers={...r.mapOverlayLayers,lidar:l},ce(),N("lidar","ready","cached coverage");return}}}catch(t){console.warn("LiDAR cache read failed",t)}N("lidar","unavailable","coverage fetch failed")}finally{r.lidarCoverageLoading=!1}}}async function Rt(){if(!r.map||r.lidarPointLoading||r.lidarPointLayer)return;if(!window.deck||!window.DeckGlLeaflet){N("lidarPoints","unavailable","deck.gl missing"),Re({status:"unavailable",reason:"deck.gl missing"});return}let e=performance.now();r.lidarPointLoading=!0;let t=r.lidarPointEptAvailable&&r.lidarPointEptMeta&&vr(r.lidarPointEptMeta);N("lidarPoints","loading",t?"loading ept tiles":"loading sample");try{if((!r.lidarPointData||r.lidarPointSource!==(t?"ept":"sample"))&&(r.lidarPointData=null,r.lidarPointSource=null),!r.lidarPointData&&t&&await Xi(),!r.lidarPointData){let{LASLoader:i}=await import("https://unpkg.com/@loaders.gl/las@3.4.14/dist/esm/index.js"),l=await fetch(ws);if(!l.ok)throw new Error(`LiDAR sample fetch failed: ${l.status}`);let c=await l.arrayBuffer(),p=await i.parse(c,{}),m=p?.attributes?.POSITION?.value;if(!m)throw new Error("LiDAR sample missing POSITION data.");let y=m.length/3,d=p?.header?.boundingBox,g=d?[(d[0][0]+d[1][0])/2,(d[0][1]+d[1][1])/2,(d[0][2]+d[1][2])/2]:[0,0,0],f=p?.attributes?.intensity?.value,h=Math.max(1,Math.ceil(y/Cs)),b=[];for(let C=0;C<y;C+=h){let S=C*3,A=f?f[C]:0,M=Math.min(255,Math.max(30,Math.round(30+A/65535*225)));b.push({position:[m[S]-g[0],m[S+1]-g[1],m[S+2]-g[2]],color:[60,M,255,200]})}r.lidarPointData=b,r.lidarPointSource="sample";let k=r.map.getCenter();r.lidarPointAnchor=[k.lng,k.lat,0]}let n=Sr(),a=new window.DeckGlLeaflet.LeafletLayer({layers:[n]});r.lidarPointLayer=a,r.mapOverlayLayers={...r.mapOverlayLayers,lidarPoints:a},ce();let s=r.lidarPointSource==="ept"?`project ${r.lidarPointProject||"ept"}`:r.lidarPointProject?`sample \u2022 ${r.lidarPointProject}`:"sample";N("lidarPoints","ready",`points ${r.lidarPointData.length} \u2022 ${s}`),Re({status:"ready",points:r.lidarPointData.length,project:r.lidarPointProject||null,eptUrl:r.lidarPointEptUrl||null,source:r.lidarPointSource||null,loadMs:Math.round(performance.now()-e)})}catch(n){console.warn("LiDAR point overlay failed",n),r.lidarPointSource=null,N("lidarPoints","unavailable",t?"ept load failed":"sample load failed"),Re({status:"unavailable",reason:n?.message||"sample load failed",source:r.lidarPointSource||null,loadMs:Math.round(performance.now()-e)})}finally{r.lidarPointLoading=!1}}function Sr(){let{PointCloudLayer:e,COORDINATE_SYSTEM:t}=window.deck,n=ne("lidarPoints",.65),a=r.lidarPointAnchor||[r.location.lon,r.location.lat,0],s=r.lidarPointSource||"sample",i=s==="ept"?t.LNGLAT:t.METER_OFFSETS;return new e({id:"lidar-points",data:r.lidarPointData||[],getPosition:l=>l.position,getColor:l=>l.color,pointSize:s==="ept"?1.5:2,opacity:n,coordinateSystem:i,coordinateOrigin:s==="ept"?void 0:a,pickable:!1})}function Re(e){let t={ts:new Date().toISOString(),...e},n=[...r.lidarPointTelemetry||[],t].slice(-50);r.lidarPointTelemetry=n;try{localStorage.setItem(Da,JSON.stringify(n))}catch(a){console.warn("LiDAR telemetry write failed",a)}}function tl(e){return e.replace("{z}","2").replace("{y}","1").replace("{x}","1")}function zn(e,t=5e3){return new Promise(n=>{let a=new Image,s=setTimeout(()=>{a.src="",n(!1)},t);a.onload=()=>{clearTimeout(s),n(!0)},a.onerror=()=>{clearTimeout(s),n(!1)};let i=e.includes("?")?"&":"?";a.src=`${e}${i}cb=${Date.now()}`})}function Ea(e,t,n){let a=2**n,s=Math.floor((t+180)/360*a),i=e*Math.PI/180,l=Math.floor((1-Math.log(Math.tan(i)+1/Math.cos(i))/Math.PI)/2*a);return{x:s,y:l,z:n}}function wr(e){let t=r.map;if(t&&typeof t.getBounds=="function"){let s=t.getBounds(),i=t.getCenter(),l=Math.min(6,Math.max(3,Math.round(t.getZoom()||4)));return[{lat:i.lat,lon:i.lng},{lat:s.getNorth(),lon:s.getWest()},{lat:s.getNorth(),lon:s.getEast()},{lat:s.getSouth(),lon:s.getWest()},{lat:s.getSouth(),lon:s.getEast()}].map(({lat:p,lon:m})=>{let{x:y,y:d}=Ea(p,m,l);return La(e,l,d,y)})}let n=4;return[{lat:50,lon:4.5},{lat:34,lon:-118.2},{lat:35.6,lon:139.6}].map(({lat:s,lon:i})=>{let{x:l,y:c}=Ea(s,i,n);return La(e,n,c,l)})}async function Cr(e){if(!e||!r.settings.mapRasterOverlays?.sar)return;let t=al(e);if(t){let s=r.sarCoverageCache?.[t];if(s&&Date.now()-s.ts<300*1e3){s.ok?N("sar","ready",`date ${e}`):N("sar","unavailable","no coverage for AOI/date");return}}let n=wr(e),a=!1;for(let s of n)if(a=await zn(s),a)break;t&&(r.sarCoverageCache[t]={ok:a,ts:Date.now()}),a?N("sar","ready",`date ${e}`):N("sar","unavailable","no coverage for AOI/date")}function nl(){r.settings.mapRasterOverlays?.sar&&(!r.sarDate||r.sarResolveInFlight||(r.sarCoverageTimer&&clearTimeout(r.sarCoverageTimer),r.sarCoverageTimer=setTimeout(()=>{Cr(r.sarDate)},600)))}function al(e){let t=r.map;if(!t||!e)return null;let n=Math.round(t.getZoom()||4),a=t.getCenter?.();return a?`${e}:${n}:${a.lat.toFixed(2)},${a.lng.toFixed(2)}`:`${e}:${n}`}function Lr(e,t){let n=new Date(`${e}T00:00:00Z`);return n.setUTCDate(n.getUTCDate()+t),n.toISOString().slice(0,10)}function rl(e){let t=R[e]||null;return t?.defaultDate?t.defaultDate:Yt(1)}async function ct(){if(!(r.imageryResolveInFlight||r.imageryDateManual)){r.imageryResolveInFlight=!0,N("imagery","loading","checking tiles");try{let e=r.settings.mapBasemap?.startsWith("gibs")?r.settings.mapBasemap:"gibs-viirs",t=R[e]||R["gibs-viirs"];if(t?.defaultDate){_e(t.defaultDate);return}let n=Yt(1),a=!1;for(let s=0;s<8;s+=1){let i=Lr(n,-s),l=tl(te(t.id,i,t.format,t.matrixSet));if(await zn(l)){_e(i),a=!0;return}}if(!a){let s=r.settings.lastImageryDate;s?(_e(s),N("imagery","ready","using last known")):N("imagery","unavailable","try Latest")}}finally{r.imageryResolveInFlight=!1}}}async function kt(){if(!(r.sarResolveInFlight||r.sarDateManual)){if(!r.settings.mapRasterOverlays?.sar){N("sar","off",""),ze();return}r.sarResolveInFlight=!0,N("sar","loading","checking tiles");try{let t=await _i()||Yt(1),n=!1;for(let a=0;a<12;a+=1){let s=Lr(t,-a),i=wr(s);for(let l of i)if(await zn(l)){_t(s),n=!0;return}}if(!n){let a=r.settings.lastSarDate;a?(_t(a),N("sar","ready","using last known")):N("sar","unavailable","try Latest")}}finally{r.sarResolveInFlight=!1}}}function _e(e){!e||!/^\d{4}-\d{2}-\d{2}$/.test(e)||(r.imageryDate=e,r.settings.mapImageryDate=e,r.settings.lastImageryDate=e,Object.entries(r.mapBaseLayers||{}).forEach(([t,n])=>{if(!t.startsWith("gibs"))return;let a=R[t];a&&(n.setUrl(te(a.id,e,a.format,a.matrixSet)),n.redraw())}),Object.entries(r.mapOverlayLayers||{}).forEach(([t,n])=>{if(!t.startsWith("gibs-overlay"))return;let a=t.replace("gibs-overlay-",""),s=U[a];s&&(n.setUrl(te(s.id,e,s.format,s.matrixSet)),n.redraw())}),ze(),D(),N("imagery","ready",`date ${e}`))}function _t(e){if(!e||!/^\d{4}-\d{2}-\d{2}$/.test(e))return;r.sarDate=e,r.settings.mapSarDate=e,r.settings.lastSarDate=e;let t=r.mapOverlayLayers?.sar;t&&(t.setUrl(hr(e)),t.redraw()),ze(),D(),N("sar","ready",`date ${e}`),Cr(e)}function sl(e){if(e==="night"){qe("gibs-nightlights"),r.settings.mapRasterOverlays={...r.settings.mapRasterOverlays,hillshade:!1,sar:!1,aerosol:!1,thermal:!1,fire:!1},D(),ce(),Le(),Ue(),ct();return}e==="thermal"&&(qe("gibs-viirs"),r.settings.mapRasterOverlays={...r.settings.mapRasterOverlays,thermal:!0,fire:!0},D(),ce(),Le(),Ue(),ct())}function Aa(){r.settings.mapBasemap="osm",r.settings.mapRasterOverlays={hillshade:!1,sar:!1,aerosol:!1,lidar:!1,lidarPoints:!1,thermal:!1,fire:!1},r.settings.mapOverlayOpacity={hillshade:.45,sar:.55,aerosol:.45,lidar:.25,lidarPoints:.65,thermal:.45,fire:.45},r.settings.lidarPointLimits={useCustom:!1,pointCap:15e4,radiusKm:5,maxTilesDesktop:16,maxTilesMobile:8},r.settings.mapImageryDate="",r.settings.mapSarDate="",r.imageryDateManual=!1,r.sarDateManual=!1,D(),qe("osm"),ce(),Le(),Ue(),ze()}function qe(e,{skipSave:t=!1}={}){if(!r.map)return;let n=e==="gibs"?"gibs-viirs":e,a=r.mapBaseLayers?.[n]||r.mapBaseLayers?.osm;if(a){if(r.activeBaseLayer&&r.map.removeLayer(r.activeBaseLayer),r.activeBaseLayer=a,a.addTo(r.map),r.settings.mapBasemap=n,a.options?.maxZoom?r.map.setMaxZoom(a.options.maxZoom):r.map.setMaxZoom(18),t||(D(),Ue()),e.startsWith("gibs")){let s=R[n];s?.defaultDate&&!r.imageryDateManual?_e(s.defaultDate):ct()}Le()}}function ce(){r.map&&Object.entries(r.mapOverlayLayers||{}).forEach(([e,t])=>{let n=e.startsWith("gibs-overlay-")?e.replace("gibs-overlay-",""):e;n.startsWith("fire")&&(n="fire");let a=!!r.settings.mapRasterOverlays?.[n],s=r.map.hasLayer(t);a&&!s&&t.addTo(r.map),!a&&s&&r.map.removeLayer(t);let i=ne(n,t.options?.opacity??.5);n==="lidar"&&typeof t.setStyle=="function"&&Number.isFinite(i)?t.setStyle($t(i)):n==="lidarPoints"&&typeof t.setProps=="function"&&Number.isFinite(i)?t.setProps({layers:[Sr()]}):typeof t.setOpacity=="function"&&Number.isFinite(i)&&t.setOpacity(i)})}function ol(){if(!o.mapBase||!window.L)return;r.map=window.L.map(o.mapBase,{zoomControl:!0,attributionControl:!0,worldCopyJump:!0}).setView([r.location.lat,r.location.lon],2);let e=rl(r.settings.mapBasemap||"gibs-viirs"),t=r.settings.mapImageryDate||e,n=r.settings.mapSarDate||e;r.imageryDate=t,r.sarDate=n,r.settings.mapImageryDate=t,r.settings.mapSarDate=n,r.mapBaseLayers={osm:window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:"&copy; OpenStreetMap contributors"}),esri:window.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:18,attribution:"&copy; Esri, Maxar, Earthstar Geographics, and the GIS User Community"}),"gibs-viirs":window.L.tileLayer(te(R["gibs-viirs"].id,t,R["gibs-viirs"].format,R["gibs-viirs"].matrixSet),{maxZoom:R["gibs-viirs"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (VIIRS True Color)"}),"gibs-modis-terra":window.L.tileLayer(te(R["gibs-modis-terra"].id,t,R["gibs-modis-terra"].format,R["gibs-modis-terra"].matrixSet),{maxZoom:R["gibs-modis-terra"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (MODIS Terra True Color)"}),"gibs-modis-aqua":window.L.tileLayer(te(R["gibs-modis-aqua"].id,t,R["gibs-modis-aqua"].format,R["gibs-modis-aqua"].matrixSet),{maxZoom:R["gibs-modis-aqua"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (MODIS Aqua True Color)"}),"gibs-nightlights":window.L.tileLayer(te(R["gibs-nightlights"].id,t,R["gibs-nightlights"].format,R["gibs-nightlights"].matrixSet),{maxZoom:R["gibs-nightlights"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (VIIRS Black Marble)"}),"gibs-daynight":window.L.tileLayer(te(R["gibs-daynight"].id,t,R["gibs-daynight"].format,R["gibs-daynight"].matrixSet),{maxZoom:R["gibs-daynight"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (VIIRS Day/Night Band)"})},r.mapOverlayLayers={hillshade:window.L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}",{maxZoom:18,maxNativeZoom:16,opacity:ne("hillshade",.45),attribution:"Esri World Hillshade"}),sar:window.L.tileLayer(hr(n),{maxZoom:18,maxNativeZoom:16,opacity:ne("sar",.55),attribution:"Sentinel-1 SAR (Terrascope)"}),"gibs-overlay-aerosol":window.L.tileLayer(te(U.aerosol.id,t,U.aerosol.format,U.aerosol.matrixSet),{maxZoom:16,maxNativeZoom:U.aerosol.maxZoom,opacity:ne("aerosol",U.aerosol.opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (Aerosol Index)"}),"gibs-overlay-thermal":window.L.tileLayer(te(U.thermal.id,t,U.thermal.format,U.thermal.matrixSet),{maxZoom:16,maxNativeZoom:U.thermal.maxZoom,opacity:ne("thermal",U.thermal.opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (Thermal Brightness)"}),"gibs-overlay-fire-east":window.L.tileLayer(te(U["fire-east"].id,t,U["fire-east"].format,U["fire-east"].matrixSet),{maxZoom:16,maxNativeZoom:U["fire-east"].maxZoom,opacity:ne("fire",U["fire-east"].opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (GOES East Fire Temp)"}),"gibs-overlay-fire-west":window.L.tileLayer(te(U["fire-west"].id,t,U["fire-west"].format,U["fire-west"].matrixSet),{maxZoom:16,maxNativeZoom:U["fire-west"].maxZoom,opacity:ne("fire",U["fire-west"].opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (GOES West Fire Temp)"})},r.settings.mapRasterOverlays?.lidar?Mn():N("lidar","off",""),r.settings.mapRasterOverlays?.lidarPoints?Rt():N("lidarPoints","off",""),qe(r.settings.mapBasemap,{skipSave:!0}),ce(),r.map.on("moveend zoomend",()=>{H(),nl()}),r.map.on("movestart zoomstart",()=>{Kn()}),r.map.whenReady(()=>{ut(),H()}),setTimeout(()=>{r.map.invalidateSize(),ut(),H()},0),ct(),r.settings.mapRasterOverlays?.sar?kt():N("sar","off","")}function il(e){return e.feedId==="noaa-incidentnews"||e.category==="spill"?"spill":e.feedId==="gpsjam"?"gpsjam":e.feedId==="arcgis-military-installations"?"military":e.feedId==="state-travel-advisories"||e.feedId==="cdc-travel-notices"?"travel":e.feedId?.startsWith("arcgis-outage-")?"outage":e.category==="travel"?"travel":e.category==="transport"?"transport":e.category==="security-lagged"?"securityLagged":e.category==="security"?"security":e.category==="infrastructure"?"infrastructure":e.category==="weather"?"weather":e.category==="disaster"?"disaster":e.category==="space"?"space":e.category==="health"?"health":"news"}function ll(e){return e==="disaster"?"rgba(255,106,106,0.9)":e==="weather"?"rgba(55,214,214,0.9)":e==="space"?"rgba(140,107,255,0.9)":e==="travel"?"rgba(255,196,87,0.95)":e==="transport"?"rgba(94,232,160,0.9)":e==="gpsjam"?"rgba(244,104,102,0.92)":e==="security"?"rgba(255,144,99,0.92)":e==="securityLagged"?"rgba(199,156,137,0.78)":e==="military"?"rgba(214,174,118,0.88)":e==="infrastructure"?"rgba(132,190,255,0.9)":e==="outage"?"rgba(255,210,90,0.92)":e==="health"?"rgba(109,209,255,0.9)":e==="spill"?"rgba(255,125,36,0.92)":"rgba(255,184,76,0.9)"}function cl(e){if(!e)return"news";let t=`${e.alertType||""} ${e.title||""}`.toLowerCase(),n=()=>t.trim()?t.includes("tornado")?"tornado":t.includes("flash flood")||t.includes("flood")?"flood":t.includes("hurricane")||t.includes("tropical storm")||t.includes("storm surge")?"hurricane":t.includes("blizzard")||t.includes("winter")||t.includes("snow")||t.includes("ice")||t.includes("freeze")?"winter":t.includes("excessive heat")||t.includes("heat")?"heat":t.includes("severe thunderstorm")||t.includes("thunderstorm")?"severe":t.includes("wind")?"wind":null:null;if(e.feedId==="noaa-incidentnews"||e.category==="spill")return"spill";if(e.feedId==="gpsjam")return"gpsjam";if(e.feedId==="usgs-quakes-hour"||e.feedId==="usgs-quakes-day")return"quake";if(e.feedId==="arcgis-border-crisis")return"border";if(e.feedId==="arcgis-kinetic-oconus"||e.feedId==="arcgis-kinetic-domestic"||e.feedId==="arcgis-kinetic-europe"||e.feedId==="arcgis-kinetic-venezuela"||e.feedId==="warspotting-losses")return"kinetic";if(e.feedId==="arcgis-drone-reports")return"drone";if(e.feedId==="arcgis-logistics-shortages")return"logistics";if(e.feedId==="arcgis-tipline-reports")return"warning";if(e.feedId==="arcgis-military-installations")return"military";if(e.feedId==="arcgis-hms-fire"||e.feedId==="arcgis-wildfire-incidents"||e.feedId==="arcgis-wildfire-perimeters")return"fire";if(e.feedId==="arcgis-noaa-severe")return"severe";if(e.feedId==="arcgis-noaa-tornado")return"tornado";if(e.feedId==="arcgis-noaa-flood")return"flood";if(e.feedId==="nws-alerts")return n()||"weather";if(e.feedId==="nhc-atlantic")return"hurricane";if(e.feedId==="arcgis-power-plants")return"power";if(e.feedId?.startsWith("arcgis-outage-")||e.feedId==="arcgis-outage-area")return"water";if(e.feedId==="arcgis-submarine-cables"||e.feedId==="arcgis-submarine-landing")return"infrastructure";if(e.feedId==="state-travel-advisories"||e.feedId==="cdc-travel-notices")return"travel";if(e.feedId==="transport-opensky")return"air";if(e.category==="travel")return"travel";if(e.category==="spill")return"spill";if(e.category==="weather")return n()||"weather";if(e.category==="disaster")return"disaster";if(e.category==="space")return"space";if(e.category==="health")return"health";if(e.category==="transport")return"transport";if(e.category==="security"){let a=(e.eventType||e.alertType||"").toLowerCase();return a.includes("battle")?"battle":a.includes("explosion")||a.includes("remote violence")?"explosion":a.includes("violence against civilians")?"violence":a.includes("protest")?"protest":a.includes("riot")?"riot":"security"}return e.category==="infrastructure"?"infrastructure":"news"}var Ta={quake:"activity",border:"flag",kinetic:"crosshair",drone:"radar",logistics:"truck",fire:"flame",warning:"alert-triangle",gpsjam:"radar",power:"bolt",severe:"cloud-lightning",tornado:"tornado",flood:"droplet",hurricane:"activity",winter:"alert-octagon",heat:"heat",wind:"radar",water:"droplet",travel:"plane",air:"plane",military:"barracks",battle:"crosshair",explosion:"alert-octagon",violence:"shield",protest:"flag",riot:"alert-triangle",health:"heart-pulse",transport:"truck",weather:"cloud-lightning",disaster:"alert-octagon",space:"satellite",security:"shield",infrastructure:"factory",spill:"droplet",news:"newspaper"},Ia={activity:'<path d="M22 12h-4l-3 9L9 3l-3 9H2" />',tornado:'<path d="M3 4h18M5 8h14M7 12h10M9 16h6M11 20h2" />',heat:'<circle cx="12" cy="12" r="4" /><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" />',flag:'<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" x2="4" y1="22" y2="15" />',crosshair:'<circle cx="12" cy="12" r="10" /><line x1="22" x2="18" y1="12" y2="12" /><line x1="6" x2="2" y1="12" y2="12" /><line x1="12" x2="12" y1="6" y2="2" /><line x1="12" x2="12" y1="22" y2="18" />',radar:'<path d="M19.07 4.93A10 10 0 0 0 6.99 3.34" /><path d="M4 6h.01" /><path d="M2.29 9.62A10 10 0 1 0 21.31 8.35" /><path d="M16.24 7.76A6 6 0 1 0 8.23 16.67" /><path d="M12 18h.01" /><path d="M17.99 11.66A6 6 0 0 1 15.77 16.67" /><circle cx="12" cy="12" r="2" /><path d="m13.41 10.59 5.66-5.66" />',truck:'<path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" /><path d="M15 18H9" /><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14" /><circle cx="17" cy="18" r="2" /><circle cx="7" cy="18" r="2" />',flame:'<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />',"alert-triangle":'<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" />',bolt:'<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><circle cx="12" cy="12" r="4" />',plane:'<path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z" />',"heart-pulse":'<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /><path d="M3.22 12H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27" />',"cloud-lightning":'<path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973" /><path d="m13 12-3 5h4l-3 5" />',"alert-octagon":'<polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" />',satellite:'<path d="M13 7 9 3 5 7l4 4" /><path d="m17 11 4 4-4 4-4-4" /><path d="m8 12 4 4 6-6-4-4Z" /><path d="m16 8 3-3" /><path d="M9 21a6 6 0 0 0-6-6" />',shield:'<path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" />',factory:'<path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" /><path d="M17 18h1" /><path d="M12 18h1" /><path d="M7 18h1" />',barracks:'<path d="M4 22h16" /><path d="M6 22V9l6-3 6 3v13" /><path d="M10 22v-6h4v6" /><path d="M12 2v4" /><path d="M12 2h4l-4 2" />',droplet:'<path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z" />',newspaper:'<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" /><path d="M18 14h-8" /><path d="M15 18h-5" /><path d="M10 6h8v4h-8V6Z" />'},yn=new Map,ul="#0a0f14",fn={r:244,g:104,b:102};function kr(e){return Ta[e]||Ta.news}function dl(e){let t=kr(e);if(!Ia[t])return null;if(yn.has(t))return yn.get(t);let n=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${ul}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${Ia[t]}</svg>`,a=new Image;return a.src=`data:image/svg+xml;utf8,${encodeURIComponent(n)}`,a.onload=()=>{o.mapCanvas&&H()},yn.set(t,a),a}function Er(e,t,n){return Math.min(n,Math.max(t,e))}function ml(e,t,n){if(!n||!t.length)return;let a=Ya();!a||!a.cellToBoundary||(e.save(),e.lineWidth=.6,e.strokeStyle="rgba(255,255,255,0.15)",t.forEach(s=>{if(!s.hex)return;let i=a.cellToBoundary(s.hex,!0);if(!i||i.length<3)return;e.beginPath(),i.forEach(([c,p],m)=>{let y=n.latLngToContainerPoint([c,p]);m===0?e.moveTo(y.x,y.y):e.lineTo(y.x,y.y)}),e.closePath();let l=Er(s.gpsIntensity??.25,.08,.35);e.fillStyle=`rgba(${fn.r}, ${fn.g}, ${fn.b}, ${l})`,e.fill(),e.stroke()}),e.restore())}function pl(e){return e==="security"||e==="securityLagged"||e==="weather"?16:24}function gl(e,t=24){let n=[];return e.forEach(a=>{let s=null;for(let i of n){let l=i.x-a.x,c=i.y-a.y;if(i.layer!==a.layer)continue;let p=pl(i.layer)||t;if(Math.sqrt(l*l+c*c)<p){s=i;break}}if(!s)n.push({x:a.x,y:a.y,points:[a],layer:a.layer});else{s.points.push(a);let i=s.points.length;s.x=(s.x*(i-1)+a.x)/i,s.y=(s.y*(i-1)+a.y)/i}}),n.map(a=>{let s=a.points.length,i=a.points.reduce((d,g)=>(d[g.layer]=(d[g.layer]||0)+1,d),{}),l=Object.entries(i).sort((d,g)=>g[1]-d[1])[0]?.[0]||"news",c=a.points.reduce((d,g)=>(d[g.type]=(d[g.type]||0)+1,d),{}),p=Object.entries(c).sort((d,g)=>g[1]-d[1])[0]?.[0]||"news",m=a.points.map(d=>d.item).sort((d,g)=>(g.publishedAt||0)-(d.publishedAt||0))[0],y=s===1?4:Math.min(16,4+Math.sqrt(s)*2);return{x:a.x,y:a.y,count:s,layer:l,type:p,iconName:kr(p),color:ll(l),primary:m,items:a.points.map(d=>d.item),radius:y}})}function H(){let e=o.mapCanvas,t=e.getContext("2d"),n=(o.mapBase||e).getBoundingClientRect(),{width:a,height:s}=n,i=window.devicePixelRatio||1;if(e.width=a*i,e.height=s*i,t.setTransform(i,0,0,i,0,0),t.clearRect(0,0,a,s),t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,r.mapPoints=[],!r.map){for(let g=0;g<=a;g+=a/6)t.beginPath(),t.moveTo(g,0),t.lineTo(g,s),t.stroke();for(let g=0;g<=s;g+=s/4)t.beginPath(),t.moveTo(0,g),t.lineTo(a,g),t.stroke()}let l=Gn(),c=l.filter(g=>g.feedId==="gpsjam"&&g.hex),p=l.filter(g=>g.feedId!=="gpsjam");r.settings.mapLayers.gpsjam&&c.length&&r.map&&ml(t,c,r.map);let m=p.map(g=>{let{lat:f,lon:h}=g.geo,b,k;if(r.map){let A=r.map.latLngToContainerPoint([f,h]);b=A.x,k=A.y}else b=(h+180)/360*a,k=(90-f)/180*s;let C=il(g),S=cl(g);return{x:b,y:k,item:g,layer:C,type:S}}).filter(g=>r.settings.mapLayers[g.layer]).filter(g=>{if(g.layer!=="security"&&g.layer!=="securityLagged")return!0;let f=fi(g.item);return r.settings.mapConflictTypes?.[f]!==!1});o.mapEmpty&&o.mapEmpty.classList.toggle("show",m.length===0);let y=gl(m),d=r.map?r.map.getZoom():2;if(y.forEach(g=>{if(t.beginPath(),t.fillStyle=g.color,t.arc(g.x,g.y,g.radius,0,Math.PI*2),t.fill(),g.count>1){t.strokeStyle="rgba(10, 15, 20, 0.7)",t.lineWidth=1.5,t.stroke(),t.fillStyle="#0a0f14",t.font='600 11px "Atkinson Hyperlegible", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(g.count>99?"99+":String(g.count),g.x,g.y);return}if(d>=3){let h=dl(g.type);h&&h.complete?t.drawImage(h,g.x-14/2,g.y-14/2,14,14):(t.fillStyle="#0a0f14",t.font='700 10px "Atkinson Hyperlegible", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("\u2022",g.x,g.y))}}),r.mapPoints=y,r.location&&r.settings.mapLayers.local){let g,f,h;if(r.map){let b=r.map.latLngToContainerPoint([r.location.lat,r.location.lon]),k=156543.03392*Math.cos(r.location.lat*Math.PI/180)/Math.pow(2,r.map.getZoom());h=r.settings.radiusKm*1e3/k,g=b.x,f=b.y}else g=(r.location.lon+180)/360*a,f=(90-r.location.lat)/180*s,h=r.settings.radiusKm/20037*a*2;t.strokeStyle="rgba(200,255,106,0.5)",t.beginPath(),t.arc(g,f,h,0,Math.PI*2),t.stroke()}}function ut(){if(!r.map)return;r.map.invalidateSize();let e={padding:[40,40],maxZoom:7};if(r.settings.scope==="global"){r.map.setView([20,0],2);return}if(r.settings.scope==="us"){let t=je();t?.code==="US"||(r.settings.country||"").toUpperCase()==="US"?r.map.fitBounds([[24,-125],[49,-66]],{padding:[30,30],maxZoom:4}):t?.bbox?r.map.fitBounds([[t.bbox.minLat,t.bbox.minLon],[t.bbox.maxLat,t.bbox.maxLon]],{padding:[30,30],maxZoom:6}):r.map.fitBounds([[24,-125],[49,-66]],{padding:[30,30],maxZoom:4});return}if(r.settings.scope==="local"){let{lat:t,lon:n}=r.location,a=r.settings.radiusKm/110.574,s=r.settings.radiusKm/(111.32*Math.cos(t*Math.PI/180));r.map.fitBounds([[t-a,n-s],[t+a,n+s]],{padding:[30,30],maxZoom:9})}}function yl(e){let t=o.mapCanvas.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top,s=r.mapPoints.find(i=>{let l=i.x-n,c=i.y-a;return Math.sqrt(l*l+c*c)<i.radius+6});if(!s){o.mapTooltip.style.display="none",o.mapWrap&&(o.mapWrap.style.cursor="default");return}if(o.mapWrap&&(o.mapWrap.style.cursor="pointer"),o.mapTooltip.style.display="block",o.mapTooltip.style.left=`${Math.min(n+12,t.width-220)}px`,o.mapTooltip.style.top=`${Math.max(a-12,10)}px`,s.count>1){let i=s.items.slice(0,2).map(l=>l.translatedTitle||l.title).join(" | ");o.mapTooltip.textContent=`${s.count} signals: ${i}`}else o.mapTooltip.textContent=s.primary.translatedTitle||s.primary.title}function Kn(){o.mapDetail&&o.mapDetail.classList.remove("show")}function Ar(){if(!o.flightFocus)return;if(!r.flightFocus){o.flightFocus.classList.remove("show"),o.flightFocusBody&&(o.flightFocusBody.innerHTML="");return}let e=r.flightFocus,t=e.callsign||e.title||"Flight",n=[];if(e.icao24&&n.push(e.icao24.toUpperCase()),e.originCountry&&n.push(e.originCountry),o.flightFocusMeta&&(o.flightFocusMeta.textContent=n.filter(Boolean).join(" \u2022 ")||"OpenSky"),o.flightFocusBody){let a=[],s=Number.isFinite(e.velocity)?`${Math.round(e.velocity*3.6)} km/h`:"\u2014",i=Number.isFinite(e.altitude)?`${Math.round(e.altitude*3.28084)} ft`:"\u2014",l=Number.isFinite(e.heading)?`${e.heading}\xB0`:"\u2014";a.push({label:"Callsign",value:t}),a.push({label:"Speed",value:s}),a.push({label:"Altitude",value:i}),a.push({label:"Heading",value:l}),a.push({label:"On ground",value:e.onGround?"Yes":"No"}),o.flightFocusBody.innerHTML=a.map(c=>`<div class="map-focus-row"><span>${c.label}</span><strong>${c.value}</strong></div>`).join("")}o.flightFocusOpen&&(o.flightFocusOpen.disabled=!e.icao24),o.flightFocus.classList.add("show")}function Tr(){r.flightFocus=null,r.flightTrack=null,r.flightTrackFetchedAt=0,r.flightTrackLayer&&r.map&&r.map.removeLayer(r.flightTrackLayer),r.flightTrackLayer=null,Ar()}async function Ir(e,t=!1){if(!e)return;let n=nn();if(n&&!r.flightTrackLoading&&!(!t&&Date.now()-r.flightTrackFetchedAt<60*1e3)){r.flightTrackLoading=!0,o.flightFocusTrack&&(o.flightFocusTrack.disabled=!0,o.flightFocusTrack.textContent="Tracking\u2026");try{let a=n.endsWith("/")?n.slice(0,-1):n,s=await ve(`${a}/tracks?icao24=${encodeURIComponent(e)}&time=0`);if(!s.ok)return;let i=await s.json();if(r.flightTrack=i,r.flightTrackFetchedAt=Date.now(),r.map&&Array.isArray(i?.path)){let l=i.path.filter(c=>Number.isFinite(c?.[1])&&Number.isFinite(c?.[2])).map(c=>[c[1],c[2]]);r.flightTrackLayer&&r.map.removeLayer(r.flightTrackLayer),l.length&&(r.flightTrackLayer=L.polyline(l,{color:"#4fa2ff",weight:2,opacity:.75}).addTo(r.map))}}catch{}finally{r.flightTrackLoading=!1,o.flightFocusTrack&&(o.flightFocusTrack.disabled=!1,o.flightFocusTrack.textContent="Track")}}}function fl(e){if(!e){Tr();return}r.flightFocus=e,Ar(),e.icao24&&Ir(e.icao24,!0)}function hl(e,t,n){if(!o.mapDetail||!o.mapDetailList)return;let a=o.mapDetailList;a.innerHTML="";let s=(o.mapWrap||o.mapCanvas).getBoundingClientRect(),i=Math.min(t+12,s.width-320),l=Math.min(n+12,s.height-220);o.mapDetail.style.left=`${Math.max(12,i)}px`,o.mapDetail.style.top=`${Math.max(12,l)}px`,o.mapDetailMeta&&(o.mapDetailMeta.textContent=`${e.count} signals in view`);let c=d=>{if(d.geoLabel)return d.geoLabel;if(d.location)return d.location;if(d.area)return d.area;if(d.title&&d.title.includes(" - ")){let g=d.title.split(" - ");if(g[1])return g.slice(1).join(" - ").trim()}return d.geo&&Number.isFinite(d.geo.lat)&&Number.isFinite(d.geo.lon)?`${d.geo.lat.toFixed(2)}, ${d.geo.lon.toFixed(2)}`:""},p=d=>{if(d.severity)return d.severity;if(d.category==="travel"&&d.title){let g=d.title.match(/Level\\s*(\\d)/i);if(g)return`Level ${g[1]}`}return""},m=d=>d.alertType?d.alertType:d.category==="travel"?"Travel Notice":d.category==="space"?"Space Weather":d.category==="weather"?"Weather Alert":d.category==="disaster"?"Disaster":d.category==="transport"?"Transport":"",y=d=>{let g=new Set;if(d.tags?.includes("us")&&g.add("US"),d.tags?.includes("global")&&g.add("Global"),d.category==="travel"){let b=ir(d.title||"");b&&g.add(b)}let f=d.geoLabel||d.location||d.area||"",h=or(f);return h&&g.add(h),Array.from(g).slice(0,3)};if(e.items.slice(0,8).forEach(d=>{let g=document.createElement("div");g.className="map-detail-item";let f=document.createElement("div");f.className="map-detail-title",f.textContent=d.translatedTitle||d.title;let h=document.createElement("div");h.className="map-detail-meta",h.textContent=`${d.source||"Source"} \u2022 ${V(d.publishedAt||Date.now())}`;let b=document.createElement("div");b.className="map-detail-badges";let k=document.createElement("span");k.className=`badge badge-${d.category||"news"}`,k.textContent=Ce[d.category]||d.category||"Signal",b.appendChild(k);let C=m(d);if(C){let v=document.createElement("span");v.className="badge badge-alert",v.textContent=C,b.appendChild(v)}if(d.verificationCount&&d.verificationCount>1){let v=document.createElement("span");v.className="badge badge-verify",v.textContent=`Verified ${d.verificationCount} sources`,b.appendChild(v)}y(d).forEach(v=>{let E=document.createElement("span");E.className="badge badge-region",E.textContent=v,b.appendChild(E)});let A=c(d),M=p(d),w=document.createElement("div");if(w.className="map-detail-info",A){let v=document.createElement("div");v.className="map-detail-info-row",v.innerHTML=`<span>Location</span><strong>${A}</strong>`,w.appendChild(v)}if(M){let v=document.createElement("div");v.className="map-detail-info-row",v.innerHTML=`<span>Severity</span><strong>${M}</strong>`,w.appendChild(v)}let I=(d.translatedSummary||d.summary||"").trim(),u=document.createElement("div");if(u.className="map-detail-summary",I?u.textContent=I:d.url?u.textContent="Tap to open full details.":u.textContent="No additional details available.",g.appendChild(f),g.appendChild(b),g.appendChild(h),w.childNodes.length&&g.appendChild(w),g.appendChild(u),d.feedId==="transport-opensky"&&d.icao24){let v=document.createElement("div");v.className="map-detail-actions";let E=document.createElement("button");E.className="chip chip-small",E.textContent="Focus Flight",E.addEventListener("click",T=>{T.stopPropagation(),fl(d)}),v.appendChild(E),g.appendChild(v)}g.addEventListener("click",()=>{d.url&&window.open(d.url,"_blank","noopener")}),a.appendChild(g),r.settings.languageMode==="translate"&&d.isNonEnglish&&ar(d,f,null)}),e.count>8){let d=document.createElement("div");d.className="map-detail-more",d.textContent=`+${e.count-8} more signals`,a.appendChild(d)}o.mapDetail.classList.add("show")}function bl(e){let t=o.mapCanvas.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top,s=r.mapPoints.find(i=>{let l=i.x-n,c=i.y-a;return Math.sqrt(l*l+c*c)<i.radius+6});if(!s){Kn();return}hl(s,n,a)}function Ut(){if(!o.chatLog)return;let e=o.chatLog.querySelector(".chat-bubble.system");e||(e=document.createElement("div"),e.className="chat-bubble system",o.chatLog.prepend(e));let t=(r.keys.openai?.key||"").trim(),n=Ne(),a=r.settings.useClientOpenAI&&t;if($()){if(n){e.textContent=a?"AI connected via proxy (using your key).":"AI connected via proxy (server key). Use your key to override.";return}r.settings.superMonitor?e.textContent=t?"Super Monitor Mode: OpenAI key stored (proxy required on GitHub Pages).":"Super Monitor Mode is on. Add an OpenAI key; chat still needs a proxy.":e.textContent="Static mode: AI chat needs a proxy. Briefings use the cached snapshot when available.";return}e.textContent=n?a?"AI connected (proxy + your key).":"AI connected (server key).":t?"AI connected. Ask a question or request a briefing.":"Connect an AI provider to enable live responses."}function Se(e,t){if(!o.searchResults||!o.searchResultsList)return;o.searchResultsList.innerHTML="";let n=e.slice(0,25);n.length?ot(o.searchResultsList,n):o.searchResultsList.innerHTML='<div class="list-item">No matching signals yet.</div>',o.searchResultsMeta&&(o.searchResultsMeta.textContent=t),o.searchResults.classList.add("open")}function vl(){o.searchResults&&(o.searchResults.classList.remove("open"),o.searchResultsList&&(o.searchResultsList.innerHTML=""),o.searchResultsMeta&&(o.searchResultsMeta.textContent="Awaiting query"),Tt())}async function Ge(e=!1){ca(!0),rt("Fetching feeds"),yo();let t=e&&$();try{$()&&(await Ra(),await qs());let n=await Promise.all(r.feeds.map(async i=>{let l=i.supportsQuery?$e(i,i.defaultQuery||""):void 0;if(t||Uo(i))try{let c=await xt(i,l);return c.error?await He(i,l,e):c}catch{}return He(i,l,e).catch(()=>({feed:i,items:[],error:"fetch_failed",httpStatus:0,fetchedAt:Date.now()}))}));n.forEach(i=>{let l=!i.error&&Et(i.feed,i);r.feedStatus[i.feed.id]={httpStatus:i.httpStatus,error:i.error,errorMessage:i.errorMessage,fetchedAt:i.fetchedAt,count:i.items.length,stale:l}});let a=n.flatMap(i=>i.items||[]);r.items=a.map(i=>si({...i,url:Ke(i.url),isNonEnglish:nr(`${i.title||""} ${i.summary||""}`),feedId:i.feedId||null})),r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(i=>i.category==="news")),r.lastFetch=Date.now(),Gs();let s=xn(n);rt(s?`Degraded (${s})`:"Healthy"),ye(),ie(),it(),H(),Pt(!1),we(),await _n(),Nt(),zt(),Oo(r.items).then(i=>{i&&(r.scopedItems=se(r.items),r.settings.scope==="local"?(r.clusters=ge(r.scopedItems.filter(l=>l.category==="news")),ye()):Vt(),ie(),it(),H(),Nt())}).catch(()=>{}),s&&Sl(),wl(n)}finally{ca(!1)}}async function Sl(){if(r.retryingFeeds)return;let e=r.feeds.filter(s=>r.feedStatus[s.id]?.error==="fetch_failed");if(!e.length)return;r.retryingFeeds=!0;let t=new Set(r.items.map(s=>s.url||s.title)),n=[];for(let s of e){let i=s.supportsQuery?$e(s,s.defaultQuery||""):void 0;try{let l=await He(s,i,!0),c=!l.error&&Et(l.feed,l);r.feedStatus[l.feed.id]={httpStatus:l.httpStatus,error:l.error,errorMessage:l.errorMessage,fetchedAt:l.fetchedAt,count:l.items.length,stale:c},l.items.forEach(p=>{let m=p.url||p.title;!m||t.has(m)||(t.add(m),n.push({...p,url:Ke(p.url)}))})}catch{}}n.length&&(r.items=[...r.items,...n],r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(s=>s.category==="news")),ye(),ie(),H()),it();let a=xn(r.feeds.map(s=>({feed:s,...r.feedStatus[s.id]})));rt(a?`Degraded (${a})`:"Healthy"),Kt(),r.retryingFeeds=!1}async function wl(e){if(r.staleRetrying||$()&&!r.settings.superMonitor)return;let t=Date.now();if(t-r.lastStaleRetry<120*1e3)return;let n=r.feeds.filter(l=>{let c=r.feedStatus[l.id];return!c||c.error||$()&&l.keySource==="server"?!1:Et(l,c)});if(!n.length)return;r.staleRetrying=!0,r.lastStaleRetry=t;let a=new Set(r.items.map(l=>l.url||l.title)),s=[];for(let l of n){let c=l.supportsQuery?$e(l,l.defaultQuery||""):void 0;try{let p=await He(l,c,!0),m=!p.error&&Et(p.feed,p);r.feedStatus[p.feed.id]={httpStatus:p.httpStatus,error:p.error,errorMessage:p.errorMessage,fetchedAt:p.fetchedAt,count:p.items.length,stale:m},p.items.forEach(y=>{let d=y.url||y.title;!d||a.has(d)||(a.add(d),s.push({...y,url:Ke(y.url)}))})}catch{}}s.length&&(r.items=[...r.items,...s],r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(l=>l.category==="news")),ye(),ie(),H()),it(),Kt();let i=xn(r.feeds.map(l=>({feed:l,...r.feedStatus[l.id]})));rt(i?`Degraded (${i})`:"Healthy"),r.staleRetrying=!1}function Mr(){r.refreshTimer&&clearInterval(r.refreshTimer),r.refreshTimer=setInterval(()=>Ge(),r.settings.refreshMinutes*60*1e3)}async function hn(){let e=o.searchInput.value.trim(),t=o.feedScope.value||"all";if(!e){o.searchHint.textContent="Enter a search term to query signals.",Se([],"Enter a search term"),Tt();return}r.lastSearchQuery=e,r.lastSearchScope=t,r.lastSearchCategories=[...r.searchCategories];let n=o.searchBtn?.textContent;o.searchBtn&&(o.searchBtn.disabled=!0,o.searchBtn.textContent="Searching..."),r.searching=!0;try{let a=e.toLowerCase(),s=$()&&r.settings.liveSearch?Ko():[],i=async p=>p.length?(await Promise.all(p.map(async y=>{let d=await fa(y,e);return xt(y,d)}))).flatMap(y=>y.items||[]):[];if(r.searchCategories.length){let p=r.searchCategories,m=r.scopedItems.filter(h=>p.includes(h.category)).filter(h=>`${h.title} ${h.summary||""}`.toLowerCase().includes(a)),y=s.filter(h=>p.includes(h.category));y.length&&(o.searchHint.textContent="Searching live sources...");let d=await i(y),g=[...m,...d],f=Qe(g);Se(f,`${f.length} matches in ${p.map(h=>Ce[h]||h).join(", ")}`),o.searchHint.textContent=y.length?"Showing cached + live search results.":"Showing multi-category search results.";return}if(t==="all"){let p=r.scopedItems.filter(g=>`${g.title} ${g.summary||""}`.toLowerCase().includes(a));s.length&&(o.searchHint.textContent="Searching live sources...");let m=await i(s),y=[...p,...m],d=Qe(y);Se(d,`${d.length} matches across all feeds`),o.searchHint.textContent=s.length?`Showing cached + live results (${d.length}).`:`Showing ${d.length} matches across all feeds.`;return}if(t.startsWith("cat:")){let p=t.replace("cat:",""),m=r.scopedItems.filter(h=>h.category===p).filter(h=>`${h.title} ${h.summary||""}`.toLowerCase().includes(a)),y=s.filter(h=>h.category===p);y.length&&(o.searchHint.textContent="Searching live sources...");let d=await i(y),g=[...m,...d],f=Qe(g);Se(f,`${f.length} matches in ${Ce[p]||p}`),o.searchHint.textContent=y.length?`Showing cached + live results (${f.length}).`:`Showing ${f.length} matches in ${Ce[p]||p}.`;return}let l=r.feeds.find(p=>p.id===t);if(!l){o.searchHint.textContent="Select a feed or category to search.",Se([],"Select a feed or category");return}o.searchHint.textContent=r.settings.aiTranslate&&ue()?"Translating query...":"Preparing query...";let c=await fa(l,e);try{if(s.find(p=>p.id===l.id)){let p=await xt(l,c),m=Qe(p.items||[]);Se(m,`${m.length} live results from ${l.name}`),o.searchHint.textContent=`Live search results from ${l.name}.`}else{let p=await He(l,c,!0),m=Qe(p.items||[]);Se(m,`${m.length} results from ${l.name}`),o.searchHint.textContent=`Search results from ${l.name}.`}}catch{o.searchHint.textContent=`Search failed for ${l.name}.`,Se([],`Search failed for ${l.name}`)}}finally{o.searchBtn&&(o.searchBtn.disabled=!1,o.searchBtn.textContent=n||"Search"),r.searching=!1,Tt()}}function xr(){if(!o.geoLocateBtn)return;let e=()=>{o.geoLocateBtn.disabled=!1,o.geoLocateBtn.textContent="Locate Me"};if(!navigator.geolocation){r.location.source="fallback",j(),o.geoLocateBtn.textContent="Location Unsupported",setTimeout(e,2200);return}o.geoLocateBtn.disabled=!0,o.geoLocateBtn.textContent="Locating...",navigator.geolocation.getCurrentPosition(t=>{r.location={lat:t.coords.latitude,lon:t.coords.longitude,source:"geo"},Ns(),r.map&&ut(),r.scopedItems=se(r.items),j(),H(),Vt(),ie(),o.geoLocateBtn.textContent="Geolocated",setTimeout(e,1800)},()=>{r.location.source="fallback",j(),o.geoLocateBtn.textContent="Location Blocked",setTimeout(e,2400)},{enableHighAccuracy:!1,timeout:7e3})}function Cl(){o.exportSnapshot&&o.exportSnapshot.addEventListener("click",gi),o.refreshNow&&o.refreshNow.addEventListener("click",()=>Ge(!0)),o.settingsToggle&&o.settingsToggle.addEventListener("click",()=>{let a=o.settingsPanel?.classList.contains("open");ft(!a)}),o.settingsScrim&&o.settingsScrim.addEventListener("click",()=>ft(!1)),o.sidebarSettings&&o.sidebarSettings.addEventListener("click",()=>{let a=o.settingsPanel?.classList.contains("open");ft(!a),De(!1)}),o.sidebarAbout&&o.sidebarAbout.addEventListener("click",()=>{Ie(!0),De(!1)}),o.navToggle&&o.navToggle.addEventListener("click",()=>{let a=o.app?.classList.contains("nav-open");De(!a)}),o.sidebarScrim&&o.sidebarScrim.addEventListener("click",()=>De(!1)),o.aboutOpen&&o.aboutOpen.addEventListener("click",()=>Ie(!0)),o.aboutOpenSettings&&o.aboutOpenSettings.addEventListener("click",()=>Ie(!0)),o.aboutClose&&o.aboutClose.addEventListener("click",()=>Ie(!1)),o.aboutOverlay&&o.aboutOverlay.addEventListener("click",a=>{a.target===o.aboutOverlay&&Ie(!1)}),o.attributionClose&&o.attributionClose.addEventListener("click",()=>St(!1)),o.attributionOverlay&&o.attributionOverlay.addEventListener("click",a=>{a.target===o.attributionOverlay&&St(!1)}),o.feedScope.addEventListener("change",()=>{o.feedScope.value!=="all"&&!o.feedScope.value.startsWith("cat:")&&(r.searchCategories=[],It())}),o.searchBtn.addEventListener("click",hn),o.searchInput.addEventListener("keydown",a=>{a.key==="Enter"&&hn()}),o.moneyFlowsRun&&o.moneyFlowsRun.addEventListener("click",()=>dn()),o.moneyFlowsQuery&&o.moneyFlowsQuery.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),dn())}),o.moneyFlowsRange&&o.moneyFlowsRange.addEventListener("change",()=>{r.moneyFlowsRangeDays=Number(o.moneyFlowsRange.value)||tt,r.moneyFlowsQuery?dn():Ye()}),o.liveSearchToggle&&o.liveSearchToggle.addEventListener("click",()=>{r.settings.liveSearch=!r.settings.liveSearch,D(),j()}),o.savedSearches&&o.savedSearches.addEventListener("click",a=>{let s=a.target.closest("button[data-query]");s&&(o.searchInput.value=s.dataset.query||"",hn())}),o.financeTabs&&o.financeTabs.addEventListener("click",a=>{let s=a.target.closest(".tab");if(!s)return;let i=s.dataset.tab;o.financeTabs.querySelectorAll(".tab").forEach(l=>{l.classList.toggle("active",l===s)}),document.querySelectorAll(".finance-panel .tab-panel").forEach(l=>{l.classList.toggle("active",l.id===(i==="markets"?"financeMarketsList":"financePolicyList"))})}),o.statusToggle&&o.statusToggle.addEventListener("click",()=>{r.settings.showStatus=!r.settings.showStatus,D(),j()}),o.keyToggle&&o.keyToggle.addEventListener("click",()=>{r.settings.showKeys=!r.settings.showKeys,D(),j()}),o.mcpToggle&&o.mcpToggle.addEventListener("click",()=>{r.settings.showMcp=!r.settings.showMcp,D(),j()}),o.travelTickerBtn&&o.travelTickerBtn.addEventListener("click",()=>{r.settings.showTravelTicker=!r.settings.showTravelTicker,D(),j(),fr()}),document.querySelectorAll(".ticker-builder-toggle").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.target,i=document.querySelector(`.ticker-builder[data-builder="${s}"]`);i&&i.classList.toggle("open")})}),document.querySelectorAll(".ticker-builder").forEach(a=>{let s=a.querySelector(".ticker-add"),i=a.querySelector(".ticker-query");s&&s.addEventListener("click",()=>ga(a)),i&&i.addEventListener("keydown",l=>{l.key==="Enter"&&(l.preventDefault(),ga(a))})}),document.addEventListener("click",a=>{let s=a.target.closest(".ticker-remove");if(!s)return;let i=s.dataset.key;i&&No(i)}),o.refreshRange.addEventListener("input",a=>{r.settings.refreshMinutes=Number(a.target.value),D(),j(),Mr()}),o.radiusRange.addEventListener("input",a=>{r.settings.radiusKm=Number(a.target.value),D(),j(),Vt(),H(),we()}),o.maxAgeRange&&o.maxAgeRange.addEventListener("input",a=>{r.settings.maxAgeDays=Number(a.target.value),D(),j(),r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(s=>s.category==="news")),ye(),ie(),H(),we()}),o.languageToggle&&o.languageToggle.addEventListener("click",a=>{let s=a.target.closest("button");s&&(r.settings.languageMode=s.dataset.language,D(),j(),r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(i=>i.category==="news")),ye(),ie(),H(),we())}),o.themeToggle.addEventListener("click",a=>{let s=a.target.closest("button");s&&(wn(s.dataset.theme),D(),j())}),o.ageToggle&&o.ageToggle.addEventListener("click",a=>{let s=a.target.closest("button");if(!s)return;let i=Number(s.dataset.age);Number.isFinite(i)&&(r.settings.maxAgeDays=i,D(),j(),r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(l=>l.category==="news")),ye(),ie(),H())}),o.scopeToggle.addEventListener("click",a=>{let s=a.target.closest("button");s&&(r.settings.scope=s.dataset.scope,r.scopedItems=se(r.items),r.clusters=ge(r.scopedItems.filter(i=>i.category==="news")),Pn(),ut(),ye(),ie(),H(),we())}),o.geoLocateBtn&&o.geoLocateBtn.addEventListener("click",xr),o.aiTranslateToggle&&o.aiTranslateToggle.addEventListener("change",a=>{r.settings.aiTranslate=a.target.checked,D(),j(),we()}),o.superMonitorToggle&&o.superMonitorToggle.addEventListener("change",a=>{r.settings.superMonitor=a.target.checked,D(),j(),Ut(),we()}),o.mapLegendBtn&&o.mapLegend&&(o.mapLegendBtn.addEventListener("click",()=>{o.mapLegend.classList.toggle("show")}),o.mapLegend.addEventListener("change",a=>{let s=a.target.closest("input[data-layer]");if(s){let m=s.dataset.layer;r.settings.mapLayers[m]=s.checked,D(),H();return}let i=a.target.closest("input[data-conflict-type]");if(i){let m=i.dataset.conflictType;r.settings.mapConflictTypes=r.settings.mapConflictTypes||{},r.settings.mapConflictTypes[m]=i.checked,D(),H();return}let l=a.target.closest("input[data-basemap]");if(l){qe(l.dataset.basemap),H();return}let c=a.target.closest("input[data-overlay]");if(c){let m=c.dataset.overlay;r.settings.mapRasterOverlays[m]=c.checked,D(),ce(),m==="sar"&&(c.checked?kt():N("sar","off","")),m==="lidar"&&(c.checked?Mn():N("lidar","off","")),m==="lidarPoints"&&(c.checked?Rt():N("lidarPoints","off",""))}let p=a.target.closest("input[data-flight-density]");if(p){r.settings.mapFlightDensity=p.dataset.flightDensity||"medium",D(),H();return}}),document.addEventListener("click",a=>{o.mapLegend.classList.contains("show")&&(o.mapLegend.contains(a.target)||o.mapLegendBtn.contains(a.target)||o.mapLegend.classList.remove("show"))})),o.imageryDateInput&&o.imageryDateInput.addEventListener("change",a=>{r.imageryDateManual=!0,_e(a.target.value)}),o.sarDateInput&&o.sarDateInput.addEventListener("change",a=>{r.sarDateManual=!0,_t(a.target.value)}),o.imageryDatePanel&&o.imageryDatePanel.addEventListener("change",a=>{r.imageryDateManual=!0,_e(a.target.value)}),o.sarDatePanel&&o.sarDatePanel.addEventListener("change",a=>{r.sarDateManual=!0,_t(a.target.value)});let e=()=>{r.imageryDateManual=!1,ct()},t=()=>{r.sarDateManual=!1,kt()};o.imageryAutoBtn&&o.imageryAutoBtn.addEventListener("click",e),o.imageryPanelAutoBtn&&o.imageryPanelAutoBtn.addEventListener("click",e),o.sarAutoBtn&&o.sarAutoBtn.addEventListener("click",t),o.sarPanelAutoBtn&&o.sarPanelAutoBtn.addEventListener("click",t),o.imageryResetBtn&&o.imageryResetBtn.addEventListener("click",Aa),o.imageryResetPanelBtn&&o.imageryResetPanelBtn.addEventListener("click",Aa),document.querySelectorAll("[data-imagery-preset]").forEach(a=>{a.addEventListener("click",()=>{sl(a.dataset.imageryPreset)})}),document.querySelectorAll("[data-imagery-basemap]").forEach(a=>{a.addEventListener("click",()=>{qe(a.dataset.imageryBasemap),Le()})}),document.querySelectorAll("[data-imagery-overlay]").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.imageryOverlay,i=!r.settings.mapRasterOverlays?.[s];r.settings.mapRasterOverlays[s]=i,D(),ce(),s==="sar"&&(i?kt():N("sar","off","")),s==="lidar"&&(i?Mn():(N("lidar","off",""),r.lidarSelectedLayer=null,r.lidarSelectedBounds=null,st())),s==="lidarPoints"&&(i?r.lidarPointEptUrl?r.lidarPointEptAvailable?Rt():N("lidarPoints","unavailable","ept unavailable"):N("lidarPoints","unavailable","select a LiDAR AOI"):N("lidarPoints","off",""),st()),Le(),Ue()})}),document.querySelectorAll("[data-overlay-opacity]").forEach(a=>{a.addEventListener("input",()=>{let s=a.dataset.overlayOpacity,i=Math.max(0,Math.min(100,Number(a.value)))/100;r.settings.mapOverlayOpacity[s]=i,D(),ce(),Le()})}),o.customFeedToggle&&o.customFeedToggle.addEventListener("click",()=>{let a=o.customFeedForm?.classList.contains("hidden");a&&za(),wt(a)}),o.customFeedExport&&o.customFeedExport.addEventListener("click",()=>{ro()}),o.customFeedDownload&&o.customFeedDownload.addEventListener("click",()=>{let a=o.customFeedJson?.value?.trim()||so(),s=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(s),l=document.createElement("a");l.href=i,l.download="custom-feeds.json",document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(i),o.customFeedJsonStatus&&(o.customFeedJsonStatus.textContent="Downloaded custom feeds JSON.")}),o.customFeedOpen&&o.customFeedOpen.addEventListener("click",()=>{let a=be("data/feeds.json");window.open(a,"_blank","noopener")}),o.customFeedImportToggle&&o.customFeedImportToggle.addEventListener("click",()=>{let a=o.customFeedJsonPanel?.classList.contains("hidden");ja(a)}),o.customFeedJsonCopy&&o.customFeedJsonCopy.addEventListener("click",async()=>{if(o.customFeedJson)try{await navigator.clipboard.writeText(o.customFeedJson.value||""),o.customFeedStatus&&(o.customFeedStatus.textContent="Copied feed JSON to clipboard.")}catch{o.customFeedStatus&&(o.customFeedStatus.textContent="Copy failed. Select and copy manually.")}}),o.customFeedJsonApply&&o.customFeedJsonApply.addEventListener("click",()=>{oo()}),o.customFeedCancel&&o.customFeedCancel.addEventListener("click",()=>{wt(!1)}),o.customFeedSave&&o.customFeedSave.addEventListener("click",()=>{let{feed:a,error:s}=io();if(s){o.customFeedStatus&&(o.customFeedStatus.textContent=s);return}nt&&(r.customFeeds=r.customFeeds.filter(i=>i.id!==nt)),a.id||(a.id=`custom-${Nn(a.url||a.name)}`),r.customFeeds=[...r.customFeeds,a],Ht(),r.feeds=qt(r.baseFeeds,r.customFeeds),jt(),Gt(),pt(),wt(!1),Ge(!0)}),o.customFeedRequiresKey&&o.customFeedRequiresKey.addEventListener("change",()=>{let a=o.customFeedRequiresKey.checked;o.customFeedKeyParam.disabled=!a,o.customFeedKeyHeader.disabled=!a}),o.customFeedSupportsQuery&&o.customFeedSupportsQuery.addEventListener("change",()=>{o.customFeedDefaultQuery.disabled=!o.customFeedSupportsQuery.checked}),o.mapDetailClose&&o.mapDetailClose.addEventListener("click",Kn),o.flightFocusClear&&o.flightFocusClear.addEventListener("click",Tr),o.flightFocusTrack&&o.flightFocusTrack.addEventListener("click",()=>{r.flightFocus?.icao24&&Ir(r.flightFocus.icao24,!0)}),o.flightFocusOpen&&o.flightFocusOpen.addEventListener("click",()=>{let a=r.flightFocus?.icao24;a&&window.open(`https://opensky-network.org/api/tracks/all?icao24=${encodeURIComponent(a)}`,"_blank","noopener")}),o.searchResultsClose&&o.searchResultsClose.addEventListener("click",vl);let n=o.mapBase||o.mapCanvas;n.addEventListener("mousemove",yl),n.addEventListener("mouseleave",()=>{o.mapTooltip.style.display="none"}),n.addEventListener("click",bl),o.analysisRun.addEventListener("click",cr),o.resetLayout.addEventListener("click",Js),o.chatSend.addEventListener("click",Sa),o.chatInput.addEventListener("keydown",a=>{a.key==="Enter"&&Sa()}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{r.settings.theme==="system"&&wn("system")}),window.addEventListener("resize",()=>{r.map&&r.map.invalidateSize(),r.energyMap&&r.energyMap.invalidateSize(),H()}),window.addEventListener("keydown",a=>{a.key==="Escape"&&(Ie(!1),St(!1),qa(!1),ft(!1),De(!1))})}async function Ll(){go(),Ds(),$s(),Os(),_s(),Us(),r.customFeeds=Hs(),wn(r.settings.theme),j(),await Fs(),j(),js(),r.panels.defaultOrder=xe().map(n=>n.id),r.panels.order.length&&r.panels.order.length!==r.panels.defaultOrder.length&&(r.panels.order=[...r.panels.defaultOrder],dt()),_a(),Fn(),Ua(),Ha(),Xs(),It(),Ks(),Ws(),document.querySelectorAll(".key-chip").forEach(n=>n.remove());let e;try{let n=await me("/api/feeds");if(e=n.data,n.error||!e)throw new Error("Feed API unreachable")}catch{rt("API offline"),o.feedHealth&&(o.feedHealth.innerHTML=$()?'<div class="settings-note">Static snapshot mode: feeds load from the latest published cache.</div>':'<div class="settings-note">Feed API unreachable. Check proxy configuration.</div>'),e={feeds:[]}}r.baseFeeds=(e.feeds||[]).filter(n=>n.url||n.requiresKey||n.requiresConfig),r.feeds=qt(r.baseFeeds,r.customFeeds),Ps(),Bs(),Gt(),no(),jt(),pt(),Ut(),ol(),ze(),Cl(),Oi(),Ri(),Ni(),Fi(),vs.initFocusModal(),Pi(),Bi(),Di(),$i(),Mi(),xi(),er(),kn(),xr(),(new URLSearchParams(window.location.search).has("about")||window.location.hash==="#about")&&Ie(!0),await Ra(),await Ge(),Mr()}var kl=typeof window<"u"&&new URLSearchParams(window.location.search).has("debug");kl&&(window.__SR_DEBUG__={state:r,getMapItems:Gn,getLocalItems:gt,applyScope:se});Ll();
