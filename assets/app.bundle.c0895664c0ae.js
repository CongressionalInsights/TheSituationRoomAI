var Fe=typeof window<"u"?window.SR_CONFIG||{}:{},eo=typeof window<"u"&&window.location.hostname.endsWith(".github.io");function Oa(e){return e?e.endsWith("/")?e.slice(0,-1):e:""}function to(){let e=Oa(Fe.apiBase);return e?/^https?:\/\//i.test(e)?e:e.startsWith("/")?`${window.location.origin}${e}`:e:window.location.origin}function no(){let e=Oa(Fe.basePath);if(e)return e;let t=window.location.pathname||"";if(!t||t==="/")return"";let n=t.endsWith("/")?t.slice(0,-1):t;return(n.split("/").pop()||"").includes(".")?n.replace(/\/[^/]*$/,""):n}var ao=to(),_a=no(),kn=typeof Fe.staticMode=="boolean"?Fe.staticMode:eo&&!Fe.apiBase,$e=`${_a}/data`;function ne(){return kn}function Ye(){return Fe.openAiProxy||""}function Ua(){return Fe.mcpProxy||""}function In(){return Fe.openSkyProxy||""}function xn(){return Fe.acledProxy||""}function Ha(e){if(e.startsWith("/api/feeds"))return`${$e}/feeds.json`;if(e.startsWith("/api/energy-map"))return`${$e}/energy-map.json`;if(e.startsWith("/api/feed")){let n=new URL(e,"http://local").searchParams.get("id");return n?`${$e}/feeds/${n}.json`:`${$e}/feeds.json`}return e.startsWith("/api/geocode")||e.startsWith("/api/chat")||e.startsWith("/api/snapshot")?`${$e}/unavailable.json`:e.startsWith("/api/money-flows")?`${$e}/unavailable.json`:e.startsWith("/api/congress-detail")?`${$e}/unavailable.json`:`${$e}/unavailable.json`}function so(e){return/^https?:\/\//i.test(e)?e:kn?Ha(e):new URL(e,ao).toString()}function Be(e){if(/^https?:\/\//i.test(e))return e;let t=e.startsWith("/")?e:`/${e}`;return`${_a}${t}`}async function Re(e,t={},n=12e3){let a=new AbortController,s=setTimeout(()=>a.abort(),n);try{let o=so(e);if(kn&&(!t.method||t.method.toUpperCase()==="GET")){let u=o.includes("?")?"&":"?";o=`${o}${u}_ts=${Date.now()}`}return await fetch(o,{...t,signal:a.signal})}finally{clearTimeout(s)}}async function Ce(e,t={},n=12e3){let a=async()=>{if(!e.startsWith("/api/feed"))return null;let u=ro(e,t);if(!u||!["energy-eia","energy-eia-brent","energy-eia-ng"].includes(u))return null;let d=Ha(`/api/feed?id=${encodeURIComponent(u)}`);try{let m=await fetch(`${d}?_ts=${Date.now()}`),f=await m.json();return{response:m,data:f,error:null}}catch{return null}},s;try{s=await Re(e,t,n)}catch(u){let d=await a();return d||{response:null,data:null,error:u}}let o=null,i=null;try{o=await s.json()}catch(u){i=u}if(!s.ok){let u=await a();if(u)return u}return{response:s,data:o,error:i}}function ro(e,t){if(e.startsWith("/api/feed")){let a=new URL(e,"http://local").searchParams.get("id");if(a)return a}if(t?.body)try{return(typeof t.body=="string"?JSON.parse(t.body):t.body)?.id||null}catch{return null}return null}function ja({elements:e,state:t,focusPanelExclude:n=new Set,focusGeoTarget:a="geo"}={}){let s={active:!1,target:null,panels:[]},o=g=>{let b=document.createElement("div");b.className="panel-placeholder";let C=g.getBoundingClientRect();b.style.height=`${Math.round(C.height)}px`;let v=window.getComputedStyle(g),S=g.style.gridColumnEnd||v.gridColumnEnd;return S&&S!=="auto"&&(b.style.gridColumnEnd=S),b},i=g=>{let b=o(g);return g.parentNode.insertBefore(b,g),e.focusBody.appendChild(g),{panel:g,placeholder:b}},u=()=>{s.panels.forEach(({panel:g,placeholder:b})=>{b.parentNode&&(b.parentNode.insertBefore(g,b),b.remove())}),s.panels=[],s.target=null},d=g=>{e.focusOverlay&&(e.focusOverlay.classList.toggle("open",g),e.focusOverlay.setAttribute("aria-hidden",g?"false":"true"),e.focusOverlay.inert=!g,!g&&e.focusBody&&(e.focusBody.innerHTML="",e.focusBody.classList.remove("focus-geo"),e.focusBody.classList.remove("focus-single")))},m=g=>{if(g===a){let C=document.querySelector('.panel[data-panel="map"]'),v=document.querySelector('.panel[data-panel="imagery"]');return[C,v].filter(Boolean)}let b=document.querySelector(`.panel[data-panel="${g}"]`);return b?[b]:[]},f=g=>{if(!e.focusBody)return;let b=String(g||"").trim().toLowerCase(),C=[".list-item",".summary-card",".finance-card",".map-detail-item",".legend-item",".legend-subitem",".detail-card",".trends-item",".denario-item"],v=e.focusBody.querySelectorAll(C.join(","));v.length&&v.forEach(S=>{if(!b){S.style.display="";return}let w=S.textContent?S.textContent.toLowerCase():"";S.style.display=w.includes(b)?"":"none"})},p=g=>{if(!e.focusBody)return;s.active&&h();let b=m(g);b.length&&(s.active=!0,s.target=g,e.focusTitle&&(e.focusTitle.textContent=g===a?"Geo + Imagery":b[0].querySelector(".panel-title")?.textContent||"Panel"),e.focusMeta&&(e.focusMeta.textContent=g===a?"Live incidents & events + basemaps/overlays":b[0].querySelector(".panel-sub")?.textContent||"Expanded view"),e.focusBody.innerHTML="",g===a&&e.focusBody.classList.add("focus-geo"),e.focusBody.classList.toggle("focus-single",b.length===1&&g!==a),s.panels=b.map(C=>i(C)),d(!0),e.focusSearch&&(e.focusSearch.value="",e.focusSearch.oninput=()=>f(e.focusSearch.value)),f(""),g===a&&t.map&&setTimeout(()=>t.map.invalidateSize(),120))},h=()=>{if(!s.active)return;let g=s.target===a;u(),d(!1),s.active=!1,e.focusSearch&&(e.focusSearch.value=""),g&&t.map&&setTimeout(()=>t.map.invalidateSize(),120)};return{initFocusModal:()=>{[...document.querySelectorAll(".panel[data-panel]")].forEach(b=>{let C=b.dataset.panel;if(n.has(C))return;let v=b.querySelector(".panel-header");if(!v)return;let S=v.querySelector(".panel-actions");if(S||(S=document.createElement("div"),S.className="panel-actions",v.appendChild(S)),S.querySelector(".panel-focus-btn"))return;let w=document.createElement("button");w.className="btn ghost panel-focus-btn",w.type="button",w.dataset.panelFocus=C==="map"||C==="imagery"?a:C,w.title="Focus panel",w.innerHTML='<svg class="icon" aria-hidden="true"><use href="#icon-expand"></use></svg><span class="sr-only">Focus</span>',w.addEventListener("click",()=>p(w.dataset.panelFocus)),S.appendChild(w)}),e.focusClose&&e.focusClose.addEventListener("click",()=>h()),e.focusOverlay&&e.focusOverlay.addEventListener("click",b=>{b.target===e.focusOverlay&&h()})},openFocusModal:p,closeFocusModal:h,applyFocusFilter:f,isActive:()=>s.active}}var oo="https://situation-room-mcp-382918878290.us-central1.run.app/mcp";var Nn=[400,900],io=2500;function Ga(e){return new Promise(t=>setTimeout(t,e))}function lo(e){try{return(e?.headers?.get("content-type")||"").toLowerCase()}catch{return""}}function qa(e){if(!e)return null;let n=e.split(`
`).map(s=>s.trim()).filter(s=>s.startsWith("data:"));if(!n.length)return null;let a=n[n.length-1].replace(/^data:\s*/,"");try{return JSON.parse(a)}catch{return null}}async function co(e,t){if(!e?.body)return null;let n=e.body.getReader(),a=new TextDecoder,s="";try{for(;;){let{value:o,done:i}=await n.read();if(i)break;s+=a.decode(o,{stream:!0});let u=()=>{let f=s.indexOf(`

`),p=s.indexOf(`\r
\r
`);return f===-1?{idx:p,len:p===-1?0:4}:p===-1?{idx:f,len:2}:p<f?{idx:p,len:4}:{idx:f,len:2}},{idx:d,len:m}=u();for(;d!==-1;){let f=s.slice(0,d);s=s.slice(d+m);let p=qa(f);if(p){try{n.cancel()}catch{}return p}({idx:d,len:m}=u())}}}catch{}finally{try{n.releaseLock()}catch{}}return null}function uo(e){if(!e)return null;let t=qa(e);if(t)return t;try{return JSON.parse(e)}catch{return null}}function za(e){let t=e||oo,n=(()=>{if(!t)return"";try{let i=new URL(t);return i.pathname=i.pathname.replace(/\/mcp\/?$/i,"/health"),i.toString()}catch{return String(t).replace(/\/mcp\/?$/i,"/health")}})();async function a(i=io){if(!n)return{ok:!1,status:null,message:"MCP health endpoint not configured."};let u=new AbortController,d=setTimeout(()=>u.abort(),i);try{let m=await fetch(n,{method:"GET",headers:{Accept:"application/json, text/plain;q=0.9"},signal:u.signal});return clearTimeout(d),m.ok?{ok:!0,status:m.status,message:"ok"}:{ok:!1,status:m.status,message:`HTTP ${m.status}`}}catch(m){return clearTimeout(d),{ok:!1,status:null,message:m?.name==="AbortError"?"Health check timed out.":m?.message||"Health check failed."}}}async function s(i,u={},d=3e4){if(!t)return{error:"missing_endpoint",message:"MCP endpoint not configured."};let m={jsonrpc:"2.0",id:Date.now(),method:"tools/call",params:{name:i,arguments:u}},f={"Content-Type":"application/json",Accept:"application/json, text/event-stream"},p=Nn.length+1,h=null;for(let y=0;y<p;y+=1){let g=new AbortController,b=setTimeout(()=>g.abort(),d),C;try{C=await fetch(t,{method:"POST",headers:f,body:JSON.stringify(m),signal:g.signal})}catch(I){clearTimeout(b),h=I?.name==="AbortError"?{error:"timeout",message:"MCP request timed out."}:{error:"network_error",message:I?.message||"MCP request failed."}}if(!C){if(clearTimeout(b),y<p-1&&(h?.error==="network_error"||h?.error==="timeout")){await Ga(Nn[y]||400);continue}return h||{error:"network_error",message:"MCP request failed."}}let v=null;if(lo(C).includes("text/event-stream")&&(v=await co(C,g)),!v){let I=await C.text();v=uo(I)}if(clearTimeout(b),!v)h={error:"invalid_response",message:"Unable to parse MCP response."};else if(v.error)h={error:v.error.message||"mcp_error",message:v.error.message||"MCP error.",status:C?.status||null,rawMessage:v.error.message||null};else{let I=v.result||v;if(!C.ok)h={error:`HTTP ${C.status}`,message:I?.error?.message||"MCP request failed.",status:C.status,rawMessage:I?.error?.message||null};else return{data:I.structuredContent??null,raw:I}}let w=h&&(h.error==="network_error"||h.error==="timeout"||h.error==="invalid_response"||h.error==="HTTP 503");if(y<p-1&&w){await Ga(Nn[y]||400);continue}return h||{error:"mcp_error",message:"MCP request failed."}}return h||{error:"mcp_error",message:"MCP request failed."}}async function o({title:i,summary:u,category:d}={}){let m=[i,u].filter(Boolean),f=m.length?m.join(" "):d?`${d} signals`:"top signals";return await s("search.smart",{query:f,limit:12})}return{callTool:s,searchRelated:o,healthCheck:a,endpoint:t,healthEndpoint:n}}var mo="top signals";var Ka=[2e3,5e3,15e3,3e4,6e4,12e4];function Mn(){return Date.now()}function po(e){if(!Number.isFinite(e)||e<=0)return"";let t=Math.round(e/1e3);return t<60?`${t}s`:`${Math.round(t/60)}m`}function Wa({state:e,elements:t,mcpClient:n,helpers:a}){var v,S,w,I,A,E;if(!t?.mcpTrendsPanel||!a?.toRelativeTime||!a?.truncateText||!a?.stripHtml)return null;let{toRelativeTime:s,truncateText:o,stripHtml:i}=a;e.mcpTrends||(e.mcpTrends={}),(v=e.mcpTrends).lastSuccessAt??(v.lastSuccessAt=null),(S=e.mcpTrends).lastAttemptAt??(S.lastAttemptAt=null),(w=e.mcpTrends).retryAt??(w.retryAt=null),(I=e.mcpTrends).retryInMs??(I.retryInMs=0),(A=e.mcpTrends).lastGood??(A.lastGood={signals:[],sources:[],summary:null}),(E=e.mcpTrends).inFlight??(E.inFlight=!1);let u=null,d=0;function m(){u&&(clearTimeout(u),u=null),e.mcpTrends.retryAt=null,e.mcpTrends.retryInMs=0}function f(){m();let T=Ka[Math.min(d,Ka.length-1)];d+=1,e.mcpTrends.retryInMs=T,e.mcpTrends.retryAt=Mn()+T,u=setTimeout(()=>{u=null,b(e.mcpTrends.query||"")},T)}function p(){let T=Array.isArray(e.mcpTrends.signals)?e.mcpTrends.signals:[];if(T.length)return T;let D=e.mcpTrends.lastGood?.signals;return Array.isArray(D)?D:[]}function h(){let T=Array.isArray(e.mcpTrends.sources)?e.mcpTrends.sources:[];if(T.length)return T;let D=e.mcpTrends.lastGood?.sources;return Array.isArray(D)?D:[]}function y(){return e.mcpTrends.summary||e.mcpTrends.lastGood?.summary||null}function g(){let{loading:T,error:D,lastSuccessAt:M,retryAt:P,retryInMs:B}=e.mcpTrends,U=p(),q=h(),F=y();if(t.mcpTrendsSummary)if(T&&!U.length)t.mcpTrendsSummary.textContent="Fetching MCP signals\u2026";else if(T&&U.length)t.mcpTrendsSummary.textContent="Refreshing MCP signals\u2026";else if(D){let x=M?`Last update ${s(M)}.`:"No recent MCP update.",_=P?` Retrying in ${po(B)}.`:"",c=U.length?" Showing last known signals.":"";t.mcpTrendsSummary.textContent=`Data delayed. ${x}${c}${_}`}else if(F)t.mcpTrendsSummary.textContent=F;else if(U.length){let x=q.length?`${q.length} sources`:"multiple sources";t.mcpTrendsSummary.textContent=`${U.length} signals across ${x}.`}else t.mcpTrendsSummary.textContent="Awaiting MCP signals.";if(t.mcpTrendsMeta){let x=M||null;t.mcpTrendsMeta.textContent=x?`Updated ${s(x)}`:"\u2014"}if(t.mcpTrendsList&&(t.mcpTrendsList.innerHTML="",!(T&&!U.length))){if(!U.length){t.mcpTrendsList.innerHTML='<div class="trends-empty">No MCP signals yet.</div>';return}U.slice(0,12).forEach(x=>{let _=document.createElement("div");_.className="trends-item";let c=document.createElement(x.url?"a":"div");c.className="trends-title",c.textContent=x.title||x.name||x.label||"Signal",x.url&&(c.href=x.url,c.target="_blank",c.rel="noopener noreferrer");let k=document.createElement("div");k.className="trends-meta";let N=[];x.source&&N.push(x.source),x.category&&N.push(x.category);let $=x.publishedAt||x.updatedAt||x.timestamp;$&&N.push(s($)),k.textContent=N.filter(Boolean).join(" \u2022 "),_.appendChild(c),_.appendChild(k);let O=x.summary||x.detailSummary||x.description;if(O){let G=document.createElement("div");G.className="trends-summary-text",G.textContent=o(i(O),140),_.appendChild(G)}t.mcpTrendsList.appendChild(_)})}}async function b(T=""){if(!n||typeof n.callTool!="function"||e.mcpTrends.inFlight)return;let D=String(T||"").trim();e.mcpTrends.query=D,e.mcpTrends.inFlight=!0,e.mcpTrends.loading=!0,e.mcpTrends.error=null,e.mcpTrends.lastAttemptAt=Mn(),g();try{if(typeof n.healthCheck=="function"){let q=await n.healthCheck(2500);if(!q?.ok){e.mcpTrends.error=q?.message||"MCP unavailable",e.mcpTrends.loading=!1,g(),f();return}}let M=await n.callTool("search.smart",{query:D||mo,limit:30},3e4);if(M?.error){e.mcpTrends.error=M.message||"MCP unavailable",e.mcpTrends.loading=!1,g(),f();return}let P=M?.data||{},B=Array.isArray(P.items)?P.items:Array.isArray(P.results)?P.results:Array.isArray(P.signals)?P.signals:[],U=Array.isArray(P.sources)?P.sources:Array.isArray(P.providers)?P.providers:[];e.mcpTrends.signals=B,e.mcpTrends.sources=U,e.mcpTrends.summary=P.summary||P.overview||null,e.mcpTrends.lastGood={signals:B,sources:U,summary:e.mcpTrends.summary},e.mcpTrends.lastSuccessAt=Mn(),e.mcpTrends.error=null,d=0,m()}catch(M){e.mcpTrends.error=M?.message||"MCP unavailable",f()}finally{e.mcpTrends.loading=!1,e.mcpTrends.inFlight=!1,g()}}function C(){t.mcpTrendsRun&&t.mcpTrendsRun.addEventListener("click",()=>{b(t.mcpTrendsQuery?.value||"")}),t.mcpTrendsQuery&&t.mcpTrendsQuery.addEventListener("keydown",T=>{T.key==="Enter"&&b(t.mcpTrendsQuery.value||"")}),g(),b("")}return C(),{render:g,refresh:b}}var go=["state of emergency","emergency declared","mandatory evacuation","evacuation order","mass casualty","shooting","explosion","bomb","terror","attack","hostage","wildfire","tornado","hurricane","earthquake","flood warning","flash flood","tsunami","landslide","hazmat","radiation","nuclear"];function Ot(e){if(!e)return!1;if(e.alertType||e.severity||e.hazardType||Number.isFinite(e.magnitude)&&e.magnitude>=6||Number.isFinite(e.fatalities)&&e.fatalities>=10||Number.isFinite(e.impactScore)&&e.impactScore>=80)return!0;let t=[e.title,e.summary,e.summaryHtml,e.detailSummary,e.detailTitle].filter(Boolean).join(" ").toLowerCase();return go.some(n=>t.includes(n))}var Fn=[{code:"AL",name:"Alabama"},{code:"AK",name:"Alaska"},{code:"AZ",name:"Arizona"},{code:"AR",name:"Arkansas"},{code:"CA",name:"California"},{code:"CO",name:"Colorado"},{code:"CT",name:"Connecticut"},{code:"DE",name:"Delaware"},{code:"DC",name:"District of Columbia"},{code:"FL",name:"Florida"},{code:"GA",name:"Georgia"},{code:"HI",name:"Hawaii"},{code:"ID",name:"Idaho"},{code:"IL",name:"Illinois"},{code:"IN",name:"Indiana"},{code:"IA",name:"Iowa"},{code:"KS",name:"Kansas"},{code:"KY",name:"Kentucky"},{code:"LA",name:"Louisiana"},{code:"ME",name:"Maine"},{code:"MD",name:"Maryland"},{code:"MA",name:"Massachusetts"},{code:"MI",name:"Michigan"},{code:"MN",name:"Minnesota"},{code:"MS",name:"Mississippi"},{code:"MO",name:"Missouri"},{code:"MT",name:"Montana"},{code:"NE",name:"Nebraska"},{code:"NV",name:"Nevada"},{code:"NH",name:"New Hampshire"},{code:"NJ",name:"New Jersey"},{code:"NM",name:"New Mexico"},{code:"NY",name:"New York"},{code:"NC",name:"North Carolina"},{code:"ND",name:"North Dakota"},{code:"OH",name:"Ohio"},{code:"OK",name:"Oklahoma"},{code:"OR",name:"Oregon"},{code:"PA",name:"Pennsylvania"},{code:"RI",name:"Rhode Island"},{code:"SC",name:"South Carolina"},{code:"SD",name:"South Dakota"},{code:"TN",name:"Tennessee"},{code:"TX",name:"Texas"},{code:"UT",name:"Utah"},{code:"VT",name:"Vermont"},{code:"VA",name:"Virginia"},{code:"WA",name:"Washington"},{code:"WV",name:"West Virginia"},{code:"WI",name:"Wisconsin"},{code:"WY",name:"Wyoming"}],_t=Object.fromEntries(Fn.map(e=>[e.code,e.name])),Va=Object.fromEntries(Fn.map(e=>[e.name.toLowerCase(),e.code]));function Ja(e){let t=ze(e);return t?_t[t]||t:""}function ze(e){let t=String(e||"").trim();if(!t)return"";let n=t.toUpperCase();if(_t[n])return n;let a=t.toLowerCase();if(Va[a])return Va[a];let s=a.match(/state:([a-z]{2})/);if(s){let o=s[1].toUpperCase();return _t[o]?o:""}return""}function Oe(e){return ze(e)||"ALL"}function Za(e){let t=Oe(e);return t==="ALL"?"All states":_t[t]||t}function Qa(e,t="ALL"){if(!e)return;let n=Oe(t),a=[{code:"ALL",name:"All states"},...Fn];e.innerHTML=a.map(s=>`<option value="${s.code}">${s.name}</option>`).join(""),e.value=n}function fo(e){return ze(e?.jurisdictionCode||e?.stateCode||e?.regionTag||e?.location)}function Ut(e,t="ALL",{includeFederal:n=!0}={}){let a=Oe(t);return a==="ALL"?e:(e||[]).filter(s=>String(s?.jurisdictionLevel||"").toLowerCase()==="state"?fo(s)===a:n)}function Ya(e,t="ALL"){if(!e||!e.supportsParams)return{};if(String(e.jurisdictionLevel||"").toLowerCase()!=="state")return{};let n=Oe(t),a=e.paramStrategy||"state-code",s={};return a==="openstates-jurisdiction"?(n!=="ALL"&&(s.jurisdiction=`ocd-jurisdiction/country:us/state:${n.toLowerCase()}/government`),s):(n!=="ALL"&&(s.state=n,s.jurisdictionCode=n),Array.isArray(e.capabilities)&&e.capabilities.length&&(s.signalType=e.capabilities[0]),s)}function Dn(e){return e==null?"":Array.isArray(e)?e.map(t=>Dn(t)).filter(Boolean).join(" "):String(e).trim()}function yo(e){return[e?.title,e?.summary,e?.jurisdictionName,e?.jurisdictionCode,e?.agency,e?.signalType,e?.status,e?.docId,e?.tags].map(n=>Dn(n)).filter(Boolean).join(" ").toLowerCase()}function ho(e){return String(e?.jurisdictionLevel||"").toLowerCase()==="state"?yo(e):[e?.title,e?.summary].map(n=>Dn(n)).filter(Boolean).join(" ").toLowerCase()}function bt(e,t){return t?ho(e).includes(t):!0}function Xa({state:e,elements:t,helpers:n}){if(!t||!n)return{handleSearch:null};let{showSearchResults:a,updateSearchHint:s,isStaticMode:o,getLiveSearchFeeds:i,translateQueryAsync:u,fetchCustomFeedDirect:d,applySearchFilters:m,CATEGORY_LABELS:f,fetchFeed:p,hasAssistantAccess:h,updateCategoryFilters:y}=n,g=async()=>{let b=t.searchInput.value.trim(),C=t.feedScope.value||"all";if(!b){t.searchHint.textContent="Enter a search term to query signals.",a([],"Enter a search term"),s();return}e.lastSearchQuery=b,e.lastSearchScope=C,e.lastSearchCategories=[...e.searchCategories];let v=Oe(e.settings.stateSignalFilter),S=(I,A=!1)=>Ut(I,v,{includeFederal:!A});e.lastSearchState=v;let w=t.searchBtn?.textContent;t.searchBtn&&(t.searchBtn.disabled=!0,t.searchBtn.textContent="Searching..."),e.searching=!0;try{let I=b.toLowerCase(),A=o()&&e.settings.liveSearch?i():[],E=async M=>M.length?(await Promise.all(M.map(async B=>{let U=await u(B,b);return d(B,U)}))).flatMap(B=>B.items||[]):[];if(e.searchCategories.length){let M=e.searchCategories,P=e.scopedItems.filter(_=>M.includes(_.category)),B=A.filter(_=>M.includes(_.category));B.length&&(t.searchHint.textContent="Searching live sources...");let U=await E(B),q=[...P,...U],F=m(q).filter(_=>bt(_,I)),x=S(F,M.includes("gov"));a(x,`${x.length} matches in ${M.map(_=>f[_]||_).join(", ")}`),t.searchHint.textContent=B.length?"Showing cached + live search results.":"Showing multi-category search results.";return}if(C==="all"){let M=[...e.scopedItems];A.length&&(t.searchHint.textContent="Searching live sources...");let P=await E(A),B=[...M,...P],U=m(B).filter(F=>bt(F,I)),q=S(U,!1);a(q,`${q.length} matches across all feeds`),t.searchHint.textContent=A.length?`Showing cached + live results (${q.length}).`:`Showing ${q.length} matches across all feeds.`;return}if(C.startsWith("cat:")){let M=C.replace("cat:",""),P=e.scopedItems.filter(_=>_.category===M),B=A.filter(_=>_.category===M);B.length&&(t.searchHint.textContent="Searching live sources...");let U=await E(B),q=[...P,...U],F=m(q).filter(_=>bt(_,I)),x=S(F,M==="gov");a(x,`${x.length} matches in ${f[M]||M}`),t.searchHint.textContent=B.length?`Showing cached + live results (${x.length}).`:`Showing ${x.length} matches in ${f[M]||M}.`;return}let T=e.feeds.find(M=>M.id===C);if(!T){t.searchHint.textContent="Select a feed or category to search.",a([],"Select a feed or category");return}t.searchHint.textContent=e.settings.aiTranslate&&h()?"Translating query...":"Preparing query...";let D=await u(T,b);try{if(A.find(M=>M.id===T.id)){let M=await d(T,D),P=m(M.items||[]).filter(U=>bt(U,I)),B=S(P,T.category==="gov");a(B,`${B.length} live results from ${T.name}`),t.searchHint.textContent=`Live search results from ${T.name}.`}else{let M=await p(T,D,!0),P=m(M.items||[]).filter(U=>bt(U,I)),B=S(P,T.category==="gov");a(B,`${B.length} results from ${T.name}`),t.searchHint.textContent=`Search results from ${T.name}.`}}catch{t.searchHint.textContent=`Search failed for ${T.name}.`,a([],`Search failed for ${T.name}`)}}finally{t.searchBtn&&(t.searchBtn.disabled=!1,t.searchBtn.textContent=w||"Search"),e.searching=!1,s()}};return t.feedScope&&t.feedScope.addEventListener("change",()=>{t.feedScope.value!=="all"&&!t.feedScope.value.startsWith("cat:")&&(e.searchCategories=[],y&&y())}),t.searchBtn&&t.searchBtn.addEventListener("click",g),t.searchInput&&t.searchInput.addEventListener("keydown",b=>{b.key==="Enter"&&g()}),{handleSearch:g}}function es({state:e,helpers:t}){if(!t)return;let{buildNewsItems:n,getCombinedItems:a,getCategoryItems:s,getFederalPolicyItems:o,getStateGovernmentItems:i,getPredictionItems:u,getLocalItemsForPanel:d,getCongressItems:m,getEnergyNewsItems:f,getCriticalAlertsItems:p,renderList:h,getListLimit:y,LIST_PAGE_SIZE:g}=t;[{id:"newsList",withCoverage:!0,getItems:()=>n(e.clusters)},{id:"financeMarketsList",getItems:()=>a(["finance","energy"])},{id:"financePolicyList",getItems:()=>a(["gov","cyber","agriculture"])},{id:"cryptoList",getItems:()=>s("crypto").items},{id:"predictionList",getItems:()=>u()},{id:"disasterList",getItems:()=>a(["disaster","weather","space"])},{id:"criticalAlertsList",getItems:()=>p?p():[]},{id:"localList",getItems:()=>d()},{id:"policyList",getItems:()=>o?o():s("gov").items},{id:"stateGovAllList",getItems:()=>i?i():[]},{id:"stateGovLegislationList",getItems:()=>i?i("legislation"):[]},{id:"stateGovRulemakingList",getItems:()=>i?i("rulemaking"):[]},{id:"stateGovExecutiveOrdersList",getItems:()=>i?i("executive_order"):[]},{id:"congressList",getItems:()=>m()},{id:"cyberList",getItems:()=>s("cyber").items},{id:"agricultureList",getItems:()=>s("agriculture").items},{id:"researchList",getItems:()=>s("research").items},{id:"spaceList",getItems:()=>s("space").items},{id:"energyList",getItems:()=>f()},{id:"healthList",getItems:()=>s("health").items},{id:"transportList",getItems:()=>s("transport").items}].forEach(C=>{let v=document.getElementById(C.id);v&&v.addEventListener("scroll",()=>{if(v.scrollTop+v.clientHeight<v.scrollHeight-60)return;let S=C.getItems();if(!S||!S.length)return;let w=y(C.id);if(w>=S.length)return;let I=Math.min(S.length,w+g);e.listLimits[C.id]=I,h(v,S.slice(w,I),{withCoverage:C.withCoverage,append:!0})})})}function ts({state:e,helpers:t}){if(typeof ResizeObserver>"u"||!t)return;let{buildNewsItems:n,getCombinedItems:a,getCategoryItems:s,getFederalPolicyItems:o,getStateGovernmentItems:i,getPredictionItems:u,getLocalItemsForPanel:d,getCongressItems:m,getEnergyNewsItems:f,getCriticalAlertsItems:p,renderListWithLimit:h}=t,y=[{id:"newsList",withCoverage:!0,getItems:()=>n(e.clusters)},{id:"financeMarketsList",getItems:()=>a(["finance","energy"])},{id:"financePolicyList",getItems:()=>a(["gov","cyber","agriculture"])},{id:"cryptoList",getItems:()=>s("crypto").items},{id:"predictionList",getItems:()=>u()},{id:"disasterList",getItems:()=>a(["disaster","weather","space"])},{id:"criticalAlertsList",getItems:()=>p?p():[]},{id:"localList",getItems:()=>d()},{id:"policyList",getItems:()=>o?o():s("gov").items},{id:"stateGovAllList",getItems:()=>i?i():[]},{id:"stateGovLegislationList",getItems:()=>i?i("legislation"):[]},{id:"stateGovRulemakingList",getItems:()=>i?i("rulemaking"):[]},{id:"stateGovExecutiveOrdersList",getItems:()=>i?i("executive_order"):[]},{id:"congressList",getItems:()=>m()},{id:"cyberList",getItems:()=>s("cyber").items},{id:"agricultureList",getItems:()=>s("agriculture").items},{id:"researchList",getItems:()=>s("research").items},{id:"spaceList",getItems:()=>s("space").items},{id:"energyList",getItems:()=>f()},{id:"healthList",getItems:()=>s("health").items},{id:"transportList",getItems:()=>s("transport").items}],g=new Map(y.map(C=>[C.id,C])),b=new ResizeObserver(C=>{C.forEach(v=>{let S=g.get(v.target.id);if(!S)return;let w=S.getItems();!w||!w.length||h(v.target,w,{withCoverage:S.withCoverage})})});y.forEach(C=>{let v=document.getElementById(C.id);v&&b.observe(v)})}function ns({elements:e,handlers:t}){!e||!t||(e.settingsToggle&&t.onSettingsToggle&&e.settingsToggle.addEventListener("click",t.onSettingsToggle),e.settingsScrim&&t.onSettingsScrim&&e.settingsScrim.addEventListener("click",t.onSettingsScrim),e.sidebarSettings&&t.onSidebarSettings&&e.sidebarSettings.addEventListener("click",t.onSidebarSettings),e.statusToggle&&t.onStatusToggle&&e.statusToggle.addEventListener("click",t.onStatusToggle),e.keyToggle&&t.onKeyToggle&&e.keyToggle.addEventListener("click",t.onKeyToggle),e.mcpToggle&&t.onMcpToggle&&e.mcpToggle.addEventListener("click",t.onMcpToggle),e.travelTickerBtn&&t.onTravelTickerToggle&&e.travelTickerBtn.addEventListener("click",t.onTravelTickerToggle),e.refreshRange&&t.onRefreshRange&&e.refreshRange.addEventListener("input",t.onRefreshRange),e.radiusRange&&t.onRadiusRange&&e.radiusRange.addEventListener("input",t.onRadiusRange),e.maxAgeRange&&t.onMaxAgeRange&&e.maxAgeRange.addEventListener("input",t.onMaxAgeRange),e.languageToggle&&t.onLanguageToggle&&e.languageToggle.addEventListener("click",t.onLanguageToggle),e.themeToggle&&t.onThemeToggle&&e.themeToggle.addEventListener("click",t.onThemeToggle),e.ageToggle&&t.onAgeToggle&&e.ageToggle.addEventListener("click",t.onAgeToggle),e.scopeToggle&&t.onScopeToggle&&e.scopeToggle.addEventListener("click",t.onScopeToggle),e.aiTranslateToggle&&t.onAiTranslateToggle&&e.aiTranslateToggle.addEventListener("change",t.onAiTranslateToggle),e.superMonitorToggle&&t.onSuperMonitorToggle&&e.superMonitorToggle.addEventListener("change",t.onSuperMonitorToggle))}function as({state:e,elements:t,helpers:n}){let{setRefreshing:a,setHealth:s,updateProxyHealth:o,isStaticMode:i,loadStaticAnalysis:u,loadStaticBuild:d,translateQuery:m,shouldFetchLiveInStatic:f,fetchCustomFeedDirect:p,fetchFeed:h,isFeedStale:y,canonicalUrl:g,isNonEnglish:b,enrichItem:C,applyScope:v,clusterNews:S,updateDataFreshBadge:w,countCriticalIssues:I,renderAllPanels:A,renderSignals:E,renderFeedHealth:T,drawMap:D,generateAnalysis:M,maybeAutoRunAnalysis:P,refreshCustomTickers:B,renderTicker:U,renderFinanceSpotlight:q,geocodeItems:F,renderLocal:x,updatePanelErrors:_}=n,c=async(O=!1)=>{a(!0),s("Fetching feeds"),o();let G=O&&i();try{i()&&(await u(),await d());let W=await Promise.all(e.feeds.map(async H=>{let j=H.supportsQuery?m(H,H.defaultQuery||""):void 0;if(G||f(H))try{let ge=await p(H,j);return ge.error?await h(H,j,O):ge}catch{}return h(H,j,O).catch(()=>({feed:H,items:[],error:"fetch_failed",httpStatus:0,fetchedAt:Date.now()}))}));W.forEach(H=>{let j=!H.error&&y(H.feed,H);e.feedStatus[H.feed.id]={httpStatus:H.httpStatus,error:H.error,errorMessage:H.errorMessage,fetchedAt:H.fetchedAt,count:H.items.length,stale:j}});let re=W.flatMap(H=>H.items||[]);e.items=re.map(H=>C({...H,url:g(H.url),isNonEnglish:b(`${H.title||""} ${H.summary||""}`),feedId:H.feedId||null})),e.scopedItems=v(e.items),e.clusters=S(e.scopedItems.filter(H=>H.category==="news")),e.lastFetch=Date.now(),w();let K=I(W);s(K?`Degraded (${K})`:"Healthy"),A(),E(),T(),D(),M(!1),P(),await B(),U(),q(),F(e.items).then(H=>{H&&(e.scopedItems=v(e.items),e.settings.scope==="local"?(e.clusters=S(e.scopedItems.filter(j=>j.category==="news")),A()):x(),E(),T(),D(),U())}).catch(()=>{}),K&&await k(),await N(W)}finally{a(!1)}},k=async()=>{if(e.retryingFeeds)return;let O=e.feeds.filter(K=>e.feedStatus[K.id]?.error==="fetch_failed");if(!O.length)return;e.retryingFeeds=!0;let G=new Set(e.items.map(K=>K.url||K.title)),W=[];for(let K of O){let H=K.supportsQuery?m(K,K.defaultQuery||""):void 0;try{let j=await h(K,H,!0),ge=!j.error&&y(j.feed,j);e.feedStatus[j.feed.id]={httpStatus:j.httpStatus,error:j.error,errorMessage:j.errorMessage,fetchedAt:j.fetchedAt,count:j.items.length,stale:ge},j.items.forEach(oe=>{let xe=oe.url||oe.title;!xe||G.has(xe)||(G.add(xe),W.push({...oe,url:g(oe.url)}))})}catch{}}W.length&&(e.items=[...e.items,...W],e.scopedItems=v(e.items),e.clusters=S(e.scopedItems.filter(K=>K.category==="news")),A(),E(),D()),T();let re=I(e.feeds.map(K=>({feed:K,...e.feedStatus[K.id]})));s(re?`Degraded (${re})`:"Healthy"),_(),e.retryingFeeds=!1},N=async O=>{if(e.staleRetrying||i()&&!e.settings.superMonitor)return;let G=Date.now();if(G-e.lastStaleRetry<120*1e3)return;let W=e.feeds.filter(j=>{let ge=e.feedStatus[j.id];return!ge||ge.error||i()&&j.keySource==="server"?!1:y(j,ge)});if(!W.length)return;e.staleRetrying=!0,e.lastStaleRetry=G;let re=new Set(e.items.map(j=>j.url||j.title)),K=[];for(let j of W){let ge=j.supportsQuery?m(j,j.defaultQuery||""):void 0;try{let oe=await h(j,ge,!0),xe=!oe.error&&y(oe.feed,oe);e.feedStatus[oe.feed.id]={httpStatus:oe.httpStatus,error:oe.error,errorMessage:oe.errorMessage,fetchedAt:oe.fetchedAt,count:oe.items.length,stale:xe},oe.items.forEach(ye=>{let Qe=ye.url||ye.title;!Qe||re.has(Qe)||(re.add(Qe),K.push({...ye,url:g(ye.url)}))})}catch{}}K.length&&(e.items=[...e.items,...K],e.scopedItems=v(e.items),e.clusters=S(e.scopedItems.filter(j=>j.category==="news")),A(),E(),D()),T(),_();let H=I(e.feeds.map(j=>({feed:j,...e.feedStatus[j.id]})));s(H?`Degraded (${H})`:"Healthy"),e.staleRetrying=!1};return{refreshAll:c,retryFailedFeeds:k,retryStaleFeeds:N,startAutoRefresh:()=>{e.refreshTimer&&clearInterval(e.refreshTimer),e.refreshTimer=setInterval(()=>c(),e.settings.refreshMinutes*60*1e3)}}}var $s=4,Bs="situationRoomCustomFeeds",bo=12e3,wt=180,vo=120,Co={hillshade:!1,sar:!1,aerosol:!1,lidar:!1,lidarPoints:!1,thermal:!1,fire:!1},So={hillshade:.45,sar:.55,aerosol:.45,lidar:.25,lidarPoints:.65,thermal:.45,fire:.45},wo={useCustom:!1,pointCap:15e4,radiusKm:5,maxTilesDesktop:16,maxTilesMobile:8},Lo={battle:!0,explosion:!0,violence:!0,protest:!0,riot:!0,other:!0},Ao={weather:!0,disaster:!0,space:!0,news:!0,spill:!0,health:!0,travel:!0,transport:!0,security:!0,securityLagged:!0,military:!0,gpsjam:!0,infrastructure:!0,outage:!0,local:!0},Ke={refreshMinutes:60,theme:"system",maxAgeDays:30,languageMode:"en",radiusKm:150,scope:"global",country:"US",countryAuto:!0,stateSignalFilter:"ALL",aiTranslate:!0,superMonitor:!1,showStatus:!0,showTravelTicker:!0,showKeys:!0,showMcp:!0,liveSearch:!0,tickerWatchlist:[],useClientOpenAI:!1,mapBasemap:"osm",mapRasterOverlays:Co,mapImageryDate:"",mapSarDate:"",lastImageryDate:"",lastSarDate:"",mapOverlayOpacity:So,lidarPointLimits:wo,lidarEnabled:!1,mapConflictTypes:Lo,mapLayers:Ao,mapFlightDensity:"medium"};function Rs(){return{...Ke,tickerWatchlist:[...Ke.tickerWatchlist],mapRasterOverlays:{...Ke.mapRasterOverlays},mapOverlayOpacity:{...Ke.mapOverlayOpacity},lidarPointLimits:{...Ke.lidarPointLimits},mapConflictTypes:{...Ke.mapConflictTypes},mapLayers:{...Ke.mapLayers}}}function ss(e={}){let t=Rs(),n={...t,...e};n.mapLayers={...t.mapLayers,...e.mapLayers||{}},n.mapRasterOverlays={...t.mapRasterOverlays,...e.mapRasterOverlays||{}},n.mapOverlayOpacity={...t.mapOverlayOpacity,...e.mapOverlayOpacity||{}},n.lidarPointLimits=dn({...t.lidarPointLimits,...e.lidarPointLimits||{}}),n.mapBasemap||(n.mapBasemap=t.mapBasemap),n.mapBasemap==="gibs"&&(n.mapBasemap="gibs-viirs"),n.mapImageryDate||(n.mapImageryDate=""),n.mapSarDate||(n.mapSarDate=""),n.lastImageryDate||(n.lastImageryDate=""),n.lastSarDate||(n.lastSarDate=""),n.mapFlightDensity||(n.mapFlightDensity=t.mapFlightDensity),(!n.mapConflictTypes||typeof n.mapConflictTypes!="object")&&(n.mapConflictTypes={...t.mapConflictTypes}),typeof n.lidarEnabled!="boolean"&&(n.lidarEnabled=t.lidarEnabled),n.aiTranslate=typeof n.aiTranslate=="boolean"?n.aiTranslate:t.aiTranslate,n.showStatus=typeof n.showStatus=="boolean"?n.showStatus:t.showStatus,n.showTravelTicker=typeof n.showTravelTicker=="boolean"?n.showTravelTicker:t.showTravelTicker,n.showKeys=typeof n.showKeys=="boolean"?n.showKeys:t.showKeys,n.showMcp=typeof n.showMcp=="boolean"?n.showMcp:t.showMcp,n.liveSearch=typeof n.liveSearch=="boolean"?n.liveSearch:t.liveSearch;let a=Object.prototype.hasOwnProperty.call(e,"superMonitor")&&typeof e.superMonitor=="boolean";n.superMonitor=a?e.superMonitor:ne(),Array.isArray(n.tickerWatchlist)||(n.tickerWatchlist=[]),n.country||(n.country=t.country),typeof n.countryAuto!="boolean"&&(n.countryAuto=t.countryAuto);let s=ze(n.stateSignalFilter);return n.stateSignalFilter=s||"ALL",n}var r={feeds:[],baseFeeds:[],customFeeds:[],items:[],scopedItems:[],clusters:[],panels:{defaultOrder:[],order:[],visibility:{},sizes:{}},keys:{},keyStatus:{},keyFilter:null,feedStatus:{},keyGroups:{},searchCategories:[],lastSearchQuery:"",lastSearchScope:"all",lastSearchCategories:[],lastSearchState:"ALL",translationCache:{},translationInFlight:new Set,congressAmendmentCache:new Map,congressBillAmendments:new Map,congressAmendmentsLoading:!1,congressHearingCache:new Map,congressDetailCache:new Map,congressDetailLoading:new Map,govinfoDetailCache:new Map,govinfoDetailLoading:new Map,federalRegisterDetailCache:new Map,federalRegisterDetailLoading:new Map,regulationsCommentDetailCache:new Map,regulationsCommentDetailLoading:new Map,staticAnalysis:null,customTickers:[],energyMarket:{},listLimits:{},countries:[],countryIndex:{},settings:Rs(),location:{lat:35.5951,lon:-82.5515,source:"fallback"},geoCache:{},chatHistory:[],mapPoints:[],mapPointsReady:!1,mapLastNonEmptyAt:0,mapLastNonEmptyCount:0,map:null,mapBaseLayers:{},mapOverlayLayers:{},activeBaseLayer:null,lidarMap:null,lidarControl:null,lidarModules:null,imageryDate:null,sarDate:null,imageryDateManual:!1,sarDateManual:!1,imageryResolveInFlight:!1,sarResolveInFlight:!1,sarCapabilitiesChecked:!1,sarCapabilitiesDate:null,sarCoverageTimer:null,sarCoverageCache:{},overlayStatus:{imagery:{state:"idle",message:""},sar:{state:"idle",message:""},lidar:{state:"idle",message:""},lidarPoints:{state:"idle",message:""}},energyMap:null,energyMapLayer:null,energyGeo:null,energyMapData:null,energyMapError:null,energyMapFetchedAt:0,moneyFlowsData:null,moneyFlowsItems:[],moneyFlowsFetchedAt:0,moneyFlowsLoading:!1,moneyFlowsError:null,moneyFlowsQuery:"",moneyFlowsRangeDays:wt,lastBuildAt:null,refreshTimer:null,lastFetch:null,refreshing:!1,retryingFeeds:!1,staleRetrying:!1,lastStaleRetry:0,health:"Initializing",previousSignals:null,analysisSignature:null,analysisRunning:!1,searching:!1,mcpTrends:{loading:!1,query:"",summary:null,signals:[],sources:[],error:null,errorDetail:null,updatedAt:null,lastSuccessAt:null,lastAttemptAt:null,retryAt:null,retryInMs:0,lastGood:{signals:[],sources:[],summary:null},inFlight:!1},denario:{loading:!1,available:!1,summary:null,generatedAt:null,items:[],error:null},predictionFallback:{items:[],loading:!1,loaded:!1},flightFocus:null,flightTrack:null,flightTrackLayer:null,flightTrackLoading:!1,flightTrackFetchedAt:0,lidarCoverageLayer:null,lidarCoverageLoading:!1,lidarPointLayer:null,lidarPointData:null,lidarPointLoading:!1,lidarPointAnchor:null,lidarPointProject:null,lidarPointEptUrl:null,lidarPointTelemetry:[],lidarPointEptAvailable:!1,lidarPointEptMeta:null,lidarPointSource:null,lidarSelectedLayer:null,lidarSelectedBounds:null},l={app:document.querySelector(".app"),sidebar:document.getElementById("sidebar"),sidebarScrim:document.getElementById("sidebarScrim"),navToggle:document.getElementById("navToggle"),sidebarSettings:document.getElementById("sidebarSettings"),sidebarAbout:document.getElementById("sidebarAbout"),communityConnect:document.getElementById("communityConnect"),communityFrame:document.querySelector(".chat-frame"),lidarMap:document.getElementById("lidarMap"),lidarLoad:document.getElementById("lidarLoad"),lidarLoadInline:document.getElementById("lidarLoadInline"),lidarReload:document.getElementById("lidarReload"),lidarOpen:document.getElementById("lidarOpen"),lidarClose:document.getElementById("lidarClose"),lidarOverlayOpen:document.getElementById("lidarOverlayOpen"),lidarScrim:document.getElementById("lidarScrim"),lidarEmpty:document.getElementById("lidarEmpty"),lidarEmptyTitle:document.getElementById("lidarEmptyTitle"),lidarEmptySub:document.getElementById("lidarEmptySub"),panelGrid:document.getElementById("panelGrid"),exportSnapshot:document.getElementById("exportSnapshot"),refreshNow:document.getElementById("refreshNow"),statusText:document.getElementById("statusText"),dataFresh:document.getElementById("dataFresh"),proxyHealth:document.getElementById("proxyHealth"),refreshValue:document.getElementById("refreshValue"),refreshRange:document.getElementById("refreshRange"),refreshRangeValue:document.getElementById("refreshRangeValue"),maxAgeRange:document.getElementById("maxAgeRange"),maxAgeValue:document.getElementById("maxAgeValue"),languageToggle:document.getElementById("languageToggle"),radiusRange:document.getElementById("radiusRange"),radiusRangeValue:document.getElementById("radiusRangeValue"),themeToggle:document.getElementById("themeToggle"),ageToggle:document.getElementById("ageToggle"),settingsPanel:document.getElementById("settingsPanel"),settingsToggle:document.getElementById("settingsToggle"),settingsScrim:document.getElementById("settingsScrim"),panelToggles:document.getElementById("panelToggles"),resetLayout:document.getElementById("resetLayout"),aiTranslateToggle:document.getElementById("aiTranslateToggle"),superMonitorToggle:document.getElementById("superMonitorToggle"),keyManager:document.getElementById("keyManager"),feedHealth:document.getElementById("feedHealth"),aboutOverlay:document.getElementById("aboutOverlay"),aboutOpen:document.getElementById("aboutOpen"),aboutOpenSettings:document.getElementById("aboutOpenSettings"),aboutClose:document.getElementById("aboutClose"),listOverlay:document.getElementById("listOverlay"),listModalTitle:document.getElementById("listModalTitle"),listModalMeta:document.getElementById("listModalMeta"),listModalList:document.getElementById("listModalList"),listModalClose:document.getElementById("listModalClose"),detailOverlay:document.getElementById("detailOverlay"),detailTitle:document.getElementById("detailTitle"),detailMeta:document.getElementById("detailMeta"),detailBody:document.getElementById("detailBody"),detailClose:document.getElementById("detailClose"),focusOverlay:document.getElementById("focusOverlay"),focusTitle:document.getElementById("focusTitle"),focusMeta:document.getElementById("focusMeta"),focusBody:document.getElementById("focusBody"),focusSearch:document.getElementById("focusSearch"),focusClose:document.getElementById("focusClose"),feedScope:document.getElementById("feedScope"),searchInput:document.getElementById("searchInput"),searchBtn:document.getElementById("searchBtn"),searchHint:document.getElementById("searchHint"),stateSignalFilter:document.getElementById("stateSignalFilter"),liveSearchToggle:document.getElementById("liveSearchToggle"),scopeToggle:document.getElementById("scopeToggle"),countrySelect:document.getElementById("countrySelect"),countrySelectLabel:document.getElementById("countrySelectLabel"),geoLocateBtn:document.getElementById("geoLocateBtn"),geoValue:document.getElementById("geoValue"),healthValue:document.getElementById("healthValue"),statusCompact:document.getElementById("statusCompact"),statusToggle:document.getElementById("statusToggle"),keySection:document.getElementById("keySection"),keyCompactBody:document.getElementById("keyCompactBody"),keyToggle:document.getElementById("keyToggle"),mcpSection:document.getElementById("mcpSection"),mcpToggle:document.getElementById("mcpToggle"),newsList:document.getElementById("newsList"),securityList:document.getElementById("securityList"),cryptoList:document.getElementById("cryptoList"),disasterList:document.getElementById("disasterList"),localList:document.getElementById("localList"),predictionList:document.getElementById("predictionList"),policyList:document.getElementById("policyList"),stateGovAllList:document.getElementById("stateGovAllList"),stateGovLegislationList:document.getElementById("stateGovLegislationList"),stateGovRulemakingList:document.getElementById("stateGovRulemakingList"),stateGovExecutiveOrdersList:document.getElementById("stateGovExecutiveOrdersList"),congressList:document.getElementById("congressList"),cyberList:document.getElementById("cyberList"),agricultureList:document.getElementById("agricultureList"),researchList:document.getElementById("researchList"),spaceList:document.getElementById("spaceList"),energyList:document.getElementById("energyList"),energyMap:document.getElementById("energyMap"),energyMapLegend:document.getElementById("energyMapLegend"),energyMapEmpty:document.getElementById("energyMapEmpty"),healthList:document.getElementById("healthList"),transportList:document.getElementById("transportList"),criticalAlertsList:document.getElementById("criticalAlertsList"),analysisOutput:document.getElementById("analysisOutput"),analysisMeta:document.getElementById("analysisMeta"),analysisStory:document.getElementById("analysisStory"),analysisBody:document.querySelector("#analysisOutput .analysis-body"),analysisRun:document.getElementById("analysisRun"),mcpTrendsPanel:document.getElementById("mcpTrendsPanel"),mcpTrendsQuery:document.getElementById("mcpTrendsQuery"),mcpTrendsRun:document.getElementById("mcpTrendsRun"),mcpTrendsSummary:document.getElementById("mcpTrendsSummary"),mcpTrendsList:document.getElementById("mcpTrendsList"),mcpTrendsMeta:document.getElementById("mcpTrendsMeta"),denarioPanel:document.getElementById("denarioPanel"),denarioMeta:document.getElementById("denarioMeta"),denarioList:document.getElementById("denarioList"),signalDeckAnchor:document.getElementById("signalDeckAnchor"),summaryGlobalActivity:document.getElementById("summaryGlobalActivity"),summaryGlobalActivityMeta:document.getElementById("summaryGlobalActivityMeta"),summaryNewsSaturation:document.getElementById("summaryNewsSaturation"),summaryNewsSaturationMeta:document.getElementById("summaryNewsSaturationMeta"),summaryLocalEvents:document.getElementById("summaryLocalEvents"),summaryLocalEventsMeta:document.getElementById("summaryLocalEventsMeta"),summaryMarketPulse:document.getElementById("summaryMarketPulse"),summaryMarketPulseMeta:document.getElementById("summaryMarketPulseMeta"),globalActivity:document.getElementById("globalActivity"),globalActivityMeta:document.getElementById("globalActivityMeta"),newsSaturation:document.getElementById("newsSaturation"),newsSaturationMeta:document.getElementById("newsSaturationMeta"),localEvents:document.getElementById("localEvents"),localEventsMeta:document.getElementById("localEventsMeta"),marketPulse:document.getElementById("marketPulse"),marketPulseMeta:document.getElementById("marketPulseMeta"),signalHealthChip:document.getElementById("signalHealthChip"),signalHealthDetail:document.getElementById("signalHealthDetail"),mapCanvas:document.getElementById("mapCanvas"),mapBase:document.getElementById("mapBase"),mapEmpty:document.getElementById("mapEmpty"),mapTooltip:document.getElementById("mapTooltip"),mapLegendBtn:document.getElementById("mapLegendBtn"),mapLegend:document.getElementById("mapLegend"),legendOutages:document.getElementById("legendOutages"),imageryDateInput:document.getElementById("imageryDateInput"),sarDateInput:document.getElementById("sarDateInput"),imageryDatePanel:document.getElementById("imageryDatePanel"),sarDatePanel:document.getElementById("sarDatePanel"),imageryAutoBtn:document.getElementById("imageryAutoBtn"),sarAutoBtn:document.getElementById("sarAutoBtn"),imageryPanelAutoBtn:document.getElementById("imageryPanelAutoBtn"),sarPanelAutoBtn:document.getElementById("sarPanelAutoBtn"),imageryResetBtn:document.getElementById("imageryResetBtn"),imageryResetPanelBtn:document.getElementById("imageryResetPanelBtn"),imageryStatus:document.getElementById("imageryStatus"),lidarPointMeta:document.getElementById("lidarPointMeta"),lidarPointProject:document.getElementById("lidarPointProject"),lidarPointEpt:document.getElementById("lidarPointEpt"),lidarPointTelemetry:document.getElementById("lidarPointTelemetry"),lidarPointPerfNote:document.getElementById("lidarPointPerfNote"),lidarPointCustomize:document.getElementById("lidarPointCustomize"),lidarPointCap:document.getElementById("lidarPointCap"),lidarPointRadius:document.getElementById("lidarPointRadius"),lidarPointTilesDesktop:document.getElementById("lidarPointTilesDesktop"),lidarPointTilesMobile:document.getElementById("lidarPointTilesMobile"),lidarPointLimitGrid:document.getElementById("lidarPointLimitGrid"),lidarPointCenter:document.getElementById("lidarPointCenter"),lidarPointRefresh:document.getElementById("lidarPointRefresh"),lidarPointLoad:document.getElementById("lidarPointLoad"),mapDetail:document.getElementById("mapDetail"),mapDetailList:document.getElementById("mapDetailList"),mapDetailMeta:document.getElementById("mapDetailMeta"),mapDetailClose:document.getElementById("mapDetailClose"),flightFocus:document.getElementById("flightFocus"),flightFocusMeta:document.getElementById("flightFocusMeta"),flightFocusBody:document.getElementById("flightFocusBody"),flightFocusTrack:document.getElementById("flightFocusTrack"),flightFocusOpen:document.getElementById("flightFocusOpen"),flightFocusClear:document.getElementById("flightFocusClear"),mapWrap:document.querySelector(".map-wrap"),travelTicker:document.getElementById("travelTicker"),travelTickerTrack:document.getElementById("travelTickerTrack"),travelTickerBtn:document.getElementById("travelTickerBtn"),tickerBar:document.getElementById("tickerBar"),tickerTrack:document.getElementById("tickerTrack"),financeSpotlight:document.getElementById("financeSpotlight"),searchResults:document.getElementById("searchResults"),searchResultsList:document.getElementById("searchResultsList"),searchResultsMeta:document.getElementById("searchResultsMeta"),searchResultsClose:document.getElementById("searchResultsClose"),aboutSources:document.getElementById("aboutSources"),attributionOverlay:document.getElementById("attributionOverlay"),attributionTitle:document.getElementById("attributionTitle"),attributionMeta:document.getElementById("attributionMeta"),attributionBody:document.getElementById("attributionBody"),attributionClose:document.getElementById("attributionClose"),categoryFilters:document.getElementById("categoryFilters"),savedSearches:document.getElementById("savedSearches"),chatLog:document.getElementById("chatLog"),chatInput:document.getElementById("chatInput"),chatSend:document.getElementById("chatSend"),financeMarketsList:document.getElementById("financeMarketsList"),financePolicyList:document.getElementById("financePolicyList"),financeTabs:document.getElementById("financeTabs"),stateGovTabs:document.getElementById("stateGovTabs"),moneyFlowsQuery:document.getElementById("moneyFlowsQuery"),moneyFlowsRange:document.getElementById("moneyFlowsRange"),moneyFlowsRun:document.getElementById("moneyFlowsRun"),moneyFlowsSummary:document.getElementById("moneyFlowsSummary"),moneyFlowsList:document.getElementById("moneyFlowsList"),moneyFlowsMeta:document.getElementById("moneyFlowsMeta"),moneyFlowsRateNotice:document.getElementById("moneyFlowsRateNotice"),moneyInMeta:document.getElementById("moneyInMeta"),moneyInBody:document.getElementById("moneyInBody"),moneyOutMeta:document.getElementById("moneyOutMeta"),moneyOutBody:document.getElementById("moneyOutBody"),moneyLobbyMeta:document.getElementById("moneyLobbyMeta"),moneyLobbyBody:document.getElementById("moneyLobbyBody"),moneyRegistryMeta:document.getElementById("moneyRegistryMeta"),moneyRegistryBody:document.getElementById("moneyRegistryBody"),customFeedToggle:document.getElementById("customFeedToggle"),customFeedExport:document.getElementById("customFeedExport"),customFeedImportToggle:document.getElementById("customFeedImportToggle"),customFeedDownload:document.getElementById("customFeedDownload"),customFeedOpen:document.getElementById("customFeedOpen"),customFeedJsonPanel:document.getElementById("customFeedJsonPanel"),customFeedJson:document.getElementById("customFeedJson"),customFeedJsonCopy:document.getElementById("customFeedJsonCopy"),customFeedJsonApply:document.getElementById("customFeedJsonApply"),customFeedJsonStatus:document.getElementById("customFeedJsonStatus"),customFeedList:document.getElementById("customFeedList"),customFeedForm:document.getElementById("customFeedForm"),customFeedName:document.getElementById("customFeedName"),customFeedUrl:document.getElementById("customFeedUrl"),customFeedCategory:document.getElementById("customFeedCategory"),customFeedFormat:document.getElementById("customFeedFormat"),customFeedProxy:document.getElementById("customFeedProxy"),customFeedTags:document.getElementById("customFeedTags"),customFeedSupportsQuery:document.getElementById("customFeedSupportsQuery"),customFeedDefaultQuery:document.getElementById("customFeedDefaultQuery"),customFeedRequiresKey:document.getElementById("customFeedRequiresKey"),customFeedKeyParam:document.getElementById("customFeedKeyParam"),customFeedKeyHeader:document.getElementById("customFeedKeyHeader"),customFeedTtl:document.getElementById("customFeedTtl"),customFeedSave:document.getElementById("customFeedSave"),customFeedCancel:document.getElementById("customFeedCancel"),customFeedStatus:document.getElementById("customFeedStatus")},To=[{id:"briefing",cols:12},{id:"map",cols:12},{id:"ticker",cols:12},{id:"finance-spotlight",cols:12},{id:"imagery",cols:12},{id:"command",cols:12},{id:"news",cols:6},{id:"finance",cols:4},{id:"money-flows",cols:12},{id:"crypto",cols:4},{id:"prediction",cols:4},{id:"mcp-trends",cols:12},{id:"hazards",cols:4},{id:"security",cols:4},{id:"local",cols:6},{id:"community",cols:6},{id:"policy",cols:4},{id:"state-gov",cols:4},{id:"congress",cols:4},{id:"cyber",cols:4},{id:"agriculture",cols:4},{id:"research",cols:4},{id:"space",cols:4},{id:"energy-map",cols:6},{id:"energy",cols:6},{id:"health",cols:4},{id:"transport",cols:6}],Eo=Object.fromEntries(To.map(e=>[e.id,{cols:e.cols}])),Lt=null,ko=["the","a","an","and","or","to","in","of","for","on","with","at","from","by","as","is","are","was","were","be","has","have"],Io=new Set(ko),xo=["b","strong","i","em","u","br","p","span","a","font"],No=new Set(xo),Mo=[{id:"openai",url:"https://platform.openai.com/api-keys"}],rs=Object.fromEntries(Mo.map(e=>[e.id,e.url])),Fo=[{id:"api.data.gov",label:"Data.gov (FOIA + GovInfo)"},{id:"eia",label:"EIA (Energy)"},{id:"openstates",label:"OpenStates (State Legislation)"}],os=Object.fromEntries(Fo.map(e=>[e.id,e.label])),Do=[{id:"hazards",filters:["weather","disaster","space"]},{id:"finance",filters:["finance","gov","cyber","agriculture"]},{id:"map",filters:["weather","disaster","space","news","travel","transport","local"]},{id:"geo",filters:["weather","disaster","space","news","travel","transport","local"]},{id:"local",filters:["news","gov","disaster","weather"]},{id:"assistant",filters:["assistant"]}],Po=Object.fromEntries(Do.map(e=>[e.id,e.filters])),Os=[{id:"news",label:"News"},{id:"finance",label:"Finance"},{id:"gov",label:"Government"},{id:"crypto",label:"Crypto / Web3"},{id:"prediction",label:"Prediction Markets"},{id:"spill",label:"Oil Spills"},{id:"disaster",label:"Disasters"},{id:"weather",label:"Weather"},{id:"space",label:"Space"},{id:"cyber",label:"Cyber"},{id:"agriculture",label:"Agriculture"},{id:"research",label:"Research"},{id:"energy",label:"Energy"},{id:"health",label:"Health"},{id:"travel",label:"Travel"},{id:"transport",label:"Transport"},{id:"security",label:"Conflict & Security"},{id:"infrastructure",label:"Infrastructure"},{id:"local",label:"Local"}],ot=Object.fromEntries(Os.map(e=>[e.id,e.label])),zn=Os.map(e=>e.id),$o=new Set(["crypto","research","space","travel","health","security"]),Bo=8,_s=[{id:"newsList",title:"News Layer",withCoverage:!0,defaultLimit:30,getItems:()=>nn(r.clusters)},{id:"securityList",title:"Conflict & Security",defaultLimit:20,getItems:()=>Te("security").items},{id:"financeMarketsList",title:"Finance: Markets",defaultLimit:20,getItems:()=>lt(["finance","energy"])},{id:"financePolicyList",title:"Finance: Regulatory",defaultLimit:20,getItems:()=>lt(["gov","cyber","agriculture"])},{id:"moneyFlowsList",title:"Money Flows",defaultLimit:20,getItems:()=>r.moneyFlowsItems||[]},{id:"cryptoList",title:"Crypto / Web3",defaultLimit:20,getItems:()=>Te("crypto").items},{id:"predictionList",title:"Prediction Markets",defaultLimit:20,getItems:()=>ln()},{id:"disasterList",title:"Hazards & Weather",defaultLimit:20,getItems:()=>lt(["disaster","weather","space"])},{id:"localList",title:"Local Lens",defaultLimit:20,getItems:()=>an()},{id:"policyList",title:"Policy & Government",defaultLimit:20,getItems:()=>xt()},{id:"stateGovAllList",title:"State Government: All",defaultLimit:20,getItems:()=>Ie()},{id:"stateGovLegislationList",title:"State Government: Legislation",defaultLimit:20,getItems:()=>Ie("legislation")},{id:"stateGovRulemakingList",title:"State Government: Rulemaking",defaultLimit:20,getItems:()=>Ie("rulemaking")},{id:"stateGovExecutiveOrdersList",title:"State Government: Executive Orders",defaultLimit:20,getItems:()=>Ie("executive_order")},{id:"congressList",title:"Congressional Insights",defaultLimit:30,getItems:()=>pt()},{id:"cyberList",title:"Cyber Pulse",defaultLimit:20,getItems:()=>Te("cyber").items},{id:"agricultureList",title:"Agriculture",defaultLimit:20,getItems:()=>Te("agriculture").items},{id:"researchList",title:"Research Watch",defaultLimit:20,getItems:()=>Te("research").items},{id:"spaceList",title:"Space Weather",defaultLimit:20,getItems:()=>Te("space").items},{id:"energyList",title:"Energy",defaultLimit:20,getItems:()=>sn()},{id:"healthList",title:"Health",defaultLimit:20,getItems:()=>Te("health").items},{id:"transportList",title:"Transport & Logistics",defaultLimit:20,getItems:()=>Te("transport").items}],Ro=Object.fromEntries(_s.filter(e=>typeof e.defaultLimit=="number").map(e=>[e.id,e.defaultLimit])),Oo=_s.map(({defaultLimit:e,...t})=>t),Ku=Object.fromEntries(Oo.map(e=>[e.id,e])),_o=new Set(["ticker","crypto","energy-map"]),Uo="geo",Ho=ja({elements:l,state:r,focusPanelExclude:_o,focusGeoTarget:Uo}),Kn=za(Ua()),qt=null,At=null,Wn=null,Us=[{id:"openstreetmap",name:"OpenStreetMap",short:"Basemap + geocoding",url:"https://www.openstreetmap.org/copyright",attribution:"\xA9 OpenStreetMap contributors. Open Data Commons Open Database License (ODbL).",termsUrl:"https://osmfoundation.org/wiki/Licence/Attribution_Guidelines",notes:"OpenStreetMap data used for basemaps and geocoding."},{id:"esri",name:"Esri Basemaps",short:"Imagery tiles",url:"https://www.esri.com/en-us/arcgis/products/arcgis-online",attribution:"Sources: Esri, DigitalGlobe, GeoEye, i-cubed, USDA FSA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community.",termsUrl:"https://support.esri.com/en-us/knowledge-base/what-is-the-correct-way-to-cite-an-arcgis-online-basema-000012040",notes:"Satellite basemaps and ArcGIS Online services."},{id:"arcgis-online",name:"ArcGIS Online (Esri)",short:"ArcGIS datasets",url:"https://www.arcgis.com",attribution:"\xA9 Esri. Data provided via ArcGIS Online services.",termsUrl:"https://www.esri.com/en-us/legal/terms/full-master-agreement",notes:"ArcGIS-hosted feature layers referenced by the map overlays."},{id:"s2-underground",name:"S2 Underground",short:"Kinetic events",url:"https://nexus-s2underground.hub.arcgis.com/",attribution:"Source: S2 Underground (Common Intelligence Picture). Please credit S2 Underground.",termsUrl:"https://nexus-s2underground.hub.arcgis.com/",notes:"Kinetic Activity Tracker layers sourced from the S2 Underground public ArcGIS Hub."},{id:"nasa-gibs",name:"NASA EOSDIS GIBS",short:"Global imagery",url:"https://earthdata.nasa.gov/eosdis/science-system-description/eosdis-components/gibs",attribution:"We acknowledge the use of imagery provided by services from NASA's Global Imagery Browse Services (GIBS), part of NASA's Earth Science Data and Information System (ESDIS).",termsUrl:"https://earthdata.nasa.gov/eosdis/science-system-description/eosdis-components/gibs",notes:"Global imagery layers (VIIRS/MODIS/Day-Night)."},{id:"nasa-firms",name:"NASA FIRMS",short:"Fire data",url:"https://firms.modaps.eosdis.nasa.gov",attribution:"We acknowledge the use of data and/or imagery from NASA's Land, Atmosphere Near real-time Capability for Earth observations (LANCE) (https://earthdata.nasa.gov/lance), part of NASA's Earth Science Data and Information System (ESDIS).",termsUrl:"https://www.earthdata.nasa.gov/data/projects/lance#ed-firms-citation",notes:"Global fire detections."},{id:"nasa-eonet",name:"NASA EONET",short:"Natural events",url:"https://eonet.gsfc.nasa.gov",attribution:"NASA EONET (Earth Observatory Natural Event Tracker). Source: NASA/GSFC.",termsUrl:"https://eonet.gsfc.nasa.gov/docs/v3",notes:"Natural events and hazards."},{id:"noaa-nws",name:"NOAA/NWS",short:"Alerts + warnings",url:"https://www.weather.gov/documentation/services-web-api",attribution:"Source: National Weather Service (NOAA). Data are public domain; credit NOAA/NWS.",termsUrl:"https://www.weather.gov/documentation/services-web-api",notes:"US weather alerts and short-term warnings."},{id:"noaa-nhc",name:"NOAA NHC",short:"Hurricane outlooks",url:"https://www.nhc.noaa.gov",attribution:"Source: NOAA National Hurricane Center. Data are public domain; credit NOAA/NHC.",termsUrl:"https://www.nhc.noaa.gov",notes:"Atlantic basin outlooks and advisories."},{id:"noaa-swpc",name:"NOAA SWPC",short:"Space weather",url:"https://www.swpc.noaa.gov",attribution:"Source: NOAA Space Weather Prediction Center. Data are public domain; credit NOAA/SWPC.",termsUrl:"https://www.swpc.noaa.gov",notes:"Kp index and solar wind conditions."},{id:"noaa-hms",name:"NOAA HMS",short:"Fire detections",url:"https://hms.smfc.nasa.gov",attribution:"Source: NOAA/NESDIS Hazard Mapping System (HMS).",termsUrl:"https://hms.smfc.nasa.gov",notes:"Satellite fire detection overlays."},{id:"noaa-incidentnews",name:"NOAA IncidentNews",short:"Spill reports",url:"https://incidentnews.noaa.gov",attribution:"Source: NOAA Office of Response and Restoration IncidentNews.",termsUrl:"https://incidentnews.noaa.gov",notes:"Oil spill and incident reports."},{id:"usgs-earthquakes",name:"USGS Earthquakes",short:"Seismic events",url:"https://earthquake.usgs.gov",attribution:"USGS Earthquake Hazards Program. Data courtesy of the U.S. Geological Survey.",termsUrl:"https://www.usgs.gov/information-policies-and-instructions/acknowledging-or-crediting-usgs",notes:"Recent seismic activity feeds."},{id:"cdc-travel",name:"CDC Travel Notices",short:"Travel alerts",url:"https://www.cdc.gov/travel",attribution:"Source: Centers for Disease Control and Prevention (CDC). Data are public domain; credit CDC.",termsUrl:"https://www.cdc.gov/other/policies.html",notes:"Travel health notices."},{id:"state-travel",name:"U.S. State Department Travel Advisories",short:"Travel advisories",url:"https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html",attribution:"Source: U.S. Department of State Travel Advisories.",termsUrl:"https://travel.state.gov/content/travel/en/legal.html",notes:"Travel advisory RSS feed."},{id:"eia",name:"U.S. EIA",short:"Energy data",url:"https://www.eia.gov",attribution:"Source: U.S. Energy Information Administration (EIA). Data are public domain; credit EIA.",termsUrl:"https://www.eia.gov/about/copyrights_reuse.php",notes:"Energy market data and Today in Energy."},{id:"bls",name:"U.S. BLS",short:"Economic data",url:"https://www.bls.gov",attribution:"Source: U.S. Bureau of Labor Statistics (BLS). Data are public domain; credit BLS.",termsUrl:"https://www.bls.gov/bls/linksite.htm",notes:"CPI and macroeconomic releases."},{id:"treasury",name:"U.S. Treasury Fiscal Data",short:"Debt & fiscal",url:"https://fiscaldata.treasury.gov",attribution:"Source: U.S. Department of the Treasury, Fiscal Service. Data are public domain; credit Treasury Fiscal Service.",termsUrl:"https://fiscaldata.treasury.gov/developer/api-documentation/",notes:"Debt to the Penny and fiscal releases."},{id:"usaspending",name:"USAspending.gov",short:"Federal spending",url:"https://www.usaspending.gov",attribution:"Source: USAspending.gov (U.S. Department of the Treasury).",termsUrl:"https://www.usaspending.gov/about",notes:"Award and transaction data from USAspending.gov."},{id:"lda",name:"U.S. Senate LDA",short:"Lobbying disclosure",url:"https://lda.senate.gov",attribution:"Source: U.S. Senate Office of Public Records (Lobbying Disclosure Act).",termsUrl:"https://lda.senate.gov/about/",notes:"LDA filings and contribution reports."},{id:"fec",name:"FEC (OpenFEC)",short:"Campaign contributions",url:"https://api.open.fec.gov",attribution:"Source: Federal Election Commission (OpenFEC API).",termsUrl:"https://api.open.fec.gov/developers/#/about/terms",notes:"Campaign finance data from the FEC."},{id:"sam",name:"SAM.gov",short:"Entity registrations",url:"https://sam.gov",attribution:"Source: SAM.gov (U.S. General Services Administration).",termsUrl:"https://sam.gov/content/home",notes:"Entity registration data from SAM.gov."},{id:"cisa-kev",name:"CISA KEV",short:"Cyber advisories",url:"https://www.cisa.gov/known-exploited-vulnerabilities-catalog",attribution:"Source: Cybersecurity and Infrastructure Security Agency (CISA). Data are public domain; credit CISA.",termsUrl:"https://www.cisa.gov/known-exploited-vulnerabilities-catalog",notes:"Known Exploited Vulnerabilities catalog."},{id:"openaq",name:"OpenAQ",short:"Air quality",url:"https://openaq.org",attribution:"Source: OpenAQ air quality data. Please credit OpenAQ.",termsUrl:"https://openaq.org/terms/",notes:"Air quality alerts and station readings."},{id:"opensky",name:"OpenSky Network",short:"Flight data",url:"https://opensky-network.org",attribution:"The OpenSky Network (https://opensky-network.org). Cite: \u201CBringing up OpenSky: A large-scale ADS-B sensor network for research\u201D (Sch\xE4fer et al., ACM/IEEE IPSN 2014).",termsUrl:"https://opensky-network.org/about/terms-of-use",notes:"Live aviation data and aircraft tracking."},{id:"coinpaprika",name:"CoinPaprika",short:"Crypto markets",url:"https://coinpaprika.com",attribution:"Source: CoinPaprika API data. Please credit CoinPaprika.",termsUrl:"https://coinpaprika.com/terms-of-use/",notes:"Crypto prices and market caps."},{id:"polymarket",name:"Polymarket (Gamma)",short:"Prediction markets",url:"https://polymarket.com",attribution:"Source: Polymarket market data via Gamma API. Please credit Polymarket/Gamma.",termsUrl:"https://docs.polymarket.com",notes:"Prediction market prices and volumes."},{id:"gdelt",name:"GDELT Project",short:"Global news",url:"https://www.gdeltproject.org",attribution:"The GDELT Project (https://www.gdeltproject.org). Any use or redistribution must cite the GDELT Project and link to the website.",termsUrl:"https://www.gdeltproject.org/about.html#termsofuse",notes:"Global news and conflict signals."},{id:"acled",name:"ACLED",short:"Conflict events",url:"https://acleddata.com",attribution:"ACLED (Armed Conflict Location & Event Data). Cite ACLED as the source and include a link to https://acleddata.com.",termsUrl:"https://acleddata.com/attributionpolicy",notes:"Conflict and security event data."},{id:"ucdp",name:"UCDP",short:"Conflict data",url:"https://ucdp.uu.se",attribution:"Uppsala Conflict Data Program (UCDP) Candidate Events Dataset. Please cite the UCDP Georeferenced Event Dataset (GED); datasets are licensed CC BY 4.0.",termsUrl:"https://ucdp.uu.se/downloads/",notes:"Candidate conflict events."},{id:"gpsjam",name:"GPSJAM",short:"GPS jamming",url:"https://gpsjam.org",attribution:"Source: GPSJAM.org. Please credit GPSJAM.org.",termsUrl:"https://gpsjam.org",notes:"GPS jamming risk overlays."},{id:"warspotting",name:"Warspotting",short:"Loss tracking",url:"https://warspotting.net",attribution:"Source: Warspotting.net. Please credit Warspotting.",termsUrl:"https://warspotting.net",notes:"Conflict equipment loss tracking."},{id:"gdacs",name:"GDACS",short:"Disaster alerts",url:"https://www.gdacs.org",attribution:"GDACS (Global Disaster Alert and Coordination System), a cooperation framework between the United Nations and the European Commission.",termsUrl:"https://www.gdacs.org/About",notes:"Global disaster alerts and coordination."},{id:"govinfo",name:"GovInfo",short:"Gov publications",url:"https://www.govinfo.gov",attribution:"Source: U.S. Government Publishing Office (govinfo.gov). Data are public domain; credit GPO.",termsUrl:"https://www.govinfo.gov/help",notes:"Federal publications and documents."},{id:"foia",name:"FOIA.gov",short:"FOIA logs",url:"https://www.foia.gov",attribution:"Source: FOIA.gov (U.S. Department of Justice). Data are public domain; credit DOJ/FOIA.gov.",termsUrl:"https://www.foia.gov/about.html",notes:"FOIA request data."},{id:"federal-register",name:"Federal Register",short:"Regulatory updates",url:"https://www.federalregister.gov",attribution:"Source: Federal Register (Office of the Federal Register, NARA). Public domain; credit Federal Register/NARA.",termsUrl:"https://www.federalregister.gov/reader-aids/using-federalregister-gov",notes:"Regulations, rules, and notices."},{id:"regulations-gov",name:"Regulations.gov",short:"Public comments",url:"https://www.regulations.gov",attribution:"Source: Regulations.gov (U.S. eRulemaking Program). Public comments and docket metadata; credit Regulations.gov.",termsUrl:"https://www.regulations.gov/about",notes:"Public comments and docket activity for proposed rules."},{id:"congress-gov",name:"Congress.gov",short:"Legislative data",url:"https://www.congress.gov",attribution:"Source: Congress.gov (Library of Congress). Data are public domain; credit Congress.gov.",termsUrl:"https://www.congress.gov/help/legislative-resources",notes:"Bills, nominations, hearings, treaties, and record."},{id:"openstates",name:"OpenStates",short:"State legislation",url:"https://openstates.org",attribution:"Source: OpenStates by Plural. Credit OpenStates/Plural for legislative data.",termsUrl:"https://docs.openstates.org/api-v3/",notes:"Multi-state legislative data (bills, actions, committees)."},{id:"state-open-data",name:"State Open Data Portals",short:"State rulemaking + EO",url:"https://s3-us-gov-west-1.amazonaws.com/cg-0817d6e3-93c4-4de8-8b32-da6919464e61/open_data_us.csv",attribution:"Source: official state government websites and state open data portals. Credit each state source when displayed.",termsUrl:"https://data.gov/open-gov/",notes:"State-level rulemaking and executive-order connectors are sourced from official state portals."},{id:"follow-the-money",name:"FollowTheMoney",short:"State-level reference",url:"https://www.followthemoney.org",attribution:"Reference source for state-level public-data API landscape and money-in-politics context.",termsUrl:"https://www.followthemoney.org/research/institute-reports/apis-for-state-level-data",notes:"Used as a source reference for state-level data coverage planning."},{id:"fda",name:"FDA MedWatch",short:"Health alerts",url:"https://www.fda.gov/safety/medwatch-fda-safety-information-and-adverse-event-reporting-program",attribution:"Source: U.S. Food and Drug Administration (FDA). Data are public domain; credit FDA.",termsUrl:"https://www.fda.gov/about-fda/website-policies",notes:"MedWatch safety alerts and recalls."},{id:"usda-nass",name:"USDA NASS",short:"Ag reports",url:"https://www.nass.usda.gov",attribution:"USDA-NASS data are in the public domain; USDA-NASS requests appropriate acknowledgment.",termsUrl:"https://www.nass.usda.gov/Data_and_Statistics/Citation_Request/index.php",notes:"Agricultural reports and price summaries."},{id:"stooq",name:"Stooq",short:"Market data",url:"https://stooq.com",attribution:"Stooq market data.",termsUrl:"https://stooq.com/terms.html",notes:"Equities and index snapshots."},{id:"google-news",name:"Google News",short:"News headlines",url:"https://news.google.com",attribution:"Google News. \xA9 Google.",termsUrl:"https://policies.google.com/terms",notes:"News aggregation results."},{id:"bbc",name:"BBC News",short:"RSS source",url:"https://www.bbc.com/news",attribution:"\xA9 BBC News.",termsUrl:"https://www.bbc.co.uk/usingthebbc/terms/",notes:"Headlines via RSS."},{id:"guardian",name:"The Guardian",short:"RSS source",url:"https://www.theguardian.com/world",attribution:"\xA9 The Guardian.",termsUrl:"https://www.theguardian.com/help/terms-of-service",notes:"Headlines via RSS."},{id:"pbs",name:"PBS NewsHour",short:"RSS source",url:"https://www.pbs.org/newshour",attribution:"\xA9 PBS NewsHour.",termsUrl:"https://www.pbs.org/about/policies/",notes:"Headlines via RSS."},{id:"dw",name:"Deutsche Welle (DW)",short:"RSS source",url:"https://www.dw.com",attribution:"\xA9 Deutsche Welle (DW).",termsUrl:"https://www.dw.com/en/legal-information/a-18265275",notes:"Headlines via RSS."},{id:"arxiv",name:"arXiv",short:"Research preprints",url:"https://arxiv.org",attribution:"arXiv.org e-print archive.",termsUrl:"https://arxiv.org/help/license",notes:"Research preprints and metadata."},{id:"blockstream",name:"mempool.space",short:"Bitcoin mempool",url:"https://mempool.space",attribution:"Source: mempool.space (Blockstream). Please credit mempool.space.",termsUrl:"https://mempool.space/docs/api",notes:"Bitcoin mempool and fee data."}],te={"gibs-viirs":{id:"VIIRS_SNPP_CorrectedReflectance_TrueColor",label:"NASA VIIRS True Color",format:"jpg",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9"},"gibs-modis-terra":{id:"MODIS_Terra_CorrectedReflectance_TrueColor",label:"MODIS Terra True Color",format:"jpg",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9"},"gibs-modis-aqua":{id:"MODIS_Aqua_CorrectedReflectance_TrueColor",label:"MODIS Aqua True Color",format:"jpg",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9"},"gibs-nightlights":{id:"VIIRS_Black_Marble",label:"VIIRS Black Marble",format:"png",maxZoom:8,matrixSet:"GoogleMapsCompatible_Level8",defaultDate:"2016-01-01"},"gibs-daynight":{id:"VIIRS_SNPP_DayNightBand_At_Sensor_Radiance",label:"VIIRS Day/Night Band",format:"png",maxZoom:8,matrixSet:"GoogleMapsCompatible_Level8"}},ie={aerosol:{id:"OMPS_Aerosol_Index",label:"Aerosol Index",format:"png",maxZoom:6,matrixSet:"GoogleMapsCompatible_Level6",opacity:.45},thermal:{id:"VIIRS_NOAA20_Brightness_Temp_BandI5_Night",label:"Thermal Brightness (VIIRS)",format:"png",maxZoom:9,matrixSet:"GoogleMapsCompatible_Level9",opacity:.45},"fire-east":{id:"GOES-East_ABI_FireTemp",label:"GOES East Fire Temp",format:"png",maxZoom:7,matrixSet:"GoogleMapsCompatible_Level7",opacity:.45},"fire-west":{id:"GOES-West_ABI_FireTemp",label:"GOES West Fire Temp",format:"png",maxZoom:7,matrixSet:"GoogleMapsCompatible_Level7",opacity:.45}},jo="https://raw.githubusercontent.com/hobuinc/usgs-lidar/master/boundaries/boundaries.topojson",is="lidarCoverageCache",Go="https://raw.githubusercontent.com/visgl/loaders.gl/master/modules/las/test/data/indoor.laz",qo=45e3,Hs="lidarPointTelemetry",zo=[{min:8,label:"Great"},{min:7,label:"Major"},{min:6,label:"Strong"},{min:5,label:"Moderate"},{min:4,label:"Light"},{min:3,label:"Minor"},{min:0,label:"Micro"}],Vn=["google-news-us","bbc-world","guardian-world","pbs-headlines","usgs-quakes-hour","nws-alerts","eonet-events","cdc-travel-notices","coinpaprika-global","coinpaprika-tickers","treasury-debt","bls-cpi","energy-eia","energy-eia-brent","energy-eia-ng","eia-today"],Ko=new Set(["llc","inc","corp","news","update","report","alert","press","group"]);function Wo(e){return e.filter(t=>!t?.feed?.id||!Vn.includes(t.feed.id)||t.error==="requires_key"||t.error==="requires_config"||t.error==="missing_server_key"?!1:t.error||t.stale||t.httpStatus&&t.httpStatus>=400).length}function Vo(e,t){if(!t?.fetchedAt)return!1;let n=Number(e?.ttlMinutes)||r.settings.refreshMinutes,a=Math.max(5,Math.min(15,Math.round(n*.2))),s=(n+a)*60*1e3;return Date.now()-t.fetchedAt>s}var Jo=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),ls="situationRoomCountryIndex",Zo="https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";function js(e,t){if(e){if(typeof e[0]=="number"&&typeof e[1]=="number"){t(e);return}e.forEach(n=>js(n,t))}}function Qo(e){let t={minLat:90,maxLat:-90,minLon:180,maxLon:-180};return js(e?.coordinates||[],n=>{let[a,s]=n;Number.isNaN(s)||Number.isNaN(a)||(t.minLat=Math.min(t.minLat,s),t.maxLat=Math.max(t.maxLat,s),t.minLon=Math.min(t.minLon,a),t.maxLon=Math.max(t.maxLon,a))}),t.minLat===90||t.maxLat===-90?null:t}function Pn(e){let t={};return e.forEach(n=>{n.code&&(t[n.code.toUpperCase()]=n)}),t}async function Yo(){if(r.countries.length)return r.countries;try{let e=localStorage.getItem(ls);if(e){let t=JSON.parse(e);if(Array.isArray(t?.list)&&t.list.length)return r.countries=t.list,r.countryIndex=Pn(t.list),r.countries}}catch{}try{let e=await fetch(Zo,{cache:"force-cache"});if(!e.ok)throw new Error("Country source fetch failed");let n=((await e.json()).features||[]).map(a=>{let s=a.properties||{},o=s["ISO3166-1-Alpha-2"],i=s.name;if(!o||!i)return null;let u=Qo(a.geometry);return u?{code:o.toUpperCase(),name:i,bbox:u}:null}).filter(Boolean);n.sort((a,s)=>a.name.localeCompare(s.name)),r.countries=n,r.countryIndex=Pn(n);try{localStorage.setItem(ls,JSON.stringify({list:n}))}catch{}return n}catch{let t=[{code:"US",name:"United States",bbox:{minLat:24,maxLat:49,minLon:-125,maxLon:-66}}];return r.countries=t,r.countryIndex=Pn(t),t}}function ft(){let e=(r.settings.country||"US").toUpperCase(),t={code:"US",name:"United States",bbox:{minLat:24,maxLat:49,minLon:-125,maxLon:-66}};return r.countryIndex?.[e]||(e==="US"?t:null)}function Xe(e){return(e||"").toString().toLowerCase()}function Ft(){return Oe(r.settings.stateSignalFilter)}function Xo(){return Za(Ft())}function Gs(e,{includeFederal:t=!0}={}){return Ut(e,Ft(),{includeFederal:t})}function ei(){Qa(l.stateSignalFilter,Ft())}function ti(e,t){if(!Array.isArray(e))return[];if(!Number.isFinite(t)||t<=0)return[];if(e.length<=t)return e;let n=Math.max(1,Math.floor(e.length/t)),a=[];for(let s=0;s<e.length&&(a.push(e[s]),!(a.length>=t));s+=n);return a}function qs(e,t){if(!t)return!1;let n=t.code.toUpperCase();if(n==="US")return e.tags?.includes("us")?!0:e.geo?Yt(e.geo.lat,e.geo.lon,t):!1;let a=Xe(e.regionTag),s=Xe(e.location||e.geoLabel||""),o=Xe(e.title||""),i=Xe(e.summary||""),u=Xe(t.name),d=n.toLowerCase();return!!(e.tags?.some(m=>Xe(m)===d)||a&&(a===d||a.includes(u))||s&&s.includes(u)||o.includes(u)||i.includes(u)||e.geo&&Yt(e.geo.lat,e.geo.lon,t))}function Yt(e,t,n){if(!n?.bbox)return!1;let{minLat:a,maxLat:s,minLon:o,maxLon:i}=n.bbox;return e>=a&&e<=s&&t>=o&&t<=i}function ni(e,t){return!Number.isFinite(e)||!Number.isFinite(t)?null:(r.countries||[]).find(a=>Yt(e,t,a))||null}function ai(){if(!r.settings.countryAuto)return;let e=ni(r.location.lat,r.location.lon);e&&(e.code!==r.settings.country&&(r.settings.country=e.code,V()),Tt())}async function si(){if(!l.countrySelect)return;let e=await Yo();l.countrySelect.innerHTML="",e.forEach(t=>{let n=document.createElement("option");n.value=t.code,n.textContent=t.name,l.countrySelect.appendChild(n)}),Tt(),l.countrySelect.addEventListener("change",()=>{let t=l.countrySelect.value||"US";r.settings.scope="us",r.settings.country=t.toUpperCase(),r.settings.countryAuto=!1,V(),da(),Tt(),r.scopedItems=Ge(r.items),r.clusters=at(r.scopedItems.filter(n=>n.category==="news")),st(),je(),br(),Mt(),fe()})}function Tt(){let e=(r.settings.country||"US").toUpperCase(),t=ft();l.countrySelect&&l.countrySelect.value!==e&&(l.countrySelect.value=e),l.countrySelect&&(l.countrySelect.disabled=!1);let n=l.scopeToggle?.querySelector('[data-scope="us"]');n&&(n.textContent=e,n.title=t?.name||"Country"),l.countrySelectLabel&&(l.countrySelectLabel.textContent=t?.name||"Country")}function ri(){let e=In(),t=r.feeds.find(n=>n.id==="transport-opensky");if(t){if(e){let n=e.endsWith("/")?e.slice(0,-1):e;t.url=`${n}/states?extended=1`,t.proxy=null,t.requiresKey=!1,t.keySource=null,t.keyGroup=null,t.keyParam=null,t.keyHeader=null}else if(t.url&&!t.url.includes("extended=1")){let n=new URL(t.url);n.searchParams.set("extended","1"),t.url=n.toString()}}}function oi(){let e=xn(),t=r.feeds.filter(n=>n.id==="acled-events"||n.acledMode);t.length&&t.forEach(n=>{if(!e)return;let a=e.endsWith("/")?e.slice(0,-1):e,s=n.acledMode==="aggregated"?"aggregated":"events";n.url=`${a}/${s}`,n.proxy=null,n.requiresKey=!1,n.keySource=null,n.keyParam=null,n.keyHeader=null,n.requiresConfig=!1})}function ii(){let e=localStorage.getItem("situationRoomSettings");if(e)try{let t=JSON.parse(e);r.settings=ss(t);try{let n=localStorage.getItem(Hs);n&&(r.lidarPointTelemetry=JSON.parse(n))}catch(n){console.warn("LiDAR telemetry read failed",n)}}catch{r.settings=ss()}}function V(){localStorage.setItem("situationRoomSettings",JSON.stringify(r.settings))}function li(){let e=localStorage.getItem("situationRoomKeys");if(e)try{r.keys=JSON.parse(e),r.keys?.openai?.key&&(r.keys.openai.key=r.keys.openai.key.trim())}catch{r.keys={}}}function $n(){localStorage.setItem("situationRoomKeys",JSON.stringify(r.keys))}function ci(){let e=localStorage.getItem("situationRoomKeyGroups");if(e)try{r.keyGroups=JSON.parse(e)}catch{r.keyGroups={}}}function ui(){localStorage.setItem("situationRoomKeyGroups",JSON.stringify(r.keyGroups))}function di(){let e=localStorage.getItem("situationRoomKeyStatus");if(e)try{r.keyStatus=JSON.parse(e)}catch{r.keyStatus={}}}function Jn(){localStorage.setItem("situationRoomKeyStatus",JSON.stringify(r.keyStatus))}function mi(){let e=localStorage.getItem("situationRoomGeoCache");if(e)try{r.geoCache=JSON.parse(e)}catch{r.geoCache={}}}function Bn(){localStorage.setItem("situationRoomGeoCache",JSON.stringify(r.geoCache))}function pi(){let e=localStorage.getItem(Bs);if(!e)return[];try{let t=JSON.parse(e);return Array.isArray(t)?t.map(n=>({...n,tags:Array.isArray(n.tags)?n.tags:[],supportsQuery:!!n.supportsQuery,requiresKey:!!n.requiresKey,format:n.format||"rss",category:n.category||"news",ttlMinutes:Number(n.ttlMinutes||60),isCustom:!0,keySource:"client"})):[]}catch{return[]}}function fn(){localStorage.setItem(Bs,JSON.stringify(r.customFeeds))}function ca(e){let t=0,n=String(e||"");for(let a=0;a<n.length;a+=1)t=(t<<5)-t+n.charCodeAt(a),t|=0;return Math.abs(t).toString(36)}function yn(e,t){let n=[...e],a=new Set(e.map(o=>o.id)),s=!1;return t.forEach(o=>{let i=o.id;if(i||(i=`custom-${ca(o.url||o.name)}`,o.id=i,s=!0),a.has(i)){let u=`${i}-${Math.random().toString(36).slice(2,6)}`;o.id=u,i=u,s=!0}o.isCustom=!0,o.keySource="client",a.add(i),n.push(o)}),s&&fn(),n}async function cs(){if(!ne())return null;try{let e=Be(`/data/analysis.json?ts=${Date.now()}`),t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error("analysis_fetch_failed");let n=await t.json();return!n||!n.text?(r.staticAnalysis=null,null):(r.staticAnalysis=n,n)}catch{return r.staticAnalysis=null,null}}async function gi(){if(!ne())return null;try{let e=Be(`/data/build.json?ts=${Date.now()}`),t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error("build_fetch_failed");let n=await t.json();return n?.generatedAt&&(r.lastBuildAt=Date.parse(n.generatedAt)),n}catch{return null}}function fi(){if(!l.dataFresh)return;let e=r.lastFetch;if(ne()&&(e=r.settings.superMonitor?r.lastFetch:r.lastBuildAt||r.lastFetch),!e){l.dataFresh.textContent="Data fresh",l.dataFresh.removeAttribute("title");return}let t=ve(e);l.dataFresh.textContent=ne()?r.settings.superMonitor?`Live ${t}`:`Cache ${t}`:`Data ${t}`;let n=new Date(e).toLocaleString();l.dataFresh.title=ne()?r.settings.superMonitor?`Live fetch ${n}`:`Cache built ${n}`:`Last fetch ${n}`}function yi(){let e=localStorage.getItem("situationRoomPanels");if(e){let t=JSON.parse(e);t.version===$s?(r.panels.order=Array.isArray(t.order)?t.order:[],r.panels.visibility=t.visibility&&typeof t.visibility=="object"?t.visibility:{},r.panels.sizes=t.sizes&&typeof t.sizes=="object"?t.sizes:{},r.panels.order=r.panels.order.filter(n=>n!=="signals"),r.panels.visibility&&"signals"in r.panels.visibility&&delete r.panels.visibility.signals,r.panels.sizes&&"signals"in r.panels.sizes&&delete r.panels.sizes.signals):(r.panels.order=[],r.panels.visibility={},r.panels.sizes={})}}function Dt(){localStorage.setItem("situationRoomPanels",JSON.stringify({order:r.panels.order,visibility:r.panels.visibility,sizes:r.panels.sizes,version:$s}))}function Je(){return[...document.querySelectorAll(".panel[data-panel]")].map(e=>({id:e.dataset.panel,title:e.querySelector(".panel-title")?.textContent||e.dataset.panel,element:e}))}function ua(){Je().forEach(e=>{let t=r.panels.visibility[e.id]!==!1;e.element.classList.toggle("panel-hidden",!t)})}function zs(){if(!r.panels.order.length)return;let e=Je(),t=new Map(e.map(n=>[n.id,n.element]));r.panels.order.forEach(n=>{let a=t.get(n);a&&l.panelGrid.appendChild(a)}),e.forEach(n=>{r.panels.order.includes(n.id)||l.panelGrid.appendChild(n.element)})}function Ks(){Je().forEach(e=>{let t=r.panels.sizes[e.id]||Eo[e.id];if(!t){e.element.style.gridColumnEnd="",e.element.style.height="";return}t.cols?e.element.style.gridColumnEnd=`span ${t.cols}`:e.element.style.gridColumnEnd="",t.height?e.element.style.height=`${t.height}px`:r.panels.sizes[e.id]?.height||(e.element.style.height="")})}function Ws(){let e=Je();l.panelToggles.innerHTML="",e.forEach(t=>{let n=document.createElement("div");n.className="panel-toggle";let a=document.createElement("label"),s=`panel-toggle-${String(t.id).replace(/[^a-zA-Z0-9_-]/g,"-")}`;a.className="panel-toggle-label",a.setAttribute("for",s),a.textContent=t.title;let o=document.createElement("input");o.type="checkbox",o.id=s,o.name=s,o.checked=r.panels.visibility[t.id]!==!1,o.addEventListener("change",()=>{r.panels.visibility[t.id]=o.checked,Dt(),ua()}),n.appendChild(a),n.appendChild(o),l.panelToggles.appendChild(n)})}function hi(){r.panels.order=[...document.querySelectorAll(".panel[data-panel]")].map(e=>e.dataset.panel),Dt()}function bi(){let e=null;Je().forEach(t=>{t.element.setAttribute("draggable","true"),t.element.addEventListener("dragstart",n=>{e=t.id,t.element.classList.add("dragging"),n.dataTransfer.effectAllowed="move"}),t.element.addEventListener("dragend",()=>{t.element.classList.remove("dragging"),document.querySelectorAll(".panel.drag-over").forEach(n=>n.classList.remove("drag-over"))}),t.element.addEventListener("dragover",n=>{n.preventDefault(),t.element.classList.add("drag-over")}),t.element.addEventListener("dragleave",()=>{t.element.classList.remove("drag-over")}),t.element.addEventListener("drop",n=>{n.preventDefault(),t.element.classList.remove("drag-over");let a=document.querySelector(`.panel[data-panel="${e}"]`);if(!a||a===t.element)return;let s=t.element.getBoundingClientRect(),o=n.clientY<s.top+s.height/2;l.panelGrid.insertBefore(a,o?t.element:t.element.nextSibling),hi()})})}function vi(){let e=l.panelGrid;if(!e)return;let t=window.getComputedStyle(e),n=parseFloat(t.columnGap||t.gap||"0"),a=(i,u,d)=>Math.min(Math.max(i,u),d),s=()=>(e.getBoundingClientRect().width-n*11)/12,o=(i,u,d)=>{d.preventDefault(),d.stopPropagation();let m=i.element.getBoundingClientRect(),f=m.width,p=m.height,h=d.clientX,y=d.clientY,C=(window.getComputedStyle(i.element).gridColumnEnd||"span 12").match(/span\s+(\d+)/),v=C?Number(C[1]):Math.round(f/(s()+n)),S=i.element.getAttribute("draggable");i.element.setAttribute("draggable","false");let w=A=>{let E=A.clientX-h,T=A.clientY-y;if(u!=="y"){let D=s(),M=f+E,P=a(Math.round((M+n)/(D+n)),2,12);i.element.style.gridColumnEnd=`span ${P}`,r.panels.sizes[i.id]={...r.panels.sizes[i.id],cols:P,height:r.panels.sizes[i.id]?.height||Math.round(p)}}if(u!=="x"){let D=Math.max(180,p+T);i.element.style.height=`${D}px`,r.panels.sizes[i.id]={...r.panels.sizes[i.id],cols:r.panels.sizes[i.id]?.cols||v,height:Math.round(D)}}Dt()},I=()=>{S!==null?i.element.setAttribute("draggable",S):i.element.removeAttribute("draggable"),window.removeEventListener("mousemove",w),window.removeEventListener("mouseup",I),r.map&&setTimeout(()=>r.map.invalidateSize(),120),r.energyMap&&setTimeout(()=>r.energyMap.invalidateSize(),120)};window.addEventListener("mousemove",w),window.addEventListener("mouseup",I)};Je().forEach(i=>{if(i.element.querySelector(".panel-resize-handle"))return;let u=document.createElement("div");u.className="panel-resize-handle",i.element.appendChild(u),u.addEventListener("mousedown",f=>o(i,"both",f));let d=document.createElement("div");d.className="panel-resize-handle-x",i.element.appendChild(d),d.addEventListener("mousedown",f=>o(i,"x",f));let m=document.createElement("div");m.className="panel-resize-handle-y",i.element.appendChild(m),m.addEventListener("mousedown",f=>o(i,"y",f))})}function Ci(){r.panels.order=[...r.panels.defaultOrder],r.panels.visibility={},r.panels.sizes={},Dt(),zs(),ua(),Ks(),Ws()}function Zn(e){r.settings.theme=e;let t=e==="system"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;l.app.dataset.theme=t,document.documentElement.dataset.theme=t,document.body.dataset.theme=t,document.querySelectorAll(".modal-overlay").forEach(n=>{n.dataset.theme=t}),cn()}function Si(){[...l.themeToggle.querySelectorAll(".seg")].forEach(e=>{e.classList.toggle("active",e.dataset.theme===r.settings.theme)})}function wi(){l.ageToggle&&[...l.ageToggle.querySelectorAll(".seg")].forEach(e=>{let t=Number(e.dataset.age);e.classList.toggle("active",t===r.settings.maxAgeDays)})}function Li(){l.languageToggle&&[...l.languageToggle.querySelectorAll(".seg")].forEach(e=>{e.classList.toggle("active",e.dataset.language===r.settings.languageMode)})}function da(){[...l.scopeToggle.querySelectorAll(".seg")].forEach(e=>{e.classList.toggle("active",e.dataset.scope===r.settings.scope)}),Tt()}function me(){l.refreshValue.textContent=`${r.settings.refreshMinutes} min`,l.refreshRange.value=r.settings.refreshMinutes,l.refreshRangeValue.textContent=r.settings.refreshMinutes,l.maxAgeRange&&(l.maxAgeRange.value=r.settings.maxAgeDays,l.maxAgeValue.textContent=`${r.settings.maxAgeDays} days`),l.radiusRange.value=r.settings.radiusKm,l.radiusRangeValue.textContent=r.settings.radiusKm,l.geoValue.textContent=r.location.source==="geo"?"Geolocated":"Fallback (Asheville)",l.aiTranslateToggle&&(l.aiTranslateToggle.checked=r.settings.aiTranslate),l.superMonitorToggle&&(l.superMonitorToggle.checked=r.settings.superMonitor),l.statusCompact&&l.statusCompact.classList.toggle("collapsed",!r.settings.showStatus),l.statusToggle&&(l.statusToggle.textContent=r.settings.showStatus?"Hide":"Show"),l.keySection&&l.keySection.classList.toggle("collapsed",!r.settings.showKeys),l.keyToggle&&(l.keyToggle.textContent=r.settings.showKeys?"Hide":"Show"),l.mcpSection&&l.mcpSection.classList.toggle("collapsed",!r.settings.showMcp),l.mcpToggle&&(l.mcpToggle.textContent=r.settings.showMcp?"Hide":"Show"),l.travelTickerBtn&&(l.travelTickerBtn.classList.toggle("active",r.settings.showTravelTicker),l.travelTickerBtn.textContent=r.settings.showTravelTicker?"Travel Ticker":"Travel Ticker Off"),l.travelTicker&&l.travelTicker.classList.toggle("hidden",!r.settings.showTravelTicker),Si(),da(),wi(),Li(),mt(),yt(),Tt(),l.liveSearchToggle&&(l.liveSearchToggle.classList.toggle("active",r.settings.liveSearch),l.liveSearchToggle.textContent=r.settings.liveSearch?"Live Search On":"Live Search Off"),hn()}function Ai(){return r.settings.aiTranslate?Me()?"AI query translation is on. Search adapts to each source.":"AI translation is on, but AI is offline. Using default feed queries.":"AI query translation is off. Searches use the exact text you enter."}function hn(){l.searchHint&&(r.searching||l.searchResults?.classList.contains("open")||(l.searchHint.textContent=Ai()))}function zt(e){l.settingsPanel.classList.toggle("open",e),l.settingsScrim&&l.settingsScrim.classList.toggle("open",e),l.settingsPanel.setAttribute("aria-hidden",e?"false":"true"),l.settingsPanel.inert=!e}function We(e){l.aboutOverlay&&(l.aboutOverlay.classList.toggle("open",e),l.aboutOverlay.setAttribute("aria-hidden",e?"false":"true"),l.aboutOverlay.inert=!e)}function Kt(e){l.attributionOverlay&&(l.attributionOverlay.classList.toggle("open",e),l.attributionOverlay.setAttribute("aria-hidden",e?"false":"true"),l.attributionOverlay.inert=!e)}function Ti(){l.aboutSources&&(l.aboutSources.innerHTML="",Us.forEach(e=>{let t=document.createElement("button");t.type="button",t.className="about-source",t.dataset.attributionId=e.id,t.setAttribute("role","listitem"),t.title=`${e.name}${e.short?` \u2014 ${e.short}`:""}`;let n=document.createElement("div");n.textContent=e.name;let a=document.createElement("span");a.className="about-source-meta",a.textContent=e.short||"Details",t.appendChild(n),t.appendChild(a),t.addEventListener("click",()=>Ei(e.id)),l.aboutSources.appendChild(t)}))}function Ei(e){let t=Us.find(a=>a.id===e);if(!t||!l.attributionBody)return;if(l.attributionTitle&&(l.attributionTitle.textContent=t.name),l.attributionMeta&&(l.attributionMeta.textContent=t.short||"Attribution requirements"),l.attributionBody.innerHTML="",t.notes){let a=document.createElement("div");a.className="detail-summary";let s=document.createElement("p");s.textContent=t.notes,a.appendChild(s),l.attributionBody.appendChild(a)}let n=[{label:"Attribution",value:t.attribution},{label:"Source",value:t.url}];t.termsUrl&&n.push({label:"Terms",value:t.termsUrl}),n.forEach(a=>{if(!a.value)return;let s=document.createElement("div");s.className="detail-row";let o=document.createElement("div");o.className="detail-label",o.textContent=a.label;let i=document.createElement("div");if(i.className="detail-value",typeof a.value=="string"&&a.value.startsWith("http")){let u=document.createElement("a");u.href=a.value,u.target="_blank",u.rel="noopener noreferrer",u.textContent=a.value,i.appendChild(u)}else i.textContent=a.value;s.appendChild(o),s.appendChild(i),l.attributionBody.appendChild(s)}),Kt(!0)}function Vs(e){l.listOverlay&&(l.listOverlay.classList.toggle("open",e),l.listOverlay.setAttribute("aria-hidden",e?"false":"true"),l.listOverlay.inert=!e,!e&&l.listModalList&&(l.listModalList.innerHTML="",l.listModalList.dataset.listContext=""))}function Js(e){l.detailOverlay&&(l.detailOverlay.classList.toggle("open",e),l.detailOverlay.setAttribute("aria-hidden",e?"false":"true"),l.detailOverlay.inert=!e,!e&&l.detailBody&&(l.detailBody.innerHTML=""))}function ki(e){let t=document.createElement("div");t.className="detail-section detail-related";let n=document.createElement("div");n.className="detail-section-title",n.textContent="Related signals",t.appendChild(n);let a=document.createElement("div");a.className="detail-related-status",t.appendChild(a);let s=document.createElement("div");if(s.className="detail-related-list",t.appendChild(s),!Kn)return a.textContent="Related signals are temporarily unavailable.",t;a.textContent="Searching related signals\u2026";let o=(e.detailTitle||e.title||"").trim(),i=e.externalUrl||e.fallbackUrl||"",u=e.summaryHtml?he(e.summaryHtml):e.translatedSummary||e.summary||e.detailSummary||e.description||"",d=e.category||e.feedCategory||"";return Kn.searchRelated({title:o,summary:u,category:d}).then(m=>{if(!t.isConnected)return;if(m?.error){a.textContent="Related signals unavailable right now.";return}let f=m?.data||{},h=(Array.isArray(f.items)?f.items:Array.isArray(f.results)?f.results:Array.isArray(f.signals)?f.signals:[]).filter(y=>{if(!y)return!1;let g=String(y.title||y.name||y.label||"").trim();if(!g||o&&g.toLowerCase()===o.toLowerCase())return!1;let b=y.url||y.externalUrl||"";return!(i&&b&&b===i)});if(!h.length){a.textContent="No related signals found.";return}a.textContent=`Showing ${Math.min(h.length,6)} related signals`,h.slice(0,6).forEach(y=>{let g=document.createElement("div");g.className="detail-related-item";let b=document.createElement(y.url||y.externalUrl?"a":"div");b.className="detail-related-title",b.textContent=y.title||y.name||y.label||"Signal",(y.url||y.externalUrl)&&(b.href=y.url||y.externalUrl,b.target="_blank",b.rel="noopener noreferrer"),g.appendChild(b);let C=document.createElement("div");C.className="detail-related-meta";let v=[];y.source&&v.push(y.source),y.category&&v.push(y.category);let S=y.publishedAt||y.updatedAt||y.timestamp;S&&v.push(ve(S)),C.textContent=v.filter(Boolean).join(" \u2022 "),g.appendChild(C);let w=y.summary||y.detailSummary||y.description;if(w){let I=document.createElement("div");I.className="detail-related-summary",I.textContent=se(he(w),140),g.appendChild(I)}s.appendChild(g)})}).catch(m=>{t.isConnected&&(a.textContent="Related signals unavailable right now.")}),t}function Zs(e){return e?e.feedId&&e.feedId.startsWith("congress-")||Array.isArray(e.tags)&&e.tags.includes("congress")?!0:e.source==="Congress.gov":!1}function Ii(e){if(!e)return!1;if(e.feedId&&e.feedId.startsWith("govinfo-")||Array.isArray(e.tags)&&e.tags.includes("govinfo"))return!0;let t=e.externalUrl||e.url||"";return typeof t=="string"&&t.includes("govinfo.gov/app/details/")?!0:e.source==="GovInfo"}function xi(e){if(!e)return!1;if(e.feedId==="federal-register"||e.feedId==="federal-register-transport")return!0;let t=e.externalUrl||e.url||"";return typeof t=="string"&&t.includes("federalregister.gov/documents/")?!0:e.source==="Federal Register"}function Ni(e){if(!(!l.detailOverlay||!e)){if(l.detailTitle&&(l.detailTitle.textContent=e.detailTitle||e.title||"Details"),l.detailMeta){let t=[e.source||e.feedName||"",ve(e.publishedAt||Date.now())].filter(Boolean);l.detailMeta.textContent=t.join(" \u2022 ")}if(l.detailBody){l.detailBody.innerHTML="";let t=e.summaryHtml?Yn(e.summaryHtml):e.translatedSummary||e.summary||"";if(t){let a=document.createElement("div");if(a.className="detail-summary",e.summaryHtml)a.innerHTML=Yn(e.summaryHtml);else{let s=document.createElement("p");s.textContent=t,a.appendChild(s)}l.detailBody.appendChild(a)}if(Array.isArray(e.detailFields)&&e.detailFields.filter(a=>a&&a.label&&a.value).forEach(a=>{let s=document.createElement("div");s.className="detail-row";let o=document.createElement("div");o.className="detail-label",o.textContent=a.label;let i=document.createElement("div");i.className="detail-value",i.textContent=a.value,s.appendChild(o),s.appendChild(i),l.detailBody.appendChild(s)}),Array.isArray(e.amendments)&&e.amendments.length){let a=document.createElement("div");a.className="detail-section";let s=document.createElement("div");s.className="detail-section-title",s.textContent="Amendments",a.appendChild(s);let o=document.createElement("div");o.className="detail-list",[...e.amendments].sort((u,d)=>(u.publishedAt||0)-(d.publishedAt||0)).forEach(u=>{let d=document.createElement("div");d.className="detail-item";let m=document.createElement("div");if(m.className="detail-item-title",u.externalUrl){let h=document.createElement("a");h.href=u.externalUrl,h.target="_blank",h.rel="noopener noreferrer",h.textContent=u.title||"Amendment",m.appendChild(h)}else m.textContent=u.title||"Amendment";d.appendChild(m);let f=document.createElement("div");f.className="detail-item-meta";let p=[u.type&&u.number?`${u.type} ${u.number}`:"",u.chamber,u.publishedAt?le(u.publishedAt):""].filter(Boolean);if(f.textContent=p.join(" \u2022 "),d.appendChild(f),u.summary){let h=document.createElement("div");h.className="detail-item-summary",h.textContent=u.summary,d.appendChild(h)}if(u.purpose){let h=document.createElement("div");h.className="detail-item-summary",h.textContent=u.purpose,d.appendChild(h)}o.appendChild(d)}),a.appendChild(o),l.detailBody.appendChild(a)}if(Array.isArray(e.nominationActions)&&e.nominationActions.length){let a=document.createElement("div");a.className="detail-section";let s=document.createElement("div");s.className="detail-section-title",s.textContent="Nomination Actions",a.appendChild(s);let o=document.createElement("div");o.className="detail-list",[...e.nominationActions].sort((u,d)=>(d.publishedAt||0)-(u.publishedAt||0)).forEach(u=>{let d=document.createElement("div");d.className="detail-item";let m=document.createElement("div");if(m.className="detail-item-title",u.externalUrl){let p=document.createElement("a");p.href=u.externalUrl,p.target="_blank",p.rel="noopener noreferrer",p.textContent=u.title||"Action",m.appendChild(p)}else m.textContent=u.title||"Action";d.appendChild(m);let f=document.createElement("div");f.className="detail-item-meta",f.textContent=u.publishedAt?le(u.publishedAt):"",d.appendChild(f),o.appendChild(d)}),a.appendChild(o),l.detailBody.appendChild(a)}if(Zs(e)){let a=document.createElement("div");a.className="detail-section detail-congress";let s=document.createElement("div");s.className="detail-related-status",s.textContent="Loading Congress.gov details\u2026",a.appendChild(s),l.detailBody.appendChild(a),Lc(e,a)}if(xi(e)){let a=document.createElement("div");a.className="detail-section detail-federal-register";let s=document.createElement("div");s.className="detail-related-status",s.textContent="Loading public comment details\u2026",a.appendChild(s),l.detailBody.appendChild(a),Cc(e,a)}if(Ii(e)){let a=document.createElement("div");a.className="detail-section detail-govinfo";let s=document.createElement("div");s.className="detail-related-status",s.textContent="Loading GovInfo details\u2026",a.appendChild(s),l.detailBody.appendChild(a),pc(e,a)}l.detailBody.appendChild(ki(e));let n=e.externalUrl||e.fallbackUrl;if(n){let a=document.createElement("div");a.className="detail-actions";let s=document.createElement("a");s.className="btn primary",s.href=n,s.target="_blank",s.rel="noopener noreferrer",s.textContent=e.detailLinkLabel||(e.source?`Open on ${e.source}`:"Open record"),a.appendChild(s),l.detailBody.appendChild(a)}}Js(!0)}}function us(){Js(!1)}function rt(e){l.app&&(l.app.classList.toggle("nav-open",e),l.navToggle&&l.navToggle.setAttribute("aria-expanded",e?"true":"false"))}function ds(e){r.health=e,l.healthValue.textContent=e,l.statusText&&(l.statusText.textContent=e==="Healthy"?"Live":e)}function Mi(e){l.refreshNow&&(r.refreshing=e,l.refreshNow.disabled=e,l.refreshNow.textContent=e?"Refreshing...":"Refresh Now",l.mapEmpty&&(l.mapEmpty.textContent=e?"Fetching geo signals\u2026":"No geo signals yet."))}function bn(){l.feedScope.innerHTML="";let e=document.createElement("option");e.value="all",e.textContent="All Sources",l.feedScope.appendChild(e);let t=Array.from(new Set(r.feeds.map(s=>s.category).filter(Boolean))),n=[...zn.filter(s=>t.includes(s)),...t.filter(s=>!zn.includes(s))];l.categoryFilters&&(l.categoryFilters.innerHTML="",n.forEach(s=>{let o=document.createElement("button");o.className="chip chip-toggle",o.type="button",o.dataset.category=s,o.textContent=ot[s]||s,o.addEventListener("click",()=>{r.searchCategories.includes(s)?r.searchCategories=r.searchCategories.filter(u=>u!==s):r.searchCategories=[...r.searchCategories,s],Xt()}),l.categoryFilters.appendChild(o)}));let a=document.createElement("optgroup");a.label="Categories",n.forEach(s=>{let o=document.createElement("option");o.value=`cat:${s}`,o.textContent=`All ${ot[s]||s}`,a.appendChild(o)}),l.feedScope.appendChild(a),n.forEach(s=>{let o=document.createElement("optgroup");o.label=`${ot[s]||s} Feeds`,r.feeds.filter(i=>i.category===s).forEach(i=>{let u=document.createElement("option");u.value=i.id,u.textContent=i.name,o.appendChild(u)}),l.feedScope.appendChild(o)}),Xt(),ei()}function Xt(){if(!l.categoryFilters)return;let e=new Set(r.searchCategories);[...l.categoryFilters.querySelectorAll(".chip-toggle")].forEach(t=>{t.classList.toggle("active",e.has(t.dataset.category))}),e.size&&(l.feedScope.value="all")}function Fi(){l.customFeedCategory&&(l.customFeedCategory.innerHTML="",zn.forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=ot[e]||e,l.customFeedCategory.appendChild(t)}))}function Wt(e){l.customFeedForm&&(l.customFeedForm.classList.toggle("hidden",!e),l.customFeedForm.setAttribute("aria-hidden",e?"false":"true"),e||(Lt=null))}function Qs(e){l.customFeedJsonPanel&&(l.customFeedJsonPanel.classList.toggle("hidden",!e),l.customFeedJsonPanel.setAttribute("aria-hidden",e?"false":"true"))}function Di(e){if(!e||typeof e!="object")return null;let t=String(e.name||"").trim(),n=String(e.url||"").trim();if(!t||!n||!/^https?:\/\//i.test(n))return null;let a=e.category||"news",s=e.format||"rss",o=e.proxy||"",i=Array.isArray(e.tags)?e.tags.filter(Boolean):[],u=!!e.supportsQuery,d=u?String(e.defaultQuery||""):"",m=!!e.requiresKey,f=m?String(e.keyParam||"api_key"):void 0,p=m?String(e.keyHeader||""):void 0,h=Number.isFinite(Number(e.ttlMinutes))?Number(e.ttlMinutes):60;return{id:e.id||ca(`${t}:${n}`),name:t,url:n,category:a,format:s,proxy:o||void 0,tags:i,supportsQuery:u,defaultQuery:d,requiresKey:m,keyParam:f,keyHeader:p,ttlMinutes:h,isCustom:!0,keySource:"client"}}function Pi(){if(!l.customFeedJson)return;let e=r.customFeeds.map(t=>({id:t.id,name:t.name,url:t.url,category:t.category,format:t.format,proxy:t.proxy,tags:t.tags,supportsQuery:t.supportsQuery,defaultQuery:t.defaultQuery,requiresKey:t.requiresKey,keyParam:t.keyParam,keyHeader:t.keyHeader,ttlMinutes:t.ttlMinutes}));l.customFeedJson.value=JSON.stringify(e,null,2),Qs(!0),l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent=e.length?"Exported feeds to JSON.":"No custom feeds to export.")}function $i(){let e=r.customFeeds.map(t=>({id:t.id,name:t.name,url:t.url,category:t.category,format:t.format,proxy:t.proxy,tags:t.tags,supportsQuery:t.supportsQuery,defaultQuery:t.defaultQuery,requiresKey:t.requiresKey,keyParam:t.keyParam,keyHeader:t.keyHeader,ttlMinutes:t.ttlMinutes}));return JSON.stringify(e,null,2)}function Bi(){if(!l.customFeedJson)return;let e=l.customFeedJson.value.trim();if(!e){l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent="Paste JSON to import feeds.");return}let t;try{t=JSON.parse(e)}catch{l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent="Invalid JSON. Please check the format.");return}let n=Array.isArray(t)?t:Array.isArray(t.feeds)?t.feeds:[];if(!n.length){l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent="No feeds found in the JSON payload.");return}let a=n.map(Di).filter(Boolean);if(!a.length){l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent="No valid feeds found. Check name and URL fields.");return}let s=new Map(r.customFeeds.map(o=>[o.id,o]));a.forEach(o=>{s.set(o.id,o)}),r.customFeeds=Array.from(s.values()),fn(),r.feeds=yn(r.baseFeeds,r.customFeeds),vn(),bn(),$t(),dt(!0),l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent=`Imported ${a.length} feed${a.length===1?"":"s"}.`)}function Ys(e){if(!l.customFeedForm)return;let t=e||{};if(l.customFeedName.value=t.name||"",l.customFeedUrl.value=t.url||"",l.customFeedCategory.value=t.category||"news",l.customFeedFormat.value=t.format||"rss",l.customFeedProxy.value=t.proxy||"",l.customFeedTags.value=Array.isArray(t.tags)?t.tags.join(", "):"",l.customFeedSupportsQuery.checked=!!t.supportsQuery,l.customFeedDefaultQuery.value=t.defaultQuery||"",l.customFeedRequiresKey.checked=!!t.requiresKey,l.customFeedKeyParam.value=t.keyParam||"api_key",l.customFeedKeyHeader.value=t.keyHeader||"",l.customFeedTtl.value=t.ttlMinutes?String(t.ttlMinutes):"",l.customFeedRequiresKey){let n=l.customFeedRequiresKey.checked;l.customFeedKeyParam.disabled=!n,l.customFeedKeyHeader.disabled=!n}l.customFeedSupportsQuery&&(l.customFeedDefaultQuery.disabled=!l.customFeedSupportsQuery.checked),l.customFeedStatus&&(l.customFeedStatus.textContent=e?"Editing custom feed.":"Custom feeds are stored in this browser only.")}function vn(){if(l.customFeedList){if(l.customFeedList.innerHTML="",!r.customFeeds.length){l.customFeedList.innerHTML='<div class="settings-note">No custom feeds yet.</div>';return}r.customFeeds.forEach(e=>{let t=document.createElement("div");t.className="custom-feed-row";let n=document.createElement("div");n.className="custom-feed-info";let a=document.createElement("div");a.className="custom-feed-name",a.textContent=e.name||e.url;let s=document.createElement("div");s.className="custom-feed-meta";let o=Array.isArray(e.tags)&&e.tags.length?`\u2022 ${e.tags.join(", ")}`:"";s.textContent=`${e.category||"news"} \u2022 ${e.format||"rss"} ${o}`.trim(),n.appendChild(a),n.appendChild(s);let i=document.createElement("div");i.className="custom-feed-actions";let u=document.createElement("button");u.className="chip",u.type="button",u.textContent="Edit",u.addEventListener("click",()=>{Lt=e.id,Ys(e),Wt(!0)});let d=document.createElement("button");d.className="chip",d.type="button",d.textContent="Remove",d.addEventListener("click",()=>{r.customFeeds=r.customFeeds.filter(m=>m.id!==e.id),fn(),r.feeds=yn(r.baseFeeds,r.customFeeds),vn(),bn(),$t(),dt(!0)}),i.appendChild(u),i.appendChild(d),t.appendChild(n),t.appendChild(i),l.customFeedList.appendChild(t)})}}function Ri(){let e=l.customFeedName.value.trim(),t=l.customFeedUrl.value.trim(),n=l.customFeedCategory.value,a=l.customFeedFormat.value,s=l.customFeedProxy.value||"",o=l.customFeedTags.value.split(",").map(y=>y.trim()).filter(Boolean),i=l.customFeedSupportsQuery.checked,u=l.customFeedDefaultQuery.value.trim(),d=l.customFeedRequiresKey.checked,m=l.customFeedKeyParam.value.trim()||"api_key",f=l.customFeedKeyHeader.value.trim(),p=Number(l.customFeedTtl.value||60);return!e||!t?{error:"Name and URL are required."}:/^https?:\/\//i.test(t)?{feed:{id:Lt,name:e,url:t,category:n,format:a,proxy:s||void 0,tags:o,supportsQuery:i,defaultQuery:i?u:"",requiresKey:d,keyParam:d?m:void 0,keyHeader:d?f:void 0,ttlMinutes:Number.isFinite(p)?p:60,isCustom:!0,keySource:"client"}}:{error:"URL must start with http:// or https://."}}function mt(){l.mapLegend&&(l.mapLegend.querySelectorAll("input[data-layer]").forEach(e=>{let t=e.dataset.layer;e.checked=!!r.settings.mapLayers[t]}),l.mapLegend.querySelectorAll("input[data-conflict-type]").forEach(e=>{let t=e.dataset.conflictType,n=r.settings.mapConflictTypes?.[t];e.checked=n!==!1}),l.legendOutages&&(l.legendOutages.checked=!!r.settings.mapLayers.outage),l.mapLegend.querySelectorAll("input[data-basemap]").forEach(e=>{let t=e.dataset.basemap;e.checked=t===r.settings.mapBasemap}),l.mapLegend.querySelectorAll("input[data-overlay]").forEach(e=>{let t=e.dataset.overlay;e.checked=!!r.settings.mapRasterOverlays?.[t]}),l.mapLegend.querySelectorAll("input[data-flight-density]").forEach(e=>{e.checked=e.dataset.flightDensity===(r.settings.mapFlightDensity||"medium")}))}function yt(){let e=r.settings.mapImageryDate||r.imageryDate,t=r.settings.mapSarDate||r.sarDate,n=Ln(0),a="2014-10-01";l.imageryDateInput&&e&&(l.imageryDateInput.min=a,l.imageryDateInput.max=n,l.imageryDateInput.value=e),l.sarDateInput&&t&&(l.sarDateInput.min=a,l.sarDateInput.max=n,l.sarDateInput.value=t),l.imageryDatePanel&&e&&(l.imageryDatePanel.min=a,l.imageryDatePanel.max=n,l.imageryDatePanel.value=e),l.sarDatePanel&&t&&(l.sarDatePanel.min=a,l.sarDatePanel.max=n,l.sarDatePanel.value=t),qe()}function z(e,t,n=""){r.overlayStatus||(r.overlayStatus={}),r.overlayStatus[e]={state:t,message:n},Xs()}function Oi(e,t){let n=e==="imagery"?"Imagery":e.toUpperCase();if(!t)return`${n}: --`;let a=`${n}: ${t.state||"--"}`;return t.message?`${a} \u2014 ${t.message}`:a}function Xs(){let e=l.imageryStatus;e&&e.querySelectorAll("[data-imagery-status]").forEach(t=>{let n=t.dataset.imageryStatus,a=r.overlayStatus?.[n];t.textContent=Oi(n,a),t.dataset.state=a?.state||""})}function Et(){if(!l.lidarPointMeta)return;let e=r.lidarPointProject||"\u2014",t=r.lidarPointEptUrl,n=r.lidarPointEptAvailable?"available":t?"unavailable":"\u2014",a=r.lidarPointTelemetry?.[r.lidarPointTelemetry.length-1],s=r.overlayStatus?.lidarPoints?.message||"",o=a?.status?`${a.status}${a.loadMs?` \u2022 ${a.loadMs}ms`:""}`:s||"\u2014",i=dn(r.settings.lidarPointLimits),u=i.useCustom?`Custom caps: ${i.pointCap.toLocaleString()} pts \u2022 ${i.radiusKm}km radius \u2022 ${i.maxTilesMobile}/${i.maxTilesDesktop} tiles`:"Defaults: 150k pts \u2022 5km radius \u2022 8/16 tiles";l.lidarPointProject&&(l.lidarPointProject.textContent=e),l.lidarPointEpt&&(l.lidarPointEpt.textContent=n,t?(l.lidarPointEpt.href=t,l.lidarPointEpt.setAttribute("aria-disabled","false")):(l.lidarPointEpt.removeAttribute("href"),l.lidarPointEpt.setAttribute("aria-disabled","true"))),l.lidarPointTelemetry&&(l.lidarPointTelemetry.textContent=o),l.lidarPointPerfNote&&(l.lidarPointPerfNote.textContent=u),l.lidarPointCustomize&&(l.lidarPointCustomize.checked=i.useCustom),l.lidarPointCap&&(l.lidarPointCap.value=String(i.pointCap)),l.lidarPointRadius&&(l.lidarPointRadius.value=String(i.radiusKm)),l.lidarPointTilesDesktop&&(l.lidarPointTilesDesktop.value=String(i.maxTilesDesktop)),l.lidarPointTilesMobile&&(l.lidarPointTilesMobile.value=String(i.maxTilesMobile)),l.lidarPointLimitGrid&&l.lidarPointLimitGrid.classList.toggle("is-hidden",!i.useCustom),l.lidarPointCenter&&(l.lidarPointCenter.disabled=!r.lidarSelectedBounds),l.lidarPointRefresh&&(l.lidarPointRefresh.disabled=!t),l.lidarPointLoad&&(l.lidarPointLoad.disabled=!r.lidarPointEptAvailable)}function Ee(e,t=.5){let n=r.settings.mapOverlayOpacity?.[e];return Number.isFinite(n)?n:t}function qe(){document.querySelectorAll("[data-imagery-basemap]").forEach(e=>{let t=e.dataset.imageryBasemap;e.classList.toggle("active",t===r.settings.mapBasemap)}),document.querySelectorAll("[data-imagery-overlay]").forEach(e=>{let t=e.dataset.imageryOverlay;e.classList.toggle("active",!!r.settings.mapRasterOverlays?.[t])}),document.querySelectorAll("[data-overlay-opacity]").forEach(e=>{let t=e.dataset.overlayOpacity,n=Math.round(Ee(t,.5)*100);e.value=n;let a=document.querySelector(`[data-overlay-opacity-value="${t}"]`);a&&(a.textContent=`${n}%`)}),Xs(),Et()}function ma(e){return e?.keySource==="server"}function _i(){let e=r.feeds.filter(t=>!ma(t)).filter(t=>t.requiresKey||t.keyParam||t.keyHeader||(t.tags||[]).includes("key")).map(t=>({...t,docsUrl:t.docsUrl||rs[t.id]}));return e.find(t=>t.id==="openai")||e.unshift({id:"openai",name:"OpenAI Assistant",category:"assistant",requiresKey:!0,docsUrl:rs.openai}),e}function Pt(e){if(ma(e))return{key:"",keyParam:"",keyHeader:"",groupId:e.keyGroup||null,fromGroup:!1,serverManaged:!0};let t=r.keys[e.id]||{},n=e.keyGroup,a=n?r.keyGroups[n]||{}:{},s=a.key||t.key,o=e.lockKeyParam?e.keyParam:t.keyParam||e.keyParam,i=e.lockKeyHeader?e.keyHeader:t.keyHeader||e.keyHeader;return{key:s,keyParam:o,keyHeader:i,groupId:n,fromGroup:!!a.key}}function $t(e){r.keyFilter=e||r.keyFilter;let t=_i(),n=r.keyFilter,a=n?Po[n]||[n]:null,s=a?t.filter(p=>a.includes(p.category)):t;n&&!s.length&&(s=t);let o=p=>String(p||"").replace(/[^a-zA-Z0-9_-]/g,"-");l.keyManager.innerHTML="";let i=document.createElement("div");i.className="key-manager-header";let u=document.createElement("div");u.textContent=n?`API Keys - ${n.toUpperCase()}`:"API Keys";let d=document.createElement("div");if(d.className="key-manager-actions",n){let p=document.createElement("button");p.className="chip",p.textContent="Show All",p.addEventListener("click",()=>{r.keyFilter=null,$t()}),d.appendChild(p)}if(i.appendChild(u),i.appendChild(d),l.keyManager.appendChild(i),ne()){let p=document.createElement("div");p.className="settings-note",p.textContent=r.settings.superMonitor?"Super Monitor Mode is active. Live fetches run for keyless feeds, plus custom feeds with browser keys. OpenAI uses the proxy by default (optional BYO key).":"Static mode is active. Feeds load from the published cache. Optional: enable Super Monitor Mode to pull live keyless feeds (proxy required for OpenAI).",l.keyManager.appendChild(p),r.settings.superMonitor||(s=s.filter(h=>h.id==="openai"))}if(r.feeds.filter(p=>ma(p)).length){let p=document.createElement("div");p.className="settings-note",p.textContent="Server-managed keys: DATA_GOV, EIA, NASA_FIRMS, OPEN_AQ. Configure in the proxy.",l.keyManager.appendChild(p)}let f=[...new Set(s.map(p=>p.keyGroup).filter(Boolean))];if(f.length){let p=document.createElement("div");p.className="key-group-section";let h=document.createElement("div");h.className="key-group-title",h.textContent="Shared Keys",p.appendChild(h),f.forEach(y=>{let g=document.createElement("div");g.className="key-row key-group-row";let b=document.createElement("div");b.className="key-row-head";let C=document.createElement("div");C.className="list-title",C.textContent=os[y]||y;let v=document.createElement("div");v.className="key-group-meta";let S=s.filter(P=>P.keyGroup===y),w=S.map(P=>P.name),I=S.map(P=>P.id);v.textContent=`Applies to: ${w.join(", ")}`,b.appendChild(C),b.appendChild(v);let A=document.createElement("label");A.textContent="API Key";let E=document.createElement("input");E.type="password",E.id=`key-group-${o(y)}`,E.name=E.id,E.autocomplete="new-password",A.setAttribute("for",E.id),E.placeholder="Paste shared key",E.value=r.keyGroups[y]?.key||"",E.addEventListener("input",()=>{let P=E.value.trim();r.keyGroups[y]={...r.keyGroups[y]||{},key:P},I.forEach(B=>{r.keyStatus[B]="untested"}),ui(),Jn(),r.energyMapData=null,r.energyMapFetchedAt=0,oa(),cn(),document.querySelectorAll(".key-row[data-feed]").forEach(B=>{let U=B.dataset.feed;if(s.find(F=>F.id===U)?.keyGroup===y){let F=B.querySelector('input[type="password"], input[type="text"]');F&&(F.value=E.value);let x=B.querySelector(".key-status");x&&(x.className="key-status untested",x.textContent="untested")}})});let T=document.createElement("button");T.className="chip",T.textContent="Show",T.addEventListener("click",()=>{E.type=E.type==="password"?"text":"password",T.textContent=E.type==="password"?"Show":"Hide"});let D=document.createElement("div");D.className="key-row-input";let M=document.createElement("input");M.type="text",M.className="sr-only",M.autocomplete="username",M.name=`user-${E.id}`,M.id=`user-${E.id}`,M.tabIndex=-1,M.setAttribute("aria-hidden","true"),D.appendChild(M),D.appendChild(E),D.appendChild(T),g.appendChild(b),g.appendChild(A),g.appendChild(D),p.appendChild(g)}),l.keyManager.appendChild(p)}if(!s.length){l.keyManager.innerHTML+='<div class="settings-note">No feeds require keys yet.</div>';return}s.forEach(p=>{let h=document.createElement("div");h.className="key-row",h.dataset.feed=p.id;let y=document.createElement("div");y.className="key-row-head";let g=document.createElement("div");g.textContent=p.name,g.className="list-title";let b=document.createElement("span"),C=r.keyStatus[p.id]||"untested";b.className=`key-status ${C}`,b.textContent=C;let v=document.createElement("div");v.className="key-row-actions";let S=document.createElement("button");if(S.className="chip",S.textContent="Test",S.addEventListener("click",()=>ji(p,b)),v.appendChild(S),p.docsUrl){let P=document.createElement("a");P.className="chip",P.href=p.docsUrl,P.target="_blank",P.rel="noopener noreferrer",P.textContent="Docs",v.appendChild(P)}y.appendChild(g),y.appendChild(b),y.appendChild(v);let w=document.createElement("label");w.textContent="API Key";let I=document.createElement("input");I.type="password",I.id=`key-${o(p.id)}`,I.name=I.id,I.autocomplete="new-password",w.setAttribute("for",I.id);let A=Pt(p),E=p.keyGroup?os[p.keyGroup]||p.keyGroup:null;I.placeholder=p.keyGroup?"Set in Shared Keys":"Paste key",I.value=A.key||"",I.disabled=!!p.keyGroup,p.keyGroup||I.addEventListener("input",()=>{let P=I.value.trim();r.keys[p.id]={...r.keys[p.id]||{},key:P},r.keyStatus[p.id]="untested",$n(),Jn(),b.className="key-status untested",b.textContent="untested",p.id==="openai"&&gn(),r.energyMapData=null,r.energyMapFetchedAt=0,oa(),cn()});let T=document.createElement("button");T.className="chip",T.textContent="Show",T.addEventListener("click",()=>{I.type=I.type==="password"?"text":"password",T.textContent=I.type==="password"?"Show":"Hide"});let D=document.createElement("div");D.className="key-row-input";let M=document.createElement("input");if(M.type="text",M.className="sr-only",M.autocomplete="username",M.name=`user-${I.id}`,M.id=`user-${I.id}`,M.tabIndex=-1,M.setAttribute("aria-hidden","true"),D.appendChild(M),D.appendChild(I),D.appendChild(T),h.appendChild(y),h.appendChild(w),h.appendChild(D),p.id==="openai"){let P=document.createElement("details");P.className="advanced-toggle",P.open=!1;let B=document.createElement("summary");B.textContent="Advanced",P.appendChild(B);let U=document.createElement("label");U.className="toggle-row";let q=document.createElement("span");q.textContent="Use my OpenAI key for AI requests";let F=document.createElement("input");F.type="checkbox",F.id="useOpenAiKey",F.name="useOpenAiKey",F.checked=!!r.settings.useClientOpenAI,F.setAttribute("aria-label","Use browser OpenAI key for AI requests"),F.addEventListener("change",()=>{r.settings.useClientOpenAI=F.checked,V(),gn(),He(),F.checked&&(P.open=!0)}),U.appendChild(q),U.appendChild(F),P.appendChild(U);let x=document.createElement("div");x.className="settings-note",x.textContent="When off, AI uses the server key. When on, your key is passed to the proxy.",P.appendChild(x),h.appendChild(P)}if(p.id!=="openai"){let P=document.createElement("label");P.textContent="Key Param (query string)";let B=document.createElement("input");B.id=`key-param-${o(p.id)}`,B.name=B.id,P.setAttribute("for",B.id),B.placeholder=p.keyParam||"api_key",B.value=p.lockKeyParam?p.keyParam||"":r.keys[p.id]?.keyParam||p.keyParam||"",p.lockKeyParam?B.disabled=!0:B.addEventListener("input",()=>{r.keys[p.id]={...r.keys[p.id]||{},keyParam:B.value},$n()});let U=document.createElement("label");U.textContent="Key Header (optional)";let q=document.createElement("input");if(q.id=`key-header-${o(p.id)}`,q.name=q.id,U.setAttribute("for",q.id),q.placeholder=p.keyHeader||"X-API-Key",q.value=p.lockKeyHeader?p.keyHeader||"":r.keys[p.id]?.keyHeader||p.keyHeader||"",p.lockKeyHeader?q.disabled=!0:q.addEventListener("input",()=>{r.keys[p.id]={...r.keys[p.id]||{},keyHeader:q.value},$n()}),h.appendChild(P),h.appendChild(B),h.appendChild(U),h.appendChild(q),p.keyGroup){let F=document.createElement("div");F.className="settings-note",F.textContent=`Uses shared key: ${E}`,h.appendChild(F)}if(p.lockKeyParam||p.lockKeyHeader){let F=document.createElement("div");F.className="settings-note",F.textContent="Key parameters are fixed for this API.",h.appendChild(F)}}else{let P=document.createElement("div");P.className="settings-note",P.textContent="Used for chat, AI briefings, and query translation.",h.appendChild(P)}l.keyManager.appendChild(h)})}function Le(e,t,n,a){r.keyStatus[e]=t,Jn(),n&&(n.className=`key-status ${t}`,n.textContent=t,a?n.title=a:n.removeAttribute("title"))}function Ui(e){return e?e.error==="requires_key"?"missing":e.httpStatus>=200&&e.httpStatus<300?"ok":e.httpStatus===401||e.httpStatus===403?"invalid":e.httpStatus===429?"rate_limited":"error":"error"}function Hi(){let e=(r.keys.openai?.key||"").trim();return e&&r.settings.useClientOpenAI?e:""}function Me(){return Ye()?!0:!ne()}function pa(e){let t=(e?.message||"").toString(),n=t.toLowerCase();return n.includes("assistant_unavailable")?{status:"error",message:"AI requires a proxy on GitHub Pages."}:n.includes("missing_api_key")||n.includes("provide an openai api key")?{status:"missing",message:"Add an OpenAI API key in Settings."}:n.includes("failed to fetch")||n.includes("network")||n.includes("cors")?{status:"error",message:"Browser blocked the request (CORS). Key saved; use a proxy for live chat."}:(n.includes("invalid")||n.includes("unauthorized")||n.includes("401"))&&!ne()?{status:"invalid",message:t||"Invalid API key"}:n.includes("invalid")||n.includes("unauthorized")||n.includes("401")?{status:"error",message:"OpenAI request blocked on static hosting. Use a proxy for live chat."}:n.includes("rate")||n.includes("429")?{status:"rate_limited",message:t||"Rate limited"}:{status:"error",message:t||"OpenAI error"}}async function ji(e,t){let n=Pt(e);e.id==="openai"&&n.key&&(n.key=n.key.trim());let a=Ye();if(!n.key){if(e.id==="openai"&&a){Le(e.id,"ok",t,"Using server key");return}Le(e.id,"missing",t,"Missing API key");return}if(Le(e.id,"testing",t,"Testing key..."),e.id==="openai"){if(a&&!r.settings.useClientOpenAI){Le(e.id,"ok",t,"Using server key");return}if(ne()&&!Ye()){if(!r.settings.superMonitor){Le(e.id,"missing",t,"Enable Super Monitor Mode to test.");return}Le(e.id,"ok",t,"Key saved. Static hosting cannot validate without a proxy.");return}try{await ht({messages:[{role:"user",content:"ping"}],context:{mode:"key-test"},temperature:0})?Le(e.id,"ok",t,"Key valid"):Le(e.id,"error",t,"No response")}catch(s){let{status:o,message:i}=pa(s);Le(e.id,o,t,i)}return}try{let s,o;if(ne()){let d=new URLSearchParams;d.set("id",e.id),d.set("force","1"),e.supportsQuery&&e.defaultQuery&&d.set("query",e.defaultQuery);let m=await Ce(`/api/feed?${d.toString()}`);s=m.data,o=m.error}else{let d=await Ce("/api/feed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,force:!0,query:e.supportsQuery?e.defaultQuery:void 0,key:n.key||void 0,keyParam:n.keyParam||void 0,keyHeader:n.keyHeader||void 0})});s=d.data,o=d.error}if(o||!s){Le(e.id,"error",t,"Feed API unreachable");return}let i=Ui(s),u=s.message||s.error||(s.httpStatus?`HTTP ${s.httpStatus}`:"");Le(e.id,i,t,u)}catch(s){Le(e.id,"error",t,s.message)}}function we(e=""){return e.toLowerCase().replace(/https?:\/\/\S+/g,"").replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(t=>t&&!Io.has(t)).join(" ").trim()}function Cn(e){if(!e)return"";try{let t=new URL(e);return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(n=>t.searchParams.delete(n)),t.toString()}catch{return e}}function Gi(){try{let e=new URL(window.location.href),t=["key","api_key","apikey","openai_key","openai","x-api-key","token","access_token"],n=!1;if(t.forEach(a=>{e.searchParams.has(a)&&(e.searchParams.delete(a),n=!0)}),n){let a=e.searchParams.toString(),s=`${e.pathname}${a?`?${a}`:""}${e.hash}`;window.history.replaceState({},document.title,s)}}catch{}}async function qi(){if(l.proxyHealth){l.proxyHealth.textContent="Feed API: Checking",l.proxyHealth.classList.remove("ok","error");try{let{response:e,data:t}=await Ce("/health",{},8e3);if(e?.ok&&t?.ok){l.proxyHealth.textContent="Feed API: Healthy",l.proxyHealth.classList.add("ok");return}l.proxyHealth.textContent="Feed API: Degraded",l.proxyHealth.classList.add("error")}catch{l.proxyHealth.textContent="Feed API: Offline",l.proxyHealth.classList.add("error")}}}function Ze(e){let t=new Set,n=[];return e.forEach(a=>{let s=a._dedupeKey||Cn(a.url||"")||we(a.title||"");if(!s){n.push(a);return}t.has(s)||(t.add(s),n.push(a))}),n}function zi(e,t){if(!e.size||!t.size)return 0;let n=0;for(let s of e)t.has(s)&&(n+=1);let a=e.size+t.size-n;return a?n/a:0}function at(e){let t=[];return e.forEach(n=>{let a=Cn(n.url),s=new Set(we(n.title).split(" ").filter(Boolean)),o=null;for(let i of t){if(a&&i.urls.has(a)){o=i;break}if(zi(s,i.tokens)>.72){o=i;break}}if(o)o.items.push(n),o.sources.add(n.source),a&&o.urls.add(a),n.publishedAt&&n.publishedAt>o.updatedAt&&(o.updatedAt=n.publishedAt,o.primary=n);else{let i={id:`cluster-${t.length}-${Date.now()}`,primary:n,items:[n],sources:new Set([n.source]),urls:a?new Set([a]):new Set,tokens:s,updatedAt:n.publishedAt||Date.now()};t.push(i)}}),t.sort((n,a)=>a.updatedAt-n.updatedAt)}function Qn(e,t){let a=new DOMParser().parseFromString(e,"text/xml"),s=[...a.getElementsByTagName("item")];if(!s.length){let o=[...a.getElementsByTagName("entry")];return(o.length?o:a.getElementsByTagNameNS?[...a.getElementsByTagNameNS("*","entry")]:[]).map(u=>{let d=u.getElementsByTagName("title")?.[0]?.textContent||"Untitled",m=u.getElementsByTagName("link")?.[0],f=m?.getAttribute("href")||m?.textContent||"",p=u.getElementsByTagName("updated")?.[0]?.textContent||u.getElementsByTagName("published")?.[0]?.textContent,h=u.getElementsByTagName("summary")?.[0],y=h?.textContent||"",g=h?.innerHTML||"",b=gs(y,g);return{title:d,url:f,summary:b.summary,summaryHtml:b.summaryHtml,publishedAt:p?Date.parse(p):Date.now(),source:t.name,category:t.category}})}return s.map(o=>{let i=o.getElementsByTagName("title")?.[0]?.textContent||"Untitled",u=o.getElementsByTagName("link")?.[0]?.textContent||o.getElementsByTagName("guid")?.[0]?.textContent||"",d=o.getElementsByTagName("dc:date")?.[0]?.textContent,m=o.getElementsByTagName("pubDate")?.[0]?.textContent||d,f=o.getElementsByTagName("source")?.[0]?.textContent||t.name,p=null,h=o.getElementsByTagName("georss:point")?.[0]?.textContent;if(h){let[v,S]=h.trim().split(/\\s+/).map(Number);!Number.isNaN(v)&&!Number.isNaN(S)&&(p={lat:v,lon:S})}else{let v=o.getElementsByTagName("geo:lat")?.[0]?.textContent,S=o.getElementsByTagName("geo:long")?.[0]?.textContent;if(v&&S){let w=Number(v),I=Number(S);!Number.isNaN(w)&&!Number.isNaN(I)&&(p={lat:w,lon:I})}}let y=o.querySelector("description"),g=y?.textContent||"",b=y?.innerHTML||"",C=gs(g,b);return{title:i,url:u,summary:C.summary,summaryHtml:C.summaryHtml,publishedAt:m?Date.parse(m):Date.now(),source:f,category:t.category,geo:p}})}function Ki(e=""){let t=String(e||"").slice(0,2048).trim().toLowerCase();return t?t.startsWith("<!doctype html")||t.startsWith("<html")||t.includes("<html")||t.includes("<body"):!1}function Wi(e=""){let t=String(e||"").slice(0,4096).trim().toLowerCase();return t?t.startsWith("<?xml")||t.includes("<rss")||t.includes("<feed")||t.includes("<rdf:rdf"):!1}function Vi(e="",t=""){let n=String(e||"").toLowerCase(),a=n.includes("rss")||n.includes("atom")||n.includes("xml");return!!(Wi(t)||a&&!Ki(t))}function en(e,t){try{if(t.format==="csv")return Ht[t.id]?Ht[t.id](e,t):tl(e,t);let n=JSON.parse(e);return t.format==="arcgis"?Zi(n,t):Ht[t.id]?Ht[t.id](n,t):t.isCustom?Ji(n,t):[]}catch{return[]}}function Ji(e,t){return(Array.isArray(e?.items)?e.items:Array.isArray(e?.entries)?e.entries:Array.isArray(e?.articles)?e.articles:Array.isArray(e?.data)?e.data:[]).slice(0,20).map(a=>{if(typeof a=="string")return{title:a,url:"",summary:"",publishedAt:Date.now(),source:t.name,category:t.category};let s=a.title||a.name||a.headline||"Untitled",o=a.url||a.link||a.permalink||"",i=a.summary||a.description||a.body||"",u=a.publishedAt||a.pubDate||a.date||a.updatedAt,d=a.geo||(a.latitude&&a.longitude?{lat:Number(a.latitude),lon:Number(a.longitude)}:null);return{title:s,url:o,summary:i,publishedAt:u?Date.parse(u):Date.now(),source:a.source||t.name,category:t.category,geo:d}})}function Zi(e,t){let n=Array.isArray(e?.features)?e.features:[],a=(g,b=[])=>{for(let C of b)if(g[C]!==void 0&&g[C]!==null&&String(g[C]).trim()!=="")return g[C];return null},s=g=>{if(g==null||g==="")return null;if(typeof g=="number"){if(g>1e12)return g;if(g>1e9)return g*1e3}let b=Date.parse(g);return Number.isNaN(b)?null:b},o=g=>{let C=a(g,["reported_date","report_date","reportdate","incident_date","event_date","date","datetime","timestamp","time","created_date","created","updated_date","updated","last_updated","last_update","edit_date","start_date","end_date"]);if(C)return s(C);for(let v of Object.keys(g||{})){let S=v.toLowerCase();if(S.includes("date")||S.includes("time")||S.includes("updated")){let w=s(g[v]);if(w)return w}}return null},i=g=>a(g,["title","name","incident","event","type","category","hazard","AttackType","attacktype","attack_type","summary","description"])||t.name,u=g=>a(g,["summary","description","details","Notes","notes","comments","status","headline"])||"",d=g=>a(g,["alert_type","event","type","category","hazard","incident_type","AttackType","attacktype","attack_type"]),m=g=>a(g,["severity","sig","significance","priority","status"]),f=g=>a(g,["location","loc_desc","area_desc","place","city","county","state","country","region"]),p=Number(t?.maxItems),h=Number.isFinite(p)?p:250;return(h>0?n.slice(0,h):n).map(g=>{let b=g?.properties||g?.attributes||{},C=i(b),v=u(b),S=o(b)||Date.now(),w=d(b),I=m(b),A=f(b),E=!!(t.mapOnly||t.tags?.includes("mapOnly")),T=fa(g.geometry);if(!T){let D=a(b,["latitude","lat","y"]),M=a(b,["longitude","lon","x"]);if(D!==null&&M!==null){let P=Number(D),B=Number(M);!Number.isNaN(P)&&!Number.isNaN(B)&&(T={lat:P,lon:B})}}return{title:C,url:b.url||b.link||"",summary:v,publishedAt:S,source:t.name,category:t.category,geo:T,alertType:w,severity:I,location:A,mapOnly:E}}).filter(g=>g.geo)}function Qi(e,t){let n=Array.isArray(e?.data)?e.data:Array.isArray(e?.response?.data)?e.response.data:[];if(!n.length)return[];let a=n[0]||{};if(!!(a.event_id_cnty||a.event_date||a.latitude||a.longitude))return n.map(m=>{let f=Number(m.latitude),p=Number(m.longitude),h=Number(m.fatalities),y=m.event_date||"",g=y?Date.parse(y):Date.now(),b=m.event_type||"Conflict Event",C=m.sub_event_type||"",v=m.location||m.admin2||m.admin1||m.country||"",S=`${b}${v?` \u2014 ${v}`:""}`,w=[];C&&w.push(C),Number.isNaN(h)||w.push(`Fatalities: ${h}`);let I=[m.actor1,m.actor2].filter(Boolean).join(" vs ");I&&w.push(`Actors: ${I}`);let A=w.join(" \u2022 "),E=(()=>{if(!Number.isFinite(f)||!Number.isFinite(p))return"";let T=Math.round(f*5)/5,D=Math.round(p*5)/5,M=we(b||"").slice(0,24);return`${y||""}:${T}:${D}:${M}`})();return{title:S,url:"",summary:A,summaryHtml:A,publishedAt:Number.isNaN(g)?Date.now():g,source:m.source||t.name,category:t.category,geo:Number.isFinite(f)&&Number.isFinite(p)?{lat:f,lon:p}:null,alertType:b,eventType:b,subEventType:C,hazardType:m.disorder_type||"",severity:Number.isNaN(h)?"":`Fatalities ${h}`,location:v,geoLabel:v,conflictKey:E,tags:["conflict","security"]}});let o=(m,f)=>{for(let p of f){let h=m?.[p];if(h!=null&&String(h).trim()!=="")return h}return null},i=(m,f)=>{let p=o(m,f),h=p===null?NaN:Number(p);return Number.isFinite(h)?h:NaN},u=o(a,["week","week_start","week_end","event_date","date"]),d=1e3*60*60*24*30;return n.map(m=>{let f=i(m,["latitude","lat","centroid_latitude","admin1_latitude","location_latitude"]),p=i(m,["longitude","lon","centroid_longitude","admin1_longitude","location_longitude"]),h=o(m,["event_type","event","type"])||o(m,["sub_event_type","subevent_type"])||"Conflict",y=o(m,["disorder_type","disorder"])||"",g=o(m,["sub_event_type","subevent_type"])||"",b=o(m,["week","week_start","week_end","event_date","date"])||"",C=b?Date.parse(b):Date.now(),v=Number.isFinite(C)?Date.now()-C>d:!1,S=o(m,["admin1","admin_1","region","location","country"])||"",w=o(m,["country"])||"",I=o(m,["admin1","admin_1"])||"",A=i(m,["event_count","events","event_cnt","event_number"]),E=i(m,["fatalities","fatality","fatalities_count"]),T=i(m,["population_exposure","pop_exposure","exposure","population"]),D=y||h||"Conflict",M=`${D}${I||w?` \u2014 ${I||w}`:""}`,P=[];g&&g!==h&&P.push(g),Number.isNaN(A)||P.push(`Events: ${ce(A)}`),Number.isNaN(E)||P.push(`Fatalities: ${ce(E)}`),Number.isNaN(T)||P.push(`Exposure: ${ce(T)}`),b&&P.push(`Week: ${b}`);let B=P.join(" \u2022 "),U=(()=>{if(!Number.isFinite(f)||!Number.isFinite(p))return"";let q=Math.round(f*5)/5,F=Math.round(p*5)/5,x=we(D||"").slice(0,24);return`${b||""}:${q}:${F}:${x}`})();return{title:M,url:"",summary:B,summaryHtml:B,publishedAt:Number.isNaN(C)?Date.now():C,source:t.name,category:v?"security-lagged":t.category,geo:Number.isFinite(f)&&Number.isFinite(p)?{lat:f,lon:p}:null,alertType:D,eventType:D,subEventType:g,hazardType:y,severity:Number.isNaN(E)?"":`Fatalities ${ce(E)}`,location:S||I||w,geoLabel:S||I||w,conflictKey:U,tags:["conflict","security","aggregated"].concat(v?["lagged"]:[])}}).filter(m=>m.geo)}function Yi(e,t){let n=Array.isArray(e?.losses)?e.losses:[],a=Number(t.limit)||300;return n.slice(0,a).map(s=>{let o=typeof s.geo=="string"?s.geo:"",i=null;if(o&&o.includes(",")){let[w,I]=o.split(","),A=Number(w),E=Number(I);Number.isFinite(A)&&Number.isFinite(E)&&(i={lat:A,lon:E})}let u=s.nearest_location||"",d=s.status||"Loss",m=s.type||"Equipment",f=s.model||"",p=s.unit||"",h=s.tags||"",y=[];m&&y.push(m),f&&f!==m&&y.push(f),p&&y.push(`Unit: ${p}`),h&&y.push(`Tags: ${h}`);let g=s.date||"",b=g?Date.parse(g):Date.now(),v=`${d} \u2014 ${f||m||"Equipment Loss"}${u?` \u2022 ${u}`:""}`,S=(()=>{if(!i)return"";let w=Math.round(i.lat*5)/5,I=Math.round(i.lon*5)/5,A=we(m||"").slice(0,24);return`${g||""}:${w}:${I}:${A}`})();return{title:v,url:"https://ukr.warspotting.net/",summary:y.join(" \u2022 "),summaryHtml:y.join(" \u2022 "),publishedAt:Number.isNaN(b)?Date.now():b,source:"Warspotting",category:t.category,geo:i,alertType:d,eventType:d,hazardType:m,severity:d,location:u,geoLabel:u,conflictKey:S,tags:["conflict","security","kinetic"]}})}function Xi(e,t){let n=Array.isArray(e?.features)?e.features:[],a=(o="")=>{let i=o.match(/<a[^>]+href="([^"]+)"[^>]*>(.*?)<\/a>/i);if(!i)return{url:"",text:""};let u=i[2]?.replace(/<[^>]*>/g,"").replace(/&nbsp;|&amp;|&quot;|&#39;/g," ").trim();return{url:i[1]||"",text:u||""}},s=(o="")=>{let i=o.toLowerCase();return i.includes("battle")||i.includes("armed clash")?"battle":i.includes("explosion")||i.includes("bomb")||i.includes("airstrike")?"explosion":i.includes("violence")||i.includes("attack")||i.includes("killed")||i.includes("shot")?"violence":i.includes("protest")||i.includes("demonstrat")?"protest":i.includes("riot")?"riot":"other"};return n.map(o=>{let i=o?.properties||{},u=fa(o?.geometry);if(!u)return null;let d=i.name||"",m=Number(i.count)||0,f=a(i.html||""),p=s(`${d} ${i.html||""}`),h=Math.round(u.lat*5)/5,y=Math.round(u.lon*5)/5,g=`${p}:${h}:${y}`,b=[];return m&&b.push(`Mentions ${m}`),f.text&&b.push(f.text.slice(0,120)),{title:`Conflict signal \u2014 ${d||"Unknown location"}`,url:f.url,summary:b.join(" \u2022 "),summaryHtml:b.join(" \u2022 "),publishedAt:Date.now(),source:"GDELT",category:t.category,geo:u,alertType:p,eventType:p,location:d,geoLabel:d,conflictKey:g,tags:["conflict","security","live"]}}).filter(Boolean)}function el(e,t){return(Array.isArray(e?.Result)?e.Result:[]).map(a=>{let s=Number(a.latitude),o=Number(a.longitude);if(!Number.isFinite(s)||!Number.isFinite(o))return null;let i=Number(a.best),u=a.date_start||a.date_end||"",d=u?Date.parse(u):Date.now(),f=Number(a.type_of_violence)===1?"battle":"violence",p=a.where_description||a.adm_2||a.adm_1||a.country||"",h=a.conflict_name||"Conflict Event",y=`${h}${p?` \u2014 ${p}`:""}`,g=[];a.dyad_name&&g.push(a.dyad_name),Number.isNaN(i)||g.push(`Fatalities ${i}`),a.source_headline&&g.push(a.source_headline);let b=Math.round(s*5)/5,C=Math.round(o*5)/5,v=`${u||""}:${b}:${C}:${we(h).slice(0,24)}`;return{title:y,url:"",summary:g.join(" \u2022 "),summaryHtml:g.join(" \u2022 "),publishedAt:Number.isNaN(d)?Date.now():d,source:"UCDP",category:t.category,geo:{lat:s,lon:o},alertType:f,eventType:f,hazardType:a.conflict_name||"",severity:Number.isNaN(i)?"":`Fatalities ${i}`,location:p,geoLabel:p,conflictKey:v,tags:["conflict","security","curated"]}}).filter(Boolean)}function tl(e,t){let n=String(e||"").trim().split(/\r?\n/);if(n.length<2)return[];let a=n[0].split(",").map(s=>s.trim().toLowerCase());return n.slice(1,21).map(s=>{let o=s.split(",").map(p=>p.trim()),i={};a.forEach((p,h)=>{i[p]=o[h]});let u=i.title||i.name||i.headline||o[0]||"Untitled",d=i.url||i.link||"",m=i.summary||i.description||"",f=i.publishedat||i.date||i.published||"";return{title:u,url:d,summary:m,publishedAt:f?Date.parse(f):Date.now(),source:t.name,category:t.category}})}function er(e){let t=[],n=[],a="",s=!1;for(let o=0;o<e.length;o+=1){let i=e[o];if(i==='"'){let u=e[o+1];s&&u==='"'?(a+='"',o+=1):s=!s;continue}if(i===","&&!s){n.push(a),a="";continue}if((i===`
`||i==="\r")&&!s){i==="\r"&&e[o+1]===`
`&&(o+=1),n.push(a),n.some(u=>u.trim()!=="")&&t.push(n),n=[],a="";continue}a+=i}return(a.length||n.length)&&(n.push(a),n.some(o=>o.trim()!=="")&&t.push(n)),t}function nl(e){let t=[e?.jurisdictionCode,e?.state,e?.stateCode,e?.state_code,e?.jurisdiction?.id,e?.jurisdiction?.name,e?.from_organization?.id,e?.organization?.id];for(let n of t){let a=ze(n);if(a)return a}return""}function al(e,t){let n=[e?.jurisdictionName,e?.stateName,e?.state_name,e?.jurisdiction?.name,e?.from_organization?.name];for(let a of n)if(a)return String(a).trim();return t?Ja(t):""}function ga(e,t,n){return(Array.isArray(e?.results)?e.results:Array.isArray(e?.items)?e.items:Array.isArray(e?.bills)?e.bills:Array.isArray(e?.data)?e.data:[]).slice(0,100).map(s=>{let o=nl(s),i=al(s,o),u=s.title||s.identifier||s.name||`${i||o||"State"} ${n||"Signal"}`,d=s.openstates_url||s.url||s.link||s.permalink||"",m=s.latest_action_description||s.abstract||s.description||s.summary||"",f=s.updated_at||s.latest_action_date||s.latest_action_at||s.first_action_date||s.publishedAt||s.date||s.created_at,p=s.id||s.identifier||s.docId||"",h=s.latest_action_description||s.status||"",y=s.from_organization?.name||s.organization?.name||s.agency||"",g=s.effective_date||s.latest_action_date||"",b=f?Date.parse(f):Date.now(),C=Array.isArray(s.classification)?s.classification:Array.isArray(s.tags)?s.tags:s.classification?[s.classification]:[],v=["us","gov","state",n,...t.tags||[],...C].map(w=>String(w||"").trim().toLowerCase()).filter(Boolean),S=Array.from(new Set(v));return{title:u,url:d,summary:m,publishedAt:Number.isNaN(b)?Date.now():b,source:s.source||t.name,category:t.category,jurisdictionLevel:"state",jurisdictionCode:o,jurisdictionName:i,signalType:n,docId:String(p||""),status:h,agency:y,effectiveDate:g,tags:S}}).filter(s=>s.title)}var sl=(e,t)=>ga(e,t,"legislation"),rl=(e,t)=>ga(e,t,"rulemaking"),ol=(e,t)=>ga(e,t,"executive_order"),ms=(e,t)=>(e.results||[]).map(n=>{let a=n.publication_date?Date.parse(n.publication_date):Date.now(),s=n.comments_close_on||null,o=n.effective_on||null,i=s||o||null,u=[{label:"Document #",value:n.document_number||""},{label:"Type",value:n.type||""},{label:"Published",value:n.publication_date||""}].filter(d=>d.value);return i&&u.push({label:s?"Comments Close":"Effective",value:i}),{title:n.title,url:n.html_url,externalUrl:n.html_url,summary:n.abstract||n.type,publishedAt:a,source:"Federal Register",category:t.category,alertType:n.type,deadline:i,documentNumber:n.document_number||"",detailTitle:n.title,detailFields:u}}),il=(e,t)=>{let n=Array.isArray(e?.packages)?e.packages:[];return n.length?n.slice(0,40).map(a=>{let s=a.packageId||a.package_id||"",o=s?`https://www.govinfo.gov/app/details/${s}`:"",i=a.lastModified||a.last_modified||"",u=a.dateIssued||a.date_issued||"",d=i?Date.parse(i):u?Date.parse(u):Date.now(),m=[a.collectionCode?`Collection: ${a.collectionCode}`:"",a.docClass?`Class: ${a.docClass}`:"",a.congress?`Congress: ${a.congress}`:"",u?`Issued: ${u}`:""].filter(Boolean),f=[{label:"Package",value:s},{label:"Collection",value:a.collectionName||a.collectionCode||""},{label:"Doc Class",value:a.docClass||""},{label:"Congress",value:a.congress||""},{label:"Issued",value:u||""},{label:"Last Modified",value:i||""}].filter(p=>p.value);return{title:a.title||s||"GovInfo Package",url:o,externalUrl:o,summary:m.join(" \u2022 "),publishedAt:Number.isNaN(d)?Date.now():d,source:"GovInfo",category:t.category,alertType:a.docClass||a.collectionCode||"GovInfo",packageId:s,apiUrl:a.packageLink||"",detailTitle:a.title||s||"GovInfo Package",detailFields:f}}):[]},_e=(e,t)=>{let n=c=>!c||String(c).trim().toLowerCase()==="untitled",a=c=>{if(!c)return"";try{let k=new URL(c);return k.searchParams.delete("api_key"),k.toString()}catch{return c}},s=(c,k,N={})=>{if(!c||!k)return"";let $=String(c).toUpperCase();return`${N[$]||$} ${k}`},o=c=>{let k=c.type||c.billType||"",N=c.number||c.billNumber||c.bill?.number||"";return s(k,N,{HR:"H.R.",S:"S.",HJRES:"H.J.Res.",SJRES:"S.J.Res.",HCONRES:"H.Con.Res.",SCONRES:"S.Con.Res.",HRES:"H.Res.",SRES:"S.Res."})},i=c=>{let k=c.type||"",N=c.number||"";return s(k,N,{HAMDT:"H.Amdt.",SAMDT:"S.Amdt."})},u=c=>{let k=c.type||"",N=c.number||"",$={HRPT:"H. Rept.",SRPT:"S. Rept.",ERPT:"E. Rept."};return c.citation||s(k,N,$)},d=c=>{let k=c.voteNumber||c.rollCall||c.rollCallNumber||c.number;if(!k)return"";let N=c.session||c.sessionNumber;return N?`Roll Call ${k} \u2022 Session ${N}`:`Roll Call ${k}`},m=c=>c.name||c.committeeName||c.committee?.name||"",f=c=>c.title||c.printTitle||c.name||"",p=c=>c.meetingTitle||c.title||c.eventTitle||"",h=c=>c.title||c.description||"",y=c=>`https://www.congress.gov/search?q=${encodeURIComponent(c)}`,g=c=>typeof c=="string"&&c.includes("congress.gov/search?"),b=c=>{let k=c.congress||c.bill?.congress||c.congressReceived,N=String(c.type||c.billType||"").toUpperCase(),$=c.number||c.billNumber||c.bill?.number;if(!k||!N||!$)return c.url||c.link||"";let G={HR:"house-bill",S:"senate-bill",HJRES:"house-joint-resolution",SJRES:"senate-joint-resolution",HCONRES:"house-concurrent-resolution",SCONRES:"senate-concurrent-resolution",HRES:"house-resolution",SRES:"senate-resolution"}[N];return G?`https://www.congress.gov/bill/${k}th-congress/${G}/${$}`:c.url||c.link||""},C=c=>{let k=c.congress,N=String(c.type||"").toUpperCase(),$=c.number;if(!k||!N||!$)return c.url||"";let O=N.startsWith("S")?"senate-amendment":"house-amendment";return`https://www.congress.gov/amendment/${k}th-congress/${O}/${$}`},v=c=>{let k=c.congress,N=String(c.type||"").toUpperCase(),$=c.number;if(!k||!N||!$)return c.url||"";let O=N.startsWith("S")?"senate-report":"house-report";return`https://www.congress.gov/congressional-report/${k}th-congress/${O}/${$}`},S=c=>{let k=c.congress,N=c.session||c.sessionNumber,$=c.voteNumber||c.rollCall||c.rollCallNumber||c.number;return k&&N&&$?`https://www.congress.gov/roll-call-vote/${k}th-congress/house-session-${N}/${$}`:$?y(`house roll call vote ${$}`):c.url||""},w=c=>{let k=(c.chamber||c.committeeChamber||"").toLowerCase(),N=c.committeeCode||c.systemCode||c.committee?.systemCode||"";if(k&&N)return`https://www.congress.gov/committee/${k}/${N}`;let $=c.name||c.committeeName||"";return $?y(`${$} committee`):""},I=c=>{let k=c.jacketNumber||c.number,N=c.congress?`${c.congress}th`:"";return y(`committee print ${N} ${k||""}`.trim())},A=c=>{let k=c.congress,N=(c.chamber||c.committeeChamber||"").toLowerCase(),$=c.eventId||c.meetingId||c.event;return k&&N&&$?`https://www.congress.gov/event/${k}th-congress/${N}-event/${$}`:y(`committee meeting ${$||""}`.trim())},E=c=>{let k=c.congress,N=c.communicationType||c.type||"",$=c.communicationNumber||c.number,O=(c.chamber||c.communicationChamber||"").toLowerCase();return k&&N&&$&&O?`https://www.congress.gov/${O==="senate"?"senate":"house"}-communication/${k}th-congress/${N}/${$}`:y(`congress communication ${$||""}`.trim())},T=c=>{let k=c?.nomination||{},N=c.number||c.nominationNumber||k.number||k.nominationNumber||k.nominationId;if(N)return String(N).replace(/^PN/i,"").split("-")[0];let O=(c.citation||k.citation||"").match(/PN(\d+)(?:-(\d+))?/i);return O?O[1]:""},D=c=>{if(!c)return"";try{let k=new URL(c),N=`${k.origin}${k.pathname}`;return N.includes("/event/")&&N.includes("/text")?N.split("/text")[0]:N}catch{return c.split("#")[0].split("?")[0]}},M=c=>{let k=c.congress,N=c.nomination?.url||c.url||c.link||"";if(N&&N.includes("congress.gov/nomination"))return N;let O=String(c.citation||c.nomination?.citation||c.title||c.detailTitle||"").toUpperCase().match(/PN\d+(?:-\d+)?/);if(k&&O){let K=O[0].replace(/^PN/i,"").split("-")[0];return`https://www.congress.gov/nomination/${k}th-congress/${K}`}let G=c.number||c.nomination?.number||c.nominationNumber,W=c.partNumber||c.nomination?.partNumber;if(k&&G){if(W){let K=String(W).replace(/^0+/,"");return`https://www.congress.gov/nomination/${k}th-congress/${G}`}return`https://www.congress.gov/nomination/${k}th-congress/${G}`}return c.citation?y(c.citation):c.nomination?.url||c.url||c.link||""},P=c=>{let k=c.description||"";if(!k)return"";let[N,$]=k.split(", of "),O=k.split(" to be ");if(O.length>1){let G=O[0].replace(/,? of .*/i,"").trim(),W=O[1].replace(/, vice .*/i,"").trim();if(G&&W)return`${G} \u2014 ${W}`}if(N&&$){let G=$.split(", vice ")[0];if(G)return`${N.trim()} \u2014 ${G.trim()}`}return k},B=c=>{let k=c.hearingTitle||c.meetingTitle||c.title||c.topic;if(k&&!n(k))return k;let N=c.committeeName||"",$=c.date?le(c.date):"";return c.number?N?`${N} \u2014 Hearing ${c.number}`:`Hearing ${c.number}`:c.jacketNumber?N?`${N} \u2014 Jacket ${c.jacketNumber}`:`Hearing Jacket ${c.jacketNumber}`:"Hearing"},U=c=>{let k=c.congressReceived||c.congressConsidered,N=c.number;return k&&N?`https://www.congress.gov/treaty/${k}th-congress/${N}`:y(`treaty ${N||""}`.trim())},q=c=>{let k=[c.eventUrl,c.hearingUrl,c.meetingUrl,c.congressUrl,c.url,c.link].find(W=>typeof W=="string"&&W.includes("congress.gov")&&!W.includes("api.congress.gov"));if(k)return k;let N=c.congress,$=(c.chamber||"").toLowerCase(),O=c.eventId||c.meetingId||c.event;if(N&&O&&($==="house"||$==="senate"))return`https://www.congress.gov/event/${N}th-congress/${$}-event/${O}`;let G=c.jacketNumber;return y(["hearing",G||O||"",c.committeeName||""].filter(Boolean).join(" "))},F=c=>{let k=c.Links||{},$=(k.FullRecord||k.Digest||k.Senate||k.House||k.Remarks)?.PDF?.[0]?.Url;return $||(c.PublishDate?y(`congressional record ${c.PublishDate}`):c.url||"")},x=c=>c?Array.isArray(c)?c:Array.isArray(c.items)?c.items:Array.isArray(c.item)?c.item:Array.isArray(c.bill)?c.bill:Array.isArray(c.amendment)?c.amendment:Array.isArray(c.report)?c.report:Array.isArray(c.hearing)?c.hearing:Array.isArray(c.nomination)?c.nomination:Array.isArray(c.treaty)?c.treaty:null:null;return(x(e?.bills)||x(e?.amendments)||x(e?.committeeReports)||x(e?.committeeReport)||x(e?.reports)||x(e?.nominations)||x(e?.treaties)||x(e?.hearings)||x(e?.committeeMeetings)||x(e?.committee)||x(e?.committees)||x(e?.committeePrints)||x(e?.committeePrint)||x(e?.houseVotes)||x(e?.houseVote)||x(e?.houseRollCallVotes)||x(e?.houseCommunications)||x(e?.houseCommunication)||x(e?.senateCommunications)||x(e?.senateCommunication)||x(e?.summaries)||x(e?.congressionalRecord)||x(e?.dailyCongressionalRecord)||x(e?.records)||x(e?.Results?.Issues)||x(e?.results)||[]).map(c=>{let k=c.number||c.billNumber||c.amendmentNumber||c.reportNumber||c.voteNumber||c.rollCallNumber||c.communicationNumber||c.jacketNumber||c.nominationNumber||c.treatyNumber||c.citation||c.report?.citation||"",N=c.title||c.shortTitle||c.name||c.bill?.title||c.report?.title||"",$=o(c)||i(c)||u(c),O=c.PublishDate?`Congressional Record \u2014 ${c.PublishDate}`:"",G=$||O||k,W=c.latestAction?.actionDate||c.latestAction?.actionDateTime||c.actionDate||c.date,re=c.updateDate||c.updateDateIncludingText||c.updateDateTime||c.updatedDate,K=c.text||c.summaryText||"",H=K?he(K):"",j=c.lastSummaryUpdateDate||c.updateDate||c.updateDateTime||c.updateDateIncludingText||"",ge=j?Date.parse(j):null,oe=c.actionDesc||"",xe=c.versionCode||"",ye=W?Date.parse(W):c.PublishDate?Date.parse(c.PublishDate):re?Date.parse(re):Date.now(),Qe=c.latestAction?.text||c.latestAction?.action||c.latestAction?.actionDesc||"",R=t.congressType||(c.type&&c.type.includes("AMDT")?"Amendment":"")||(c.type&&c.type.includes("RPT")?"Committee Report":"")||(c.citation&&c.citation.startsWith("PN")?"Nomination":"")||(c.voteNumber||c.rollCall||c.rollCallNumber?"House Vote":"")||(c.committeeCode||c.systemCode||c.committee?.systemCode?"Committee":"")||(c.printTitle||c.jacketNumber?"Committee Print":"")||(c.meetingType||c.eventId?"Committee Meeting":"")||(c.communicationType?"Communication":"")||(c.topic?"Treaty":"")||(c.Links?"Congressional Record":"")||(c.jacketNumber||c.chamber?"Hearing":"")||(c.summaryText||c.summary||c.bill?.title?"Summary":"")||"Bill";(n(N)||String(N).toLowerCase().includes("untitled"))&&(R==="Hearing"?N=B(c):R==="Committee Report"?N=u(c)||`Committee Report ${k||""}`.trim():R==="Amendment"?N=i(c)||`Amendment ${k||""}`.trim():R==="House Vote"?N=d(c)||`House Vote ${k||""}`.trim():R==="Committee"?N=m(c)||`Committee ${k||""}`.trim():R==="Committee Print"?N=f(c)||`Committee Print ${k||""}`.trim():R==="Committee Meeting"?N=p(c)||`Committee Meeting ${k||""}`.trim():R==="Communication"?N=h(c)||`Communication ${k||""}`.trim():R==="Summary"?N=o(c.bill||c)||c.bill?.title||c.summaryTitle||`Summary ${k||""}`.trim():R==="Nomination"?N=P(c)||c.citation||`Nomination ${k||""}`.trim():R==="Treaty"?N=c.topic?`${c.topic} Treaty`:`Treaty ${k||""}`.trim():R==="Congressional Record"?N=c.PublishDate?`Congressional Record ${c.PublishDate}`:"Congressional Record":N=o(c)||`Bill ${k||""}`.trim());let Na=(G&&N&&N!==G?`${G} \u2014 ${N}`:N||G)||"Untitled",de=Qe||c.summary||c.description||c.action||H||"";if(R==="Summary"&&H&&(de=se(H,360)),!de){if(R==="Bill"){let Y=c.originChamber||c.chamber||"",ee=o(c)||`${c.type||""} ${c.number||""}`.trim();de=[Y,ee,c.latestAction?.actionDate].filter(Boolean).join(" \u2022 ")}else if(R==="Amendment")de=c.purpose?`Purpose: ${c.purpose}`:i(c)||"Amendment";else if(R==="House Vote"){let Y=c.question||c.voteQuestion||c.title||"",ee=c.result||c.voteResult||c.voteResultText||"",Pe=c.voteDate||c.startDate||c.actionDate||c.date||c.updateDate;de=[Y,ee,Pe?le(Pe):""].filter(Boolean).join(" \u2022 ")}else if(R==="Committee"){let Y=c.chamber||c.committeeChamber||"",ee=c.committeeCode||c.systemCode||c.committee?.systemCode||"";de=[Y,ee].filter(Boolean).join(" \u2022 ")}else if(R==="Committee Print"){let Y=c.committeeName||c.committee?.name||"",ee=c.jacketNumber||c.number||"";de=[Y,ee?`Jacket ${ee}`:"",c.chamber||""].filter(Boolean).join(" \u2022 ")}else if(R==="Committee Meeting"){let Y=c.committeeName||c.committee?.name||"",ee=c.date||c.meetingDate||c.startDate;de=[Y,c.meetingType||"",ee?le(ee):""].filter(Boolean).join(" \u2022 ")}else if(R==="Communication"){let Y=c.chamber||c.communicationChamber||"",ee=c.communicationType||c.type||"",Pe=c.communicationNumber||c.number||"";de=[Y,ee?ee.toUpperCase():"",Pe].filter(Boolean).join(" \u2022 ")}else if(R==="Summary"){let Y=o(c.bill||c)||"",ee=j||c.updateDate||c.updateDateTime||c.latestAction?.actionDate;de=[Y,ee?`Updated ${le(ee)}`:""].filter(Boolean).join(" \u2022 ")}else if(R==="Committee Report"){let Y=c.citation||u(c),ee=c.part?`Part ${c.part}`:"";de=[c.chamber,Y,ee].filter(Boolean).join(" \u2022 ")}else if(R==="Hearing"){let Y=c.hearingTitle||c.meetingTitle||c.title||"",ee=c.number?`Hearing ${c.number}`:"",Pe=c.jacketNumber?`Jacket ${c.jacketNumber}`:"",Yr=c.committeeName||"",Xr=c.date?le(c.date):"";de=[Yr,c.chamber,Y,ee,Pe,Xr].filter(Boolean).join(" \u2022 ")}else if(R==="Nomination")de=c.description||(c.organization?`Organization: ${c.organization}`:"Nomination");else if(R==="Treaty"){let Y=c.transmittedDate?`Transmitted ${le(c.transmittedDate)}`:"";de=[c.topic||"Treaty",Y].filter(Boolean).join(" \u2022 ")}else if(R==="Congressional Record"){let Y=c.Issue?`Issue ${c.Issue}`:"",ee=c.Volume?`Volume ${c.Volume}`:"",Pe=c.Session?`Session ${c.Session}`:"";de=[Y,ee,Pe].filter(Boolean).join(" \u2022 ")}}de||(de=[c.chamber,c.organization,c.topic,c.purpose].filter(Boolean).join(" \u2022 ")),R==="Summary"&&ge&&(ye=ge);let An=a(c.url&&String(c.url).includes("api.congress.gov")?c.url:c.link&&String(c.link).includes("api.congress.gov")?c.link:""),Q=c.url||c.link||c.links?.self||c.bill?.url||c.report?.url||"";c.Links?Q=F(c):c.type&&(c.type.includes("AMDT")||c.amendmentNumber)?Q=C(c)||Q:c.type&&c.type.includes("RPT")?Q=v(c)||Q:R==="House Vote"?Q=S(c)||Q:R==="Committee"?Q=w(c)||Q:R==="Committee Print"?Q=I(c)||Q:R==="Committee Meeting"?Q=A(c)||Q:R==="Communication"?Q=E(c)||Q:R==="Summary"?(Q=b(c.bill||c)||Q,!An&&c.bill?.url&&(An=a(c.bill.url))):c.citation&&c.citation.startsWith("PN")?Q=M(c)||Q:c.topic&&(c.congressReceived||c.congressConsidered)?Q=U(c)||Q:c.jacketNumber||c.chamber?Q=q(c)||Q:(c.type||c.billNumber||c.bill?.number)&&(Q=b(c)||Q);let jr=Q&&!g(Q)?Q:"",Gr=Q||"",Tn=c.congress||c.bill?.congress||c.congressReceived||c.congressConsidered||"",qr=c.billType||c.bill?.type||(R==="Bill"?c.type:"")||"",zr=c.billNumber||c.bill?.number||(R==="Bill"?c.number:"")||"",Kr=R==="Amendment"&&(c.type||c.amendmentType)||"",Wr=R==="Amendment"&&(c.number||c.amendmentNumber)||"",Ma=c.voteNumber||c.rollCall||c.rollCallNumber||(R==="House Vote"?c.number:""),Fa=c.session||c.sessionNumber||"",Da=c.committeeCode||c.systemCode||c.committee?.systemCode||"",En=c.committeeChamber||c.chamber||c.committee?.chamber||"",Vr=c.reportType||(R==="Committee Report"?c.type:"")||"",Jr=c.reportNumber||(R==="Committee Report"?c.number:"")||"",Pa=c.jacketNumber||(R==="Committee Print"?c.number:"")||"",$a=c.communicationType||c.type||"",Ba=c.communicationNumber||(R==="Communication"?c.number:"")||"",Zr=c.communicationChamber||c.chamber||"",Ra=[],J=(Y,ee)=>{ee&&Ra.push({label:Y,value:String(ee)})};if(J("Type",R),J("Chamber",c.originChamber||c.chamber||c.committeeName),J("Congress",Tn?`${Tn}th Congress`:""),J("Number",k),J("Jacket",c.jacketNumber),J("Citation",c.citation||c.report?.citation),J("Committee",c.committeeName||c.committees?.[0]?.name),R==="House Vote"&&(J("Session",Fa),J("Vote Number",Ma),J("Result",c.result||c.voteResult||""),J("Question",c.question||c.voteQuestion||"")),R==="Committee"&&(J("Committee Code",Da),J("Chamber",En||c.chamber)),R==="Committee Print"&&(J("Chamber",En||c.chamber),J("Jacket",Pa)),R==="Committee Meeting"&&(J("Meeting Type",c.meetingType||c.type),J("Event ID",c.eventId||c.meetingId||"")),R==="Communication"&&(J("Communication Type",$a),J("Communication Number",Ba)),R==="Hearing"&&(J("Hearing Title",c.hearingTitle||c.meetingTitle||c.title||c.topic||""),J("Meeting Type",c.meetingType||c.type),J("Hearing Date",c.date?le(c.date):""),J("Event ID",c.eventId||c.meetingId||"")),J("Topic",c.topic),J("Organization",c.organization),R==="Nomination"){let Y=P(c);Y&&J("Nominee",Y)}J("Latest Action",Qe),J("Action Date",W?le(W):""),J("Updated",re?le(re):""),J("Source ID",c.systemCode||c.billId||c.reportId||c.hearingId);let Qr=R==="Nomination"?T(c):"";return{title:Na,url:"",externalUrl:jr,fallbackUrl:Gr,apiUrl:An,summary:de,publishedAt:Number.isNaN(ye)?Date.now():ye,source:"Congress.gov",category:t.category,alertType:R,detailTitle:Na,detailFields:Ra,summaryHtml:K,summaryUpdatedAt:ge,summaryVersionCode:xe,summaryActionDesc:oe,congress:Tn,billType:qr,billNumber:zr,amendmentType:Kr,amendmentNumber:Wr,voteNumber:Ma,voteSession:Fa,committeeCode:Da,committeeChamber:En,reportType:Vr,reportNumber:Jr,jacketNumber:Pa,communicationType:$a,communicationNumber:Ba,communicationChamber:Zr,nominationId:Qr,location:c.originChamber||c.committeeName||c.chamber||c.organization||c.latestAction?.actionType||""}})},Rn=(e,t)=>{let n=Array.isArray(e?.series)?e.series:[];if(n.length){let s=n.flatMap(o=>{if(!Array.isArray(o.data)||!o.data.length)return[];let i=o.name||o.series_id||"EIA Series Update",u=o.units?` ${o.units}`:"",d=o.data[0],m=o.data[1],f=m?Number(d[1])-Number(m[1]):null,p=m&&Number(m[1])?f/Number(m[1])*100:null;return o.data.slice(0,4).map(([h,y],g)=>{let b=y!=null?ce(y):"--";return{title:g===0?i:`${i} (${h})`,url:o.link||t.docsUrl||t.url,summary:`${h||"Latest"}: ${b}${u}`,publishedAt:Date.now()-g*3600*1e3,source:"EIA",category:t.category,value:Number(y),unit:o.units||"",delta:g===0?f:null,deltaPct:g===0?p:null}})});if(s.length)return s}let a=e?.response;if(a&&Array.isArray(a.data)&&a.data.length){let s=a.description||a.series_id||e.series_id||"EIA Series Update";return a.data.slice(0,4).map((o,i)=>{let u=o.period||o.date||o.timestamp||o.time,d=o.value??o.price??o.data;if(d===void 0&&o){let f=Object.keys(o).find(p=>!["period","date","timestamp","time","series","series_id"].includes(p));d=o[f]}let m=d!=null?ce(d):"--";return{title:i===0?s:`${s} (${u})`,url:t.docsUrl||t.url,summary:`${u||"Latest"}: ${m}`,publishedAt:Date.now()-i*3600*1e3,source:"EIA",category:t.category,value:Number(d)}})}return[]},ll=(e,t)=>{let n=Array.isArray(e)?e:e?.markets||e?.data||[];if(!Array.isArray(n)||!n.length)return[];let a=i=>{let u=Number(i);return Number.isFinite(u)?u:null},s=i=>{if(!i)return[];if(Array.isArray(i))return i;try{let u=JSON.parse(i);return Array.isArray(u)?u:[]}catch{return[]}};return[...n].sort((i,u)=>{let d=a(i.volume24hr??i.volume)||0;return(a(u.volume24hr??u.volume)||0)-d}).slice(0,60).map(i=>{let u=s(i.outcomes),d=s(i.outcomePrices),m=u.findIndex(M=>String(M).toLowerCase()==="yes"),f=m>=0?m:0,p=d[f]!==void 0?Number(d[f]):null,h=a(i.bestBid),y=a(i.bestAsk),g=Number.isFinite(h)&&Number.isFinite(y)?(h+y)/2:null,b=Number.isFinite(g)?g:a(i.lastTradePrice),C=Number.isFinite(p)?p:b,v=Number.isFinite(C)?Math.round(C*100):null,S=u[f]||"Yes",w=a(i.volume24hr)||a(i.volume24hrClob)||a(i.volume)||0,I=a(i.liquidity)||a(i.liquidityClob)||0,A=a(i.oneDayPriceChange),E=[];v!==null&&E.push(`${S}: ${v}%`),w&&E.push(`24h Vol ${Se(w)}`),I&&E.push(`Liq ${Se(I)}`);let T=i.endDate||i.endDateIso;T&&E.push(`Ends ${new Date(T).toLocaleDateString("en-US")}`);let D=i.updatedAt||i.createdAt||i.startDate||i.endDate;return{title:i.question||i.title||"Polymarket Market",url:i.slug?`https://polymarket.com/market/${i.slug}`:"https://polymarket.com/",summary:E.join(" \u2022 "),publishedAt:D?Date.parse(D):Date.now(),source:"Polymarket",category:t.category,value:v!==null?v:null,alertType:"Prediction",volume24:w,liquidity:I,probability:v,outcomeLabel:S,change24h:A}})},cl=(e,t)=>{if(!e)return[];let n=er(e);if(n.length<2)return[];let a=n[0].map(i=>i.trim().toLowerCase()),s=i=>a.indexOf(i),o=(i,u)=>{let d=s(u);return d>=0?i[d]:""};return n.slice(1,101).map(i=>{let u=o(i,"id"),d=o(i,"name"),m=o(i,"location"),f=o(i,"threat")||"Oil",p=o(i,"commodity"),h=o(i,"open_date"),y=Number(o(i,"lat")),g=Number(o(i,"lon"));if(!Number.isFinite(y)||!Number.isFinite(g))return null;let b=[];return f&&b.push(f),p&&b.push(p),m&&b.push(m),{title:d||"Incident",url:u?`https://incidentnews.noaa.gov/incident/${u}`:"https://incidentnews.noaa.gov/",summary:b.join(" \u2022 "),publishedAt:h?Date.parse(h):Date.now(),source:"NOAA IncidentNews",category:t.category,geo:{lat:y,lon:g},alertType:f||"Spill",location:m,severity:f}}).filter(Boolean)},tr=(e,t)=>{if(!e)return[];let n=e.trim().split(/\r?\n/);if(n.length<2)return[];let a=n[0].split(",").map(m=>m.trim()),s=n[1].split(",").map(m=>m.trim());if(s.length<a.length)return[];let o=a.reduce((m,f,p)=>(m[f]=s[p],m),{});if(!o.Symbol||!o.Close||o.Close==="N/D")return[];let i=Number(o.Close);if(!Number.isFinite(i))return[];let u=Number(o.Open),d=Number.isFinite(u)&&u?(i-u)/u*100:null;return[{title:`${o.Symbol} Price`,url:`https://stooq.com/q/?s=${encodeURIComponent(o.Symbol.toLowerCase())}`,summary:`Close ${ce(i)} | ${o.Date||"Latest"} ${o.Time||""}`.trim(),publishedAt:Date.now(),source:"Stooq",category:t.category,value:i,deltaPct:d,symbol:o.Symbol}]},Ht={"gdelt-doc":(e,t)=>(e.articles||[]).map(n=>({title:n.title,url:n.url,summary:n.seen||"",publishedAt:n.seendate?Date.parse(n.seendate):Date.now(),source:n.domain||n.sourceCountry||t.name,category:t.category})),"gdelt-conflict-geo":Xi,"ucdp-candidate-events":el,"state-legislation":sl,"state-rulemaking":rl,"state-executive-orders":ol,"federal-register":ms,"federal-register-transport":ms,"govinfo-api":il,"congress-api":_e,"congress-amendments":_e,"congress-summaries":_e,"congress-reports":_e,"congress-hearings":_e,"congress-nominations":_e,"congress-treaties":_e,"congress-record":_e,"nws-alerts":(e,t)=>(e.features||[]).map(n=>({title:n.properties.event,url:n.properties.uri,summary:n.properties.headline,publishedAt:Date.parse(n.properties.sent)||Date.now(),source:"NWS",category:t.category,geo:fa(n.geometry),severity:n.properties.severity,location:n.properties.areaDesc,alertType:n.properties.event})),"usgs-quakes-hour":(e,t)=>ps(e,t),"usgs-quakes-day":(e,t)=>ps(e,t),"eonet-events":(e,t)=>(e.events||[]).map(n=>({title:n.title,url:n.link,summary:n.description||"",publishedAt:n.geometry?.[0]?.date?Date.parse(n.geometry[0].date):Date.now(),source:"NASA EONET",category:t.category,geo:n.geometry?.[0]?{lat:n.geometry[0].coordinates[1],lon:n.geometry[0].coordinates[0]}:null})),"swpc-json":(e,t)=>{if(!Array.isArray(e)||!e.length)return[];let n=e[e.length-1],a=n.speed??n.vsw??n.VSW,s=n.density??n.proton_density??n.DENSITY,o=n.temperature??n.TEMP,i=[];return a&&i.push(`Speed ${ce(a)} km/s`),s&&i.push(`Density ${ce(s)} p/cm3`),o&&i.push(`Temp ${ce(o)} K`),[{title:"SWPC Solar Wind (1m)",url:"https://services.swpc.noaa.gov/json/",summary:i.length?i.join(" | "):"Solar wind updated.",publishedAt:n.time_tag?Date.parse(n.time_tag):Date.now(),source:"NOAA SWPC",category:t.category,alertType:"Solar Wind"}]},"swpc-kp":(e,t)=>{if(!Array.isArray(e)||!e.length)return[];let n=e[e.length-1],a=Number(n.kp_index??n.kp);if(!Number.isFinite(a))return[];let s="Quiet";a>=5?s="Storm":a>=4&&(s="Active");let o=`Kp ${a.toFixed(1)} (${s})`;return[{title:"Geomagnetic Kp Index",url:"https://www.swpc.noaa.gov/products/planetary-k-index",summary:o,publishedAt:n.time_tag?Date.parse(n.time_tag):Date.now(),source:"NOAA SWPC",category:t.category,severity:o,alertType:"Geomagnetic"}]},"energy-eia":Rn,"energy-eia-brent":Rn,"energy-eia-ng":Rn,"acled-events":Qi,"warspotting-losses":Yi,"polymarket-markets":ll,"noaa-incidentnews":cl,"stooq-quote":tr,"transport-opensky":(e,t)=>{let n=Array.isArray(e?.states)?e.states:[];if(!n.length)return[];let a=n.filter(d=>Number.isFinite(d?.[5])&&Number.isFinite(d?.[6])),s=r.settings.scope;if(s==="us"){let d=ft();d?.bbox&&(a=a.filter(m=>Yt(m?.[6],m?.[5],d)))}else if(s==="local"){let{lat:d,lon:m}=r.location,f=r.settings.radiusKm||200;a=a.filter(p=>Rt(d,m,p?.[6],p?.[5])<=f)}let i=ti(a,s==="global"?240:s==="us"?160:80),u=e?.time?e.time*1e3:Date.now();return i.map(d=>{let m=d?.[0]||"",p=(d?.[1]||"").toString().trim()||m||"Flight",h=d?.[2]||"",y=Number.isFinite(d?.[9])?d[9]:null,g=Number.isFinite(y)?`${Math.round(y*3.6)} km/h`:null,b=Number.isFinite(d?.[7])?d[7]:null,C=Number.isFinite(b)?`${Math.round(b*3.28084)} ft`:null,v=Number.isFinite(d?.[10])?Math.round(d[10]):null,S=!!d?.[8],w=[g,C].filter(Boolean);return{title:`${p} \u2022 ${h||"Unknown"}`,url:m?`https://opensky-network.org/api/tracks/all?icao24=${encodeURIComponent(m)}`:"https://opensky-network.org/",summary:w.length?w.join(" | "):"Airborne signal",publishedAt:d?.[4]?d[4]*1e3:u,source:"OpenSky",category:t.category,geo:{lat:d[6],lon:d[5]},icao24:m,callsign:p,originCountry:h,velocity:y,altitude:b,heading:v,onGround:S,alertType:"Flight"}})},"coinpaprika-global":(e,t)=>[{title:`Global Market Cap: $${ce(e.market_cap_usd)}`,url:"https://coinpaprika.com",summary:`24h Volume $${ce(e.volume_24h_usd)} | Dominance BTC ${e.bitcoin_dominance_percentage?.toFixed(2)}%`,publishedAt:Date.now(),source:"CoinPaprika",category:t.category,value:Number(e.market_cap_usd),secondaryValue:Number(e.volume_24h_usd),dominance:Number(e.bitcoin_dominance_percentage)}],"coinpaprika-tickers":(e,t)=>e.slice(0,10).map(n=>({title:`${n.name} (${n.symbol})`,url:`https://coinpaprika.com/coin/${n.id}/`,summary:`Price $${n.quotes.USD.price.toFixed(2)} | 24h ${n.quotes.USD.percent_change_24h?.toFixed(2)}%`,publishedAt:Date.now(),source:"CoinPaprika",category:t.category,value:Number(n.quotes.USD.price),change24h:Number(n.quotes.USD.percent_change_24h),symbol:n.symbol})),"blockstream-mempool":(e,t)=>[{title:`Bitcoin Mempool: ${ce(e.count)} tx`,url:"https://blockstream.info",summary:`vSize ${ce(e.vsize)} | Fees ${ce(e.total_fee)} sat`,publishedAt:Date.now(),source:"Blockstream",category:t.category}],"openaq-api":(e,t)=>{let n=Array.isArray(e?.results)?e.results:[];return n.length?n.slice(0,12).map(a=>{let s=a.coordinates||{},o=Number(s.latitude??s.lat),i=Number(s.longitude??s.lon),u=Number.isFinite(o)&&Number.isFinite(i),d=a.locality||a.city||a.name,m=a.country?.name||a.country?.code||a.country,f=a.provider?.name||a.provider||"OpenAQ",p=Array.isArray(a.parameters)?a.parameters.map(y=>y.name||y.parameter).filter(Boolean):[],h=[];return m&&h.push(m),p.length&&h.push(`Sensors: ${p.slice(0,4).join(", ")}`),{title:d?`${d}`:"Air Quality Station",url:a.id?`https://openaq.org/locations/${a.id}`:"https://openaq.org/",summary:h.length?h.join(" | "):"Air quality station update.",publishedAt:a.updatedAt?Date.parse(a.updatedAt):Date.now(),source:f,category:t.category,alertType:"Air Quality",regionTag:m,geo:u?{lat:o,lon:i}:null,mapOnly:!0}}):[]},"foia-api":(e,t)=>{let n=Array.isArray(e?.result?.results)?e.result.results:null;if(n)return n.slice(0,12).map(s=>({title:s.title||s.name||"FOIA Dataset",url:s.url||(s.name?`https://catalog.data.gov/dataset/${s.name}`:""),summary:s.notes||"",publishedAt:s.metadata_modified?Date.parse(s.metadata_modified):Date.now(),source:s.organization?.title||"Data.gov",category:t.category}));let a=Array.isArray(e?.data)?e.data:[];return a.length?a.slice(0,12).map(s=>({title:s.attributes?.name||s.attributes?.title||"FOIA Component",url:s.links?.self||"https://www.foia.gov/developer/",summary:s.attributes?.description||"",publishedAt:Date.parse(s.attributes?.updated_at||s.attributes?.created_at)||Date.now(),source:"FOIA.gov",category:t.category})):[]},"treasury-debt":(e,t)=>(e.data||[]).map(n=>({title:`Debt to the Penny (${n.record_date})`,url:"https://fiscaldata.treasury.gov/",summary:`Total: $${ce(n.tot_pub_debt_out_amt||n.total_public_debt_outstanding_amt)} | Intragov: $${ce(n.intragov_hold_amt||n.intragovernmental_holdings)}`,publishedAt:Date.parse(n.record_date)||Date.now(),source:"US Treasury",category:t.category,value:Number(n.tot_pub_debt_out_amt||n.total_public_debt_outstanding_amt),secondaryValue:Number(n.intragov_hold_amt||n.intragovernmental_holdings)})),"bls-cpi":(e,t)=>{let n=e.Results?.series?.[0]?.data?.[0];return n?[{title:`CPI (CUUR0000SA0) ${n.periodName} ${n.year}`,url:"https://www.bls.gov/",summary:`Value ${n.value}`,publishedAt:Date.now(),source:"BLS",category:t.category,value:Number(n.value)}]:[]},"cisa-kev":(e,t)=>(e.vulnerabilities||[]).slice(0,8).map(n=>({title:`${n.cveID} | ${n.vendorProject}`,url:"https://www.cisa.gov/known-exploited-vulnerabilities-catalog",summary:`${n.product} | Due ${n.dueDate}`,publishedAt:Date.parse(n.dateAdded)||Date.now(),source:"CISA KEV",category:t.category,alertType:"Known Exploited",deadline:n.dueDate,severity:n.knownRansomwareCampaignUse&&n.knownRansomwareCampaignUse!=="Unknown"?"Ransomware":"Exploited"}))};function ps(e,t){return(e.features||[]).map(n=>({title:`${n.properties.mag.toFixed(1)}M - ${n.properties.place}`,url:n.properties.url,summary:`Depth ${n.geometry.coordinates[2]} km`,publishedAt:n.properties.time||Date.now(),source:"USGS",category:t.category,magnitude:n.properties.mag,severity:(()=>{let a=n.properties.mag;if(a==null)return null;let s=zo.find(o=>a>=o.min);return s?`Magnitude ${a.toFixed(1)} (${s.label})`:`Magnitude ${a.toFixed(1)}`})(),location:n.properties.place,alertType:"Earthquake",geo:{lat:n.geometry.coordinates[1],lon:n.geometry.coordinates[0]}}))}function fa(e){if(!e||!e.coordinates)return null;if(e.type==="Point")return{lat:e.coordinates[1],lon:e.coordinates[0]};if(e.type==="MultiPoint"){let a=e.coordinates;return a?.length?{lat:a[0][1],lon:a[0][0]}:null}if(e.type==="LineString"){let a=e.coordinates;if(!a?.length)return null;let s=a[Math.floor(a.length/2)];return{lat:s[1],lon:s[0]}}if(e.type==="MultiLineString"){let a=e.coordinates?.[0];if(!a?.length)return null;let s=a[Math.floor(a.length/2)];return{lat:s[1],lon:s[0]}}let t=e.type==="Polygon"?e.coordinates[0]:e.type==="MultiPolygon"?e.coordinates[0][0]:null;if(!t||!t.length)return null;let n=t.reduce((a,s)=>(a.lat+=s[1],a.lon+=s[0],a),{lat:0,lon:0});return{lat:n.lat/t.length,lon:n.lon/t.length}}function ce(e){if(e==null)return"--";let t=Number(e);return Number.isNaN(t)?e:t.toLocaleString("en-US",{maximumFractionDigits:2})}function le(e){if(!e)return"--";let t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function ya(e){return e&&new DOMParser().parseFromString(e,"text/html").documentElement.textContent||""}function he(e){if(!e)return"";let t=e;return(t.includes("&lt;")||t.includes("&gt;"))&&(t=ya(t)),new DOMParser().parseFromString(`<div>${t}</div>`,"text/html").body.textContent||""}function se(e,t){if(!e)return"";if(e.length<=t)return e;let n=e.slice(0,t),a=n.lastIndexOf(" ");return`${n.slice(0,a>80?a:t).trim()}\u2026`}function gs(e,t){let n=t&&t!==e?t:e;if(!n)return{summary:e||"",summaryHtml:""};let a=n;return(n.includes("&lt;")||n.includes("&gt;"))&&(a=ya(n)),a.includes("<")&&a.includes(">")?{summary:he(a).replace(/\s+/g," ").trim()||e||"",summaryHtml:a}:{summary:e||a,summaryHtml:""}}function nr(e){return e?(e in r.listLimits||(r.listLimits[e]=Ro[e]??6),r.listLimits[e]):6}function Yn(e){if(!e)return"";let t=e;(t.includes("&lt;")||t.includes("&gt;"))&&(t=ya(t));let a=new DOMParser().parseFromString(`<div>${t}</div>`,"text/html"),s=a.body.firstElementChild;if(!s)return"";let o=i=>{if(i.nodeType===Node.TEXT_NODE)return;if(i.nodeType!==Node.ELEMENT_NODE){i.remove();return}let u=i.tagName.toLowerCase();if(!No.has(u)){let d=a.createTextNode(i.textContent||"");i.replaceWith(d);return}[...i.attributes].forEach(d=>{u==="a"&&d.name==="href"||i.removeAttribute(d.name)}),u==="a"&&(i.setAttribute("target","_blank"),i.setAttribute("rel","noopener noreferrer")),[...i.childNodes].forEach(o)};return[...s.childNodes].forEach(o),s.innerHTML}function ha(e,t={}){return Number.isFinite(e)?new Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:2,...t}).format(e):"--"}function Se(e){return Number.isFinite(e)?`$${ha(e)}`:"--"}function De(e){return`${e.type}:${e.lookup}`}function ar(e){return Number.isFinite(e.value)?e.isIndex?ha(e.value):Se(e.value):"--"}function On(e=""){if(!e)return"";let t=e.split("|");return t.length<2?"":t[1].trim()}function ul(){let e=r.settings.tickerWatchlist||[];if(!e.length&&!r.customTickers.length)return[];let t=new Map;return r.customTickers.forEach(n=>{let a=De({type:n.type,lookup:n.lookup||n.symbol||n.label||""});t.set(a,n)}),e.map(n=>{let a=De(n),s=t.get(a);if(!s)return{text:`${n.label||n.symbol}: --`,url:n.url||"",change:null,pending:!0};let o=ar(s),i=Number.isFinite(s.delta)?`${s.delta>0?"+":""}${s.delta.toFixed(2)}%`:"",u=[`${s.label}: ${o}`];return i&&u.push(`24h ${i}`),{text:u.join(" | "),url:s.url,change:s.delta}})}function dl(e){return e.trim().replace(/\s+/g,"").replace(/[^a-zA-Z0-9.^-]/g,"").toUpperCase()}async function ml(e,t){if(!r.settings.aiTranslate||!Me())return null;let n=`Return the best ${e==="market"?"market index":"equity"} ticker symbol for "${t}". Use ^ prefix for indices. Return only the symbol or UNKNOWN.`;try{let s=(await ht({messages:[{role:"user",content:n}],context:{mode:"ticker_resolve",type:e},temperature:0})||"").split(/\s+/)[0].replace(/[^a-zA-Z0-9.^-]/g,"").toUpperCase();return!s||s.includes("UNKNOWN")?null:s}catch{return null}}async function pl(e,t){let n=t.trim();if(!n)return null;if(e==="crypto"){let u=await(await fetch(`https://api.coinpaprika.com/v1/search/?q=${encodeURIComponent(n)}&c=currencies`)).json();if(!u?.currencies?.length)return null;let d=n.replace(/\s+/g,"").toLowerCase(),m=u.currencies.find(f=>f.symbol?.toLowerCase()===d)||u.currencies[0];return m?{type:"crypto",symbol:m.symbol,label:`${m.name} (${m.symbol})`,lookup:m.id,source:"CoinPaprika"}:null}let a=dl(n);if(!a)return null;if((/\s/.test(n)||n.length>6)&&Me()){let i=await ml(e,n);i&&(a=i)}let s=e==="market"||a.startsWith("^"),o=a;return e==="market"&&!a.startsWith("^")&&(o=`^${a}`,a=`^${a}`),!o.includes(".")&&!o.startsWith("^")&&(o=`${o}.US`),{type:e==="market"?"market":"equity",symbol:a,label:a,lookup:o.toLowerCase(),isIndex:s,source:"Stooq"}}async function Vt(e){let t=r.feeds.find(a=>a.id==="stooq-quote");if(!t)return null;if(ne()){let a=`https://stooq.com/q/l/?s=${encodeURIComponent(e)}&f=sd2t2ohlcv&h&e=csv`,s=["allorigins","jina"];for(let o of s)try{let i=va(a,o),u=await fetch(i);if(!u.ok)continue;let d=await u.text(),m=tr(d,t);if(m?.[0])return m[0]}catch{}return null}return(await ea(t,e,!0)).items?.[0]||null}async function gl(e){let n=await(await fetch(`https://api.coinpaprika.com/v1/tickers/${e}`)).json();return!n||!n.quotes?.USD?null:{value:Number(n.quotes.USD.price),delta:Number(n.quotes.USD.percent_change_24h),url:`https://coinpaprika.com/coin/${n.id}/`,name:n.name,symbol:n.symbol}}function Xn(){document.querySelectorAll("[data-watchlist]").forEach(t=>{t.innerHTML="";let n=r.settings.tickerWatchlist||[];if(!n.length){let a=document.createElement("div");a.className="ticker-builder-hint",a.textContent="No custom tickers yet.",t.appendChild(a);return}n.forEach(a=>{let s=document.createElement("div");s.className=`ticker-chip ${a.type}`;let o=document.createElement("span");o.textContent=a.label||a.symbol;let i=document.createElement("button");i.className="ticker-remove",i.type="button",i.textContent="\xD7",i.dataset.key=De(a),s.appendChild(o),s.appendChild(i),t.appendChild(s)})})}async function fs(){if(ne()&&!r.settings.superMonitor)try{let s=await fetch(Be(`/data/energy-market.json?ts=${Date.now()}`),{cache:"no-store"});if(s.ok){let o=await s.json();if(o?.items){r.energyMarket=o.items;return}}}catch{}let[e,t,n]=await Promise.all([Vt("cl.f"),Vt("ng.f"),Vt("xauusd")]),a={};e?.value&&(a.wti={label:"WTI Crude",value:e.value,delta:Number.isFinite(e.deltaPct)?e.deltaPct:null,url:e.url,asOf:On(e.summary||""),symbol:e.symbol}),t?.value&&(a.gas={label:"Nat Gas",value:t.value,delta:Number.isFinite(t.deltaPct)?t.deltaPct:null,url:t.url,asOf:On(t.summary||""),symbol:t.symbol}),n?.value&&(a.gold={label:"Gold",value:n.value,delta:Number.isFinite(n.deltaPct)?n.deltaPct:null,url:n.url,asOf:On(n.summary||""),symbol:n.symbol}),r.energyMarket=a}async function ba(){let e=r.settings.tickerWatchlist||[];if(!e.length){r.customTickers=[],Xn(),await fs();return}let t=await Promise.all(e.map(async n=>{if(n.type==="crypto"){let s=await gl(n.lookup);return!s||!Number.isFinite(s.value)?null:{label:n.label||`${s.name} (${s.symbol})`,value:s.value,delta:Number.isFinite(s.delta)?s.delta:null,url:s.url,type:n.type,isIndex:!1,lookup:n.lookup,symbol:n.symbol}}let a=await Vt(n.lookup);return!a||!Number.isFinite(a.value)?null:{label:n.label||a.symbol||n.symbol,value:a.value,delta:Number.isFinite(a.deltaPct)?a.deltaPct:null,url:a.url,type:n.type,isIndex:n.isIndex||n.symbol?.startsWith("^")||a.symbol?.startsWith("^"),lookup:n.lookup,symbol:n.symbol||a.symbol}}));r.customTickers=t.filter(Boolean),Xn(),await fs()}function et(e,t,n){let a=e.querySelector(".ticker-builder-status");a&&(a.textContent=t||"",a.classList.remove("error","success"),n&&a.classList.add(n))}async function ys(e){let t=e.querySelector(".ticker-type"),n=e.querySelector(".ticker-query");if(!t||!n)return;let a=t.value,s=n.value.trim();if(s){et(e,"Searching...",null);try{let o=await pl(a,s);if(!o){et(e,"No match found. Try a symbol like AAPL, ^SPX, BTC.","error");return}let i=De(o);if((r.settings.tickerWatchlist||[]).some(m=>De(m)===i)){et(e,"Already in watchlist.","error");return}r.settings.tickerWatchlist=[...r.settings.tickerWatchlist||[],o],V(),n.value="",et(e,"Added. Fetching quote\u2026","success"),await ba();let d=r.customTickers.some(m=>De({type:m.type,lookup:m.lookup||m.symbol||m.label||""})===i);et(e,d?"Added to watchlist.":"Added, quote pending. Will refresh shortly.",d?"success":"error"),Ca(),Sn()}catch{et(e,"Unable to add ticker right now.","error")}}}function fl(e){r.settings.tickerWatchlist=(r.settings.tickerWatchlist||[]).filter(t=>De(t)!==e),V(),ba().then(()=>{Ca(),Sn()})}function yl(){let e=ue(r.items),t=A=>e.filter(E=>E.feedId===A),n=A=>t(A)[0],a=A=>t("coinpaprika-tickers").find(E=>E.symbol===A),s=[],o=n("treasury-debt");o?.value&&s.push({label:"US Debt",value:Se(o.value),meta:o.secondaryValue?`Intragov ${Se(o.secondaryValue)}`:"",source:o.source,url:o.url,category:"finance"});let i=n("bls-cpi");i?.value&&s.push({label:"CPI",value:ha(i.value),meta:i.title.replace("CPI (CUUR0000SA0) ",""),source:i.source,url:i.url,category:"finance"});let u=r.energyMarket?.wti,d=n("energy-eia");if(u?.value||d?.value){let A=u?.value?u:d,E=u?.value?u.asOf?`Market ${u.asOf}`:"Market":d.summary.split(":")[0];s.push({label:"WTI Crude",value:Se(A.value),meta:E,delta:Number.isFinite(A.delta??A.deltaPct)?A.delta??A.deltaPct:null,source:A.source||(u?.value?"Stooq":d.source),url:A.url||d.url,category:"energy"})}let m=n("energy-eia-brent");m?.value&&s.push({label:"Brent",value:Se(m.value),meta:m.summary.split(":")[0],delta:Number.isFinite(m.deltaPct)?m.deltaPct:null,source:m.source,url:m.url,category:"energy"});let f=r.energyMarket?.gas,p=n("energy-eia-ng");if(f?.value||p?.value){let A=f?.value?f:p,E=f?.value?f.asOf?`Market ${f.asOf}`:"Market":p.summary.split(":")[0];s.push({label:"Nat Gas",value:Se(A.value),meta:E,delta:Number.isFinite(A.delta??A.deltaPct)?A.delta??A.deltaPct:null,source:A.source||(f?.value?"Stooq":p.source),url:A.url||p.url,category:"energy"})}let h=r.energyMarket?.gold;h?.value&&s.push({label:"Gold",value:Se(h.value),meta:h.asOf?`Market ${h.asOf}`:"Market",delta:Number.isFinite(h.delta)?h.delta:null,source:h.source||"Stooq",url:h.url,category:"finance"});let y=n("coinpaprika-global");y?.value&&s.push({label:"Crypto Mkt Cap",value:Se(y.value),meta:y.dominance?`BTC Dom ${y.dominance.toFixed(2)}%`:"",source:y.source,url:y.url,category:"crypto"});let g=a("BTC");g?.value&&s.push({label:"Bitcoin",value:Se(g.value),delta:Number.isFinite(g.change24h)?g.change24h:null,meta:"24h",source:g.source,url:g.url,category:"crypto"});let b=a("ETH");b?.value&&s.push({label:"Ethereum",value:Se(b.value),delta:Number.isFinite(b.change24h)?b.change24h:null,meta:"24h",source:b.source,url:b.url,category:"crypto"});let C=r.settings.tickerWatchlist||[],v=new Map;r.customTickers.forEach(A=>{let E=De({type:A.type,lookup:A.lookup||A.symbol||A.label||""});v.set(E,A)});let S=C.map(A=>{let E=De(A),T=v.get(E);return T?{label:T.label||T.symbol,value:ar(T),meta:T.type==="crypto"?"24h":"Session",delta:Number.isFinite(T.delta)?T.delta:null,url:T.url,category:T.type==="crypto"?"crypto":"finance"}:{label:A.label||A.symbol,value:"--",meta:"Awaiting quote",delta:null,url:A.url||"",category:A.type==="crypto"?"crypto":"finance"}}),w=new Set;return[...S,...s].filter(A=>{if(!A.label)return!1;let E=A.label.toLowerCase();return w.has(E)?!1:(w.add(E),!0)})}function hl(e,t,n="spotlight"){e&&(e.innerHTML="",t.forEach(a=>{let s=document.createElement("a");s.className=`finance-card ${n}`,Number.isFinite(a.delta)&&s.classList.add(a.delta>=0?"up":"down"),a.url&&(s.href=a.url,s.target="_blank",s.rel="noopener");let o=document.createElement("div");o.className="finance-label",o.textContent=a.label;let i=document.createElement("div");i.className="finance-value",i.textContent=a.value||"--";let u=document.createElement("div");u.className="finance-meta";let d=Number.isFinite(a.delta)?`${a.delta>0?"+":""}${a.delta.toFixed(2)}%`:"";u.textContent=[a.meta,d].filter(Boolean).join(" \u2022 "),s.appendChild(o),s.appendChild(i),s.appendChild(u),e.appendChild(s)}))}function Sn(){if(!l.financeSpotlight)return;let e=yl().slice(0,8);hl(l.financeSpotlight,e,"spotlight")}function bl(e=wt){let t=new Date,n=new Date(t);return n.setDate(t.getDate()-Number(e||wt)),{start:n.toISOString().slice(0,10),end:t.toISOString().slice(0,10)}}function sr(e){let t=Number(e);return Number.isFinite(t)?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(t):"--"}function hs(e){let t=Number(e);if(!Number.isFinite(t))return"--";let n=Math.abs(t);return n>=1e12?`${(t/1e12).toFixed(2)}T`:n>=1e9?`${(t/1e9).toFixed(2)}B`:n>=1e6?`${(t/1e6).toFixed(2)}M`:n>=1e3?`${(t/1e3).toFixed(1)}K`:sr(t)}function vl(){if(!l.moneyFlowsRateNotice)return;let e=r.moneyFlowsData?.sources?.sam;if(!e||!e.error||!e.retryAt){l.moneyFlowsRateNotice.textContent="",l.moneyFlowsRateNotice.classList.remove("active");return}let t=new Date(e.retryAt),n=Number.isNaN(t.getTime())?"later":`${t.toLocaleDateString(void 0,{month:"short",day:"numeric"})} ${t.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}`;l.moneyFlowsRateNotice.textContent=`SAM rate limit reached \u2014 try again ${n}.`,l.moneyFlowsRateNotice.classList.add("active")}function vt(){if(!l.moneyFlowsList)return;if(l.moneyFlowsMeta)if(!r.moneyFlowsQuery)l.moneyFlowsMeta.textContent="No query yet.";else if(r.moneyFlowsLoading)l.moneyFlowsMeta.textContent="Fetching money flows...";else if(r.moneyFlowsError)l.moneyFlowsMeta.textContent=`Error: ${r.moneyFlowsError}`;else{let s=r.moneyFlowsItems?.length||0,o=r.moneyFlowsData?.sources?Object.entries(r.moneyFlowsData.sources).map(([i,u])=>`${i}: ${u.count||0}${u.error?" (err)":""}`).join(" \u2022 "):"";l.moneyFlowsMeta.textContent=s?`Showing ${s} items${o?` \xB7 ${o}`:""}`:"No matching flows yet."}if(l.moneyFlowsSummary){let s=r.moneyFlowsData?.summary;if(!s)l.moneyFlowsSummary.innerHTML="";else{let o=s.buckets||{},i=[{id:"contributions",label:"Contributions In",tone:"money-tone-in"},{id:"spending",label:"Spending Out",tone:"money-tone-out"},{id:"lobbying",label:"Lobbying",tone:"money-tone-lobby"},{id:"registry",label:"SAM Registry",tone:"money-tone-registry"}],u=i.map(m=>Number(o[m.id]?.totalAmount||0)),d=Math.max(...u,1);l.moneyFlowsSummary.innerHTML=`
        <div class="summary-card money-summary-card">
          <div class="summary-label">Total items</div>
          <div class="summary-value">${s.totalItems||0}</div>
          <div class="summary-sub">Across all sources</div>
        </div>
        ${i.map(m=>{let f=o[m.id]||{},p=Number(f.totalAmount||0),h=f.count||0,y=Math.max(4,Math.round(p/d*100));return`
            <div class="summary-card money-summary-card ${m.tone}">
              <div class="summary-label">${m.label}</div>
              <div class="summary-value">${p?sr(p):"\u2014"}</div>
              <div class="summary-sub">${h} items</div>
              <div class="money-bar"><span style="width:${p?y:6}%"></span></div>
            </div>
          `}).join("")}
      `}}vl();let e=r.moneyFlowsData?.summary,t=e?.buckets||{},n=e?.top||{},a=(s,o,{totalAmount:i,count:u,rows:d})=>{if(!s||!o)return;let m=Number(i)?hs(i):"\u2014";s.textContent=`${m} \xB7 ${u||0} items`,o.innerHTML=d.map(f=>{let p=f.value||"\u2014",h=Number.isFinite(f.amount)&&f.amount?hs(f.amount):"\u2014";return`
        <div class="money-rank">
          <div>
            <div class="money-rank-label">${f.label}</div>
            <div class="money-rank-value">${p}</div>
          </div>
          <div class="money-rank-amount">${h}</div>
        </div>
      `}).join("")};if(e?(a(l.moneyInMeta,l.moneyInBody,{totalAmount:t.contributions?.totalAmount||0,count:t.contributions?.count||0,rows:[{label:"Top donor",value:n.contributions?.donor,amount:n.contributions?.donorAmount},{label:"Top recipient",value:n.contributions?.recipient,amount:n.contributions?.recipientAmount}]}),a(l.moneyOutMeta,l.moneyOutBody,{totalAmount:t.spending?.totalAmount||0,count:t.spending?.count||0,rows:[{label:"Top recipient",value:n.spending?.recipient,amount:n.spending?.recipientAmount}]}),a(l.moneyLobbyMeta,l.moneyLobbyBody,{totalAmount:t.lobbying?.totalAmount||0,count:t.lobbying?.count||0,rows:[{label:"Top client",value:n.lobbying?.client,amount:n.lobbying?.clientAmount},{label:"Top registrant",value:n.lobbying?.registrant,amount:n.lobbying?.registrantAmount}]}),a(l.moneyRegistryMeta,l.moneyRegistryBody,{totalAmount:t.registry?.totalAmount||0,count:t.registry?.count||0,rows:[{label:"Top entity",value:n.registry?.entity,amount:n.registry?.entityAmount}]})):(l.moneyInMeta&&(l.moneyInMeta.textContent="\u2014"),l.moneyOutMeta&&(l.moneyOutMeta.textContent="\u2014"),l.moneyLobbyMeta&&(l.moneyLobbyMeta.textContent="\u2014"),l.moneyRegistryMeta&&(l.moneyRegistryMeta.textContent="\u2014"),l.moneyInBody&&(l.moneyInBody.innerHTML=""),l.moneyOutBody&&(l.moneyOutBody.innerHTML=""),l.moneyLobbyBody&&(l.moneyLobbyBody.innerHTML=""),l.moneyRegistryBody&&(l.moneyRegistryBody.innerHTML="")),r.moneyFlowsLoading){l.moneyFlowsList.innerHTML='<div class="list-item">Loading money flows...</div>';return}if(r.moneyFlowsError){l.moneyFlowsList.innerHTML='<div class="list-item">Unable to load money flows.</div>';return}kt(l.moneyFlowsList,r.moneyFlowsItems||[])}async function _n(){let e=l.moneyFlowsQuery?.value?.trim();if(!e){r.moneyFlowsError="Enter a query to search.",r.moneyFlowsLoading=!1,r.moneyFlowsItems=[],vt();return}let t=Number(l.moneyFlowsRange?.value)||wt;r.moneyFlowsRangeDays=t,r.moneyFlowsQuery=e;let{start:n,end:a}=bl(t),s=new URLSearchParams({q:e,start:n,end:a,limit:String(vo)});r.moneyFlowsLoading=!0,r.moneyFlowsError=null,vt();try{let{data:o,error:i}=await Ce(`/api/money-flows?${s.toString()}`,{},3e4);if(i)throw new Error(o?.message||i);r.moneyFlowsData=o,r.moneyFlowsItems=(o?.items||[]).map(u=>({...u,url:u.url||u.externalUrl||null})),r.moneyFlowsFetchedAt=o?.fetchedAt||Date.now()}catch(o){r.moneyFlowsError=o?.message||"Fetch failed.",r.moneyFlowsData=null,r.moneyFlowsItems=[]}finally{r.moneyFlowsLoading=!1,vt(),dr(),wn()}}function Cl(e){let t=`${e.title||""} ${e.summary||""}`.replace(/https?:\/\/\S+/g,""),n=new Set,a=(e.location||e.geoLabel||"").trim();if(a){let m=a.split(";")[0].split(",").slice(0,2).join(",").trim();m&&n.add(m)}let s=(e.title||"").match(/Travel Advisory\s*[-]\s*([A-Za-z\s.'-]+)/i);s&&n.add(s[1].trim());let o=t.match(/([A-Z][A-Za-z.'-]+(?:\s+[A-Z][A-Za-z.'-]+){0,3}),\s*([A-Z]{2})/);o&&n.add(`${o[1]}, ${o[2]}`);let i=(e.title||"").match(/-\s*([A-Z][A-Za-z.'-]+(?:\s+[A-Z][A-Za-z.'-]+){0,3})$/);i&&n.add(i[1]);let u=/\b(?:in|near|at|outside|north of|south of|east of|west of)\s+([A-Z][A-Za-z.'-]+(?:\s+[A-Z][A-Za-z.'-]+){0,3})/g,d;for(;(d=u.exec(t))!==null;)n.add(d[1]);return[...n].filter(Boolean)}async function Sl(e,t=60){let n=e.filter(o=>o&&!o.geo&&o.category!=="crypto"&&o.category!=="finance"),a=new Set,s=!1;for(let o of n.slice(0,t)){let i=Cl(o);for(let u of i){let d=u.toLowerCase();if(a.has(d))continue;a.add(d);let m=r.geoCache[d];if(m){if(!m.notFound&&m.lat){o.geo={lat:m.lat,lon:m.lon},o.geoLabel=m.displayName||u,s=!0;break}continue}try{let{data:f,error:p}=await Ce(`/api/geocode?q=${encodeURIComponent(u)}`);if(p||!f){r.geoCache[d]={query:u,notFound:!0},Bn();continue}if(r.geoCache[d]=f,Bn(),!f.notFound&&f.lat){o.geo={lat:f.lat,lon:f.lon},o.geoLabel=f.displayName||u,s=!0;break}}catch{r.geoCache[d]={query:u,notFound:!0},Bn()}}}return s}function wl(e){return Ya(e,Ft())}async function ea(e,t,n=!1,a={}){if(e.isCustom)return na(e,t);if(e.id==="gpsjam")return Al(e,n);let s=new URLSearchParams,o={...wl(e),...a&&typeof a=="object"?a:{}},i=Object.keys(o).some(d=>o[d]!==void 0&&o[d]!==null&&String(o[d])!==""),u=Pt(e);try{let d,m;ne()?(s.set("id",e.id),t&&s.set("query",t),n&&s.set("force","1"),i&&Object.entries(o).forEach(([b,C])=>{C==null||C===""||s.set(`param.${b}`,String(C))}),m=await Re(`/api/feed?${s.toString()}`),d=await m.json()):(m=await Re("/api/feed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,query:t,force:!!n,key:u.key||void 0,keyParam:u.keyParam||void 0,keyHeader:u.keyHeader||void 0,params:i?o:void 0})}),d=await m.json());let f=d.httpStatus||m.status||0,p=d.error||(f>=400?`http_${f}`:null),h=d.message||(f>=400?`HTTP ${f}`:null),g=(p?[]:e.format==="rss"?Qn(d.body,e):en(d.body,e)).map(b=>({...b,tags:Array.from(new Set([...e.tags||[],...Array.isArray(b.tags)?b.tags:[]])),feedId:e.id,feedName:e.name}));return{feed:e,items:g,error:p,errorMessage:h,httpStatus:f,fetchedAt:d.fetchedAt}}catch(d){return{feed:e,items:[],error:"fetch_failed",errorMessage:d.message,httpStatus:0,fetchedAt:Date.now()}}}function rr(){return window.h3||window.h3js||window.h3Js||null}function Ll(e,t,n){let a=rr();if(!a||!a.cellToLatLng&&!a.h3ToGeo)return{items:[],error:"h3_unavailable",errorMessage:"H3 library not available."};let o=er(String(e||"").trim()).filter(m=>m?.length>=3&&String(m[0]||"").trim().toLowerCase()!=="hex"),i=[];return o.map(m=>({hex:String(m[0]||"").trim(),good:Number(m[1]||0),bad:Number(m[2]||0)})).filter(m=>m.hex&&Number.isFinite(m.bad)&&m.bad>0).sort((m,f)=>f.bad-m.bad).slice(0,1200).forEach(m=>{let f=a.cellToLatLng?a.cellToLatLng(m.hex):a.h3ToGeo(m.hex);if(!f||f.length<2)return;let[p,h]=f;if(!Number.isFinite(p)||!Number.isFinite(h))return;let y=Number.isFinite(m.good)?m.good+m.bad:m.bad,g=y>0?Math.round(m.bad/y*100):null,b=n?Date.parse(n):Date.now(),C=[`Bad aircraft: ${m.bad}`];Number.isFinite(m.good)&&C.push(`Good aircraft: ${m.good}`),g!==null&&C.push(`Bad share: ${g}%`);let v=g!==null?g/140:Rr(m.bad/400,.1,.35);i.push({title:"GPS Jamming Risk",url:n?`https://gpsjam.org/?lat=${p.toFixed(4)}&lon=${h.toFixed(4)}&z=6&date=${n}`:"https://gpsjam.org/",summary:C.join(" \u2022 "),summaryHtml:C.join(" \u2022 "),publishedAt:Number.isNaN(b)?Date.now():b,source:t.name,category:t.category,geo:{lat:p,lon:h},hex:m.hex,gpsBad:m.bad,gpsGood:m.good,gpsRatio:g,gpsIntensity:v,alertType:"GPS Jamming",severity:`${m.bad} affected aircraft`,mapOnly:!0,tags:t.tags||[],feedId:t.id,feedName:t.name})}),{items:i,error:null,errorMessage:null}}async function Al(e,t=!1){try{let n=await Re(t?"/api/gpsjam?force=1":"/api/gpsjam"),a=await n.json();if(a.error)return{feed:e,items:[],error:a.error,errorMessage:a.message||"GPSJam fetch failed.",httpStatus:a.httpStatus||n.status||0,fetchedAt:a.fetchedAt||Date.now()};let s=Ll(a.body||"",e,a.date||"");return{feed:e,items:s.items.map(o=>({...o,tags:e.tags||[]})),error:s.error,errorMessage:s.errorMessage,httpStatus:a.httpStatus||n.status||0,fetchedAt:a.fetchedAt||Date.now()}}catch(n){return{feed:e,items:[],error:"fetch_failed",errorMessage:n.message,httpStatus:0,fetchedAt:Date.now()}}}function va(e,t){return t?Array.isArray(t)?va(e,t[0]):t==="allorigins"?`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`:t==="jina"?`https://r.jina.ai/http://${e.replace(/^https?:\/\//,"")}`:e:e}function Tl(e){return!(!ne()||!r.settings.superMonitor||e.keySource==="server"||e.requiresKey&&!Pt(e).key)}function El(e,t){if(!t)return e;if(e.includes("{{query}}"))return e.replaceAll("{{query}}",encodeURIComponent(t));let n=new URL(e);return n.searchParams.set("q",t),n.toString()}function ta(e){let t=e instanceof Date?e:new Date(e);return Number.isNaN(t.getTime())?"":t.toISOString().slice(0,10)}function or(){let e=new Date,t=Math.max(1,Number(r.settings.maxAgeDays)||1),n=new Date(e);return n.setDate(e.getDate()-t),{startDate:ta(n),endDate:ta(e)}}function kl(e){let t=xn(),{startDate:n,endDate:a}=or(),s=new URLSearchParams,o=String(e.limit||500),i=r.settings.scope!=="global"?ft()?.name:"";if(t){let u=t.endsWith("/")?t.slice(0,-1):t;return s.set("start",n),s.set("end",a),s.set("limit",o),e.acledMode==="aggregated"?(s.set("region",e.acledRegion||"global"),i&&s.set("country",i),`${u}/aggregated?${s.toString()}`):(i&&s.set("country",i),`${u}/events?${s.toString()}`)}return s.set("_format","json"),s.set("event_date",`${n}|${a}`),s.set("limit",o),i&&s.set("country",i),`${e.url}?${s.toString()}`}function Il(e,t){let a=`${Math.max(1,Number(r.settings.maxAgeDays)||1)}d`,s=t||e.defaultQuery||"",o=e.url||"";if(o=o.replaceAll("{{query}}",encodeURIComponent(s)),o=o.replaceAll("{{timespan}}",encodeURIComponent(a)),!o.includes("timespan=")){let i=new URL(o);i.searchParams.set("timespan",a),o=i.toString()}return o}function xl(e){let{startDate:t,endDate:n}=or(),a=e.url||"";return a=a.replaceAll("{{start}}",encodeURIComponent(t)),a=a.replaceAll("{{end}}",encodeURIComponent(n)),a}async function Nl(e,t={},n=bo){let a=new AbortController,s=setTimeout(()=>a.abort(),n);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(s)}}async function na(e,t){let n=Pt(e),a=e.acledMode?kl(e):e.id==="gdelt-conflict-geo"?Il(e,t):e.id==="ucdp-candidate-events"?xl(e):El(e.url,e.supportsQuery&&(t||e.defaultQuery)||"");if(n.key&&n.keyParam){let o=new URL(a);o.searchParams.set(n.keyParam,n.key),a=o.toString()}let s={};n.key&&n.keyHeader&&(s[n.keyHeader]=n.key);try{let o=Array.isArray(e.proxy)?e.proxy:e.proxy?[e.proxy]:[],i=[a,...o.map(y=>va(a,y))],u=null,d="",m=!1;for(let y of i)try{let g=await Nl(y,{headers:s});if(u=g,!g.ok)continue;let b=await g.text();if(d=b,e.format==="rss"&&!Vi(g.headers.get("content-type")||"",b)){m=!0;continue}m=!1;let v=(e.format==="rss"?Qn(b,e):en(b,e)).map(S=>({...S,tags:Array.from(new Set([...e.tags||[],...Array.isArray(S.tags)?S.tags:[]])),feedId:e.id,feedName:e.name}));return{feed:e,items:v,error:null,errorMessage:null,httpStatus:g.status,fetchedAt:Date.now()}}catch{}let f=e.format==="rss"&&u?.ok&&m,h=(u&&u.ok&&!f?e.format==="rss"?Qn(d,e):en(d,e):[]).map(y=>({...y,tags:Array.from(new Set([...e.tags||[],...Array.isArray(y.tags)?y.tags:[]])),feedId:e.id,feedName:e.name}));return{feed:e,items:h,error:f?"invalid_rss":u?.ok?null:u?`http_${u.status}`:"fetch_failed",errorMessage:f?"Upstream response was not valid RSS/Atom XML.":u?.ok?null:u?`HTTP ${u.status}`:"fetch failed",httpStatus:u?.status||0,fetchedAt:Date.now()}}catch(o){return{feed:e,items:[],error:"fetch_failed",errorMessage:o.message,httpStatus:0,fetchedAt:Date.now()}}}function Jt(e,t){return!e||!t||e.id==="gdelt-doc"?t:e.id.startsWith("google-news")?t.includes("when:")?t:`${t} when:1d`:t}function Ml(){let e=new Set(["gdelt-doc","google-news-search"]);return r.feeds.filter(t=>!t||!t.supportsQuery||t.requiresKey||t.keyParam||t.keyHeader||t.requiresConfig||t.isCustom?!1:e.has(t.id)||(t.tags||[]).includes("search"))}async function Fl(e,t){if(!e||!t)return t;if(!r.settings.aiTranslate||!Me())return Jt(e,t);try{let n=`Translate this search query for the feed "${e.name}". Keep it short and compatible with the feed. Return only the final query string. Original: ${t}`;return(await ht({messages:[{role:"user",content:n}],context:{feed:{id:e.id,name:e.name,url:e.url}},temperature:0})||"").split(`
`)[0].replace(/^\"|\"$/g,"").trim()||Jt(e,t)}catch{return Jt(e,t)}}function ve(e){let t=e;typeof e=="string"&&(t=Date.parse(e));let n=Number(t);if(!Number.isFinite(n))return"\u2014";let a=Date.now()-n,s=Math.max(1,Math.round(a/6e4));if(s<60)return`${s}m ago`;let o=Math.round(s/60);return o<24?`${o}h ago`:`${Math.round(o/24)}d ago`}function ir(e){if(!e)return"\u2014";let t=typeof e=="number"?e:Date.parse(e);return Number.isFinite(t)?ve(t):"\u2014"}function lr(){document.querySelectorAll(".panel[data-panel]").forEach(e=>{if(e.dataset.noUpdate)return;let t=e.dataset.panel;if(e.querySelector(`[data-panel-update="${t}"]`))return;let a=e.querySelector(".panel-header > div");if(!a)return;let s=document.createElement("div");s.className="panel-updated",s.dataset.panelUpdate=t,s.textContent="Updated --",a.appendChild(s)})}function tt(e){return!e||!e.length?null:e.reduce((t,n)=>Math.max(t,n.publishedAt||0),0)||null}function bs(e){let n=r.feeds.filter(a=>e.includes(a.category)).map(a=>r.feedStatus[a.id]?.fetchedAt).filter(Boolean);return n.length?Math.max(...n):null}function vs(e){if(!Array.isArray(e)||!e.length)return null;let t=e.map(n=>r.feedStatus[n]?.fetchedAt).filter(Boolean);return t.length?Math.max(...t):null}function cr(){return r.feeds.filter(e=>String(e?.category||"").toLowerCase()==="gov").filter(e=>String(e?.jurisdictionLevel||"").toLowerCase()==="state").map(e=>e.id)}function ur(){return r.feeds.filter(e=>String(e?.category||"").toLowerCase()==="gov").filter(e=>String(e?.jurisdictionLevel||"").toLowerCase()!=="state").filter(e=>!(String(e?.id||"").toLowerCase().startsWith("congress-")||(Array.isArray(e?.tags)?e.tags.map(a=>String(a||"").toLowerCase()):[]).includes("congress"))).map(e=>e.id)}var aa={map:["weather","disaster","space","news","travel","transport","local","security","infrastructure"],ticker:["finance","crypto","energy"],"finance-spotlight":["finance","crypto","energy"],news:["news"],finance:["finance","energy","gov","cyber","agriculture"],crypto:["crypto"],prediction:["prediction"],hazards:["disaster","weather","space"],"critical-alerts":["news","disaster","weather","space","security","cyber","health","gov","travel","transport"],local:["news","gov","disaster","weather"],policy:["gov"],"state-gov":["gov"],cyber:["cyber"],agriculture:["agriculture"],research:["research"],space:["space"],energy:["energy"],"energy-map":["energy"],health:["health"],transport:["transport"]};function Dl(e){let t=n=>{let a=r.scopedItems.filter(u=>n.includes(u.category)),s=tt(a);if(s)return s;let o=pe(ue(r.items)).filter(u=>n.includes(u.category)),i=tt(o);return i||bs(n)||r.lastFetch||null};switch(e){case"map":return tt(Aa())||r.lastFetch||null;case"ticker":case"finance-spotlight":return t(["finance","crypto","energy"]);case"command":case"signals":return r.lastFetch||null;case"news":return r.clusters.reduce((a,s)=>Math.max(a,s.updatedAt||0),0)||bs(["news"])||r.lastFetch||null;case"finance":return t(["finance","energy","gov","cyber","agriculture"]);case"money-flows":return r.moneyFlowsFetchedAt||null;case"crypto":return t(["crypto"]);case"prediction":return t(["prediction"]);case"hazards":return t(["disaster","weather","space"]);case"critical-alerts":return t(["news","disaster","weather","space","security","cyber","health","gov","travel","transport"]);case"local":return tt(Bt())||r.lastFetch||null;case"policy":{let n=tt(xt());return n||vs(ur())||r.lastFetch||null}case"state-gov":{let n=tt(Ie());return n||vs(cr())||r.lastFetch||null}case"cyber":return t(["cyber"]);case"agriculture":return t(["agriculture"]);case"research":return t(["research"]);case"space":return t(["space"]);case"energy":return t(["energy"]);case"energy-map":return t(["energy"]);case"health":return t(["health"]);case"transport":return t(["transport"]);default:return r.lastFetch||null}}function Pl(e){if(e==="map")return r.feeds.filter(n=>n.mapOnly||aa.map.includes(n.category)).map(n=>n.id);if(e==="policy")return ur();if(e==="state-gov")return cr();let t=aa[e];return t?r.feeds.filter(n=>t.includes(n.category)).map(n=>n.id):[]}function dr(){lr(),document.querySelectorAll(".panel-updated[data-panel-update]").forEach(e=>{let t=e.dataset.panelUpdate,n=Dl(t);e.textContent=n?`Updated ${ve(n)}`:"Updated --"})}function $l(){document.querySelectorAll(".panel[data-panel]").forEach(e=>{if(e.dataset.noUpdate)return;let t=e.dataset.panel;if(e.querySelector(`[data-panel-error="${t}"]`))return;let a=e.querySelector(".panel-header > div");if(!a)return;let s=document.createElement("div");s.className="panel-error",s.dataset.panelError=t,s.textContent="",a.appendChild(s)})}function wn(){$l(),document.querySelectorAll(".panel-error[data-panel-error]").forEach(e=>{let t=e.dataset.panelError,n="";if(t==="money-flows")n=r.moneyFlowsError?"Feed error":"";else if(t==="map")if(r.refreshing||!r.mapPointsReady)n="";else if(r.mapPoints&&r.mapPoints.length)n="";else{let a=r.scopedItems.filter(u=>u?.category==="travel"),s=pe(ue(r.items)).filter(u=>u?.category==="travel"),o=(a.length||s.length)>0,i=r.mapLastNonEmptyAt&&Date.now()-r.mapLastNonEmptyAt<360*60*1e3;if(o||i)n="";else{let d=r.feeds.filter(p=>p.mapOnly||aa.map.includes(p.category)).filter(p=>r.feedStatus[p.id]?.error==="fetch_failed");n=d.filter(p=>p.mapOnly).length>0||d.length>=2?"Data delayed":""}}else n=Pl(t).some(s=>r.feedStatus[s]?.error==="fetch_failed")?"Feed error":"";e.textContent=n,e.classList.toggle("active",!!n)})}function mr(e=""){return e?/[\u0400-\u04FF\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\u1100-\u11FF\u2E80-\u9FFF\u3040-\u30FF\uAC00-\uD7AF]/.test(e):!1}function pe(e){return r.settings.languageMode==="all"?e:r.settings.languageMode==="translate"?Me()?e:e.filter(t=>!t.isNonEnglish):e.filter(t=>!t.isNonEnglish)}function ue(e){let t=Date.now()-r.settings.maxAgeDays*24*60*60*1e3;return e.filter(n=>(n.publishedAt||Date.now())>=t)}function Bl(e){return e.map(t=>({...t,url:Cn(t.url),isNonEnglish:typeof t.isNonEnglish=="boolean"?t.isNonEnglish:mr(`${t.title||""} ${t.summary||""}`)}))}function Rl(e){let t=Bl(e),n=Ze(t);return pe(ue(n))}function Ol(){let e=ue(r.items),t=pe(e),n=y=>t.filter(g=>g.feedId===y),a=y=>n(y)[0],s=y=>y.map(g=>a(g)).find(Boolean),o=y=>n("coinpaprika-tickers").find(g=>g.title?.includes(`(${y})`)),i=y=>{if(!y?.summary)return null;let g=y.summary.match(/24h\s+(-?\d+(?:\.\d+)?)%/i);return g?Number(g[1]):null},u=[];ul().forEach(y=>u.push(y));let d=r.energyMarket?.wti,m=r.energyMarket?.gas,f=(y,g)=>{if(!y?.value)return;let b=Se(y.value),C=y.asOf?`Market ${y.asOf}`:"Market";u.push({text:`${g}: ${b} \u2022 ${C}`,url:y.url,change:Number.isFinite(y.delta)?y.delta:null})};f(d,"WTI Crude"),f(m,"Nat Gas");let p=(y,g)=>{if(!y)return;let b=y.translatedTitle||y.title||g,C=y.summary||"";u.push({text:C?`${b} \u2022 ${C}`:b,url:y.url,change:i(y)})};p(a("treasury-debt"),"US Debt"),p(a("bls-cpi"),"US CPI"),d?.value||p(a("energy-eia"),"WTI Crude"),p(a("energy-eia-brent"),"Brent Crude"),m?.value||p(a("energy-eia-ng"),"Nat Gas"),p(a("coinpaprika-global"),"Crypto Market Cap"),["BTC","ETH"].forEach(y=>p(o(y),y)),p(a("blockstream-mempool"),"Bitcoin Mempool");let h=new Set;return u.filter(y=>{let g=(y.text||"").toLowerCase();return!g||h.has(g)?!1:(h.add(g),!0)})}function Ca(){if(!l.tickerTrack||!l.tickerBar)return;let e=Ol();if(l.tickerTrack.innerHTML="",!e.length){l.tickerBar.classList.add("empty"),l.tickerTrack.textContent="No market signals yet.";return}l.tickerBar.classList.remove("empty");let t=document.createElement("div");t.className="ticker-group",e.forEach(a=>{let s=document.createElement(a.url?"a":"span");s.className="ticker-item",typeof a.change=="number"&&s.classList.add(a.change>=0?"up":"down"),s.textContent=a.text,a.url&&(s.href=a.url,s.target="_blank",s.rel="noopener noreferrer"),t.appendChild(s)});let n=t.cloneNode(!0);l.tickerTrack.appendChild(t),l.tickerTrack.appendChild(n)}async function pr(e,t,n){if(!Me()||!e||!e.isNonEnglish)return;let a=`${e.title}|${e.summary}`;if(r.translationCache[a]){let s=r.translationCache[a];s.title&&t&&(t.textContent=s.title);return}if(!(r.translationInFlight.has(a)||r.translationInFlight.size>4)){r.translationInFlight.add(a);try{let s=`Translate the following title to English. Return only the translated title.
Title: ${e.title}`,i={title:(await ht({messages:[{role:"user",content:s}],context:{mode:"translate"},temperature:0})||e.title||"").trim()};r.translationCache[a]=i,i.title&&t&&(t.textContent=i.title)}catch{}finally{r.translationInFlight.delete(a)}}}function _l(e){if(!e)return"";try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}var Ul=new Set(["reuters.com","apnews.com","bloomberg.com","wsj.com","nytimes.com","ft.com","bbc.com","theguardian.com","washingtonpost.com","npr.org","economist.com","aljazeera.com","cnn.com","foxnews.com","forbes.com","wsj.com","nationalgeographic.com","nature.com","sciencemag.org"]),Hl=new Set(["yahoo.com","finance.yahoo.com","cnbc.com","axios.com","politico.com","thehill.com","time.com","usatoday.com","abcnews.go.com","nbcnews.com","cbsnews.com","newsweek.com","businessinsider.com","marketwatch.com"]);function gr(e){let t=_l(e.url||"");return t?t.endsWith(".gov")||t.endsWith(".mil")||t.endsWith(".edu")?{label:"Tier 1",className:"tier-1"}:Ul.has(t)?{label:"Tier 1",className:"tier-1"}:Hl.has(t)?{label:"Tier 2",className:"tier-2"}:{label:"Tier 3",className:"tier-3"}:null}function jl(e){if(!e.coverage)return null;let t=(Date.now()-(e.publishedAt||Date.now()))/6e4;return e.coverage>=6&&t<120?"Spiking":e.coverage>=4?"Broad":t<60?"Fresh":null}function Gl(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function nt(e){let t=Gl(e);return t=t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t=t.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'),t}function tn(e){let n=String(e||"").replace(/```[\s\S]*?```/g,"").trim().split(/\r?\n/).map(o=>o.trim()).filter(Boolean),a="",s=null;return n.forEach(o=>{let i=/^[-*]\s*/.test(o),u=/^\d+[.)]\s+/.test(o);if(i||u){let f=u?"ol":"ul";s&&s!==f&&(a+=`</${s}>`,s=null),s||(s=f,a+=`<${f}>`);let p=o.replace(/^[-*]\s*/,"").replace(/^\d+[.)]\s+/,"");a+=`<li>${nt(p)}</li>`;return}s&&(a+=`</${s}>`,s=null);let d=/^(#{1,3})\s+(.+)/.exec(o);if(d){a+=`<div class="analysis-heading">${nt(d[2])}</div>`;return}let m=/^([A-Z][A-Za-z0-9 &/.-]{2,}):\s*(.+)$/.exec(o);if(m){a+=`<p><strong>${nt(m[1])}:</strong> ${nt(m[2])}</p>`;return}a+=`<p>${nt(o)}</p>`}),s&&(a+=`</${s}>`),a||`<p>${nt(e)}</p>`}function it(e){l.analysisBody&&(l.analysisBody.innerHTML=tn(e))}function ql(){let e=r.scopedItems.length?r.scopedItems:r.items,t=0;return e.forEach(n=>{let a=new Date(n.publishedAt||n.updatedAt||0).getTime();Number.isFinite(a)&&(t=Math.max(t,a))}),[e.length,t,r.clusters.length,r.lastFetch||0,r.lastBuildAt||0,r.settings.scope,r.settings.radiusKm,r.settings.languageMode].join("|")}function He(){let e=ql();e!==r.analysisSignature&&(r.analysisSignature=e,Me()?Cr({emitChat:!1,auto:!0}):rn(!1,{metaNote:"AI offline"}))}function fr(e){if(!e.geo)return null;let{lat:t,lon:n}=r.location;return Rt(t,n,e.geo.lat,e.geo.lon)}function yr(e){if(!e)return"";let t=e.toUpperCase();if(t.includes("UNITED STATES")||t.includes("U.S.")||t.includes("USA"))return"US";if(t.includes("GLOBAL"))return"Global";let a=(t.match(/\b[A-Z]{2}\b/g)||[]).find(s=>Jo.has(s));if(a)return a;if(e.includes(",")){let s=e.split(",").pop().trim();if(s&&s.length<=24)return s}return""}function hr(e=""){if(/global/i.test(e))return"Global";let t=e.match(/\bin\s+([A-Za-z][A-Za-z\s.-]+)/i);return t?t[1].trim():""}function zl(e=""){let t=e.match(/Level\s*(\d)/i);return t?`Level ${t[1]}`:""}function Kl(e){let t={...e},n=`${e.title||""} ${e.summary||""}`.toLowerCase();if(e.category==="travel"){t.alertType=t.alertType||"Travel Notice";let a=zl(e.title||"");a&&!t.severity&&(t.severity=a);let s=hr(e.title||"");s&&(t.regionTag=s),/dengue|chikungunya|zika|malaria/.test(n)?t.hazardType="Mosquito-borne":/rabies/.test(n)?t.hazardType="Zoonotic":/rmsf|rocky mountain spotted fever|tick/.test(n)?t.hazardType="Tick-borne":/cholera|diarrhea/.test(n)?t.hazardType="Waterborne":/measles|respiratory/.test(n)&&(t.hazardType="Respiratory")}if(e.category==="health"&&!t.alertType&&(/recall/.test(n)?t.alertType="Recall":/outbreak|cases/.test(n)?t.alertType="Outbreak":/advisory/.test(n)?t.alertType="Advisory":/alert/.test(n)&&(t.alertType="Alert")),e.category==="cyber"&&!t.alertType&&/cve-\\d{4}-\\d+/i.test(e.title||"")&&(t.alertType="Vulnerability"),e.category==="research"&&/arxiv/i.test(e.source||"")){let a=(e.source||"").replace(/arxiv/i,"").replace(/[()]/g,"").trim();t.topicTag=a||"arXiv";let s=(e.url||"").match(/v(\\d+)$/);s&&Number(s[1])>1?t.alertType="Updated":t.alertType="New"}if(e.category==="news"&&e.url){let a=gr(e);a&&(t.credibility=a.label)}if(!t.regionTag){let a=yr(e.location||e.geoLabel||"");a?t.regionTag=a:e.tags?.includes("us")?t.regionTag="US":e.tags?.includes("global")&&(t.regionTag="Global")}if(Array.isArray(e.tags)&&e.tags.includes("govinfo")&&(t.externalUrl=t.externalUrl||t.url||"",t.detailTitle=t.detailTitle||t.title||"GovInfo",!Array.isArray(t.detailFields)||!t.detailFields.length)){let a=Lr(t.externalUrl||t.url||"");t.detailFields=[{label:"Package",value:a||""},{label:"Feed",value:t.feedName||"GovInfo"}].filter(s=>s.value)}return t}var Cs={critical:5,alertType:10,severity:20,hazardType:30,deadline:40,regionTag:50,distance:60,delta:70,trend:80,credibility:90,topicTag:100},Wl={news:{alertType:8,severity:12,hazardType:16,regionTag:20,trend:30,credibility:40},local:{distance:5,alertType:10,severity:14,hazardType:18,regionTag:22},travel:{severity:5,hazardType:8,regionTag:12,alertType:16},research:{topicTag:5,alertType:10},financeMarkets:{delta:5,trend:10,alertType:20,severity:24,regionTag:28},financePolicy:{alertType:5,deadline:10,regionTag:16,severity:20},policy:{alertType:5,deadline:10,regionTag:16,severity:20},cyber:{alertType:5,severity:10,deadline:14,regionTag:18},health:{alertType:5,severity:10,hazardType:14,regionTag:18},disaster:{severity:5,alertType:10,hazardType:14,regionTag:18},crypto:{delta:5,trend:10,regionTag:20},energy:{delta:5,trend:10,alertType:16},transport:{alertType:8,severity:12,regionTag:16},agriculture:{alertType:8,severity:12,regionTag:16}};function Vl(e,t){let n={newsList:"news",financeMarketsList:"financeMarkets",financePolicyList:"financePolicy",policyList:"policy",stateGovAllList:"policy",stateGovLegislationList:"policy",stateGovRulemakingList:"policy",stateGovExecutiveOrdersList:"policy",congressList:"policy",cryptoList:"crypto",disasterList:"disaster",localList:"local",cyberList:"cyber",agricultureList:"agriculture",researchList:"research",spaceList:"space",energyList:"energy",healthList:"health",transportList:"transport"};return e==="searchResultsList"?(t.category==="gov"?"policy":t.category)||"default":n[e]||(t.category==="gov"?"policy":t.category)||"default"}function Jl(e,t){let n=Wl[e]||{};return Object.prototype.hasOwnProperty.call(n,t)?n[t]:Object.prototype.hasOwnProperty.call(Cs,t)?Cs[t]:999}function Sa(e){if(!e)return!1;let t=`${e.alertType||""} ${e.severity||""} ${e.title||""}`.toLowerCase();if(/(emergency|warning|extreme|catastrophic|major|critical)/.test(t))return!0;let n=Number(e.magnitude??e.mag);return!!(Number.isFinite(n)&&n>=6||e.category==="cyber"&&/(known exploited|kev|ransomware)/.test(t)||e.category==="health"&&/(outbreak|recall|fatal)/.test(t)||e.category==="security"&&/(attack|explosion|shooting)/.test(t))}function Zl(e,t){let n=Vl(t,e),a=[],s=(o,i,u)=>{a.push({label:i,className:u,priority:Jl(n,o),order:a.length})};if(e.category==="news"){let o=gr(e);o&&s("credibility",o.label,`chip-badge ${o.className}`);let i=jl(e);i&&s("trend",i,"chip-badge trend")}if(Ot(e)&&!e.alertType&&s("alert","Alert","chip-badge alert"),Sa(e)&&s("critical","Critical","chip-badge critical"),e.alertType&&s("alertType",e.alertType,"chip-badge alert"),e.severity&&s("severity",e.severity,"chip-badge severity"),Number.isFinite(e.delta)){let o=e.delta>0?`+${ce(e.delta)}`:ce(e.delta),i=e.unit?` ${e.unit}`:"";s("delta",`\u0394 ${o}${i}`,"chip-badge trend")}if(e.hazardType&&s("hazardType",e.hazardType,"chip-badge hazard"),e.verificationCount&&e.verificationCount>1&&s("verified",`Verified ${e.verificationCount} sources`,"chip-badge verified"),e.deadline&&s("deadline",`Due ${le(e.deadline)}`,"chip-badge deadline"),e.regionTag&&s("regionTag",e.regionTag,"chip-badge region"),n==="local"){let o=fr(e);Number.isFinite(o)&&s("distance",`${Math.round(o)} km`,"chip-badge distance")}return e.topicTag&&s("topicTag",e.topicTag,"chip-badge topic"),a.sort((o,i)=>o.priority-i.priority||o.order-i.order).slice(0,4)}function kt(e,t,{withCoverage:n=!1,append:a=!1}={}){if(!e)return;if(a||(e.innerHTML=""),!t.length){a||(e.innerHTML='<div class="list-item">No signals yet.</div>');return}let s=0,o=e?.dataset?.listContext||e?.id||"";t.forEach(i=>{if(r.settings.languageMode==="en"&&i.isNonEnglish)return;let u=document.createElement("div");u.className="list-item",Ot(i)&&u.classList.add("is-alert"),Sa(i)&&u.classList.add("is-critical");let m=Array.isArray(i.detailFields)&&i.detailFields.length||i.detailSummary||i.detailTitle;m&&u.classList.add("is-clickable");let f=!!(i.url&&!m),p=document.createElement(f?"a":m?"button":"div");p.className=`list-title${m?" btn-link":""}`,p.textContent=i.translatedTitle||i.title,f?(p.href=i.url,p.target="_blank",p.rel="noopener noreferrer"):m&&(p.type="button",p.addEventListener("click",()=>Ni(i)));let h=document.createElement("div");h.className="list-meta";let y=document.createElement("span");y.textContent=i.source||"Source";let g=document.createElement("span");if(g.textContent=ve(i.publishedAt||Date.now()),h.appendChild(y),h.appendChild(g),i.externalUrl){let A=document.createElement("a");A.className="list-open-link",A.href=i.externalUrl,A.target="_blank",A.rel="noopener noreferrer",A.textContent="Open",h.appendChild(A)}let b=null;if(i.category==="prediction"&&Number.isFinite(i.probability)){let A=document.createElement("div");A.className="prediction-odds";let E=document.createElement("div");E.className="prediction-odds-label";let T=Number.isFinite(i.change24h)?i.change24h:null,D=T!==null?` (${T>0?"+":""}${Math.round(T*100)}%)`:"";E.textContent=`${i.outcomeLabel||"Yes"} ${i.probability}%${D}`;let M=document.createElement("div");M.className="prediction-odds-bar";let P=document.createElement("span");P.style.width=`${Math.max(4,Math.min(100,i.probability))}%`,M.appendChild(P),A.appendChild(E),A.appendChild(M),b=A}if(n&&i.coverage){let A=document.createElement("div");A.className="list-coverage";let E=Array.from({length:Math.min(i.coverage,6)}).map(()=>'<span class="cover-dot"></span>').join(""),T=i.coverage-Math.min(i.coverage,6);A.innerHTML=T>0?`${E} <span>+${T}</span>`:E,h.appendChild(A)}let C=Zl(i,o);if(C.length){let A=document.createElement("div");A.className="list-badges",C.forEach(E=>{let T=document.createElement("span");T.className=E.className,T.textContent=E.label,A.appendChild(T)}),u.appendChild(A)}let v=document.createElement("div");v.className="list-summary";let S=o==="newsList",w=he(i.summaryHtml||i.summary||"").trim();if(S){let A=i.translatedSummary||w;v.textContent=se(A,240)}else i.summaryHtml?v.innerHTML=Yn(i.summaryHtml):v.textContent=i.translatedSummary||w;u.appendChild(p),u.appendChild(h),b&&u.appendChild(b),(i.summary||i.summaryHtml)&&!(r.settings.languageMode==="translate"&&i.isNonEnglish)&&u.appendChild(v),e.appendChild(u),s+=1,r.settings.languageMode==="translate"&&i.isNonEnglish&&pr(i,p,v)}),!s&&!a&&(e.innerHTML='<div class="list-item">No signals yet.</div>')}function be(e,t,n={}){if(!e)return;let a=Math.min(nr(e.id),t.length);kt(e,t.slice(0,a),n);let s=n.rowEstimate||92;if(!e.clientHeight||t.length<=a)return;let o=Math.min(t.length,Math.max(a,Math.floor(e.clientHeight/s)));o>a&&(r.listLimits[e.id]=o,kt(e,t.slice(0,o),n))}function Ql(e){let t=nn(e);be(l.newsList,t,{withCoverage:!0})}function je(){let e=r.scopedItems.length,t=r.clusters.length,n=Bt(),a=pe(ue(r.items)).filter(u=>u.category==="crypto"||u.category==="finance"),s=r.previousSignals,o=(u,d)=>{if(d==null)return"";let m=u-d;return m?m>0?`\u2022 +${m}`:`\u2022 ${m}`:""};l.globalActivity&&(l.globalActivity.textContent=e||"--"),l.globalActivityMeta&&(l.globalActivityMeta.textContent=e?`Signals ingested: ${e} ${o(e,s?.totalItems)}`.trim():r.refreshing?"Fetching feeds\u2026":"Awaiting signals"),l.summaryGlobalActivity&&(l.summaryGlobalActivity.textContent=e||"--",l.summaryGlobalActivityMeta.textContent=e?`Signals ingested: ${e} ${o(e,s?.totalItems)}`.trim():r.refreshing?"Fetching feeds\u2026":"Awaiting signals"),l.newsSaturation&&(l.newsSaturation.textContent=t||"--"),l.newsSaturationMeta&&(l.newsSaturationMeta.textContent=t?`Clusters across sources ${o(t,s?.newsClusters)}`.trim():r.refreshing?"Fetching clusters\u2026":"No clusters yet"),l.summaryNewsSaturation&&(l.summaryNewsSaturation.textContent=t||"--",l.summaryNewsSaturationMeta.textContent=t?`Clusters across sources ${o(t,s?.newsClusters)}`.trim():r.refreshing?"Fetching clusters\u2026":"No clusters yet"),l.localEvents&&(l.localEvents.textContent=n.length?n.length:"--"),l.localEventsMeta&&(l.localEventsMeta.textContent=n.length?r.location.source==="geo"?`Within local radius ${o(n.length,s?.localItems)}`:`Fallback region ${o(n.length,s?.localItems)}`:r.refreshing?"Locating\u2026":"No local signals yet"),l.summaryLocalEvents&&(l.summaryLocalEvents.textContent=n.length?n.length:"--",l.summaryLocalEventsMeta.textContent=n.length?r.location.source==="geo"?`Within local radius ${o(n.length,s?.localItems)}`:`Fallback region ${o(n.length,s?.localItems)}`:r.refreshing?"Locating\u2026":"No local signals yet");let i=a.length;if(l.marketPulse&&(l.marketPulse.textContent=i||"--"),l.marketPulseMeta&&(l.marketPulseMeta.textContent=i?`Markets + macro feeds ${o(i,s?.marketCount)}`.trim():r.refreshing?"Fetching feeds\u2026":"No market signals yet"),l.summaryMarketPulse&&(l.summaryMarketPulse.textContent=i||"--",l.summaryMarketPulseMeta.textContent=i?`Markets + macro feeds ${o(i,s?.marketCount)}`.trim():r.refreshing?"Fetching feeds\u2026":"No market signals yet"),l.signalHealthChip){let u=Vn.map(f=>r.feedStatus[f]).filter(f=>f?f.stale?!0:!(!f.error||f.error==="requires_key"||f.error==="requires_config"||f.error==="missing_server_key"):!1),m=Vn.filter(f=>{let p=r.feedStatus[f];return p?p.stale?!0:!(!p.error||p.error==="requires_key"||p.error==="requires_config"||p.error==="missing_server_key"):!1}).map(f=>r.feeds.find(p=>p.id===f)?.name||f);if(u.length){if(l.signalHealthChip.textContent=`Feed Health: Degraded (${u.length})`,l.signalHealthChip.classList.add("degraded"),l.signalHealthChip.classList.remove("healthy"),l.signalHealthDetail){let f=m.slice(0,3).join(", "),p=m.length>3?` +${m.length-3} more`:"";l.signalHealthDetail.textContent=`Degraded: ${f}${p}`,l.signalHealthDetail.title=m.join(", ")}}else l.signalHealthChip.textContent="Feed Health: Healthy",l.signalHealthChip.classList.add("healthy"),l.signalHealthChip.classList.remove("degraded"),l.signalHealthDetail&&(l.signalHealthDetail.textContent="",l.signalHealthDetail.removeAttribute("title"))}ec(),r.previousSignals={totalItems:e,newsClusters:t,localItems:n.length,marketCount:i}}function nn(e){return e.map((t,n)=>({title:t.primary.title,source:Array.from(t.sources).slice(0,2).join(", "),summary:n<3?se(he(t.primary.summaryHtml||t.primary.summary||""),240):"",summaryHtml:"",publishedAt:t.updatedAt,coverage:t.sources.size,url:t.primary.url,isNonEnglish:t.primary.isNonEnglish}))}function an(){let e=Bt().filter(n=>!n.mapOnly);return e.length||(e=pe(ue(r.items)).filter(n=>n.tags?.includes("us")&&!n.mapOnly)),e.filter(n=>!Sr(n)).map(n=>({item:n,score:nc(n)})).sort((n,a)=>a.score-n.score).map(n=>n.item)}function sn(){let e=r.scopedItems.filter(t=>t.feedId==="eia-today");return e.length||(e=pe(ue(r.items)).filter(t=>t.feedId==="eia-today")),e.length||(e=r.scopedItems.filter(t=>t.category==="energy")),e.length||(e=pe(ue(r.items)).filter(t=>t.category==="energy")),Ze(e)}function br(){if(!l.feedHealth)return;if(!Object.keys(r.feedStatus).length){l.feedHealth.innerHTML='<div class="settings-note">Fetching feeds...</div>';return}let t=r.feeds.map(n=>{let a=r.feedStatus[n.id]||{},s=a.stale,o=s?"STALE":a.httpStatus||(a.error?"ERR":"OK"),i=!a.error&&!s&&(a.httpStatus?a.httpStatus<400:!0);return{id:n.id,name:n.name,ok:i,code:o,stale:s,fetchedAt:a.fetchedAt,error:a.error,message:a.errorMessage}}).filter(n=>!n.ok&&n.error!=="requires_config");if(!t.length){l.feedHealth.innerHTML='<div class="settings-note">All feeds are healthy.</div>';return}l.feedHealth.innerHTML="",t.slice(0,6).forEach(n=>{let a=document.createElement("div");a.className="feed-health-row";let s=document.createElement("div");s.textContent=n.name;let o=document.createElement("div");o.className="feed-health-meta";let i=n.message;!i&&n.stale&&n.fetchedAt&&(i=`Stale (${ve(n.fetchedAt)})`),!i&&n.error==="requires_key"&&(i="Missing API key"),!i&&n.error==="missing_server_key"&&(i="Missing server API key"),o.textContent=i||(n.error?n.error:`HTTP ${n.code}`),a.appendChild(s),a.appendChild(o),l.feedHealth.appendChild(a)})}function sa(){if(!r.staticAnalysis?.generatedAt)return null;let e=Date.parse(r.staticAnalysis.generatedAt);return Number.isFinite(e)?e:null}function Yl(){return ne()&&!r.settings.superMonitor?sa()||r.lastBuildAt||r.lastFetch||null:r.lastFetch||r.lastBuildAt||sa()||null}function Ct(e,t,n){if(!l.analysisMeta)return;let a={ai:"AI briefing",cached:"Cached briefing",heuristic:"Heuristic briefing",empty:"Awaiting signals"},s="";if(e==="empty")s=t||"Awaiting signals to build a briefing.";else{let o=a[e]||"Briefing",i=n??Yl(),u=i?`Data ${ir(i)}`:"";s=[o,t,u].filter(Boolean).join(" \u2022 ")}l.analysisMeta.textContent=s,l.analysisOutput&&e&&(l.analysisOutput.dataset.mode=e)}function wa(){return r.clusters.length?[...r.clusters].sort((e,t)=>{let n=t.sources.size-e.sources.size;return n||t.updatedAt-e.updatedAt})[0]:null}function St(e){return!e||!e.length?null:[...e].sort((t,n)=>{let a=t.publishedAt||t.updatedAt||0;return(n.publishedAt||n.updatedAt||0)-a})[0]}function La(e=5){if(!r.clusters.length)return[];let t=[];r.clusters.slice(0,12).forEach(a=>{we(a.primary.title).split(" ").forEach(o=>{!o||o.length<3||Ko.has(o)||/^\d+$/.test(o)||t.push(o)})});let n=t.reduce((a,s)=>(a[s]=(a[s]||0)+1,a),{});return Object.entries(n).sort((a,s)=>s[1]-a[1]).slice(0,e).map(([a])=>a)}function Xl(){let e=[],t=wa();if(t){let i=se(t.primary.title||"",120),u=t.sources?.size?`${t.sources.size} sources`:"Single source",d=t.updatedAt?ve(t.updatedAt):"",m=[u,d].filter(Boolean).join(" \u2022 ");e.push({label:"Focus",value:m?`${i} \u2022 ${m}`:i})}let n=St(It());if(n){let i=se(n.title||"",120),u=n.geoLabel||n.location||n.area||"",d=n.publishedAt?ve(n.publishedAt):"",m=[u,d].filter(Boolean).join(" \u2022 ");e.push({label:"Local",value:m?`${i} \u2022 ${m}`:i})}else r.settings.scope!=="global"&&e.push({label:"Local",value:`No signals within ${r.settings.radiusKm} km.`});let a=pe(ue(r.items)).filter(i=>i.category==="crypto"||i.category==="finance"),s=St(a);if(s){let i=se(s.title||"",120),u=s.summary?se(he(s.summary),80):"";e.push({label:"Market",value:u?`${i} \u2022 ${u}`:i})}let o=La(3);return o.length&&e.push({label:"Themes",value:o.join(", ")}),e.slice(0,4)}function ec(){if(!l.analysisStory)return;let e=Xl();if(l.analysisStory.innerHTML="",!e.length){l.analysisStory.innerHTML='<div class="analysis-story-empty">Awaiting narrative context.</div>';return}e.forEach(t=>{let n=document.createElement("div");n.className="analysis-story-item";let a=document.createElement("div");a.className="analysis-story-label",a.textContent=t.label;let s=document.createElement("div");s.className="analysis-story-value",s.textContent=t.value,n.appendChild(a),n.appendChild(s),l.analysisStory.appendChild(n)})}function vr(){let e=wa(),t=r.feeds.map(d=>{let m=r.feedStatus[d.id];return!m||m.error==="requires_key"||m.error==="requires_config"||m.error==="missing_server_key"||!m.error&&!m.stale?null:{id:d.id,name:d.name,error:m.error||null,stale:!!m.stale,fetchedAt:m.fetchedAt||null}}).filter(Boolean).slice(0,6),n=pt(),a=n.slice(0,6).map(d=>({title:d.title,type:d.alertType||d.category,publishedAt:d.publishedAt,url:d.externalUrl||d.url})),s=Gs(r.scopedItems.filter(d=>(d.category||"").toLowerCase()==="gov"&&(d.jurisdictionLevel||"").toLowerCase()==="state"),{includeFederal:!1}),o=s.reduce((d,m)=>{let f=m.signalType||"other";return d[f]=(d[f]||0)+1,d},{}),i=Ft(),u=Xo();return{generatedAt:new Date().toISOString(),scope:r.settings.scope,location:r.location,refreshMinutes:r.settings.refreshMinutes,feedHealth:{status:r.health,issueCount:t.length,issues:t},signals:{totalItems:r.scopedItems.length,newsClusters:r.clusters.length,localEvents:It().length,congressItems:n.length},congressSignals:a,stateSignals:{selectedStateCode:i,selectedStateName:u,total:s.length,bySignalType:o,sample:s.slice(0,6).map(d=>({title:d.title,signalType:d.signalType||null,jurisdictionCode:d.jurisdictionCode||null,jurisdictionName:d.jurisdictionName||null,publishedAt:d.publishedAt||null,url:d.externalUrl||d.url||null}))},searchContext:{query:r.lastSearchQuery||null,scope:r.lastSearchScope,categories:r.lastSearchCategories,state:r.lastSearchState||i},themes:La(5),focusCluster:e?{title:e.primary.title,sources:Array.from(e.sources),updatedAt:e.updatedAt,url:e.primary.url}:null,topClusters:r.clusters.slice(0,8).map(d=>({title:d.primary.title,sources:Array.from(d.sources),updatedAt:d.updatedAt,url:d.primary.url})),localSignals:It().slice(0,6).map(d=>({title:d.title,source:d.source,publishedAt:d.publishedAt,url:d.url})),marketSignals:r.scopedItems.filter(d=>d.category==="finance"||d.category==="crypto").slice(0,6).map(d=>({title:d.title,source:d.source,publishedAt:d.publishedAt,url:d.url}))}}async function ht({messages:e,context:t,temperature:n=.2,model:a}={}){let s=Ye(),o=Hi();if(s){let m={messages:Array.isArray(e)?e:[],context:t,temperature:n};a&&(m.model=a);let f={"Content-Type":"application/json"};o&&(f["x-openai-key"]=o);let h=await(await fetch(s,{method:"POST",headers:f,body:JSON.stringify(m)})).json();if(h.error)throw new Error(h.message||h.error);return(h.text||"").trim()}if(ne())throw new Error("assistant_unavailable");let i={messages:Array.isArray(e)?e:[],context:t,temperature:n};a&&(i.model=a);let d=await(await Re("/api/chat",{method:"POST",headers:{"Content-Type":"application/json",...o?{"x-openai-key":o}:{}},body:JSON.stringify(i)})).json();if(d.error)throw new Error(d.message||d.error);return(d.text||"").trim()}function rn(e=!1,t={}){let{metaNote:n}=t;if(ne()&&r.staticAnalysis?.text){let S=sa(),w=S?`

Updated ${ve(S)}`:"";Ct("cached",n,S),it(`${r.staticAnalysis.text}${w}`);return}let a=r.scopedItems.length,s=r.clusters.length,o=It().length,i=pe(ue(r.items)).filter(S=>S.category==="crypto"||S.category==="finance").length,u=pt(),d=u.length;if(!a&&!s){let S=`Awaiting signals. Check feed health or refresh. Local radius: ${r.settings.radiusKm} km.`;Ct("empty",n||"Awaiting signals to build a briefing."),it(S),e&&Ve(`Briefing: ${S}`,"system");return}let m=wa(),f=St(It()),p=pe(ue(r.items)).filter(S=>S.category==="crypto"||S.category==="finance"),h=St(p),y=St(u),g=La(4),b=["## Storyline"];if(m){let S=se(m.primary.title||"",140),w=`${m.sources.size} sources`,I=m.updatedAt?ve(m.updatedAt):"";b.push(`- Focus: ${S} (${[w,I].filter(Boolean).join(" \u2022 ")})`)}if(f){let S=se(f.title||"",140),w=f.geoLabel||f.location||"",I=f.publishedAt?ve(f.publishedAt):"";b.push(`- Local: ${S} (${[w,I].filter(Boolean).join(" \u2022 ")})`)}if(h){let S=se(h.title||"",140);b.push(`- Market: ${S}`)}if(y){let S=se(y.title||"",140);b.push(`- Congress: ${S}`)}g.length&&b.push(`- Themes: ${g.join(", ")}`);let C=["## Signals",`- Signals in view: ${a||"awaiting"} across ${s||"no"} news clusters.`,`- Local risks: ${o||"no"} events within ${r.settings.radiusKm} km.`,`- Market pulse: ${i||"no"} finance/crypto signals.`,`- Congress: ${d||"no"} legislative updates.`],v=[...b,...C].join(`
`);Ct("heuristic",n),it(v),e&&Ve(`Briefing:
${v}`,"system")}async function Cr({emitChat:e=!0}={}){if(!l.analysisRun||l.analysisRun.disabled)return;let t=l.analysisRun.textContent;if(l.analysisRun.disabled=!0,l.analysisRun.classList.add("loading"),l.analysisRun.setAttribute("aria-busy","true"),l.analysisRun.textContent="Briefing\u2026",r.analysisRunning=!0,!Me()){rn(e,{metaNote:"AI unavailable"}),l.analysisRun.disabled=!1,l.analysisRun.classList.remove("loading"),l.analysisRun.removeAttribute("aria-busy"),l.analysisRun.textContent=t,r.analysisRunning=!1;return}Ct("ai","Generating briefing"),it("Generating AI briefing...");let n=e?Ve("Generating briefing\u2026","system"):null;try{let s=await ht({messages:[{role:"user",content:"Provide a concise situation briefing with 3 bullets: global pulse, local risks, and notable market/cyber signals. Mention sources when possible."}],context:vr(),temperature:.2})||"No response yet.";Ct("ai"),it(s),e&&(n?(n.className="chat-bubble assistant",n.innerHTML=tn(s)):Ve(s,"assistant"))}catch(a){let s=pa(a),o=s?.message?`AI briefing unavailable. ${s.message} Showing heuristic analysis.`:"AI briefing failed. Showing heuristic analysis.";it(o),n&&(n.className="chat-bubble system",n.innerHTML=tn(o)),rn(e,{metaNote:"AI unavailable"})}finally{l.analysisRun.disabled=!1,l.analysisRun.classList.remove("loading"),l.analysisRun.removeAttribute("aria-busy"),l.analysisRun.textContent=t,r.analysisRunning=!1}}function Ve(e,t){let n=document.createElement("div");return n.className=`chat-bubble ${t}`,t==="assistant"||t==="system"?n.innerHTML=tn(e):n.textContent=e,l.chatLog.appendChild(n),l.chatLog.scrollTop=l.chatLog.scrollHeight,n}async function Ss(){let e=l.chatInput.value.trim();if(!e)return;if(Ve(e,"user"),l.chatInput.value="",!Me()){Ve('AI is offline. Enable the proxy or turn on "Use my OpenAI key" in Settings > API Keys.',"system");return}let t=Ve("Thinking...","system");r.chatHistory.push({role:"user",content:e});let n=r.chatHistory.slice(-6);try{let a=await ht({messages:n,context:vr(),temperature:.3});t.textContent=a||"No response.",r.chatHistory.push({role:"assistant",content:a||"No response."})}catch(a){let s=pa(a);t.textContent=s.message||`Assistant error: ${a.message}`}}function tc(){let e={generatedAt:new Date().toISOString(),settings:r.settings,location:r.location,scope:r.settings.scope,feeds:r.feeds.map(s=>({id:s.id,name:s.name,category:s.category})),items:r.scopedItems,clusters:r.clusters.map(s=>({title:s.primary.title,sources:Array.from(s.sources),updatedAt:s.updatedAt,url:s.primary.url}))},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=document.createElement("a"),a=new Date().toISOString().replace(/[:.]/g,"-");n.href=URL.createObjectURL(t),n.download=`situation-room-snapshot-${a}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href),ne()||Re("/api/snapshot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(()=>{})}function Ge(e){let t=ue(e);if(r.settings.scope==="us"){let n=ft();t=t.filter(a=>qs(a,n))}return r.settings.scope==="local"&&(t=t.filter(n=>n.geo&&Rt(r.location.lat,r.location.lon,n.geo.lat,n.geo.lon)<=r.settings.radiusKm)),pe(t)}function Bt(){let e=r.settings.scope==="global"?pe(ue(r.items)):r.scopedItems;if(!e.length)return[];let{lat:t,lon:n}=r.location,a=r.settings.radiusKm;return e.filter(s=>s.geo&&Rt(t,n,s.geo.lat,s.geo.lon)<=a)}function Sr(e){if(!e)return!1;let t=(e.alertType||"").toLowerCase(),n=(e.feedId||"").toLowerCase(),a=Array.isArray(e.tags)?e.tags.map(i=>String(i).toLowerCase()):[],s=(e.category||"").toLowerCase();return!!(new Set(["arcgis-military-installations","arcgis-power-plants","arcgis-submarine-cables","arcgis-submarine-landing"]).has(n)||n.includes("military")||a.includes("military")||a.includes("installations")||n==="transport-opensky"||t==="flight"||a.includes("flight")||a.includes("aviation")||a.includes("airport")||a.includes("aircraft")||e.mapOnly&&a.includes("infrastructure")&&!a.includes("outage")||e.mapOnly&&s==="infrastructure"&&!a.includes("outage")||s==="crypto"||s==="finance")}function It(){return Bt().filter(e=>!Sr(e))}function nc(e){let t=0,n=(e.category||"").toLowerCase(),a=Array.isArray(e.tags)?e.tags.map(u=>String(u).toLowerCase()):[];e.alertType&&(t+=40),e.severity&&(t+=25),e.hazardType&&(t+=20),Number.isFinite(e.impactScore)&&(t+=Math.min(e.impactScore,80)),Number.isFinite(e.fatalities)&&(t+=Math.min(e.fatalities*5,60)),Number.isFinite(e.magnitude)&&(t+=Math.min((e.magnitude-3)*10,50)),new Set(["security","disaster","weather","health","infrastructure","transport","gov","travel"]).has(n)&&(t+=20),a.includes("outage")&&(t+=20),a.includes("evacuation")&&(t+=20),a.includes("emergency")&&(t+=20);let o=e.publishedAt||e.updatedAt||0;if(o){let u=Math.max(0,(Date.now()-o)/36e5);t+=Math.max(0,24-u)}let i=fr(e);return Number.isFinite(i)&&(t+=Math.max(0,25-Math.min(i,25))),t}function Rt(e,t,n,a){let o=(n-e)*Math.PI/180,i=(a-t)*Math.PI/180,u=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))}function Aa(){let e=pe(ue(r.items));if(r.settings.scope==="us"){let n=ft();return e=e.filter(a=>a.geo&&qs(a,n)),Zt(Un(e))}if(r.settings.scope==="local"){let{lat:n,lon:a}=r.location,s=r.settings.radiusKm,o=e.filter(i=>i.geo&&Rt(n,a,i.geo.lat,i.geo.lon)<=s);return Zt(Un(o))}let t=r.scopedItems.filter(n=>n.geo);return Zt(Un(t))}function Un(e){let t=[],n=[];if(e.forEach(o=>{o?.tags?.includes("wildfire")?t.push(o):n.push(o)}),!t.length)return e;t.sort((o,i)=>(i.publishedAt||0)-(o.publishedAt||0));let a=new Set,s=[];return t.forEach(o=>{if(!o.geo){s.push(o);return}let i=Math.round(o.geo.lat*10)/10,u=Math.round(o.geo.lon*10)/10,d=`${i}:${u}:${we(o.title||o.alertType||"fire")}`;a.has(d)||(a.add(d),s.push(o))}),[...n,...s]}function Zt(e){let t=[],n=[];if(e.forEach(o=>{o?.category==="security"||o?.tags?.includes("conflict")?t.push(o):n.push(o)}),!t.length)return e;let a=new Map;t.forEach(o=>{let i=o.conflictKey||(()=>{if(!o.geo)return"";let d=ta(o.publishedAt||Date.now()),m=Math.round(o.geo.lat*5)/5,f=Math.round(o.geo.lon*5)/5,p=we(o.alertType||o.eventType||o.title||"").slice(0,24);return`${d}:${m}:${f}:${p}`})();if(!i){let d=`na:${we(o.title||"").slice(0,24)}`,m=a.get(d)||[];m.push(o),a.set(d,m);return}let u=a.get(i)||[];u.push(o),a.set(i,u)});let s=[];return a.forEach(o=>{let u={...[...o].sort((m,f)=>(f.publishedAt||0)-(m.publishedAt||0))[0]},d=Array.from(new Set(o.map(m=>m.source||m.feedName||"").filter(Boolean)));d.length>1&&(u.verificationCount=d.length,u.verificationSources=d,u.verified=!0),s.push(u)}),[...n,...s]}function ac(e){if(!e)return"other";let t=(e.eventType||e.alertType||e.subEventType||e.title||"").toLowerCase();return t.includes("battle")?"battle":t.includes("explosion")||t.includes("remote violence")||t.includes("ied")||t.includes("bomb")||t.includes("incendiary")||t.includes("arson")?"explosion":t.includes("violence against civilians")||t.includes("violence")||t.includes("assault")||t.includes("shoot")||t.includes("active shooter")||t.includes("killing")||t.includes("murder")||t.includes("attack")||t.includes("ambush")||t.includes("stabbing")||t.includes("ramming")||t.includes("vandalism")?"violence":t.includes("riot")?"riot":t.includes("protest")||t.includes("demonstration")?"protest":t.includes("riot")?"riot":"other"}function on(){let e=an();be(l.localList,e)}function Te(e){let t=r.scopedItems.filter(a=>a.category===e);!t.length&&$o.has(e)&&(t=pe(ue(r.items)).filter(a=>a.category===e));let n=t;if(t=t.filter(a=>!a.mapOnly),e==="health"&&!t.length&&n.length)return{items:[],mapOnlyNotice:!0};if(e==="health"&&t.length&&r.settings.mapLayers.health){let a=t.filter(s=>s.feedId!=="openaq-api");if(a.length)t=a;else return{items:[],mapOnlyNotice:!0}}return e==="crypto"&&(t=[...t].sort((a,s)=>Math.abs(s.change24h||0)-Math.abs(a.change24h||0))),e==="research"&&(t=Ze(t)),e==="security"&&(t=Zt(t)),{items:t,mapOnlyNotice:!1}}function sc(e){let t=String(e?.signalType||"").trim().toLowerCase();return t?t==="executive_order"||t==="executive-order"||t==="executive order"||t.includes("executive")?"executive_order":t==="rulemaking"||t==="rule"||t==="rules"||t.includes("rule")?"rulemaking":t==="legislation"||t==="legislative"||t==="bill"||t==="bills"||t.includes("legis")||t.includes("bill")?"legislation":"other":"other"}function Ie(e=null){let t=r.scopedItems.filter(n=>n?.category==="gov"&&String(n?.jurisdictionLevel||"").toLowerCase()==="state"&&!n?.mapOnly);return t=Gs(t,{includeFederal:!1}),e&&(t=t.filter(n=>sc(n)===e)),[...t].sort((n,a)=>(a.publishedAt||0)-(n.publishedAt||0))}function xt(){return[...r.scopedItems.filter(t=>t?.category==="gov"&&String(t?.jurisdictionLevel||"").toLowerCase()!=="state"&&!t?.mapOnly&&!Zs(t))].sort((t,n)=>(n.publishedAt||0)-(t.publishedAt||0))}function Ta(e){return e?String(e).toUpperCase().replace(/\./g,"").trim():""}function wr(e,t,n){let a=Number(e);return!a||!t||!n?"":`${a}:${Ta(t)}:${n}`}function ws(e){return e?wr(e.congress,e.billType,e.billNumber):""}function Ls(e){return e?.alertType==="Amendment"}function rc(e,t){let n=Number(e);return!n||!t?"":`${n}:PN:${t}`}function oc(e){let t=typeof globalThis<"u"?globalThis.formatNominationTitle:void 0;if(typeof t=="function")return t(e);let n=e?.description||"";if(!n)return"";let[a,s]=n.split(", of "),o=n.split(" to be ");if(o.length>1){let i=o[0].replace(/,? of .*/i,"").trim(),u=o[1].replace(/, vice .*/i,"").trim();if(i&&u)return`${i} \u2014 ${u}`}if(a&&s){let i=s.split(", vice ")[0];if(i)return`${a.trim()} \u2014 ${i.trim()}`}return n}function ke(e){let t=typeof globalThis<"u"?globalThis.normalizeCongressUrl:void 0;if(typeof t=="function")return t(e);if(!e)return"";try{let n=new URL(e),a=`${n.origin}${n.pathname}`;return a.includes("/event/")&&a.includes("/text")?a.split("/text")[0]:a}catch{return e.split("#")[0].split("?")[0]}}function ic(e){return e.length?e.find(n=>{let a=oc(n),s=n.detailTitle||n.title||"";return a||n.description||s.includes("\u2014")||s.length>40})||e[0]:null}function lc(e){if(!e)return{amendment:null,bill:null};let t=e.amendment||e.amendments?.[0]||e.results?.[0]||e,n=t?.amendedBill||t?.amendedBills?.[0]||t?.bill||t?.legislation||null;return{amendment:t,bill:n}}function cc(e){return e?e.hearing||e.hearings?.[0]||e.meeting||e.meetings?.[0]||e.results?.[0]||e:null}function Lr(e){if(!e)return"";let t=String(e),n=t.match(/govinfo\.gov\/app\/details\/([^/?#]+)/i);if(n&&n[1])return n[1];let a=t.match(/\/content\/pkg\/([^/]+)/i);return a&&a[1]?a[1]:""}function uc(e){return e?`https://api.govinfo.gov/packages/${encodeURIComponent(e)}/summary`:""}async function dc(e){if(!e)return null;let{response:t,data:n}=await Ce(`/api/govinfo-detail?url=${encodeURIComponent(e)}`,{},12e3);return t?.ok?n:n?.status===404?{__empty:!0,__status:404}:null}async function mc(e){if(!e)return null;if(r.govinfoDetailCache.has(e))return r.govinfoDetailCache.get(e);if(r.govinfoDetailLoading.has(e))return r.govinfoDetailLoading.get(e);let t=dc(e).then(n=>{let a=n?.__empty?null:n;return r.govinfoDetailCache.set(e,a||null),r.govinfoDetailLoading.delete(e),a||null}).catch(()=>(r.govinfoDetailCache.set(e,null),r.govinfoDetailLoading.delete(e),null));return r.govinfoDetailLoading.set(e,t),t}async function pc(e,t){if(!t||!e)return;let n=t.querySelector(".detail-related-status"),a=e.packageId||Lr(e.externalUrl||e.url||""),s=e.apiUrl&&String(e.apiUrl).includes("api.govinfo.gov/packages/")?e.apiUrl:uc(a);if(!s){n&&(n.textContent="No GovInfo package identifier found.");return}let o=await mc(s);if(!o){n&&(n.textContent="GovInfo details unavailable right now.");return}n&&n.remove();let i=document.createElement("div");i.className="detail-section-title",i.textContent="GovInfo",t.appendChild(i),[{label:"Collection",value:o.collectionName||o.collectionCode||""},{label:"Package",value:o.packageId||a||""},{label:"Issued",value:o.dateIssued||""},{label:"Doc Class",value:o.docClass||o.documentType||""},{label:"Branch",value:o.branch||""},{label:"Congress",value:o.congress||""},{label:"Pages",value:o.pages||""},{label:"Category",value:o.category||""},{label:"Publisher",value:o.publisher||""},{label:"Last Modified",value:o.lastModified||""}].filter(m=>m.value).forEach(m=>{let f=document.createElement("div");f.className="detail-row";let p=document.createElement("div");p.className="detail-label",p.textContent=m.label;let h=document.createElement("div");h.className="detail-value",h.textContent=String(m.value),f.appendChild(p),f.appendChild(h),t.appendChild(f)});let d=o.detailsLink||"";d&&!e.externalUrl&&(e.externalUrl=d)}function gc(e){let t=e?.documentNumber||"";if(t&&/^\d{4}-\d{5}$/.test(t))return t;let n=String(e?.externalUrl||e?.url||""),a=n.match(/\/documents\/\d{4}\/\d{2}\/\d{2}\/(\d{4}-\d{5})\b/i)||n.match(/\/documents\/(\d{4}-\d{5})\b/i);return a&&a[1]?a[1]:""}async function fc(e){if(!e)return null;let{response:t,data:n}=await Ce(`/api/federal-register-detail?documentNumber=${encodeURIComponent(e)}`,{},12e3);return t?.ok?n:null}async function yc(e){if(!e)return null;if(r.federalRegisterDetailCache.has(e))return r.federalRegisterDetailCache.get(e);if(r.federalRegisterDetailLoading.has(e))return r.federalRegisterDetailLoading.get(e);let t=fc(e).then(n=>(r.federalRegisterDetailCache.set(e,n||null),r.federalRegisterDetailLoading.delete(e),n||null)).catch(()=>(r.federalRegisterDetailCache.set(e,null),r.federalRegisterDetailLoading.delete(e),null));return r.federalRegisterDetailLoading.set(e,t),t}async function hc({docketId:e,searchTerm:t="",pageSize:n=20,pageNumber:a=1,sort:s="-postedDate"}={}){if(!e)return{data:null,error:"missing_docketId"};let o=new URLSearchParams;o.set("docketId",e),t&&o.set("searchTerm",t),o.set("pageSize",String(n)),o.set("pageNumber",String(a)),o.set("sort",s);let{response:i,data:u,error:d}=await Ce(`/api/regulations-comments?${o.toString()}`,{},2e4);return!i?.ok||d?{data:null,error:u?.error||d||"fetch_failed"}:{data:u,error:null}}function As(e){let t=e?.data?.attributes||e?.attributes||{},n=String(t.organization||"").trim(),a=String(t.firstName||"").trim(),s=String(t.lastName||"").trim(),o=String(t.submitterRep||"").trim(),i=String(t.title||"").trim();return n||(a||s?`${a} ${s}`.trim():o||(/anonymous/i.test(i)?"Anonymous":""))}async function bc(e){if(!e)return null;let{response:t,data:n}=await Ce(`/api/regulations-comment-detail?commentId=${encodeURIComponent(e)}`,{},2e4);return t?.ok?n:null}async function Ts(e){if(!e)return null;if(r.regulationsCommentDetailCache.has(e))return r.regulationsCommentDetailCache.get(e);if(r.regulationsCommentDetailLoading.has(e))return r.regulationsCommentDetailLoading.get(e);let t=bc(e).then(n=>(r.regulationsCommentDetailCache.set(e,n||null),r.regulationsCommentDetailLoading.delete(e),n||null)).catch(()=>(r.regulationsCommentDetailCache.set(e,null),r.regulationsCommentDetailLoading.delete(e),null));return r.regulationsCommentDetailLoading.set(e,t),t}function vc(e){let t=String(e||"").trim();if(!t)return"";if(/^anonymous\b/i.test(t))return"Anonymous";let n=t.match(/comment submitted by\s+(.+)$/i);return n&&n[1]?n[1].trim():t.length>80?t.slice(0,80):t}async function Cc(e,t){if(!t||!e)return;let n=t.querySelector(".detail-related-status"),a=gc(e);if(!a){n&&(n.textContent="Federal Register identifier missing.");return}let s=await yc(a);if(!s){n&&(n.textContent="Federal Register detail unavailable right now.");return}n&&n.remove();let o=document.createElement("div");o.className="detail-section-title",o.textContent="Public Comments",t.appendChild(o);let i=s.regulations_dot_gov_info||{},u=i.docket_id||"",d=i.comments_url||i.commentsUrl||"",m=s.comment_url||s.regulations_dot_gov_url||"",f=s.comments_close_on||"",p=Number.isFinite(Number(i.comments_count))?Number(i.comments_count):null;[{label:"Docket",value:u||(Array.isArray(s.docket_ids)?s.docket_ids[0]:"")},{label:"Comments Close",value:f||""},{label:"Count",value:p!==null?String(p):""}].filter(F=>F.value).forEach(F=>{let x=document.createElement("div");x.className="detail-row";let _=document.createElement("div");_.className="detail-label",_.textContent=F.label;let c=document.createElement("div");c.className="detail-value",c.textContent=F.value,x.appendChild(_),x.appendChild(c),t.appendChild(x)});let y=document.createElement("div");if(y.className="detail-actions",d){let F=document.createElement("a");F.className="btn ghost",F.href=d,F.target="_blank",F.rel="noopener noreferrer",F.textContent="Open Docket",y.appendChild(F)}if(m){let F=document.createElement("a");F.className="btn",F.href=m,F.target="_blank",F.rel="noopener noreferrer",F.textContent="Submit / View Comments",y.appendChild(F)}if(y.childNodes.length&&t.appendChild(y),!u){let F=document.createElement("div");F.className="detail-related-status",F.textContent="Comment docket unavailable for this document.",t.appendChild(F);return}let g=document.createElement("div");g.className="detail-subsection";let b=document.createElement("div");b.className="detail-section-title",b.textContent="Search Comments",g.appendChild(b);let C=document.createElement("input");C.type="text",C.placeholder="Search within public comments (optional)\u2026",C.autocomplete="off",g.appendChild(C);let v=document.createElement("button");v.className="btn ghost",v.type="button",v.textContent="Search",g.appendChild(v);let S=document.createElement("div");S.className="detail-related-status",S.textContent="Enter a term to search, or run empty to see latest comments.",g.appendChild(S);let w=document.createElement("div");w.className="detail-list",g.appendChild(w);let I=document.createElement("div");I.className="detail-actions";let A=document.createElement("button");A.className="btn ghost",A.type="button",A.textContent="Load more",A.disabled=!0,I.appendChild(A),g.appendChild(I),t.appendChild(g);let E={searchTerm:"",pageNumber:1,pageSize:20,hasNextPage:!1,totalElements:null,loaded:[],submitterCounts:new Map},T=F=>{let x=F?.data,_=Array.isArray(x?.data)?x.data:Array.isArray(x)?x:[],c=x?.meta||F?.meta||{};return{items:_,meta:c}},D=F=>{let x=F?.attributes?.title||"";return vc(x)||"Unknown"},M=()=>{let F=[...E.submitterCounts.entries()].sort((c,k)=>k[1]-c[1]).slice(0,6).map(([c,k])=>`${c} (${k})`),x=Number.isFinite(E.totalElements)?` of ${E.totalElements}`:"",_=E.loaded.length;S.textContent=_?`Loaded ${_}${x} comments. Top submitters: ${F.join(", ")||"\u2014"}`:"No comments found."},P=F=>{let x=document.createElement("div");x.className="detail-item";let _=document.createElement("div");_.className="detail-item-title";let c=document.createElement("a");c.href=`https://www.regulations.gov/document/${F.id}`,c.target="_blank",c.rel="noopener noreferrer",c.textContent=F?.attributes?.title||F.id,_.appendChild(c),x.appendChild(_);let k=document.createElement("div");k.className="detail-item-meta",k.textContent=F?.attributes?.postedDate?le(F.attributes.postedDate):"",x.appendChild(k);let N=F?.attributes?.highlightedContent||"";if(N){let re=document.createElement("div");re.className="detail-item-summary",re.textContent=se(he(N),240),x.appendChild(re)}let $=document.createElement("button");$.className="btn ghost",$.type="button",$.textContent="Details",x.appendChild($);let O=document.createElement("div");O.className="detail-item-summary",O.style.display="none",x.appendChild(O);let G=!1,W=async()=>{if(G){G=!1,$.textContent="Details",O.style.display="none";return}G=!0,$.textContent="Hide",O.style.display="block",O.textContent="Loading comment detail\u2026";let re=await Ts(F.id);if(!re){O.textContent="Comment detail unavailable.";return}let K=re?.data?.attributes||{},H=As(re)||D(F),j=K.subtype||K.category||"",ge=K.trackingNbr||"",oe=K.receiveDate||"",xe=K.comment||"",ye=[];H&&ye.push(`Submitter: ${H}`),j&&ye.push(`Type: ${j}`),ge&&ye.push(`Tracking: ${ge}`),oe&&ye.push(`Received: ${le(oe)}`),xe&&ye.push(`Comment: ${se(he(xe),360)}`),O.textContent=ye.length?ye.join(" \u2022 "):"No extra metadata on this comment."};return $.addEventListener("click",W),x},B=F=>{F.forEach(x=>{if(!x?.id||E.loaded.some(c=>c.id===x.id))return;E.loaded.push(x);let _=D(x);E.submitterCounts.set(_,(E.submitterCounts.get(_)||0)+1),w.appendChild(P(x))}),M()},U=async F=>{let x=F.slice(0,10),_=3,c=[...x],k=Array.from({length:_}).map(async()=>{for(;c.length;){let N=c.shift();if(!N?.id)continue;let $=await Ts(N.id);if(!$)continue;let O=As($);if(!O)continue;let G=D(N);if(G===O)continue;let W=E.submitterCounts.get(G)||0;W>0&&E.submitterCounts.set(G,W-1),E.submitterCounts.set(O,(E.submitterCounts.get(O)||0)+1)}});await Promise.all(k),M()},q=async({reset:F=!0}={})=>{v.disabled=!0,A.disabled=!0,S.textContent=F?"Searching comments\u2026":"Loading more comments\u2026";try{let x=C.value.trim();F&&(w.innerHTML="",E.loaded=[],E.submitterCounts=new Map,E.pageNumber=1,E.searchTerm=x,E.totalElements=null);let _=await hc({docketId:u,searchTerm:x,pageSize:E.pageSize,pageNumber:E.pageNumber,sort:"-postedDate"});if(_.error||!_.data){S.textContent="Comment search unavailable right now.",w.innerHTML="";return}let{items:c,meta:k}=T(_);if(F&&!c.length){S.textContent="No comments found.",w.innerHTML="";return}E.hasNextPage=!!k?.hasNextPage,E.totalElements=Number.isFinite(Number(k?.totalElements))?Number(k.totalElements):E.totalElements,B(c),A.disabled=!E.hasNextPage,c.length&&U(c).catch(()=>{})}finally{v.disabled=!1}};v.addEventListener("click",q),C.addEventListener("keydown",F=>{F.key==="Enter"&&q()}),A.addEventListener("click",async()=>{E.hasNextPage&&(E.pageNumber+=1,await q({reset:!1}))})}async function Ea(e){if(!e)return null;let{response:t,data:n}=await Ce(`/api/congress-detail?url=${encodeURIComponent(e)}`,{},12e3);return t?.ok?n:n?.status===404?{__empty:!0,__status:404}:null}function Z(e){return`https://api.congress.gov/v3${e}`}function Hn(e){return e?Ta(e).toLowerCase():""}function ae(e,t){if(!e)return[];for(let n of t){let a=e[n];if(Array.isArray(a))return a;if(Array.isArray(a?.items))return a.items;if(Array.isArray(a?.item))return a.item;if(Array.isArray(a?.results))return a.results;if(Array.isArray(a?.result))return a.result}return[]}async function Sc(e){if(!e)return null;if(r.congressDetailCache.has(e))return r.congressDetailCache.get(e);if(r.congressDetailLoading.has(e))return r.congressDetailLoading.get(e);let t=Ea(e).then(n=>{let a=n?.__empty?null:n;return r.congressDetailCache.set(e,a||null),r.congressDetailLoading.delete(e),a||null}).catch(()=>(r.congressDetailCache.set(e,null),r.congressDetailLoading.delete(e),null));return r.congressDetailLoading.set(e,t),t}function wc(e){let t=[];if(e?.feedId==="congress-summaries"&&e.apiUrl){let v=String(e.apiUrl||"").match(/https?:\/\/api\.congress\.gov\/v3(.*)/i);if(v&&v[1]){let S=v[1].startsWith("/")?v[1]:`/${v[1]}`,w=S.includes("format=json")?S:`${S}${S.includes("?")?"&":"?"}format=json`;t.push({type:"summary-detail",label:"Summary Detail",url:Z(w)})}}let n=e.congress,a=Hn(e.billType),s=e.billNumber;if(n&&a&&s){let C=`/bill/${n}/${a}/${s}`;t.push({type:"bill-detail",label:"Bill Detail",url:Z(`${C}?format=json`)}),t.push({type:"summary",label:"Summary",url:Z(`${C}/summaries?format=json`)}),t.push({type:"actions",label:"Actions",url:Z(`${C}/actions?format=json&limit=20`)}),t.push({type:"committees",label:"Committees",url:Z(`${C}/committees?format=json&limit=20`)}),t.push({type:"cosponsors",label:"Cosponsors",url:Z(`${C}/cosponsors?format=json&limit=20`)}),t.push({type:"related",label:"Related Bills",url:Z(`${C}/relatedbills?format=json&limit=20`)}),t.push({type:"subjects",label:"Subjects",url:Z(`${C}/subjects?format=json&limit=20`)}),t.push({type:"titles",label:"Titles",url:Z(`${C}/titles?format=json&limit=20`)}),t.push({type:"text",label:"Text Versions",url:Z(`${C}/text?format=json&limit=20`)}),t.push({type:"bill-amendments",label:"Bill Amendments",url:Z(`${C}/amendments?format=json&limit=20`)})}let o=Hn(e.amendmentType),i=e.amendmentNumber;if(n&&o&&i){let C=`/amendment/${n}/${o}/${i}`;t.push({type:"amendment-detail",label:"Amendment Detail",url:Z(`${C}?format=json`)}),t.push({type:"amend-actions",label:"Amendment Actions",url:Z(`${C}/actions?format=json&limit=20`)}),t.push({type:"amend-cosponsors",label:"Amendment Cosponsors",url:Z(`${C}/cosponsors?format=json&limit=20`)}),t.push({type:"amendment-amendments",label:"Amendment Amendments",url:Z(`${C}/amendments?format=json&limit=20`)}),t.push({type:"amend-text",label:"Amendment Text",url:Z(`${C}/text?format=json&limit=20`)})}let u=e.voteNumber,d=e.voteSession;if(n&&d&&u){let C=`/house-vote/${n}/${d}/${u}`;t.push({type:"vote",label:"Vote Detail",url:Z(`${C}?format=json&limit=20`)}),t.push({type:"vote-members",label:"Member Votes",url:Z(`${C}/members?format=json&limit=500`)})}let m=e.committeeCode,f=(e.committeeChamber||"").toLowerCase();if(m&&f){let C=`/committee/${f}/${m}`;t.push({type:"committee-detail",label:"Committee Detail",url:Z(`${C}?format=json`)}),t.push({type:"committee-bills",label:"Committee Bills",url:Z(`${C}/bills?format=json&limit=20`)}),t.push({type:"committee-reports",label:"Committee Reports",url:Z(`${C}/reports?format=json&limit=20`)}),t.push({type:"committee-nominations",label:"Committee Nominations",url:Z(`${C}/nominations?format=json&limit=20`)}),t.push({type:"committee-communications-house",label:"Committee House Communications",url:Z(`${C}/house-communication?format=json&limit=20`)}),t.push({type:"committee-communications-senate",label:"Committee Senate Communications",url:Z(`${C}/senate-communication?format=json&limit=20`)})}let p=Hn(e.reportType),h=e.reportNumber;if(n&&p&&h){let C=`/committee-report/${n}/${p}/${h}`;t.push({type:"report-detail",label:"Committee Report",url:Z(`${C}?format=json`)}),t.push({type:"report-text",label:"Report Text",url:Z(`${C}/text?format=json&limit=20`)})}let y=e.jacketNumber;if(n&&f&&y&&e.alertType==="Committee Print"){let C=`/committee-print/${n}/${f}/${y}`;t.push({type:"print-detail",label:"Committee Print",url:Z(`${C}?format=json`)}),t.push({type:"print-text",label:"Print Text",url:Z(`${C}/text?format=json&limit=20`)})}if(e.alertType==="Committee Meeting"&&n&&f&&(e.eventId||e.meetingId||e.event)){let C=e.eventId||e.meetingId||e.event,v=`/committee-meeting/${n}/${f}/${C}`;t.push({type:"meeting-detail",label:"Meeting Detail",url:Z(`${v}?format=json`)})}let g=e.communicationType,b=e.communicationNumber;if(n&&g&&b){let v=`/${(e.communicationChamber||"").toLowerCase()==="senate"?"senate":"house"}-communication/${n}/${g}/${b}`;t.push({type:"communication-detail",label:"Communication Detail",url:Z(`${v}?format=json`)})}return t}function X(e,t){if(!t.length)return null;let n=document.createElement("div");n.className="detail-subsection";let a=document.createElement("div");a.className="detail-section-title",a.textContent=e,n.appendChild(a);let s=document.createElement("div");return s.className="detail-list",t.forEach(o=>{let i=document.createElement("div");i.className="detail-item";let u=document.createElement("div");if(u.className="detail-item-title",o.url){let d=document.createElement("a");d.href=o.url,d.target="_blank",d.rel="noopener noreferrer",d.textContent=o.title||"View",u.appendChild(d)}else u.textContent=o.title||"View";if(i.appendChild(u),o.meta){let d=document.createElement("div");d.className="detail-item-meta",d.textContent=o.meta,i.appendChild(d)}if(o.summary){let d=document.createElement("div");d.className="detail-item-summary",d.textContent=o.summary,i.appendChild(d)}s.appendChild(i)}),n.appendChild(s),n}function jt(e,t=8){return!Array.isArray(e)||!e.length?[]:e.slice(0,t).map(n=>({title:n.fullName||n.name||n.bioguideId||n.bioguide||"Member",meta:[n.party,n.state,n.district?`District ${n.district}`:""].filter(Boolean).join(" \u2022 "),url:ke(n.url)||""}))}function Es(e,t,n,a={}){t.innerHTML="";let s=document.createElement("div");if(s.className="detail-section-title",s.textContent="Congress.gov Details",t.appendChild(s),!n.length){let o=document.createElement("div");if(o.className="detail-related-status",o.textContent="No additional Congress.gov details available.",t.appendChild(o),a.emptyCount){let i=document.createElement("div");i.className="detail-related-status",i.textContent="Some Congress.gov endpoints returned no data (404).",t.appendChild(i)}return}if(n.forEach(o=>{o&&t.appendChild(o)}),a.emptyCount){let o=document.createElement("div");o.className="detail-related-status",o.textContent="Some Congress.gov endpoints returned no data (404).",t.appendChild(o)}}async function Lc(e,t){let n=wc(e);if(!n.length){Es(e,t,[]);return}let a=!1,s=0,o=await Promise.allSettled(n.map(async u=>{let d=await Sc(u.url);return{target:u,detail:d}})),i=[];if(o.forEach(u=>{if(u.status!=="fulfilled"||!u.value.detail)return;let{target:d,detail:m}=u.value;if(m?.__empty){s+=1;return}if(d.type==="summary-detail"){let f=m?.summary||m?.summaries?.[0]||m,p=f?.summaryText||f?.summary||f?.text||f?.description||"";if(p){a=!0;let h=document.createElement("div");h.className="detail-subsection";let y=document.createElement("div");y.className="detail-section-title",y.textContent="Summary Detail",h.appendChild(y);let g=document.createElement("div");g.className="detail-rich-text",g.textContent=se(he(p),1400),h.appendChild(g),i.push(h)}return}if(d.type==="summary"){let f=ae(m,["summaries","summary","items"]),p=f.find(y=>y?.summaryText||y?.summary||y?.text)||f[0],h=p?.summaryText||p?.summary||p?.text||"";if(h){a=!0;let y=document.createElement("div");y.className="detail-subsection";let g=document.createElement("div");g.className="detail-section-title",g.textContent="Summary",y.appendChild(g);let b=document.createElement("div");b.className="detail-summary";let C=document.createElement("p");C.textContent=h,b.appendChild(C),y.appendChild(b),i.push(y)}return}if(d.type==="bill-detail"){let f=m?.bill||m;if(!f)return;let p=jt(ae(f,["sponsors","sponsor","sponsorItem"])),h=jt(ae(f,["onBehalfOfSponsor","onBehalfOf","onBehalf"])),y=ae(f,["cboCostEstimates","cboCostEstimate"]).slice(0,6).map(v=>({title:v.title||v.description||"CBO Cost Estimate",meta:v.pubDate?le(v.pubDate):"",url:v.url||v.link||""})),g=ae(f,["laws","law"]).slice(0,4).map(v=>({title:[v.lawType,v.lawNumber].filter(Boolean).join(" ")||"Law",meta:v.lawType||""})),b=ae(f,["committeeReports","committeeReport"]).slice(0,6).map(v=>({title:v.citation||v.reportTitle||"Committee Report",meta:[v.reportType,v.reportNumber].filter(Boolean).join(" "),url:ke(v.url||v.link||"")}));if(p.length){let v=X("Sponsors",p);v&&i.push(v)}if(h.length){let v=X("Introduced On Behalf Of",h);v&&i.push(v)}if(y.length){let v=X("CBO Cost Estimates",y);v&&i.push(v)}if(g.length){let v=X("Laws",g);v&&i.push(v)}if(b.length){let v=X("Committee Reports",b);v&&i.push(v)}let C=f.constitutionalAuthorityStatementText||"";if(C){let v=document.createElement("div");v.className="detail-subsection";let S=document.createElement("div");S.className="detail-section-title",S.textContent="Constitutional Authority Statement",v.appendChild(S);let w=document.createElement("div");w.className="detail-rich-text",w.textContent=se(he(C),1200),v.appendChild(w),i.push(v)}return}if(d.type==="amendment-detail"){let f=m?.amendment||m;if(!f)return;let p=jt(ae(f,["sponsors","sponsor","sponsorItem"])),h=jt(ae(f,["onBehalfOf","onBehalf"])),y=[];if(f.amendedBill){let g=f.amendedBill;y.push({title:g.title||[g.type,g.number].filter(Boolean).join(" ")||"Amended Bill",meta:[g.congress?`${g.congress}th Congress`:"",g.type,g.number].filter(Boolean).join(" \u2022 "),url:g.url||""})}if(f.amendedAmendment){let g=f.amendedAmendment;y.push({title:g.title||[g.type,g.number].filter(Boolean).join(" ")||"Amended Amendment",meta:[g.congress?`${g.congress}th Congress`:"",g.type,g.number].filter(Boolean).join(" \u2022 "),url:g.url||""})}if(f.amendedTreaty){let g=f.amendedTreaty;y.push({title:g.title||g.topic||"Amended Treaty",meta:[g.congress?`${g.congress}th Congress`:"",g.number||g.treatyNumber].filter(Boolean).join(" \u2022 "),url:g.url||""})}if(p.length){let g=X("Sponsors",p);g&&i.push(g)}if(h.length){let g=X("Submitted On Behalf Of",h);g&&i.push(g)}if(y.length){let g=X("Amends",y);g&&i.push(g)}return}if(d.type==="actions"||d.type==="amend-actions"){let p=ae(m,["actions","action"]).slice(0,8).map(y=>({title:y.text||y.action||y.actionDesc||"Action",meta:y.actionDate?le(y.actionDate):"",summary:y.committee||y.committeeName||""})),h=X("Actions",p);h&&i.push(h);return}if(d.type==="committees"){let p=ae(m,["committees","committee"]).slice(0,8).map(y=>({title:y.name||y.committeeName||y.systemCode||"Committee",meta:[y.chamber,y.systemCode].filter(Boolean).join(" \u2022 ")})),h=X("Committees",p);h&&i.push(h);return}if(d.type==="cosponsors"||d.type==="amend-cosponsors"){let p=ae(m,["cosponsors","cosponsor"]).slice(0,8).map(y=>({title:y.fullName||y.name||y.bioguideId||"Cosponsor",meta:[y.party,y.state].filter(Boolean).join(" \u2022 ")})),h=X("Cosponsors",p);h&&i.push(h);return}if(d.type==="related"){let p=ae(m,["relatedBills","relatedBill"]).slice(0,8).map(y=>({title:y.title||y.number||"Related Bill",meta:[y.type,y.number].filter(Boolean).join(" "),summary:y.relationshipType||y.relationship||""})),h=X("Related Bills",p);h&&i.push(h);return}if(d.type==="subjects"){let p=ae(m,["subjects","subject"]).slice(0,8).map(y=>({title:y.name||y.subject||y.term||"Subject",meta:y.policyArea?`Policy Area: ${y.policyArea}`:""})),h=X("Subjects",p);h&&i.push(h);return}if(d.type==="titles"){let p=ae(m,["titles","title"]).slice(0,8).map(y=>({title:y.title||y.text||"Title",meta:y.titleType||y.type||""})),h=X("Titles",p);h&&i.push(h);return}if(d.type==="text"||d.type==="amend-text"||d.type==="report-text"||d.type==="print-text"){let p=ae(m,["textVersions","textVersion","text","texts"]).slice(0,8).map(y=>({title:y.type||y.format||y.description||"Text Version",meta:y.date?le(y.date):"",url:y.url||y.link||y.pdfUrl||""})),h=X("Text Versions",p);h&&i.push(h);return}if(d.type==="bill-amendments"){if(Array.isArray(e.amendments)&&e.amendments.length)return;let p=ae(m,["amendments","amendment"]).slice(0,6).map(y=>({title:y.title||y.number||"Amendment",meta:[y.type,y.number].filter(Boolean).join(" ")})),h=X("Amendments",p);h&&i.push(h);return}if(d.type==="amendment-amendments"){let p=ae(m,["amendments","amendment"]).slice(0,6).map(y=>({title:y.title||y.number||"Amendment",meta:[y.type,y.number].filter(Boolean).join(" "),url:ke(y.url||y.link||"")})),h=X("Amendments to Amendment",p);h&&i.push(h);return}if(d.type==="vote"||d.type==="vote-members"){let f=m?.houseRollCallVote||m?.houseRollCallVotes?.[0]||m?.houseVote||m,p=[{label:"Question",value:f?.voteQuestion||f?.question},{label:"Result",value:f?.voteResult||f?.result},{label:"Vote Type",value:f?.voteType||f?.voteTypeCode},{label:"Legislation",value:[f?.legislationType,f?.legislationNumber].filter(Boolean).join(" ")},{label:"Start",value:f?.startDate?le(f.startDate):""},{label:"Source",value:f?.sourceDataURL||f?.url}].filter(v=>v.value);if(p.length){let v=p.map(w=>({title:w.label,meta:w.label==="Source"?"":w.value,url:w.label==="Source"?w.value:""})),S=X("Vote Metadata",v);S&&i.push(S)}let y=ae(f,["members","member","votes","houseRollCallVoteMembers"]).reduce((v,S)=>{let w=(S.voteCast||S.vote||S.position||"Other").toString();return v[w]=(v[w]||0)+1,v},{}),g=Object.entries(y).map(([v,S])=>({title:v,meta:`${S} members`})),b=X("Vote Breakdown",g);b&&i.push(b);let C=f?.votesPartyTotal||f?.votePartyTotals||f?.votesByPartyTotal||f?.voteTotals;if(Array.isArray(C)&&C.length){let v=C.slice(0,10).map(w=>({title:w.party||w.partyCode||w.partyName||"Party",meta:[w.yea?`Yea ${w.yea}`:"",w.nay?`Nay ${w.nay}`:"",w.present?`Present ${w.present}`:"",w.notVoting?`Not Voting ${w.notVoting}`:""].filter(Boolean).join(" \u2022 ")})),S=X("Party Totals",v);S&&i.push(S)}return}if(d.type==="committee-detail"){let f=m?.committee||m;if(!f)return;let p=[{title:f.name||f.committeeName||"Committee Detail",meta:[f.chamber,f.systemCode].filter(Boolean).join(" \u2022 "),summary:f.jurisdiction||f.description||""}],h=X("Committee Detail",p);h&&i.push(h);return}if(d.type==="committee-bills"||d.type==="committee-reports"||d.type==="committee-nominations"){let p=ae(m,["bills","bill","committeeReports","committeeReport","nominations","nomination"]).slice(0,8).map(g=>({title:g.title||g.number||g.citation||"Item",meta:g.number||g.citation||""})),y=X({"committee-bills":"Committee Bills","committee-reports":"Committee Reports","committee-nominations":"Committee Nominations"}[d.type],p);y&&i.push(y);return}if(d.type==="committee-communications-house"||d.type==="committee-communications-senate"||d.type==="communication-detail"){let p=ae(m,["communications","communication","houseCommunication","senateCommunication"]).slice(0,8).map(y=>({title:y.description||y.title||"Communication",meta:[y.communicationType||y.type,y.number].filter(Boolean).join(" "),summary:y.abstract||y.summary||""})),h=X("Communications",p);if(h&&i.push(h),d.type==="communication-detail"){let y=m?.houseCommunication||m?.senateCommunication||m?.communication||m;if(y?.abstract){let T=document.createElement("div");T.className="detail-subsection";let D=document.createElement("div");D.className="detail-section-title",D.textContent="Abstract",T.appendChild(D);let M=document.createElement("div");M.className="detail-rich-text",M.textContent=se(he(y.abstract),800),T.appendChild(M),i.push(T)}let b=ae(y,["committees","committee"]).slice(0,6).map(T=>({title:T.name||T.committeeName||"Committee",meta:T.referralDate?le(T.referralDate):"",url:ke(T.url)||""})),C=X("Committees",b);C&&i.push(C);let S=ae(y,["matchingRequirements","matchingRequirement"]).slice(0,6).map(T=>({title:T.number||T.title||T.requirement||"Requirement",meta:T.name||T.type||"",url:T.url||T.URL||""})),w=X("Matching Requirements",S);w&&i.push(w);let A=ae(y,["houseDocument","houseDocuments","document"]).slice(0,6).map(T=>({title:T.documentNumber||T.documentTitle||T.title||"Document",meta:T.documentType||T.type||"",url:T.url||T.URL||""})),E=X("House Documents",A);E&&i.push(E)}return}if(d.type==="report-detail"||d.type==="print-detail"||d.type==="meeting-detail"){let f=m?.report||m?.print||m?.meeting||m?.committeePrint||m?.committeeMeeting||m;if(!f)return;let p=[{title:f.title||f.meetingTitle||f.description||d.label,meta:[f.chamber,f.jacketNumber].filter(Boolean).join(" \u2022 "),summary:f.summary||f.description||""}],h=X(d.label,p);h&&i.push(h)}}),!a){let u=e.summaryHtml||e.summaryText||e.summary||"";if(u){let d=document.createElement("div");d.className="detail-subsection";let m=document.createElement("div");m.className="detail-section-title",m.textContent="Summary",d.appendChild(m);let f=document.createElement("div");f.className="detail-rich-text",f.textContent=se(he(u),1400),d.appendChild(f),i.push(d)}}Es(e,t,i,{emptyCount:s})}async function Ac(e){if(!e.length)return;let t=e.filter(a=>a.apiUrl&&!r.congressHearingCache.has(a.apiUrl));if(!t.length)return;let n=t.slice(0,40);for(let a of n){let s=await Ea(a.apiUrl);r.congressHearingCache.set(a.apiUrl,s||null)}}async function Tc(e){if(!e.length||r.congressAmendmentsLoading)return;let t=e.filter(n=>n.apiUrl&&!r.congressAmendmentCache.has(n.apiUrl));if(t.length){r.congressAmendmentsLoading=!0;try{let n=t.slice(0,80);for(let a of n){let s=await Ea(a.apiUrl);r.congressAmendmentCache.set(a.apiUrl,s||null);let{amendment:o,bill:i}=lc(s),u=wr(i?.congress||a.congress,i?.type||a.billType,i?.number||a.billNumber);if(!u)continue;let d={title:a.title,summary:a.summary,publishedAt:a.publishedAt,externalUrl:a.externalUrl,type:Ta(a.amendmentType||a.type),number:a.amendmentNumber||a.number,chamber:a.location||a.chamber||"",purpose:o?.purpose||o?.description||""},f=[...r.congressBillAmendments.get(u)||[],d].filter((p,h,y)=>p.externalUrl?y.findIndex(g=>g.externalUrl===p.externalUrl)===h:y.findIndex(g=>g.title===p.title)===h);f.sort((p,h)=>(h.publishedAt||0)-(p.publishedAt||0)),r.congressBillAmendments.set(u,f.slice(0,50))}Er()}finally{r.congressAmendmentsLoading=!1}}}function pt(){let e=g=>g.feedId==="congress-api"||g.tags?.includes("congress"),t=r.scopedItems.filter(e);t.length||(t=pe(ue(r.items)).filter(e)),t=t.filter(g=>!g.mapOnly);let n=g=>g.alertType==="Summary"||g.feedId==="congress-summaries",a=new Map;t.filter(n).forEach(g=>{let b=ws(g);if(!b)return;let C=a.get(b),v=C?.summaryUpdatedAt||C?.publishedAt||0,S=g.summaryUpdatedAt||g.publishedAt||0;(!C||S>v)&&a.set(b,g)}),t=t.filter(g=>!n(g));let s=Ze(t),o=s.filter(Ls),i=s.filter(g=>g.alertType==="Hearing"),u=s.filter(g=>g.nominationId),d=s.filter(g=>!Ls(g));Tc(o),Ac(i);let m=new Map;u.forEach(g=>{let b=rc(g.congress,g.nominationId);if(!b)return;let C=m.get(b)||[];C.push(g),m.set(b,C)});let f=[];m.forEach(g=>{let b=[...g].sort((w,I)=>(I.publishedAt||0)-(w.publishedAt||0)),C=ic(b)||b[0];if(!C)return;let v=b.map(w=>({title:w.summary||w.title,publishedAt:w.publishedAt,externalUrl:w.externalUrl})),S=b[0]?.publishedAt||C.publishedAt;f.push({...C,nominationActions:v,publishedAt:S})});let p=new Map;i.forEach(g=>{let b=cc(r.congressHearingCache.get(g.apiUrl));if(!b)return;let C=b.meetingTitle||b.title||b.eventTitle||b.description||g.title,v=b.committee?.name||b.committees?.[0]?.name||b.committeeName,S=b.date||b.meetingDate||b.startDate,w=(b.chamber||g.chamber||"").toLowerCase(),I=b.congress||g.congress,A=b.eventId||b.hearingId||b.meetingId||b.event,E=I&&A&&(w==="house"||w==="senate")?`https://www.congress.gov/event/${I}th-congress/${w}-event/${A}`:"",T=ke(b.url)||ke(b.websiteUrl)||ke(b.eventUrl)||ke(b.congressUrl)||ke(E)||ke(g.externalUrl)||ke(g.fallbackUrl);p.set(g.apiUrl,{title:C||g.title,committee:v,when:S,link:T})});let y=[...d.filter(g=>!g.nominationId),...f].map(g=>{let b=g.publishedAt||0;if(g.alertType==="Hearing"&&g.apiUrl&&p.has(g.apiUrl)){let A=p.get(g.apiUrl),E=[A.committee,g.chamber,A.when?le(A.when):""].filter(Boolean);return{...g,title:A.title||g.title,detailTitle:A.title||g.detailTitle,summary:E.length?E.join(" \u2022 "):g.summary,externalUrl:A.link?A.link:g.externalUrl||g.fallbackUrl,detailFields:g.detailFields?.map(T=>T.label==="Committee"&&A.committee?{...T,value:A.committee}:T.label==="Hearing Date"&&A.when?{...T,value:le(A.when)}:T),congressSortTime:b}}let C=ws(g),v=C?a.get(C):null;if(v?.summary){let A=se(v.summary,360);g={...g,summary:A||g.summary,summaryHtml:v.summaryHtml||v.summaryText||g.summaryHtml,summaryUpdatedAt:v.summaryUpdatedAt||g.summaryUpdatedAt,summaryVersionCode:v.summaryVersionCode||g.summaryVersionCode,summaryActionDesc:v.summaryActionDesc||g.summaryActionDesc}}let S=C?r.congressBillAmendments.get(C)||[]:[],w=S[0]?.publishedAt||0,I=Math.max(b,w||0);return{...g,amendments:S,congressSortTime:I}});return y.sort((g,b)=>(b.congressSortTime||0)-(g.congressSortTime||0)),y.map(({congressSortTime:g,...b})=>b)}function Ue(e,t){if(!t)return;let{items:n,mapOnlyNotice:a}=Te(e);if(a){t.innerHTML='<div class="list-item"><div class="list-title">Air quality signals are shown on the map.</div><div class="list-summary">Toggle the Health layer in the map legend to filter air quality stations.</div></div>';return}be(t,n)}function Ar(){if(!l.policyList)return;let e=xt();be(l.policyList,e)}function Tr(){let e=Ie(),t=Ie("legislation"),n=Ie("rulemaking"),a=Ie("executive_order");l.stateGovAllList&&be(l.stateGovAllList,e),l.stateGovLegislationList&&be(l.stateGovLegislationList,t);let s=r.feeds.find(m=>m.id==="state-rulemaking"),o=r.feeds.find(m=>m.id==="state-executive-orders"),i=!!(s?.requiresConfig&&!s?.url),u=!!(o?.requiresConfig&&!o?.url),d='<div class="list-item"><div class="list-title">Rulemaking/Executive Order connectors are not configured yet; legislation remains live.</div></div>';l.stateGovRulemakingList&&(!n.length&&i?l.stateGovRulemakingList.innerHTML=d:be(l.stateGovRulemakingList,n)),l.stateGovExecutiveOrdersList&&(!a.length&&u?l.stateGovExecutiveOrdersList.innerHTML=d:be(l.stateGovExecutiveOrdersList,a))}function Er(){if(!l.congressList)return;let e=pt();be(l.congressList,e)}function lt(e){let t=r.scopedItems.filter(n=>e.includes(n.category));return(e.includes("weather")||e.includes("disaster")||e.includes("space"))&&(t=Ze(t.map(n=>({...n,_dedupeKey:`${we(n.alertType||"")}|${we(n.title||"")}|${we(n.location||n.geoLabel||"")}`}))).map(n=>{let{_dedupeKey:a,...s}=n;return s})),t}function jn(e,t){if(!t)return;let n=lt(e);be(t,n)}function ra(){let e=Array.isArray(r.scopedItems)?r.scopedItems:[],t=pe(ue(r.items)),a=(e.length?e:t).filter(o=>!o||o.category==="crypto"||o.category==="finance"||o.category==="energy"||o.mapOnly?!1:Sa(o)||Ot(o)&&!!(o.severity||o.alertType||o.hazardType)),s=Ze(a);return s.sort((o,i)=>(i.publishedAt||0)-(o.publishedAt||0)),s.slice(0,60)}function Ec(){if(!l.criticalAlertsList)return;let e=ra();be(l.criticalAlertsList,e)}function oa(){if(!l.energyList)return;let e=sn();be(l.energyList,e)}async function kc(){if(!(r.predictionFallback.loading||r.predictionFallback.loaded)){r.predictionFallback.loading=!0;try{let e=r.feeds.find(a=>a.id==="polymarket-markets");if(!e){r.predictionFallback.loaded=!0;return}let n=await(await fetch(`${Be("/data/feeds/polymarket-markets.json")}?_ts=${Date.now()}`)).json();if(n?.body){let a=en(n.body,e)||[];r.predictionFallback.items=a.map(s=>({...s,tags:e.tags||[],feedId:e.id,feedName:e.name}))}r.predictionFallback.loaded=!0}catch{r.predictionFallback.loaded=!0}finally{r.predictionFallback.loading=!1}}}function ln(){let e=Te("prediction").items;if(!e.length&&r.predictionFallback.items.length&&(e=r.predictionFallback.items),!e.length)return[];let t=y=>/\\b(btc|eth|sol|xrp|crypto|bitcoin|ethereum|solana|doge)\\b/i.test(y.title||""),n=[...e].sort((y,g)=>(g.volume24||0)-(y.volume24||0)),a=n.filter(y=>!t(y)),s=n.filter(y=>t(y)),o=[...a.slice(0,2),...s.slice(0,Math.max(0,2-a.length))],i=new Set(o.map(y=>y.title)),u=[...e].sort((y,g)=>(g.publishedAt||0)-(y.publishedAt||0)).filter(y=>!i.has(y.title)),d=u.filter(y=>!t(y)),m=u.filter(y=>t(y)),f=[...d.slice(0,2),...m.slice(0,Math.max(0,2-d.length))],p=[...o,...f],h=e.filter(y=>!p.includes(y));return[...p,...h]}function kr(){if(!l.predictionList)return;let e=ln();!e.length&&!r.predictionFallback.loaded&&!r.predictionFallback.loading&&kc().then(()=>kr()),!e.length&&r.predictionFallback.items.length&&(e=r.predictionFallback.items),be(l.predictionList,e)}async function Ic(){if(r.energyGeo)return r.energyGeo;let t=await(await fetch(Be("/geo/us-states.geojson"))).json();return r.energyGeo=t,t}async function xc(){if(r.energyMapData&&Date.now()-r.energyMapFetchedAt<36e5)return r.energyMapData;try{let{data:t,error:n}=await Ce("/api/energy-map");return n||!t?(r.energyMapError="fetch_failed",null):t?.error?(r.energyMapError=t.error,null):(r.energyMapError=null,r.energyMapData=t,r.energyMapFetchedAt=Date.now(),t)}catch{return r.energyMapError="fetch_failed",null}}function Nc(e,t,n){if(!Number.isFinite(e))return"rgba(90, 100, 120, 0.2)";let a=(e-t)/(n-t||1),s=l.app?.dataset?.theme==="light",o=200,i=s?70:75,u=s?85-a*35:55-a*25;return`hsl(${o}, ${i}%, ${u}%)`}async function cn(){if(!l.energyMap||!window.L)return;let[e,t]=await Promise.all([Ic(),xc()]);if(!e||!t){if(l.energyMapEmpty){let o=r.energyMapError==="missing_server_key"?"Energy map needs the server EIA key to be configured.":"Energy map unavailable right now.";l.energyMapEmpty.textContent=o,l.energyMapEmpty.style.display="flex"}return}l.energyMapEmpty&&(l.energyMapEmpty.style.display="none"),r.energyMap||(r.energyMap=window.L.map(l.energyMap,{zoomControl:!1,attributionControl:!1,dragging:!0,scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!1,keyboard:!1})),r.energyMapLayer&&r.energyMap.removeLayer(r.energyMapLayer),r.energyMapLayer=window.L.geoJSON(e,{style:o=>{let i=o?.properties?.STUSPS,u=t.values?.[i];return{color:"rgba(60, 80, 110, 0.6)",weight:1,fillColor:Nc(u?.value,t.min,t.max),fillOpacity:.8}},onEachFeature:(o,i)=>{let u=o?.properties?.STUSPS,d=o?.properties?.NAME||u||"Unknown",m=t.values?.[u],f=m?`${m.value.toFixed(2)} ${t.units}`:"No data",p=m?.period||t.period;i.bindTooltip(`${d} (${u}) \u2022 ${f} ${p?`\u2022 ${p}`:""}`,{sticky:!0,direction:"top"}),i.on("mouseover",()=>{i.setStyle({weight:2,fillOpacity:.95})}),i.on("mouseout",()=>{i.setStyle({weight:1,fillOpacity:.8})})}}).addTo(r.energyMap);let n=new Set(["AK","HI","PR","GU","VI","MP","AS"]),a=(e.features||[]).filter(o=>!n.has(o?.properties?.STUSPS)),s=a.length?window.L.geoJSON(a).getBounds():r.energyMapLayer.getBounds();s.isValid()&&r.energyMap.fitBounds(s,{padding:[10,10],maxZoom:5}),setTimeout(()=>r.energyMap.invalidateSize(),80),l.energyMapLegend&&(l.energyMapLegend.innerHTML=`
      <div class="energy-map-legend-title">Price (cents/kWh)</div>
      <div class="energy-map-legend-scale">
        <span>${t.min.toFixed(1)}</span>
        <span>${t.max.toFixed(1)}</span>
      </div>
      <div class="energy-map-legend-bar"></div>
      <div class="energy-map-legend-meta">Residential \u2022 ${t.period}</div>
    `)}function Ir(){if(!l.travelTicker||!l.travelTickerTrack||(l.travelTicker.classList.toggle("hidden",!r.settings.showTravelTicker),!r.settings.showTravelTicker))return;let e=r.scopedItems.filter(a=>a.category==="travel");if(e.length||(e=pe(ue(r.items)).filter(a=>a.category==="travel")),e=Ze(e).slice(0,14),l.travelTickerTrack.innerHTML="",!e.length){l.travelTickerTrack.innerHTML='<span class="map-travel-item">No travel advisories in the current window.</span>';return}let t=()=>{let a=document.createElement("div");return a.className="map-travel-group",e.forEach(s=>{let o=document.createElement(s.url?"a":"span");o.className="map-travel-item",s.url&&(o.href=s.url,o.target="_blank",o.rel="noopener noreferrer");let i=[];s.severity&&i.push(`<span class="map-travel-chip">${s.severity}</span>`),s.regionTag&&i.push(`<span class="map-travel-chip">${s.regionTag}</span>`),i.push(`<span class="map-travel-text">${se(s.title||"",120)}</span>`),o.innerHTML=i.join(""),a.appendChild(o)}),a},n=t();l.travelTickerTrack.appendChild(n),e.length>4&&l.travelTickerTrack.appendChild(t())}function ia(){if(!l.denarioPanel||(l.denarioPanel.classList.toggle("is-hidden",!r.denario.available),!r.denario.available))return;if(l.denarioMeta){let t=[];r.denario.summary&&t.push(r.denario.summary),Number.isFinite(r.denario.generatedAt)&&t.push(`Updated ${ir(r.denario.generatedAt)}`),l.denarioMeta.textContent=t.length?t.join(" \u2022 "):"Denario insights loaded."}if(!l.denarioList)return;l.denarioList.innerHTML="";let e=Array.isArray(r.denario.items)?r.denario.items:[];if(!e.length){l.denarioList.innerHTML='<div class="denario-empty">No deep analysis available yet.</div>';return}e.slice(0,6).forEach(t=>{let n=document.createElement("div");n.className="denario-item";let a=document.createElement("div");a.className="denario-item-title",a.textContent=t.title||t.label||"Insight";let s=document.createElement("div");s.className="denario-item-summary",s.textContent=se(he(t.summary||t.detail||""),180),n.appendChild(a),n.appendChild(s),l.denarioList.appendChild(n)})}async function Mc(){if(l.denarioPanel){r.denario.loading=!0,ia();try{let e=await fetch(Be("data/denario.json"));if(!e.ok)throw new Error("Denario unavailable");let t=await e.json();r.denario.available=!0,r.denario.summary=t.summary||t.overview||null;let n=t.generatedAt||t.generated_at||t.timestamp||"",a=Date.parse(n);r.denario.generatedAt=Number.isFinite(a)?a:null,r.denario.items=Array.isArray(t.items)?t.items:[]}catch(e){r.denario.available=!1,r.denario.summary=null,r.denario.generatedAt=null,r.denario.items=[],r.denario.error=e?.message||"Denario unavailable"}finally{r.denario.loading=!1,ia()}}}function st(){Ql(r.clusters),jn(["finance","energy"],l.financeMarketsList),jn(["gov","cyber","agriculture"],l.financePolicyList),Ue("crypto",l.cryptoList),kr(),jn(["disaster","weather","space"],l.disasterList),Ec(),Ue("security",l.securityList),Ar(),Tr(),Er(),Ue("cyber",l.cyberList),Ue("agriculture",l.agricultureList),Ue("research",l.researchList),Ue("space",l.spaceList),oa(),cn(),Ue("health",l.healthList),Ue("transport",l.transportList),on(),Ir(),Sn(),vt(),qt&&typeof qt.render=="function"&&qt.render(),ia(),dr(),wn()}function ks(){Vs(!1)}function Fc(){l.listModalClose&&l.listModalClose.addEventListener("click",()=>ks()),l.listOverlay&&l.listOverlay.addEventListener("click",e=>{e.target===l.listOverlay&&ks()})}function Dc(){l.detailClose&&l.detailClose.addEventListener("click",()=>us()),l.detailOverlay&&l.detailOverlay.addEventListener("click",e=>{e.target===l.detailOverlay&&us()})}function Pc(){if(!l.communityConnect||!l.communityFrame)return;let e=l.communityFrame,t=()=>{if(e.src)return;let n=e.dataset.src;n&&(e.src=n)};l.communityConnect.addEventListener("click",()=>{t()})}function $c(){let e=Array.from(document.querySelectorAll(".clock-card[data-timezone]"));if(!e.length)return;let t=new Map,n=i=>(t.has(i)||t.set(i,new Intl.DateTimeFormat("en-US",{timeZone:i,hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})),t.get(i)),a=i=>{let u=NaN,d=NaN,m=NaN;return i.forEach(f=>{f.type==="hour"&&(u=Number(f.value)),f.type==="minute"&&(d=Number(f.value)),f.type==="second"&&(m=Number(f.value))}),Number.isNaN(u)||Number.isNaN(d)||Number.isNaN(m)?null:{hours:u,minutes:d,seconds:m}},s=(i,u)=>{try{let d=n(i).formatToParts(u),m=a(d);if(m)return m}catch{}try{let d=new Date(u.toLocaleString("en-US",{timeZone:i}));if(!Number.isNaN(d.getTime()))return{hours:d.getHours(),minutes:d.getMinutes(),seconds:d.getSeconds()}}catch{}return{hours:u.getHours(),minutes:u.getMinutes(),seconds:u.getSeconds()}},o=()=>{let i=new Date;e.forEach(u=>{let d=u.dataset.timezone,{hours:m,minutes:f,seconds:p}=s(d,i),y=(m%12+f/60+p/3600)*30,g=(f+p/60)*6,b=p*6,C=u.querySelector(".clock-hand.hour"),v=u.querySelector(".clock-hand.minute"),S=u.querySelector(".clock-hand.second");C&&(C.style.transform=`translateX(-50%) rotate(${y}deg)`),v&&(v.style.transform=`translateX(-50%) rotate(${g}deg)`),S&&(S.style.transform=`translateX(-50%) rotate(${b}deg)`);let w=u.querySelector('[data-role="time"]');if(w){let I=String(m).padStart(2,"0"),A=String(f).padStart(2,"0");w.textContent=`${I}:${A}`}})};o(),setInterval(o,1e3)}function Bc(){let e=[...document.querySelectorAll(".nav-link[data-panel-target]")];if(!e.length)return;let t=[...document.querySelectorAll(".panel[data-panel]")].filter(i=>i.dataset.panel!=="lidar"),n={signals:l.signalDeckAnchor},a=i=>{e.forEach(u=>{u.classList.toggle("active",u.dataset.panelTarget===i)})};e.forEach(i=>{i.addEventListener("click",()=>{let u=i.dataset.panelTarget,d=t.find(m=>m.dataset.panel===u);d?d.scrollIntoView({behavior:"smooth",block:"start"}):n[u]&&n[u].scrollIntoView({behavior:"smooth",block:"start"}),a(u),rt(!1)})});let s=!1,o=()=>{s||(s=!0,requestAnimationFrame(()=>{let u=t[0],d=u?u.getBoundingClientRect():null,m=u?.dataset.panel;d&&d.top-140>0&&(m="signals"),t.forEach(f=>{f.getBoundingClientRect().top-140<=0&&(m=f.dataset.panel)}),m&&a(m),s=!1}))};window.addEventListener("scroll",o,{passive:!0}),o()}function Rc(){[...document.querySelectorAll(".command-section")].forEach(t=>{let n=t.querySelector(".command-section-toggle");if(!n)return;let a=t.dataset.defaultOpen==="true";t.classList.toggle("is-open",a),n.setAttribute("aria-expanded",a?"true":"false"),n.addEventListener("click",()=>{let s=t.classList.toggle("is-open");n.setAttribute("aria-expanded",s?"true":"false")})})}function Ln(e=1){let t=new Date;return t.setUTCDate(t.getUTCDate()-e),t.toISOString().slice(0,10)}function Ae(e,t,n="jpg",a="GoogleMapsCompatible_Level9"){return`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${e}/default/${t}/${a}/{z}/{y}/{x}.${n}`}function xr(e){return`https://services.terrascope.be/wmts/v2/wmts?service=WMTS&request=GetTile&version=1.0.0&layer=CGS_S1_GRD_SIGMA0&style=default&format=image/png&tilematrixset=EPSG:3857&tilematrix=EPSG:3857:{z}&tilerow={y}&tilecol={x}&time=${e}`}function Is(e,t,n,a){return`https://services.terrascope.be/wmts/v2/wmts?service=WMTS&request=GetTile&version=1.0.0&layer=CGS_S1_GRD_SIGMA0&style=default&format=image/png&tilematrixset=EPSG:3857&tilematrix=EPSG:3857:${t}&tilerow=${n}&tilecol=${a}&time=${e}`}async function Oc(){if(r.sarCapabilitiesChecked)return r.sarCapabilitiesDate;r.sarCapabilitiesChecked=!0;let e="https://services.terrascope.be/wmts/v2/wmts?service=WMTS&request=GetCapabilities";try{let t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error(`GetCapabilities ${t.status}`);let n=await t.text(),a=n.match(/<Layer[^>]*>[\s\S]*?<Identifier>CGS_S1_GRD_SIGMA0<\/Identifier>[\s\S]*?<\/Layer>/i),o=(a?a[0]:n).match(/\d{4}-\d{2}-\d{2}/g);o&&o.length&&(r.sarCapabilitiesDate=o[o.length-1])}catch(t){console.warn("SAR GetCapabilities fetch failed",t)}return r.sarCapabilitiesDate}function un(e=.25){let t=Math.max(0,Math.min(e,.6));return{color:`rgba(58, 148, 255, ${Math.min(1,t+.35).toFixed(2)})`,weight:1,fillColor:`rgba(58, 148, 255, ${t.toFixed(2)})`,fillOpacity:t}}function _c(e=.3){let t=Math.max(.15,Math.min(e,.7));return{color:"rgba(255, 189, 64, 0.95)",weight:2,fillColor:`rgba(255, 189, 64, ${t.toFixed(2)})`,fillOpacity:t}}function Uc(e){let t=Ee("lidar",.25);r.lidarSelectedLayer&&r.lidarSelectedLayer.setStyle&&r.lidarSelectedLayer.setStyle(un(t)),r.lidarSelectedLayer=e||null,e?.setStyle&&(e.setStyle(_c(t+.1)),e.bringToFront&&e.bringToFront())}function Hc(e){if(!e)return null;let t=e.replace(/\s+/g,"_");return`https://s3-us-west-2.amazonaws.com/usgs-lidar-public/${encodeURIComponent(t)}/ept.json`}function Nr(e){if(!e)return null;let t=e.boundsConforming||e.bounds;if(!Array.isArray(t)||t.length<6)return null;let n=(t[0]+t[3])/2,a=(t[1]+t[4])/2,s=(t[2]+t[5])/2;return[n,a,s]}function Gt(e,t,n,a){let s=Number(e);return Number.isFinite(s)?Math.min(a,Math.max(n,s)):t}function dn(e={}){return{useCustom:!!e.useCustom,pointCap:Gt(e.pointCap,15e4,1e4,5e5),radiusKm:Gt(e.radiusKm,5,1,25),maxTilesDesktop:Gt(e.maxTilesDesktop,16,1,32),maxTilesMobile:Gt(e.maxTilesMobile,8,1,16)}}function jc(){let e=window.matchMedia&&window.matchMedia("(max-width: 900px)").matches,t=dn(),n=dn(r.settings.lidarPointLimits),a=n.useCustom;return{pointCap:a?n.pointCap:t.pointCap,radiusKm:a?n.radiusKm:t.radiusKm,maxTiles:a?e?n.maxTilesMobile:n.maxTilesDesktop:e?t.maxTilesMobile:t.maxTilesDesktop}}function ka(e){let t=e?.srs;if(!t)return null;let n=t?.horizontal||t?.authority||t?.horizontalEPSG||t?.authorityCode,a=Number(n);return Number.isFinite(a)?a:null}function Mr(e){let t=ka(e);return t===4326||t===3857}function Gc(e,t){let a=e/6378137*(180/Math.PI),s=(2*Math.atan(Math.exp(t/6378137))-Math.PI/2)*(180/Math.PI);return[a,s]}function qc(e){return e?e.replace(/\/ept\.json$/i,"/"):null}function zc(e,t){return`${e}ept-hierarchy/${t}.json`}function Kc(e,t,n){return`${e}data/${t}.${n}`}function Wc(e){let t=String(e).split("-").map(i=>Number(i));if(t.length!==4||t.some(i=>!Number.isFinite(i)))return null;let[n,a,s,o]=t;return{depth:n,x:a,y:s,z:o}}function Vc(e,t){let n=Wc(t);if(!n)return null;let a=e?.boundsConforming||e?.bounds;if(!Array.isArray(a)||a.length<6)return null;let[s,o,i,u,d,m]=a,f=2**n.depth,p=(u-s)/f,h=(d-o)/f,y=(m-i)/f,g=s+n.x*p,b=g+p,C=o+n.y*h,v=C+h,S=i+n.z*y,w=S+y;return[g,C,S,b,v,w]}function Jc(e,t,n,a){let o=m=>m*Math.PI/180,i=o(n-e),u=o(a-t),d=Math.sin(i/2)**2+Math.cos(o(e))*Math.cos(o(n))*Math.sin(u/2)**2;return 2*6371e3*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))}async function Zc(e){let n=zc(e,"0-0-0-0"),a=await fetch(n,{cache:"no-store"});if(!a.ok)throw new Error(`EPT hierarchy ${a.status}`);let s=await a.json();return Object.entries(s||{}).map(([o,i])=>({key:o,count:Number(i)||0}))}function Qc(e,t,n,a,s){if(!e.length)return[];let o=ka(n),i=(s||0)*1e3,u=e.map(p=>{let h=Vc(n,p.key);if(!h||!a)return{...p,distance:Number.POSITIVE_INFINITY};let y=(h[0]+h[3])/2,g=(h[1]+h[4])/2,b=Number.POSITIVE_INFINITY;if(o===4326)b=Jc(a[1],a[0],g,y);else if(o===3857){let C=y-a[0],v=g-a[1];b=Math.sqrt(C*C+v*v)}return{...p,distance:b}}),d=i?u.filter(p=>p.distance<=i):u;return(d.length?d:u).slice().sort((p,h)=>p.distance!==h.distance?p.distance-h.distance:h.count-p.count).slice(0,t).map(p=>p.key)}async function Yc(){let e=r.lidarPointEptUrl,t=r.lidarPointEptMeta;if(!e||!t)throw new Error("EPT metadata missing");if(!Mr(t))throw new Error("EPT SRS unsupported");let n=qc(e),a=t.dataType||"laz",s=jc(),o=await Zc(n),i=Nr(t),u=Qc(o,s.maxTiles,t,i,s.radiusKm);if(!u.length)throw new Error("EPT hierarchy empty");let{LASLoader:d}=await import("https://unpkg.com/@loaders.gl/las@3.4.14/dist/esm/index.js"),m=[],f=ka(t),p=0;for(let h of u){let y=Kc(n,h,a),g=await fetch(y);if(!g.ok)continue;let b=await g.arrayBuffer(),v=(await d.parse(b,{}))?.attributes?.POSITION?.value;if(!v)continue;let S=v.length/3,w=Math.max(1,Math.ceil(S/Math.max(1,Math.floor(s.pointCap/u.length))));for(let I=0;I<S&&p<s.pointCap;I+=w){let A=I*3,E=v[A],T=v[A+1],D=v[A+2];if(f===3857){let M=Gc(E,T);E=M[0],T=M[1]}if(m.push({position:[E,T,D],color:[80,195,255,200]}),p+=1,p>=s.pointCap)break}if(p>=s.pointCap)break}if(!m.length)throw new Error("EPT tiles empty");return r.lidarPointSource="ept",r.lidarPointData=m,m.length}function xs(e,t,n){if(!e||!t)return;let a=e?.properties?.name||null;r.lidarPointProject=a,r.lidarPointEptUrl=Hc(a),r.lidarPointEptAvailable=!1,r.lidarPointEptMeta=null,r.lidarPointSource=null,r.lidarSelectedBounds=t,Uc(n),r.lidarPointEptUrl&&Xc(r.lidarPointEptUrl);let s=t.getCenter?.();s&&(r.lidarPointAnchor=[s.lng,s.lat,0]),r.settings.mapRasterOverlays?.lidarPoints&&mn(),Et()}async function Xc(e){if(e){z("lidarPoints","loading","checking ept");try{let t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error(`EPT status ${t.status}`);r.lidarPointEptAvailable=!0;try{let n=await t.clone().json();r.lidarPointEptMeta=n;let a=Nr(n);a&&(r.lidarPointAnchor=[a[0],a[1],0]),ct({status:"ept_meta",project:r.lidarPointProject||null})}catch(n){console.warn("LiDAR EPT meta parse failed",n)}z("lidarPoints","ready",`ept ok \u2022 ${r.lidarPointProject||"project"}`),ct({status:"ept_ok",project:r.lidarPointProject||null,eptUrl:e})}catch(t){console.warn("LiDAR EPT check failed",t),r.lidarPointEptAvailable=!1,r.lidarPointEptMeta=null,z("lidarPoints","unavailable","ept unavailable"),ct({status:"ept_unavailable",project:r.lidarPointProject||null,eptUrl:e,reason:t?.message||"ept unavailable"})}finally{Et()}}}async function la(){if(!(!r.map||r.lidarCoverageLoading||r.lidarCoverageLayer)){if(!window.topojson){console.warn("TopoJSON not available for LiDAR coverage."),z("lidar","unavailable","topojson missing");return}r.lidarCoverageLoading=!0,z("lidar","loading","loading coverage");try{let e=await fetch(jo);if(!e.ok)throw new Error(`LiDAR coverage fetch failed: ${e.status}`);let t=await e.json();try{localStorage.setItem(is,JSON.stringify(t))}catch(i){console.warn("LiDAR cache write failed",i)}let n=t?.objects?Object.keys(t.objects)[0]:null;if(!n)throw new Error("LiDAR coverage data missing.");let a=window.topojson.feature(t,t.objects[n]),s=Ee("lidar",.25),o=window.L.geoJSON(a,{style:()=>un(s),onEachFeature:(i,u)=>{let d=i?.properties?.name||"LiDAR coverage",m=i?.properties?.count,f=m?`${d} \u2022 ${m} tiles`:d;u?.bindPopup&&u.bindPopup(f),u?.on&&u.getBounds&&u.on("click",()=>{xs(i,u.getBounds(),u)})}});r.lidarCoverageLayer=o,r.mapOverlayLayers={...r.mapOverlayLayers,lidar:o},Ne(),z("lidar","ready","coverage loaded")}catch(e){console.warn("LiDAR coverage load failed",e);try{let t=localStorage.getItem(is);if(t){let n=JSON.parse(t),a=n?.objects?Object.keys(n.objects)[0]:null;if(a){let s=window.topojson.feature(n,n.objects[a]),o=Ee("lidar",.25),i=window.L.geoJSON(s,{style:()=>un(o),onEachFeature:(u,d)=>{d?.on&&d.getBounds&&d.on("click",()=>{xs(u,d.getBounds(),d)})}});r.lidarCoverageLayer=i,r.mapOverlayLayers={...r.mapOverlayLayers,lidar:i},Ne(),z("lidar","ready","cached coverage");return}}}catch(t){console.warn("LiDAR cache read failed",t)}z("lidar","unavailable","coverage fetch failed")}finally{r.lidarCoverageLoading=!1}}}async function mn(){if(!r.map||r.lidarPointLoading||r.lidarPointLayer)return;if(!window.deck||!window.DeckGlLeaflet){z("lidarPoints","unavailable","deck.gl missing"),ct({status:"unavailable",reason:"deck.gl missing"});return}let e=performance.now();r.lidarPointLoading=!0;let t=r.lidarPointEptAvailable&&r.lidarPointEptMeta&&Mr(r.lidarPointEptMeta);z("lidarPoints","loading",t?"loading ept tiles":"loading sample");try{if((!r.lidarPointData||r.lidarPointSource!==(t?"ept":"sample"))&&(r.lidarPointData=null,r.lidarPointSource=null),!r.lidarPointData&&t&&await Yc(),!r.lidarPointData){let{LASLoader:o}=await import("https://unpkg.com/@loaders.gl/las@3.4.14/dist/esm/index.js"),i=await fetch(Go);if(!i.ok)throw new Error(`LiDAR sample fetch failed: ${i.status}`);let u=await i.arrayBuffer(),d=await o.parse(u,{}),m=d?.attributes?.POSITION?.value;if(!m)throw new Error("LiDAR sample missing POSITION data.");let f=m.length/3,p=d?.header?.boundingBox,h=p?[(p[0][0]+p[1][0])/2,(p[0][1]+p[1][1])/2,(p[0][2]+p[1][2])/2]:[0,0,0],y=d?.attributes?.intensity?.value,g=Math.max(1,Math.ceil(f/qo)),b=[];for(let v=0;v<f;v+=g){let S=v*3,w=y?y[v]:0,I=Math.min(255,Math.max(30,Math.round(30+w/65535*225)));b.push({position:[m[S]-h[0],m[S+1]-h[1],m[S+2]-h[2]],color:[60,I,255,200]})}r.lidarPointData=b,r.lidarPointSource="sample";let C=r.map.getCenter();r.lidarPointAnchor=[C.lng,C.lat,0]}let n=Fr(),a=new window.DeckGlLeaflet.LeafletLayer({layers:[n]});r.lidarPointLayer=a,r.mapOverlayLayers={...r.mapOverlayLayers,lidarPoints:a},Ne();let s=r.lidarPointSource==="ept"?`project ${r.lidarPointProject||"ept"}`:r.lidarPointProject?`sample \u2022 ${r.lidarPointProject}`:"sample";z("lidarPoints","ready",`points ${r.lidarPointData.length} \u2022 ${s}`),ct({status:"ready",points:r.lidarPointData.length,project:r.lidarPointProject||null,eptUrl:r.lidarPointEptUrl||null,source:r.lidarPointSource||null,loadMs:Math.round(performance.now()-e)})}catch(n){console.warn("LiDAR point overlay failed",n),r.lidarPointSource=null,z("lidarPoints","unavailable",t?"ept load failed":"sample load failed"),ct({status:"unavailable",reason:n?.message||"sample load failed",source:r.lidarPointSource||null,loadMs:Math.round(performance.now()-e)})}finally{r.lidarPointLoading=!1}}function Fr(){let{PointCloudLayer:e,COORDINATE_SYSTEM:t}=window.deck,n=Ee("lidarPoints",.65),a=r.lidarPointAnchor||[r.location.lon,r.location.lat,0],s=r.lidarPointSource||"sample",o=s==="ept"?t.LNGLAT:t.METER_OFFSETS;return new e({id:"lidar-points",data:r.lidarPointData||[],getPosition:i=>i.position,getColor:i=>i.color,pointSize:s==="ept"?1.5:2,opacity:n,coordinateSystem:o,coordinateOrigin:s==="ept"?void 0:a,pickable:!1})}function ct(e){let t={ts:new Date().toISOString(),...e},n=[...r.lidarPointTelemetry||[],t].slice(-50);r.lidarPointTelemetry=n;try{localStorage.setItem(Hs,JSON.stringify(n))}catch(a){console.warn("LiDAR telemetry write failed",a)}}function eu(e){return e.replace("{z}","2").replace("{y}","1").replace("{x}","1")}function Ia(e,t=5e3){return new Promise(n=>{let a=new Image,s=setTimeout(()=>{a.src="",n(!1)},t);a.onload=()=>{clearTimeout(s),n(!0)},a.onerror=()=>{clearTimeout(s),n(!1)};let o=e.includes("?")?"&":"?";a.src=`${e}${o}cb=${Date.now()}`})}function Ns(e,t,n){let a=2**n,s=Math.floor((t+180)/360*a),o=e*Math.PI/180,i=Math.floor((1-Math.log(Math.tan(o)+1/Math.cos(o))/Math.PI)/2*a);return{x:s,y:i,z:n}}function Dr(e){let t=r.map;if(t&&typeof t.getBounds=="function"){let s=t.getBounds(),o=t.getCenter(),i=Math.min(6,Math.max(3,Math.round(t.getZoom()||4)));return[{lat:o.lat,lon:o.lng},{lat:s.getNorth(),lon:s.getWest()},{lat:s.getNorth(),lon:s.getEast()},{lat:s.getSouth(),lon:s.getWest()},{lat:s.getSouth(),lon:s.getEast()}].map(({lat:d,lon:m})=>{let{x:f,y:p}=Ns(d,m,i);return Is(e,i,p,f)})}let n=4;return[{lat:50,lon:4.5},{lat:34,lon:-118.2},{lat:35.6,lon:139.6}].map(({lat:s,lon:o})=>{let{x:i,y:u}=Ns(s,o,n);return Is(e,n,u,i)})}async function Pr(e){if(!e||!r.settings.mapRasterOverlays?.sar)return;let t=nu(e);if(t){let s=r.sarCoverageCache?.[t];if(s&&Date.now()-s.ts<300*1e3){s.ok?z("sar","ready",`date ${e}`):z("sar","unavailable","no coverage for AOI/date");return}}let n=Dr(e),a=!1;for(let s of n)if(a=await Ia(s),a)break;t&&(r.sarCoverageCache[t]={ok:a,ts:Date.now()}),a?z("sar","ready",`date ${e}`):z("sar","unavailable","no coverage for AOI/date")}function tu(){r.settings.mapRasterOverlays?.sar&&(!r.sarDate||r.sarResolveInFlight||(r.sarCoverageTimer&&clearTimeout(r.sarCoverageTimer),r.sarCoverageTimer=setTimeout(()=>{Pr(r.sarDate)},600)))}function nu(e){let t=r.map;if(!t||!e)return null;let n=Math.round(t.getZoom()||4),a=t.getCenter?.();return a?`${e}:${n}:${a.lat.toFixed(2)},${a.lng.toFixed(2)}`:`${e}:${n}`}function $r(e,t){let n=new Date(`${e}T00:00:00Z`);return n.setUTCDate(n.getUTCDate()+t),n.toISOString().slice(0,10)}function au(e){let t=te[e]||null;return t?.defaultDate?t.defaultDate:Ln(1)}async function Nt(){if(!(r.imageryResolveInFlight||r.imageryDateManual)){r.imageryResolveInFlight=!0,z("imagery","loading","checking tiles");try{let e=r.settings.mapBasemap?.startsWith("gibs")?r.settings.mapBasemap:"gibs-viirs",t=te[e]||te["gibs-viirs"];if(t?.defaultDate){ut(t.defaultDate);return}let n=Ln(1),a=!1;for(let s=0;s<8;s+=1){let o=$r(n,-s),i=eu(Ae(t.id,o,t.format,t.matrixSet));if(await Ia(i)){ut(o),a=!0;return}}if(!a){let s=r.settings.lastImageryDate;s?(ut(s),z("imagery","ready","using last known")):z("imagery","unavailable","try Latest")}}finally{r.imageryResolveInFlight=!1}}}async function Qt(){if(!(r.sarResolveInFlight||r.sarDateManual)){if(!r.settings.mapRasterOverlays?.sar){z("sar","off",""),yt();return}r.sarResolveInFlight=!0,z("sar","loading","checking tiles");try{let t=await Oc()||Ln(1),n=!1;for(let a=0;a<12;a+=1){let s=$r(t,-a),o=Dr(s);for(let i of o)if(await Ia(i)){pn(s),n=!0;return}}if(!n){let a=r.settings.lastSarDate;a?(pn(a),z("sar","ready","using last known")):z("sar","unavailable","try Latest")}}finally{r.sarResolveInFlight=!1}}}function ut(e){!e||!/^\d{4}-\d{2}-\d{2}$/.test(e)||(r.imageryDate=e,r.settings.mapImageryDate=e,r.settings.lastImageryDate=e,Object.entries(r.mapBaseLayers||{}).forEach(([t,n])=>{if(!t.startsWith("gibs"))return;let a=te[t];a&&(n.setUrl(Ae(a.id,e,a.format,a.matrixSet)),n.redraw())}),Object.entries(r.mapOverlayLayers||{}).forEach(([t,n])=>{if(!t.startsWith("gibs-overlay"))return;let a=t.replace("gibs-overlay-",""),s=ie[a];s&&(n.setUrl(Ae(s.id,e,s.format,s.matrixSet)),n.redraw())}),yt(),V(),z("imagery","ready",`date ${e}`))}function pn(e){if(!e||!/^\d{4}-\d{2}-\d{2}$/.test(e))return;r.sarDate=e,r.settings.mapSarDate=e,r.settings.lastSarDate=e;let t=r.mapOverlayLayers?.sar;t&&(t.setUrl(xr(e)),t.redraw()),yt(),V(),z("sar","ready",`date ${e}`),Pr(e)}function su(e){if(e==="night"){gt("gibs-nightlights"),r.settings.mapRasterOverlays={...r.settings.mapRasterOverlays,hillshade:!1,sar:!1,aerosol:!1,thermal:!1,fire:!1},V(),Ne(),qe(),mt(),Nt();return}e==="thermal"&&(gt("gibs-viirs"),r.settings.mapRasterOverlays={...r.settings.mapRasterOverlays,thermal:!0,fire:!0},V(),Ne(),qe(),mt(),Nt())}function Ms(){r.settings.mapBasemap="osm",r.settings.mapRasterOverlays={hillshade:!1,sar:!1,aerosol:!1,lidar:!1,lidarPoints:!1,thermal:!1,fire:!1},r.settings.mapOverlayOpacity={hillshade:.45,sar:.55,aerosol:.45,lidar:.25,lidarPoints:.65,thermal:.45,fire:.45},r.settings.lidarPointLimits={useCustom:!1,pointCap:15e4,radiusKm:5,maxTilesDesktop:16,maxTilesMobile:8},r.settings.mapImageryDate="",r.settings.mapSarDate="",r.imageryDateManual=!1,r.sarDateManual=!1,V(),gt("osm"),Ne(),qe(),mt(),yt()}function gt(e,{skipSave:t=!1}={}){if(!r.map)return;let n=e==="gibs"?"gibs-viirs":e,a=r.mapBaseLayers?.[n]||r.mapBaseLayers?.osm;if(a){if(r.activeBaseLayer&&r.map.removeLayer(r.activeBaseLayer),r.activeBaseLayer=a,a.addTo(r.map),r.settings.mapBasemap=n,a.options?.maxZoom?r.map.setMaxZoom(a.options.maxZoom):r.map.setMaxZoom(18),t||(V(),mt()),e.startsWith("gibs")){let s=te[n];s?.defaultDate&&!r.imageryDateManual?ut(s.defaultDate):Nt()}qe()}}function Ne(){r.map&&Object.entries(r.mapOverlayLayers||{}).forEach(([e,t])=>{let n=e.startsWith("gibs-overlay-")?e.replace("gibs-overlay-",""):e;n.startsWith("fire")&&(n="fire");let a=!!r.settings.mapRasterOverlays?.[n],s=r.map.hasLayer(t);a&&!s&&t.addTo(r.map),!a&&s&&r.map.removeLayer(t);let o=Ee(n,t.options?.opacity??.5);n==="lidar"&&typeof t.setStyle=="function"&&Number.isFinite(o)?t.setStyle(un(o)):n==="lidarPoints"&&typeof t.setProps=="function"&&Number.isFinite(o)?t.setProps({layers:[Fr()]}):typeof t.setOpacity=="function"&&Number.isFinite(o)&&t.setOpacity(o)})}function ru(){if(!l.mapBase||!window.L)return;if(r.map=window.L.map(l.mapBase,{zoomControl:!0,attributionControl:!0,worldCopyJump:!0}).setView([r.location.lat,r.location.lon],2),l.mapLegend&&window.L?.DomEvent){window.L.DomEvent.disableScrollPropagation(l.mapLegend),window.L.DomEvent.disableClickPropagation(l.mapLegend);let a=s=>s.stopPropagation();l.mapLegend.addEventListener("wheel",a,{passive:!0}),l.mapLegend.addEventListener("touchmove",a,{passive:!0})}let e=au(r.settings.mapBasemap||"gibs-viirs"),t=r.settings.mapImageryDate||e,n=r.settings.mapSarDate||e;r.imageryDate=t,r.sarDate=n,r.settings.mapImageryDate=t,r.settings.mapSarDate=n,r.mapBaseLayers={osm:window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:"&copy; OpenStreetMap contributors"}),esri:window.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:18,attribution:"&copy; Esri, Maxar, Earthstar Geographics, and the GIS User Community"}),"gibs-viirs":window.L.tileLayer(Ae(te["gibs-viirs"].id,t,te["gibs-viirs"].format,te["gibs-viirs"].matrixSet),{maxZoom:te["gibs-viirs"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (VIIRS True Color)"}),"gibs-modis-terra":window.L.tileLayer(Ae(te["gibs-modis-terra"].id,t,te["gibs-modis-terra"].format,te["gibs-modis-terra"].matrixSet),{maxZoom:te["gibs-modis-terra"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (MODIS Terra True Color)"}),"gibs-modis-aqua":window.L.tileLayer(Ae(te["gibs-modis-aqua"].id,t,te["gibs-modis-aqua"].format,te["gibs-modis-aqua"].matrixSet),{maxZoom:te["gibs-modis-aqua"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (MODIS Aqua True Color)"}),"gibs-nightlights":window.L.tileLayer(Ae(te["gibs-nightlights"].id,t,te["gibs-nightlights"].format,te["gibs-nightlights"].matrixSet),{maxZoom:te["gibs-nightlights"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (VIIRS Black Marble)"}),"gibs-daynight":window.L.tileLayer(Ae(te["gibs-daynight"].id,t,te["gibs-daynight"].format,te["gibs-daynight"].matrixSet),{maxZoom:te["gibs-daynight"].maxZoom,crossOrigin:"anonymous",attribution:"NASA GIBS (VIIRS Day/Night Band)"})},r.mapOverlayLayers={hillshade:window.L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}",{maxZoom:18,maxNativeZoom:16,opacity:Ee("hillshade",.45),attribution:"Esri World Hillshade"}),sar:window.L.tileLayer(xr(n),{maxZoom:18,maxNativeZoom:16,opacity:Ee("sar",.55),attribution:"Sentinel-1 SAR (Terrascope)"}),"gibs-overlay-aerosol":window.L.tileLayer(Ae(ie.aerosol.id,t,ie.aerosol.format,ie.aerosol.matrixSet),{maxZoom:16,maxNativeZoom:ie.aerosol.maxZoom,opacity:Ee("aerosol",ie.aerosol.opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (Aerosol Index)"}),"gibs-overlay-thermal":window.L.tileLayer(Ae(ie.thermal.id,t,ie.thermal.format,ie.thermal.matrixSet),{maxZoom:16,maxNativeZoom:ie.thermal.maxZoom,opacity:Ee("thermal",ie.thermal.opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (Thermal Brightness)"}),"gibs-overlay-fire-east":window.L.tileLayer(Ae(ie["fire-east"].id,t,ie["fire-east"].format,ie["fire-east"].matrixSet),{maxZoom:16,maxNativeZoom:ie["fire-east"].maxZoom,opacity:Ee("fire",ie["fire-east"].opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (GOES East Fire Temp)"}),"gibs-overlay-fire-west":window.L.tileLayer(Ae(ie["fire-west"].id,t,ie["fire-west"].format,ie["fire-west"].matrixSet),{maxZoom:16,maxNativeZoom:ie["fire-west"].maxZoom,opacity:Ee("fire",ie["fire-west"].opacity),crossOrigin:"anonymous",attribution:"NASA GIBS (GOES West Fire Temp)"})},r.settings.mapRasterOverlays?.lidar?la():z("lidar","off",""),r.settings.mapRasterOverlays?.lidarPoints?mn():z("lidarPoints","off",""),gt(r.settings.mapBasemap,{skipSave:!0}),Ne(),r.map.on("moveend zoomend",()=>{fe(),tu()}),r.map.on("movestart zoomstart",()=>{xa()}),r.map.whenReady(()=>{Mt(),fe()}),setTimeout(()=>{r.map.invalidateSize(),Mt(),fe()},0),Nt(),r.settings.mapRasterOverlays?.sar?Qt():z("sar","off","")}function ou(e){return e.feedId==="noaa-incidentnews"||e.category==="spill"?"spill":e.feedId==="gpsjam"?"gpsjam":e.feedId==="arcgis-military-installations"?"military":e.feedId==="state-travel-advisories"||e.feedId==="cdc-travel-notices"?"travel":e.feedId?.startsWith("arcgis-outage-")?"outage":e.category==="travel"?"travel":e.category==="transport"?"transport":e.category==="security-lagged"?"securityLagged":e.category==="security"?"security":e.category==="infrastructure"?"infrastructure":e.category==="weather"?"weather":e.category==="disaster"?"disaster":e.category==="space"?"space":e.category==="health"?"health":"news"}function iu(e){return e==="disaster"?"rgba(255,106,106,0.9)":e==="weather"?"rgba(55,214,214,0.9)":e==="space"?"rgba(140,107,255,0.9)":e==="travel"?"rgba(255,196,87,0.95)":e==="transport"?"rgba(94,232,160,0.9)":e==="gpsjam"?"rgba(244,104,102,0.92)":e==="security"?"rgba(255,144,99,0.92)":e==="securityLagged"?"rgba(199,156,137,0.78)":e==="military"?"rgba(214,174,118,0.88)":e==="infrastructure"?"rgba(132,190,255,0.9)":e==="outage"?"rgba(255,210,90,0.92)":e==="health"?"rgba(109,209,255,0.9)":e==="spill"?"rgba(255,125,36,0.92)":"rgba(255,184,76,0.9)"}function lu(e){if(!e)return"news";let t=`${e.alertType||""} ${e.title||""}`.toLowerCase(),n=()=>t.trim()?t.includes("tornado")?"tornado":t.includes("flash flood")||t.includes("flood")?"flood":t.includes("hurricane")||t.includes("tropical storm")||t.includes("storm surge")?"hurricane":t.includes("blizzard")||t.includes("winter")||t.includes("snow")||t.includes("ice")||t.includes("freeze")?"winter":t.includes("excessive heat")||t.includes("heat")?"heat":t.includes("severe thunderstorm")||t.includes("thunderstorm")?"severe":t.includes("wind")?"wind":null:null;if(e.feedId==="noaa-incidentnews"||e.category==="spill")return"spill";if(e.feedId==="gpsjam")return"gpsjam";if(e.feedId==="usgs-quakes-hour"||e.feedId==="usgs-quakes-day")return"quake";if(e.feedId==="arcgis-border-crisis")return"border";if(e.feedId==="arcgis-kinetic-oconus"||e.feedId==="arcgis-kinetic-domestic"||e.feedId==="arcgis-kinetic-europe"||e.feedId==="arcgis-kinetic-venezuela"||e.feedId==="warspotting-losses")return"kinetic";if(e.feedId==="arcgis-drone-reports")return"drone";if(e.feedId==="arcgis-logistics-shortages")return"logistics";if(e.feedId==="arcgis-tipline-reports")return"warning";if(e.feedId==="arcgis-military-installations")return"military";if(e.feedId==="arcgis-hms-fire"||e.feedId==="arcgis-wildfire-incidents"||e.feedId==="arcgis-wildfire-perimeters")return"fire";if(e.feedId==="arcgis-noaa-severe")return"severe";if(e.feedId==="arcgis-noaa-tornado")return"tornado";if(e.feedId==="arcgis-noaa-flood")return"flood";if(e.feedId==="nws-alerts")return n()||"weather";if(e.feedId==="nhc-atlantic")return"hurricane";if(e.feedId==="arcgis-power-plants")return"power";if(e.feedId?.startsWith("arcgis-outage-")||e.feedId==="arcgis-outage-area")return"water";if(e.feedId==="arcgis-submarine-cables"||e.feedId==="arcgis-submarine-landing")return"infrastructure";if(e.feedId==="state-travel-advisories"||e.feedId==="cdc-travel-notices")return"travel";if(e.feedId==="transport-opensky")return"air";if(e.category==="travel")return"travel";if(e.category==="spill")return"spill";if(e.category==="weather")return n()||"weather";if(e.category==="disaster")return"disaster";if(e.category==="space")return"space";if(e.category==="health")return"health";if(e.category==="transport")return"transport";if(e.category==="security"){let a=(e.eventType||e.alertType||"").toLowerCase();return a.includes("battle")?"battle":a.includes("explosion")||a.includes("remote violence")?"explosion":a.includes("violence against civilians")?"violence":a.includes("protest")?"protest":a.includes("riot")?"riot":"security"}return e.category==="infrastructure"?"infrastructure":"news"}var Fs={quake:"activity",border:"flag",kinetic:"crosshair",drone:"radar",logistics:"truck",fire:"flame",warning:"alert-triangle",gpsjam:"radar",power:"bolt",severe:"cloud-lightning",tornado:"tornado",flood:"droplet",hurricane:"activity",winter:"alert-octagon",heat:"heat",wind:"radar",water:"droplet",travel:"plane",air:"plane",military:"barracks",battle:"crosshair",explosion:"alert-octagon",violence:"shield",protest:"flag",riot:"alert-triangle",health:"heart-pulse",transport:"truck",weather:"cloud-lightning",disaster:"alert-octagon",space:"satellite",security:"shield",infrastructure:"factory",spill:"droplet",news:"newspaper"},Ds={activity:'<path d="M22 12h-4l-3 9L9 3l-3 9H2" />',tornado:'<path d="M3 4h18M5 8h14M7 12h10M9 16h6M11 20h2" />',heat:'<circle cx="12" cy="12" r="4" /><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" />',flag:'<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" x2="4" y1="22" y2="15" />',crosshair:'<circle cx="12" cy="12" r="10" /><line x1="22" x2="18" y1="12" y2="12" /><line x1="6" x2="2" y1="12" y2="12" /><line x1="12" x2="12" y1="6" y2="2" /><line x1="12" x2="12" y1="22" y2="18" />',radar:'<path d="M19.07 4.93A10 10 0 0 0 6.99 3.34" /><path d="M4 6h.01" /><path d="M2.29 9.62A10 10 0 1 0 21.31 8.35" /><path d="M16.24 7.76A6 6 0 1 0 8.23 16.67" /><path d="M12 18h.01" /><path d="M17.99 11.66A6 6 0 0 1 15.77 16.67" /><circle cx="12" cy="12" r="2" /><path d="m13.41 10.59 5.66-5.66" />',truck:'<path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" /><path d="M15 18H9" /><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14" /><circle cx="17" cy="18" r="2" /><circle cx="7" cy="18" r="2" />',flame:'<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />',"alert-triangle":'<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" />',bolt:'<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><circle cx="12" cy="12" r="4" />',plane:'<path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z" />',"heart-pulse":'<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /><path d="M3.22 12H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27" />',"cloud-lightning":'<path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973" /><path d="m13 12-3 5h4l-3 5" />',"alert-octagon":'<polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" />',satellite:'<path d="M13 7 9 3 5 7l4 4" /><path d="m17 11 4 4-4 4-4-4" /><path d="m8 12 4 4 6-6-4-4Z" /><path d="m16 8 3-3" /><path d="M9 21a6 6 0 0 0-6-6" />',shield:'<path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" />',factory:'<path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" /><path d="M17 18h1" /><path d="M12 18h1" /><path d="M7 18h1" />',barracks:'<path d="M4 22h16" /><path d="M6 22V9l6-3 6 3v13" /><path d="M10 22v-6h4v6" /><path d="M12 2v4" /><path d="M12 2h4l-4 2" />',droplet:'<path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z" />',newspaper:'<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" /><path d="M18 14h-8" /><path d="M15 18h-5" /><path d="M10 6h8v4h-8V6Z" />'},Gn=new Map,cu="#0a0f14",qn={r:244,g:104,b:102};function Br(e){return Fs[e]||Fs.news}function uu(e){let t=Br(e);if(!Ds[t])return null;if(Gn.has(t))return Gn.get(t);let n=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${cu}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${Ds[t]}</svg>`,a=new Image;return a.src=`data:image/svg+xml;utf8,${encodeURIComponent(n)}`,a.onload=()=>{l.mapCanvas&&fe()},Gn.set(t,a),a}function Rr(e,t,n){return Math.min(n,Math.max(t,e))}function du(e,t,n){if(!n||!t.length)return;let a=rr();!a||!a.cellToBoundary||(e.save(),e.lineWidth=.6,e.strokeStyle="rgba(255,255,255,0.15)",t.forEach(s=>{if(!s.hex)return;let o=a.cellToBoundary(s.hex,!0);if(!o||o.length<3)return;e.beginPath(),o.forEach(([u,d],m)=>{let f=n.latLngToContainerPoint([u,d]);m===0?e.moveTo(f.x,f.y):e.lineTo(f.x,f.y)}),e.closePath();let i=Rr(s.gpsIntensity??.25,.08,.35);e.fillStyle=`rgba(${qn.r}, ${qn.g}, ${qn.b}, ${i})`,e.fill(),e.stroke()}),e.restore())}function mu(e){return e==="security"||e==="securityLagged"||e==="weather"?16:24}function pu(e,t=24){let n=[];return e.forEach(a=>{let s=null;for(let o of n){let i=o.x-a.x,u=o.y-a.y;if(o.layer!==a.layer)continue;let d=mu(o.layer)||t;if(Math.sqrt(i*i+u*u)<d){s=o;break}}if(!s)n.push({x:a.x,y:a.y,points:[a],layer:a.layer});else{s.points.push(a);let o=s.points.length;s.x=(s.x*(o-1)+a.x)/o,s.y=(s.y*(o-1)+a.y)/o}}),n.map(a=>{let s=a.points.length,o=a.points.reduce((p,h)=>(p[h.layer]=(p[h.layer]||0)+1,p),{}),i=Object.entries(o).sort((p,h)=>h[1]-p[1])[0]?.[0]||"news",u=a.points.reduce((p,h)=>(p[h.type]=(p[h.type]||0)+1,p),{}),d=Object.entries(u).sort((p,h)=>h[1]-p[1])[0]?.[0]||"news",m=a.points.map(p=>p.item).sort((p,h)=>(h.publishedAt||0)-(p.publishedAt||0))[0],f=s===1?4:Math.min(16,4+Math.sqrt(s)*2);return{x:a.x,y:a.y,count:s,layer:i,type:d,iconName:Br(d),color:iu(i),primary:m,items:a.points.map(p=>p.item),radius:f}})}function fe(){let e=l.mapCanvas,t=e.getContext("2d"),n=(l.mapBase||e).getBoundingClientRect(),{width:a,height:s}=n,o=window.devicePixelRatio||1;if(e.width=a*o,e.height=s*o,t.setTransform(o,0,0,o,0,0),t.clearRect(0,0,a,s),t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,r.mapPoints=[],r.mapPointsReady=!1,!r.map){for(let h=0;h<=a;h+=a/6)t.beginPath(),t.moveTo(h,0),t.lineTo(h,s),t.stroke();for(let h=0;h<=s;h+=s/4)t.beginPath(),t.moveTo(0,h),t.lineTo(a,h),t.stroke()}let i=Aa(),u=i.filter(h=>h.feedId==="gpsjam"&&h.hex),d=i.filter(h=>h.feedId!=="gpsjam");r.settings.mapLayers.gpsjam&&u.length&&r.map&&du(t,u,r.map);let m=d.map(h=>{let{lat:y,lon:g}=h.geo,b,C;if(r.map){let w=r.map.latLngToContainerPoint([y,g]);b=w.x,C=w.y}else b=(g+180)/360*a,C=(90-y)/180*s;let v=ou(h),S=lu(h);return{x:b,y:C,item:h,layer:v,type:S}}).filter(h=>r.settings.mapLayers[h.layer]).filter(h=>{if(h.layer!=="security"&&h.layer!=="securityLagged")return!0;let y=ac(h.item);return r.settings.mapConflictTypes?.[y]!==!1});l.mapEmpty&&l.mapEmpty.classList.toggle("show",m.length===0);let f=pu(m),p=r.map?r.map.getZoom():2;if(f.forEach(h=>{if(t.beginPath(),t.fillStyle=h.color,t.arc(h.x,h.y,h.radius,0,Math.PI*2),t.fill(),h.count>1){t.strokeStyle="rgba(10, 15, 20, 0.7)",t.lineWidth=1.5,t.stroke(),t.fillStyle="#0a0f14",t.font='600 11px "Atkinson Hyperlegible", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(h.count>99?"99+":String(h.count),h.x,h.y);return}if(p>=3){let g=uu(h.type);g&&g.complete?t.drawImage(g,h.x-14/2,h.y-14/2,14,14):(t.fillStyle="#0a0f14",t.font='700 10px "Atkinson Hyperlegible", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("\u2022",h.x,h.y))}}),r.mapPoints=f,r.mapPointsReady=!0,f.length&&(r.mapLastNonEmptyAt=Date.now(),r.mapLastNonEmptyCount=f.length),wn(),r.location&&r.settings.mapLayers.local){let h,y,g;if(r.map){let b=r.map.latLngToContainerPoint([r.location.lat,r.location.lon]),C=156543.03392*Math.cos(r.location.lat*Math.PI/180)/Math.pow(2,r.map.getZoom());g=r.settings.radiusKm*1e3/C,h=b.x,y=b.y}else h=(r.location.lon+180)/360*a,y=(90-r.location.lat)/180*s,g=r.settings.radiusKm/20037*a*2;t.strokeStyle="rgba(200,255,106,0.5)",t.beginPath(),t.arc(h,y,g,0,Math.PI*2),t.stroke()}}function Mt(){if(!r.map)return;r.map.invalidateSize();let e={padding:[40,40],maxZoom:7};if(r.settings.scope==="global"){r.map.setView([20,0],2);return}if(r.settings.scope==="us"){let t=ft();t?.code==="US"||(r.settings.country||"").toUpperCase()==="US"?r.map.fitBounds([[24,-125],[49,-66]],{padding:[30,30],maxZoom:4}):t?.bbox?r.map.fitBounds([[t.bbox.minLat,t.bbox.minLon],[t.bbox.maxLat,t.bbox.maxLon]],{padding:[30,30],maxZoom:6}):r.map.fitBounds([[24,-125],[49,-66]],{padding:[30,30],maxZoom:4});return}if(r.settings.scope==="local"){let{lat:t,lon:n}=r.location,a=r.settings.radiusKm/110.574,s=r.settings.radiusKm/(111.32*Math.cos(t*Math.PI/180));r.map.fitBounds([[t-a,n-s],[t+a,n+s]],{padding:[30,30],maxZoom:9})}}function gu(e){let t=l.mapCanvas.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top,s=r.mapPoints.find(o=>{let i=o.x-n,u=o.y-a;return Math.sqrt(i*i+u*u)<o.radius+6});if(!s){l.mapTooltip.style.display="none",l.mapWrap&&(l.mapWrap.style.cursor="default");return}if(l.mapWrap&&(l.mapWrap.style.cursor="pointer"),l.mapTooltip.style.display="block",l.mapTooltip.style.left=`${Math.min(n+12,t.width-220)}px`,l.mapTooltip.style.top=`${Math.max(a-12,10)}px`,s.count>1){let o=s.items.slice(0,2).map(i=>i.translatedTitle||i.title).join(" | ");l.mapTooltip.textContent=`${s.count} signals: ${o}`}else l.mapTooltip.textContent=s.primary.translatedTitle||s.primary.title}function xa(){l.mapDetail&&l.mapDetail.classList.remove("show")}function Or(){if(!l.flightFocus)return;if(!r.flightFocus){l.flightFocus.classList.remove("show"),l.flightFocusBody&&(l.flightFocusBody.innerHTML="");return}let e=r.flightFocus,t=e.callsign||e.title||"Flight",n=[];if(e.icao24&&n.push(e.icao24.toUpperCase()),e.originCountry&&n.push(e.originCountry),l.flightFocusMeta&&(l.flightFocusMeta.textContent=n.filter(Boolean).join(" \u2022 ")||"OpenSky"),l.flightFocusBody){let a=[],s=Number.isFinite(e.velocity)?`${Math.round(e.velocity*3.6)} km/h`:"\u2014",o=Number.isFinite(e.altitude)?`${Math.round(e.altitude*3.28084)} ft`:"\u2014",i=Number.isFinite(e.heading)?`${e.heading}\xB0`:"\u2014";a.push({label:"Callsign",value:t}),a.push({label:"Speed",value:s}),a.push({label:"Altitude",value:o}),a.push({label:"Heading",value:i}),a.push({label:"On ground",value:e.onGround?"Yes":"No"}),l.flightFocusBody.innerHTML=a.map(u=>`<div class="map-focus-row"><span>${u.label}</span><strong>${u.value}</strong></div>`).join("")}l.flightFocusOpen&&(l.flightFocusOpen.disabled=!e.icao24),l.flightFocus.classList.add("show")}function _r(){r.flightFocus=null,r.flightTrack=null,r.flightTrackFetchedAt=0,r.flightTrackLayer&&r.map&&r.map.removeLayer(r.flightTrackLayer),r.flightTrackLayer=null,Or()}async function Ur(e,t=!1){if(!e)return;let n=In();if(n&&!r.flightTrackLoading&&!(!t&&Date.now()-r.flightTrackFetchedAt<60*1e3)){r.flightTrackLoading=!0,l.flightFocusTrack&&(l.flightFocusTrack.disabled=!0,l.flightFocusTrack.textContent="Tracking\u2026");try{let a=n.endsWith("/")?n.slice(0,-1):n,s=await Re(`${a}/tracks?icao24=${encodeURIComponent(e)}&time=0`);if(!s.ok)return;let o=await s.json();if(r.flightTrack=o,r.flightTrackFetchedAt=Date.now(),r.map&&Array.isArray(o?.path)){let i=o.path.filter(u=>Number.isFinite(u?.[1])&&Number.isFinite(u?.[2])).map(u=>[u[1],u[2]]);r.flightTrackLayer&&r.map.removeLayer(r.flightTrackLayer),i.length&&(r.flightTrackLayer=L.polyline(i,{color:"#4fa2ff",weight:2,opacity:.75}).addTo(r.map))}}catch{}finally{r.flightTrackLoading=!1,l.flightFocusTrack&&(l.flightFocusTrack.disabled=!1,l.flightFocusTrack.textContent="Track")}}}function fu(e){if(!e){_r();return}r.flightFocus=e,Or(),e.icao24&&Ur(e.icao24,!0)}function yu(e,t,n){if(!l.mapDetail||!l.mapDetailList)return;let a=l.mapDetailList;a.innerHTML="";let s=(l.mapWrap||l.mapCanvas).getBoundingClientRect(),o=Math.min(t+12,s.width-320),i=Math.min(n+12,s.height-220);l.mapDetail.style.left=`${Math.max(12,o)}px`,l.mapDetail.style.top=`${Math.max(12,i)}px`,l.mapDetailMeta&&(l.mapDetailMeta.textContent=`${e.count} signals in view`);let u=p=>{if(p.geoLabel)return p.geoLabel;if(p.location)return p.location;if(p.area)return p.area;if(p.title&&p.title.includes(" - ")){let h=p.title.split(" - ");if(h[1])return h.slice(1).join(" - ").trim()}return p.geo&&Number.isFinite(p.geo.lat)&&Number.isFinite(p.geo.lon)?`${p.geo.lat.toFixed(2)}, ${p.geo.lon.toFixed(2)}`:""},d=p=>{if(p.severity)return p.severity;if(p.category==="travel"&&p.title){let h=p.title.match(/Level\\s*(\\d)/i);if(h)return`Level ${h[1]}`}return""},m=p=>p.alertType?p.alertType:p.category==="travel"?"Travel Notice":p.category==="space"?"Space Weather":p.category==="weather"?"Weather Alert":p.category==="disaster"?"Disaster":p.category==="transport"?"Transport":"",f=p=>{let h=new Set;if(p.tags?.includes("us")&&h.add("US"),p.tags?.includes("global")&&h.add("Global"),p.category==="travel"){let b=hr(p.title||"");b&&h.add(b)}let y=p.geoLabel||p.location||p.area||"",g=yr(y);return g&&h.add(g),Array.from(h).slice(0,3)};if(e.items.slice(0,8).forEach(p=>{let h=document.createElement("div");h.className="map-detail-item";let y=document.createElement("div");y.className="map-detail-title",y.textContent=p.translatedTitle||p.title;let g=document.createElement("div");g.className="map-detail-meta",g.textContent=`${p.source||"Source"} \u2022 ${ve(p.publishedAt||Date.now())}`;let b=document.createElement("div");b.className="map-detail-badges";let C=document.createElement("span");C.className=`badge badge-${p.category||"news"}`,C.textContent=ot[p.category]||p.category||"Signal",b.appendChild(C);let v=m(p);if(v){let D=document.createElement("span");D.className="badge badge-alert",D.textContent=v,b.appendChild(D)}if(p.verificationCount&&p.verificationCount>1){let D=document.createElement("span");D.className="badge badge-verify",D.textContent=`Verified ${p.verificationCount} sources`,b.appendChild(D)}f(p).forEach(D=>{let M=document.createElement("span");M.className="badge badge-region",M.textContent=D,b.appendChild(M)});let w=u(p),I=d(p),A=document.createElement("div");if(A.className="map-detail-info",w){let D=document.createElement("div");D.className="map-detail-info-row",D.innerHTML=`<span>Location</span><strong>${w}</strong>`,A.appendChild(D)}if(I){let D=document.createElement("div");D.className="map-detail-info-row",D.innerHTML=`<span>Severity</span><strong>${I}</strong>`,A.appendChild(D)}let E=(p.translatedSummary||p.summary||"").trim(),T=document.createElement("div");if(T.className="map-detail-summary",E?T.textContent=E:p.url?T.textContent="Tap to open full details.":T.textContent="No additional details available.",h.appendChild(y),h.appendChild(b),h.appendChild(g),A.childNodes.length&&h.appendChild(A),h.appendChild(T),p.feedId==="transport-opensky"&&p.icao24){let D=document.createElement("div");D.className="map-detail-actions";let M=document.createElement("button");M.className="chip chip-small",M.textContent="Focus Flight",M.addEventListener("click",P=>{P.stopPropagation(),fu(p)}),D.appendChild(M),h.appendChild(D)}h.addEventListener("click",()=>{p.url&&window.open(p.url,"_blank","noopener")}),a.appendChild(h),r.settings.languageMode==="translate"&&p.isNonEnglish&&pr(p,y,null)}),e.count>8){let p=document.createElement("div");p.className="map-detail-more",p.textContent=`+${e.count-8} more signals`,a.appendChild(p)}l.mapDetail.classList.add("show")}function hu(e){let t=l.mapCanvas.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top,s=r.mapPoints.find(o=>{let i=o.x-n,u=o.y-a;return Math.sqrt(i*i+u*u)<o.radius+6});if(!s){xa();return}yu(s,n,a)}function gn(){if(!l.chatLog)return;let e=l.chatLog.querySelector(".chat-bubble.system");e||(e=document.createElement("div"),e.className="chat-bubble system",l.chatLog.prepend(e));let t=(r.keys.openai?.key||"").trim(),n=Ye(),a=r.settings.useClientOpenAI&&t;if(ne()){if(n){e.textContent=a?"AI connected via proxy (using your key).":"AI connected via proxy (server key). Use your key to override.";return}r.settings.superMonitor?e.textContent=t?"Super Monitor Mode: OpenAI key stored (proxy required on GitHub Pages).":"Super Monitor Mode is on. Add an OpenAI key; chat still needs a proxy.":e.textContent="Static mode: AI chat needs a proxy. Briefings use the cached snapshot when available.";return}e.textContent=n?a?"AI connected (proxy + your key).":"AI connected (server key).":t?"AI connected. Ask a question or request a briefing.":"Connect an AI provider to enable live responses."}function bu(e,t){if(!l.searchResults||!l.searchResultsList)return;l.searchResultsList.innerHTML="";let n=e.slice(0,25);n.length?kt(l.searchResultsList,n):l.searchResultsList.innerHTML='<div class="list-item">No matching signals yet.</div>',l.searchResultsMeta&&(l.searchResultsMeta.textContent=t),l.searchResults.classList.add("open")}function vu(){l.searchResults&&(l.searchResults.classList.remove("open"),l.searchResultsList&&(l.searchResultsList.innerHTML=""),l.searchResultsMeta&&(l.searchResultsMeta.textContent="Awaiting query"),hn())}async function dt(e=!1){if(!At)throw new Error("Feed manager not initialized.");return At.refreshAll(e)}function Ps(){if(!At)throw new Error("Feed manager not initialized.");return At.startAutoRefresh()}function Hr(){if(!l.geoLocateBtn)return;let e=()=>{l.geoLocateBtn.disabled=!1,l.geoLocateBtn.textContent="Locate Me"};if(!navigator.geolocation){r.location.source="fallback",me(),l.geoLocateBtn.textContent="Location Unsupported",setTimeout(e,2200);return}l.geoLocateBtn.disabled=!0,l.geoLocateBtn.textContent="Locating...",navigator.geolocation.getCurrentPosition(t=>{r.location={lat:t.coords.latitude,lon:t.coords.longitude,source:"geo"},ai(),r.map&&Mt(),r.scopedItems=Ge(r.items),me(),fe(),on(),je(),l.geoLocateBtn.textContent="Geolocated",setTimeout(e,1800)},()=>{r.location.source="fallback",me(),l.geoLocateBtn.textContent="Location Blocked",setTimeout(e,2400)},{enableHighAccuracy:!1,timeout:7e3})}function Cu(){l.exportSnapshot&&l.exportSnapshot.addEventListener("click",tc),l.refreshNow&&l.refreshNow.addEventListener("click",()=>dt(!0)),l.sidebarAbout&&l.sidebarAbout.addEventListener("click",()=>{We(!0),rt(!1)}),l.navToggle&&l.navToggle.addEventListener("click",()=>{let a=l.app?.classList.contains("nav-open");rt(!a)}),l.sidebarScrim&&l.sidebarScrim.addEventListener("click",()=>rt(!1)),l.aboutOpen&&l.aboutOpen.addEventListener("click",()=>We(!0)),l.aboutOpenSettings&&l.aboutOpenSettings.addEventListener("click",()=>We(!0)),l.aboutClose&&l.aboutClose.addEventListener("click",()=>We(!1)),l.aboutOverlay&&l.aboutOverlay.addEventListener("click",a=>{a.target===l.aboutOverlay&&We(!1)}),l.attributionClose&&l.attributionClose.addEventListener("click",()=>Kt(!1)),l.attributionOverlay&&l.attributionOverlay.addEventListener("click",a=>{a.target===l.attributionOverlay&&Kt(!1)}),l.moneyFlowsRun&&l.moneyFlowsRun.addEventListener("click",()=>_n()),l.moneyFlowsQuery&&l.moneyFlowsQuery.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),_n())}),l.moneyFlowsRange&&l.moneyFlowsRange.addEventListener("change",()=>{r.moneyFlowsRangeDays=Number(l.moneyFlowsRange.value)||wt,r.moneyFlowsQuery?_n():vt()}),l.liveSearchToggle&&l.liveSearchToggle.addEventListener("click",()=>{r.settings.liveSearch=!r.settings.liveSearch,V(),me()}),l.savedSearches&&l.savedSearches.addEventListener("click",a=>{let s=a.target.closest("button[data-query]");s&&(l.searchInput.value=s.dataset.query||"",Wn?.handleSearch&&Wn.handleSearch())}),l.stateSignalFilter&&l.stateSignalFilter.addEventListener("change",()=>{let a=ze(l.stateSignalFilter.value)||"ALL";r.settings.stateSignalFilter=a,r.lastSearchState=a,V(),Ar(),Tr(),je(),hn(),dt(!0).catch(()=>{})}),l.financeTabs&&l.financeTabs.addEventListener("click",a=>{let s=a.target.closest(".tab");if(!s)return;let o=s.dataset.tab;l.financeTabs.querySelectorAll(".tab").forEach(i=>{i.classList.toggle("active",i===s)}),document.querySelectorAll(".finance-panel .tab-panel").forEach(i=>{i.classList.toggle("active",i.id===(o==="markets"?"financeMarketsList":"financePolicyList"))})}),l.stateGovTabs&&l.stateGovTabs.addEventListener("click",a=>{let s=a.target.closest(".tab");if(!s)return;let o=s.dataset.tab,u={all:"stateGovAllList",legislation:"stateGovLegislationList",rulemaking:"stateGovRulemakingList",executive:"stateGovExecutiveOrdersList"}[o]||"stateGovAllList";l.stateGovTabs.querySelectorAll(".tab").forEach(d=>{d.classList.toggle("active",d===s)}),document.querySelectorAll(".state-gov-panel .tab-panel").forEach(d=>{d.classList.toggle("active",d.id===u)})}),document.querySelectorAll(".ticker-builder-toggle").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.target,o=document.querySelector(`.ticker-builder[data-builder="${s}"]`);o&&o.classList.toggle("open")})}),document.querySelectorAll(".ticker-builder").forEach(a=>{let s=a.querySelector(".ticker-add"),o=a.querySelector(".ticker-query");s&&s.addEventListener("click",()=>ys(a)),o&&o.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),ys(a))})}),document.addEventListener("click",a=>{let s=a.target.closest(".ticker-remove");if(!s)return;let o=s.dataset.key;o&&fl(o)}),l.geoLocateBtn&&l.geoLocateBtn.addEventListener("click",Hr),l.mapLegendBtn&&l.mapLegend&&(l.mapLegendBtn.addEventListener("click",()=>{l.mapLegend.classList.toggle("show")}),l.mapLegend.addEventListener("change",a=>{let s=a.target.closest("input[data-layer]");if(s){let m=s.dataset.layer;r.settings.mapLayers[m]=s.checked,V(),fe();return}let o=a.target.closest("input[data-conflict-type]");if(o){let m=o.dataset.conflictType;r.settings.mapConflictTypes=r.settings.mapConflictTypes||{},r.settings.mapConflictTypes[m]=o.checked,V(),fe();return}let i=a.target.closest("input[data-basemap]");if(i){gt(i.dataset.basemap),fe();return}let u=a.target.closest("input[data-overlay]");if(u){let m=u.dataset.overlay;r.settings.mapRasterOverlays[m]=u.checked,V(),Ne(),m==="sar"&&(u.checked?Qt():z("sar","off","")),m==="lidar"&&(u.checked?la():z("lidar","off","")),m==="lidarPoints"&&(u.checked?mn():z("lidarPoints","off",""))}let d=a.target.closest("input[data-flight-density]");if(d){r.settings.mapFlightDensity=d.dataset.flightDensity||"medium",V(),fe();return}}),document.addEventListener("click",a=>{l.mapLegend.classList.contains("show")&&(l.mapLegend.contains(a.target)||l.mapLegendBtn.contains(a.target)||l.mapLegend.classList.remove("show"))})),l.imageryDateInput&&l.imageryDateInput.addEventListener("change",a=>{r.imageryDateManual=!0,ut(a.target.value)}),l.sarDateInput&&l.sarDateInput.addEventListener("change",a=>{r.sarDateManual=!0,pn(a.target.value)}),l.imageryDatePanel&&l.imageryDatePanel.addEventListener("change",a=>{r.imageryDateManual=!0,ut(a.target.value)}),l.sarDatePanel&&l.sarDatePanel.addEventListener("change",a=>{r.sarDateManual=!0,pn(a.target.value)});let e=()=>{r.imageryDateManual=!1,Nt()},t=()=>{r.sarDateManual=!1,Qt()};l.imageryAutoBtn&&l.imageryAutoBtn.addEventListener("click",e),l.imageryPanelAutoBtn&&l.imageryPanelAutoBtn.addEventListener("click",e),l.sarAutoBtn&&l.sarAutoBtn.addEventListener("click",t),l.sarPanelAutoBtn&&l.sarPanelAutoBtn.addEventListener("click",t),l.imageryResetBtn&&l.imageryResetBtn.addEventListener("click",Ms),l.imageryResetPanelBtn&&l.imageryResetPanelBtn.addEventListener("click",Ms),document.querySelectorAll("[data-imagery-preset]").forEach(a=>{a.addEventListener("click",()=>{su(a.dataset.imageryPreset)})}),document.querySelectorAll("[data-imagery-basemap]").forEach(a=>{a.addEventListener("click",()=>{gt(a.dataset.imageryBasemap),qe()})}),document.querySelectorAll("[data-imagery-overlay]").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.imageryOverlay,o=!r.settings.mapRasterOverlays?.[s];r.settings.mapRasterOverlays[s]=o,V(),Ne(),s==="sar"&&(o?Qt():z("sar","off","")),s==="lidar"&&(o?la():(z("lidar","off",""),r.lidarSelectedLayer=null,r.lidarSelectedBounds=null,Et())),s==="lidarPoints"&&(o?r.lidarPointEptUrl?r.lidarPointEptAvailable?mn():z("lidarPoints","unavailable","ept unavailable"):z("lidarPoints","unavailable","select a LiDAR AOI"):z("lidarPoints","off",""),Et()),qe(),mt()})}),document.querySelectorAll("[data-overlay-opacity]").forEach(a=>{a.addEventListener("input",()=>{let s=a.dataset.overlayOpacity,o=Math.max(0,Math.min(100,Number(a.value)))/100;r.settings.mapOverlayOpacity[s]=o,V(),Ne(),qe()})}),l.customFeedToggle&&l.customFeedToggle.addEventListener("click",()=>{let a=l.customFeedForm?.classList.contains("hidden");a&&Ys(),Wt(a)}),l.customFeedExport&&l.customFeedExport.addEventListener("click",()=>{Pi()}),l.customFeedDownload&&l.customFeedDownload.addEventListener("click",()=>{let a=l.customFeedJson?.value?.trim()||$i(),s=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(s),i=document.createElement("a");i.href=o,i.download="custom-feeds.json",document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(o),l.customFeedJsonStatus&&(l.customFeedJsonStatus.textContent="Downloaded custom feeds JSON.")}),l.customFeedOpen&&l.customFeedOpen.addEventListener("click",()=>{let a=Be("data/feeds.json");window.open(a,"_blank","noopener")}),l.customFeedImportToggle&&l.customFeedImportToggle.addEventListener("click",()=>{let a=l.customFeedJsonPanel?.classList.contains("hidden");Qs(a)}),l.customFeedJsonCopy&&l.customFeedJsonCopy.addEventListener("click",async()=>{if(l.customFeedJson)try{await navigator.clipboard.writeText(l.customFeedJson.value||""),l.customFeedStatus&&(l.customFeedStatus.textContent="Copied feed JSON to clipboard.")}catch{l.customFeedStatus&&(l.customFeedStatus.textContent="Copy failed. Select and copy manually.")}}),l.customFeedJsonApply&&l.customFeedJsonApply.addEventListener("click",()=>{Bi()}),l.customFeedCancel&&l.customFeedCancel.addEventListener("click",()=>{Wt(!1)}),l.customFeedSave&&l.customFeedSave.addEventListener("click",()=>{let{feed:a,error:s}=Ri();if(s){l.customFeedStatus&&(l.customFeedStatus.textContent=s);return}Lt&&(r.customFeeds=r.customFeeds.filter(o=>o.id!==Lt)),a.id||(a.id=`custom-${ca(a.url||a.name)}`),r.customFeeds=[...r.customFeeds,a],fn(),r.feeds=yn(r.baseFeeds,r.customFeeds),vn(),bn(),$t(),Wt(!1),dt(!0)}),l.customFeedRequiresKey&&l.customFeedRequiresKey.addEventListener("change",()=>{let a=l.customFeedRequiresKey.checked;l.customFeedKeyParam.disabled=!a,l.customFeedKeyHeader.disabled=!a}),l.customFeedSupportsQuery&&l.customFeedSupportsQuery.addEventListener("change",()=>{l.customFeedDefaultQuery.disabled=!l.customFeedSupportsQuery.checked}),l.mapDetailClose&&l.mapDetailClose.addEventListener("click",xa),l.flightFocusClear&&l.flightFocusClear.addEventListener("click",_r),l.flightFocusTrack&&l.flightFocusTrack.addEventListener("click",()=>{r.flightFocus?.icao24&&Ur(r.flightFocus.icao24,!0)}),l.flightFocusOpen&&l.flightFocusOpen.addEventListener("click",()=>{let a=r.flightFocus?.icao24;a&&window.open(`https://opensky-network.org/api/tracks/all?icao24=${encodeURIComponent(a)}`,"_blank","noopener")}),l.searchResultsClose&&l.searchResultsClose.addEventListener("click",vu);let n=l.mapBase||l.mapCanvas;n.addEventListener("mousemove",gu),n.addEventListener("mouseleave",()=>{l.mapTooltip.style.display="none"}),n.addEventListener("click",hu),l.analysisRun.addEventListener("click",Cr),l.resetLayout.addEventListener("click",Ci),l.chatSend.addEventListener("click",Ss),l.chatInput.addEventListener("keydown",a=>{a.key==="Enter"&&Ss()}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{r.settings.theme==="system"&&Zn("system")}),window.addEventListener("resize",()=>{r.map&&r.map.invalidateSize(),r.energyMap&&r.energyMap.invalidateSize(),fe()}),window.addEventListener("keydown",a=>{a.key==="Escape"&&(We(!1),Kt(!1),Vs(!1),zt(!1),rt(!1))})}async function Su(){Gi(),ii(),li(),ci(),di(),mi(),r.customFeeds=pi(),Zn(r.settings.theme),me(),await si(),me(),yi(),r.panels.defaultOrder=Je().map(n=>n.id),r.panels.order.length&&r.panels.order.length!==r.panels.defaultOrder.length&&(r.panels.order=[...r.panels.defaultOrder],Dt()),zs(),ua(),Ks(),Ws(),Ti(),Xt(),bi(),vi(),document.querySelectorAll(".key-chip").forEach(n=>n.remove());let e;try{let n=await Ce("/api/feeds");if(e=n.data,n.error||!e)throw new Error("Feed API unreachable")}catch{ds("API offline"),l.feedHealth&&(l.feedHealth.innerHTML=ne()?'<div class="settings-note">Static snapshot mode: feeds load from the latest published cache.</div>':'<div class="settings-note">Feed API unreachable. Check proxy configuration.</div>'),e={feeds:[]}}r.baseFeeds=(e.feeds||[]).filter(n=>n.url||n.requiresKey||n.requiresConfig),r.feeds=yn(r.baseFeeds,r.customFeeds),ri(),oi(),At=as({state:r,elements:l,helpers:{setRefreshing:Mi,setHealth:ds,updateProxyHealth:qi,isStaticMode:ne,loadStaticAnalysis:cs,loadStaticBuild:gi,translateQuery:Jt,shouldFetchLiveInStatic:Tl,fetchCustomFeedDirect:na,fetchFeed:ea,isFeedStale:Vo,canonicalUrl:Cn,isNonEnglish:mr,enrichItem:Kl,applyScope:Ge,clusterNews:at,updateDataFreshBadge:fi,countCriticalIssues:Wo,renderAllPanels:st,renderSignals:je,renderFeedHealth:br,drawMap:fe,generateAnalysis:rn,maybeAutoRunAnalysis:He,refreshCustomTickers:ba,renderTicker:Ca,renderFinanceSpotlight:Sn,geocodeItems:Sl,renderLocal:on,updatePanelErrors:wn}}),bn(),Fi(),vn(),$t(),gn(),ru(),yt(),Cu(),Wn=Xa({state:r,elements:l,helpers:{showSearchResults:bu,updateSearchHint:hn,isStaticMode:ne,getLiveSearchFeeds:Ml,translateQueryAsync:Fl,fetchCustomFeedDirect:na,applySearchFilters:Rl,CATEGORY_LABELS:ot,fetchFeed:ea,hasAssistantAccess:Me,updateCategoryFilters:Xt}}),ns({elements:l,handlers:{onSettingsToggle:()=>{let n=l.settingsPanel?.classList.contains("open");zt(!n)},onSettingsScrim:()=>zt(!1),onSidebarSettings:()=>{let n=l.settingsPanel?.classList.contains("open");zt(!n),rt(!1)},onStatusToggle:()=>{r.settings.showStatus=!r.settings.showStatus,V(),me()},onKeyToggle:()=>{r.settings.showKeys=!r.settings.showKeys,V(),me()},onMcpToggle:()=>{r.settings.showMcp=!r.settings.showMcp,V(),me()},onTravelTickerToggle:()=>{r.settings.showTravelTicker=!r.settings.showTravelTicker,V(),me(),Ir()},onRefreshRange:n=>{r.settings.refreshMinutes=Number(n.target.value),V(),me(),Ps()},onRadiusRange:n=>{r.settings.radiusKm=Number(n.target.value),V(),me(),on(),fe(),He()},onMaxAgeRange:n=>{r.settings.maxAgeDays=Number(n.target.value),V(),me(),r.scopedItems=Ge(r.items),r.clusters=at(r.scopedItems.filter(a=>a.category==="news")),st(),je(),fe(),He()},onLanguageToggle:n=>{let a=n.target.closest("button");a&&(r.settings.languageMode=a.dataset.language,V(),me(),r.scopedItems=Ge(r.items),r.clusters=at(r.scopedItems.filter(s=>s.category==="news")),st(),je(),fe(),He())},onThemeToggle:n=>{let a=n.target.closest("button");a&&(Zn(a.dataset.theme),V(),me())},onAgeToggle:n=>{let a=n.target.closest("button");if(!a)return;let s=Number(a.dataset.age);Number.isFinite(s)&&(r.settings.maxAgeDays=s,V(),me(),r.scopedItems=Ge(r.items),r.clusters=at(r.scopedItems.filter(o=>o.category==="news")),st(),je(),fe())},onScopeToggle:n=>{let a=n.target.closest("button");a&&(r.settings.scope=a.dataset.scope,r.scopedItems=Ge(r.items),r.clusters=at(r.scopedItems.filter(s=>s.category==="news")),da(),Mt(),st(),je(),fe(),He())},onAiTranslateToggle:n=>{r.settings.aiTranslate=n.target.checked,V(),me(),He()},onSuperMonitorToggle:n=>{r.settings.superMonitor=n.target.checked,V(),me(),gn(),He()}}}),es({state:r,helpers:{buildNewsItems:nn,getCombinedItems:lt,getCategoryItems:Te,getFederalPolicyItems:xt,getStateGovernmentItems:Ie,getPredictionItems:ln,getLocalItemsForPanel:an,getCongressItems:pt,getEnergyNewsItems:sn,getCriticalAlertsItems:ra,renderList:kt,getListLimit:nr,LIST_PAGE_SIZE:Bo}}),ts({state:r,helpers:{buildNewsItems:nn,getCombinedItems:lt,getCategoryItems:Te,getFederalPolicyItems:xt,getStateGovernmentItems:Ie,getPredictionItems:ln,getLocalItemsForPanel:an,getCongressItems:pt,getEnergyNewsItems:sn,getCriticalAlertsItems:ra,renderListWithLimit:be}}),Fc(),Dc(),Ho.initFocusModal(),Pc(),$c(),Bc(),Rc(),qt=Wa({state:r,elements:l,mcpClient:Kn,helpers:{toRelativeTime:ve,truncateText:se,stripHtml:he}}),Mc(),lr(),Xn(),Hr(),(new URLSearchParams(window.location.search).has("about")||window.location.hash==="#about")&&We(!0),typeof window<"u"&&(window.__SR_READY__=!0),await cs(),await dt(),Ps()}var wu=typeof window<"u"&&new URLSearchParams(window.location.search).has("debug");wu&&(window.__SR_DEBUG__={state:r,getMapItems:Aa,getLocalItems:Bt,applyScope:Ge});Su();
